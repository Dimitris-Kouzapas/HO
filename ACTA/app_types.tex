%In this appendix 
We 
first 
formally define \emph{type equivalence}. % and \emph{duality}. Then, we  
%present and describe our typing rules, given in~\figref{fig:typerulesmy}.
%Finally, we 
Then we 
give details of the proof of Theorem~\ref{t:sr} (page~\pageref{t:sr}).
%\smallskip
%\subsection{Type Equivalence and Duality}
%\begin{definition}[Type Equivalence]
%\label{def:iso}
%Let $\mathsf{ST}$ a set of closed session types. 
%Two types $S$ and $S'$ are said to be {\em isomorphic} if a pair $(S,S')$ is 
%in the largest fixed point of the monotone function
%$F:\mathcal{P}(\mathsf{ST}\times \mathsf{ST}) \to 
%\mathcal{P}(\mathsf{ST}\times \mathsf{ST})$ defined by: \\
%%\hspace{-0.5cm}
%\begin{tabular}{rcl}
%$F(\Re)$ &$\!\!=\!\!$&	$\set{(\tinact, \tinact)}$\\
%         &$\!\!\cup\!\!$&	$\set{(\btout{U_1} S_1, \btout{U_2} S_2)
%\bnfbar (S_1, S_2),(U_1, U_2)\in \Re}$\\ 
%       &$\!\!\cup\!\!$&	$\set{(\btinp{U_1} S_1, \btinp{U_2} S_2)
%\bnfbar(S_1, S_2),(U_1, U_2)\in \Re}$\\ 
%	&$\!\!\cup\!\!$&	$\set{(\btbra{l_i: S_i}_{i \in I} \,,\, \btbra{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(\btsel{l_i: S_i}_{i \in I}\,,\, \btsel{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(\trec{t}{S}, S')
%\bnfbar (S\subst{\trec{t}{S}}{\vart{t}},S')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(S,\trec{t}{S'})
%\bnfbar (S,S'\subst{\trec{t}{S'}}{\vart{t}})\in \Re}$
%\end{tabular}
%	
%\noindent
%Standard arguments ensure that $F$ is monotone, thus the greatest fixed point
%of $F$ exists. We write $S_1 \sim S_2$ if  $(S_1,S_2)\in \Re$. 
%\end{definition}
%
%\smallskip 
%
%\begin{definition}[Duality]
%\label{def:dual}
%Let $\mathsf{ST}$ a set of closed session types. 
%Two types $S$ and $S'$ are said to be {\em dual} if a pair $(S,S')$ is 
%in the largest fixed point of the monotone function
%$F:\mathcal{P}(\mathsf{ST}\times \mathsf{ST}) \to 
%\mathcal{P}(\mathsf{ST}\times \mathsf{ST})$ defined by:\\ %[1mm]
%\begin{tabular}{rcl}
%$F(\Re)$ &$\!\!=\!\!$&	$\set{(\tinact, \tinact)}$\\
%         &$\!\!\cup\!\!$&	$\set{(\btout{U_1} S_1, \btinp{U_2} S_2)
%\bnfbar(S_1, S_2)\in \Re, \  U_1 \sim U_2 }$\\ 
%       &$\!\!\cup\!\!$&	$\set{(\btinp{U_1} S_1, \btout{U_2} S_2)
%\bnfbar(S_1, S_2)\in \Re, \ U_1 \sim U_2}$\\ 
%	&$\!\!\cup\!\!$&	$\set{(\btsel{l_i: S_i}_{i \in I} \,,\, \btbra{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(\btbra{l_i: S_i}_{i \in I}\,,\, \btsel{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(\trec{t}{S}, S')
%\bnfbar (S\subst{\trec{t}{S}}{\vart{t}},S')\in \Re}$\\
%	&$\!\!\cup\!\!$&	$\set{(S,\trec{t}{S'})
%\bnfbar (S,S'\subst{\trec{t}{S'}}{\vart{t}})\in \Re}$\\[1mm]
%\end{tabular}
%
%\noindent
%%where $U_1 \sim U_2$ means $U_1$ is type equivalent to $U_2$ \cite{yoshida.vasconcelos:language-primitives}.
%Standard arguments ensure that $F$ is monotone, thus the greatest fixed point
%of $F$ exists. We write $S_1 \dualof S_2$ if  $(S_1,S_2)\in \Re$. 
%\end{definition}
%
%\smallskip 
%\subsection{Typing Rules}
%\input{type_system}
%\subsection{Proof of Theorem~\ref{t:sr}}
%We state type soundness of our system.

\subsection{Type Equivalence}
\begin{definition}[Type Equivalence]
\label{def:iso}
Let $\mathsf{ST}$ a set of closed session types. 
Two types $S$ and $S'$ are said to be {\em isomorphic} if a pair $(S,S')$ is 
in the largest fixed point of the monotone function
$F:\mathcal{P}(\mathsf{ST}\times \mathsf{ST}) \to 
\mathcal{P}(\mathsf{ST}\times \mathsf{ST})$ defined by: \\
%\hspace{-0.5cm}
\begin{tabular}{rcl}
$F(\Re)$ &$\!\!=\!\!$&	$\set{(\tinact, \tinact)}$\\
         &$\!\!\cup\!\!$&	$\set{(\btout{U_1} S_1, \btout{U_2} S_2)
\bnfbar (S_1, S_2),(U_1, U_2)\in \Re}$\\ 
       &$\!\!\cup\!\!$&	$\set{(\btinp{U_1} S_1, \btinp{U_2} S_2)
\bnfbar(S_1, S_2),(U_1, U_2)\in \Re}$\\ 
	&$\!\!\cup\!\!$&	$\set{(\btbra{l_i: S_i}_{i \in I} \,,\, \btbra{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
	&$\!\!\cup\!\!$&	$\set{(\btsel{l_i: S_i}_{i \in I}\,,\, \btsel{l_i: S_i'}_{i \in I}) \bnfbar \forall i\in I. (S_i, S_i')\in \Re}$\\
	&$\!\!\cup\!\!$&	$\set{(\trec{t}{S}, S')
\bnfbar (S\subst{\trec{t}{S}}{\vart{t}},S')\in \Re}$\\
	&$\!\!\cup\!\!$&	$\set{(S,\trec{t}{S'})
\bnfbar (S,S'\subst{\trec{t}{S'}}{\vart{t}})\in \Re}$
\end{tabular}

Standard arguments ensure that $F$ is monotone, thus the greatest fixed point
of $F$ exists. We write $S_1 \sim S_2$ if  $(S_1,S_2)\in \Re$. 
\end{definition}


\subsection{Proof of Theorem~\ref{t:sr} (Type Soundness)}
As our typed process framework is closely related to that considered
by Mostrous and Yoshida~\cite{MostrousY15}, the proof of type soundness requires notions
and properties which are specific instances of those already shown in~\cite{MostrousY15}.
We begin by stating weakening and strengthening lemmas,
which have standard proofs.

%%% Weakening
\begin{lemma}[Weakening - Lemma C.2 in~\cite{MostrousY15}]\rm
	\label{l:weak}
	\begin{enumerate}[$-$]
		\item	If $\Gamma; \Lambda; \Delta \proves P \hastype \Proc$
			and
			$x \not\in \dom{\Gamma,\Lambda,\Delta}$
			then
			$\Gamma\cat x: \shot{U}; \Lambda; \Delta \proves P \hastype \Proc$ 
	\end{enumerate}
\end{lemma}

\begin{lemma}[Strengthening - Lemmas C.3 and C.4 in~\cite{MostrousY15}]\rm
	\label{l:stren}
	We have:
	\begin{enumerate}[$-$]
		\item	If $\Gamma \cat x: \shot{U}; \Lambda; \Delta \proves P \hastype \Proc$
			and
			$x \not\in \fpv{P}$ then
			$\Gamma; \Lambda; \Delta \proves P \hastype \Proc$

		\item	If $\Gamma; \Lambda; \Delta \cat s: \tinact \proves P \hastype \Proc$
			and
			$s \not\in \fn{P}$
			then
			$\Gamma; \Lambda; \Delta \proves P \hastype \Proc$
	\end{enumerate}
\end{lemma}

\begin{lemma}[Substitution Lemma - Lemma C.10 in~\cite{MostrousY15}]\rm
	\label{l:subst}
	We have:
	\begin{enumerate}[1.]
		\item	Suppose $\Gamma; \Lambda; \Delta \cat x:S  \proves P \hastype \Proc$ and
			$s \not\in \dom{\Gamma, \Lambda, \Delta}$. 
			Then $\Gamma; \Lambda; \Delta \cat s:S  \vdash P\subst{s}{x} \hastype \Proc$.

		\item	Suppose $\Gamma \cat x:\chtype{U}; \Lambda; \Delta \proves P \hastype \Proc$ and
			$a \notin \dom{\Gamma, \Lambda, \Delta}$. 
			Then $\Gamma \cat a:\chtype{U}; \Lambda; \Delta   \vdash P\subst{a}{x} \hastype \Proc$.

		\item	Suppose $\Gamma; \Lambda_1 \cat x:\lhot{U}; \Delta_1  \proves P \hastype \Proc$ 
			and $\Gamma; \Lambda_2; \Delta_2  \proves V \hastype \lhot{U}$ with 
			$\Lambda_1, \Lambda_2$ and $\Delta_1, \Delta_2$ defined.  
			Then $\Gamma; \Lambda_1 \cat \Lambda_2; \Delta_1 \cat \Delta_2  \proves P\subst{V}{x} \hastype \Proc$.

		\item	Suppose $\Gamma \cat x:\shot{U}; \Lambda; \Delta  \proves P \hastype \Proc$ and
			$\Gamma; \emptyset ; \emptyset  \proves V \hastype \shot{U}$.
			Then $\Gamma; \Lambda; \Delta  \proves P\subst{V}{x} \hastype \Proc$.
		\end{enumerate}
\end{lemma}

\begin{proof}
	In all four parts, we proceed by induction on the typing for $P$,
	with a case analysis on the last applied rule. 
%	Parts (1) and (2) are standard and therefore omitted. 
%
%	In Part (3), we content ourselves by detailing only the case in
%	which the last applied rule is \trule{App}. 
%	Then we have $P = \appl{V}{u}$. By inversion on the first assumption 
%	we infer:
%	\[
%	\tree{
%	\tree{}{
%	\Gamma;\, \Lambda_1 \cat x:\lhot{C} ;\, \Delta_{11}   \proves V \hastype \lhot{C}} \quad
%	\tree{}{\Gamma;\,  \emptyset   ;\, \Delta_{12}  \proves u \hastype C}
%	}{
%	\Gamma;\,  \Lambda_1 \cat x:\lhot{C};\, \Delta_1    \proves \appl{V}{u} \hastype \Proc}
%	\]
%	where $\Delta_1 = \Delta_{11} \cat \Delta_{12}$.
%	By inversion on the second assumption we infer that either
%	(i)\,$V = y$ (for some   variable $y$) or 
%	(ii)\,$V = \abs{z}Q$, for some $Q$ such that
%%
%	\begin{equation}
%		\Gamma'; \Lambda_1 \cat x:\lhot{C} ; \Delta_{11} \cat \Delta' \proves Q \hastype \Proc \label{eq:subseq2}\\
%	\end{equation}
%%
%	In possibility\,(i), we have a simple substitution on process variables and the thesis follows easily. 
%	In possibility\,(ii), we observe that $P\subst{V}{X} = \appl{X}{\mytilde{k}}\subst{\abs{\mytilde{z}}Q}{X} = Q\subst{\mytilde{k}}{\mytilde{z}}$.
%	The thesis then follows by using Lemma~\ref{lem:subst}\,(1) with 
%	the second premise of the typing of $\appl{X}{\mytilde{k}}$
%	and \eqref{eq:subseq2} above to infer 
%	\begin{equation*}
%		\Gamma; \Lambda_2 ; \Delta_2 \cat \mytilde{k}:\mytilde{C}  \proves Q \subst{\mytilde{k}}{\mytilde{z}} \hastype \Proc .
%	\end{equation*}
%%
%	The proof of Part (4) follows similar lines as that of Part (3).
%	\qed
\end{proof}

%\begin{definition}[Well-typed Session Environment]%\rm
%	Let $\Delta$ be a session environment.
%	We say that $\Delta$ is {\em well-typed} if whenever
%	$s: S_1, \dual{s}: S_2 \in \Delta$ then $S_1 \dualof S_2$.
%\end{definition}
%
%\begin{definition}[Session Environment Reduction]%\rm
%	We define the relation $\red$ on session environments as:
%	\begin{enumerate}[$-$]
%		\item	$\Delta \cat s: \btout{U} S_1 \cat \dual{s}: \btinp{U} S_2 \red \Delta \cat s: S_1 \cat \dual{s}: S_2$
%		\item	$\Delta \cat s: \btsel{l_i: S_i}_{i \in I} \cat \dual{s}: \btbra{l_i: S_i'}_{i \in I} \red \Delta \cat s: S_k \cat \dual{s}: S_k', \quad k \in I$.
%	\end{enumerate}
%\end{definition}

We now state the instance of type soundness that we
can derive from~\cite{MostrousY15}.
It is worth noticing 
the 
definition of structural congruence in~\cite{MostrousY15} is richer. 
Also, their statement for subject reduction relies on an 
ordering on typing associated to queues and other 
runtime elements. % (such extended typings are denoted $\Delta$ in~\cite{MostrousY15}).
Since we are working with synchronous communication we can omit such an ordering.

We now repeat the statement of
\thmref{t:sr} in Page~\pageref{t:sr}:

\begin{theorem}[Type Soundness - \thmref{t:sr}]\rm\label{t:srfull}
We have:
	\begin{enumerate}[1.]
		\item	(Subject Congruence) Suppose $\Gamma; \Lambda; \Delta \proves P \hastype \Proc$.
			Then $P \scong P'$ implies $\Gamma; \Lambda; \Delta \proves P' \hastype \Proc$.

		\item	(Subject Reduction) Suppose $\Gamma; \es; \Delta \proves P \hastype \Proc$
			with
			balanced $\Delta$. \\
			Then $P \red P'$ implies $\Gamma; \es; \Delta'  \proves P' \hastype \Proc$
			and $\Delta = \Delta'$ or $\Delta \red \Delta'$.

	\end{enumerate}
\end{theorem}

\begin{proof}
	Part (1) is standard, using weakening and strengthening lemmas. Part (2) proceeds by induction on the last reduction rule used. Below, we give some details:
	\begin{enumerate}[1.]
	   \item
	   Case \orule{App}: Then we have
	   $$
	   P = (\abs{x}{Q}) \, u   \red  Q \subst{u}{x} = P'
	   $$
	   Suppose $\Gamma;\, \emptyset ;\, \Delta \proves (\abs{x}{Q}) \, u \hastype \Proc$. 
	   We examine one possible way in which 
	   this assumption can be derived; other cases are similar or simpler:
	   \[
	   \tree{
	   \tree{\Gamma;\, \emptyset ;\, \Delta \cat \{x:S\} \proves Q  \hastype \Proc \quad 
	   \Gamma';\, \emptyset ;\, \{x:S\} \proves x  \hastype S}
	   {
	   \Gamma;\, \emptyset ;\, \Delta \proves \abs{x}{Q}  \hastype \lhot{S} }
	   \qquad
	   \tree{}{
	   \Gamma;\, \emptyset ;\, \{u:S\} \proves   u \hastype S}
	   }{
	   \Gamma;\, \emptyset ;\, \Delta \cat u:S \proves (\abs{x}{Q}) \, u \hastype \Proc
	   }
	   \]
	  Then, by combining premise
	   $\Gamma;\, \emptyset ;\, \Delta \cat \{x:S\} \proves Q  \hastype \Proc$
	   with
	   the substitution lemma (\lemref{l:subst}(1)),
	   we obtain 
	    $\Gamma;\, \emptyset ;\, \Delta \cat u:S \proves Q\subst{u}{x}  \hastype \Proc$, as desired.
	    
	    \item Case \orule{Pass}: 
	    There are several sub-cases, depending on the type of the communication 
	    subject $n$ and the type of the object $V$. We analyse two representative sub-cases:
	    
	    \begin{enumerate}[(a)]
	    \item $n$ is a shared name and $V$ is a name $v$. 
	    Then we have the following reduction: 
	    $$
	    P = \bout{n}{v} Q_1 \Par \binp{n}{x} Q_2  \red  Q_1 \Par Q_2 \subst{v}{x} = P'
	    $$
	    By assumption, we have 
	    the following typing derivation:
	    \[	    \hspace{-12mm}
	    \tree{
%	    \tree{
%	     \Gamma' \cat n:\chtype{S};\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{S}
%	     \quad
%	      \Gamma;\, \emptyset ;\, \Delta_1    \proves   Q_1  \hastype \Proc
%	      \quad
%	       \Gamma;\, \emptyset ;\, \{v:S\}  \proves v  \hastype S	    
%	    }{
%	    \Gamma;\, \emptyset ;\, \Delta_1 \cat \{v:S\}  \proves \bout{n}{v} Q_1  \hastype \Proc
%	    } 
		\eqref{eq:sound1}
	    \quad 
	    		\eqref{eq:sound2}
%	    	    \tree{
%	    \Gamma' \cat n:\chtype{S};\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{S}
%	     \quad
%	      \Gamma;\, \emptyset ;\, \Delta_3 \cat x:S    \proves   Q_2  \hastype \Proc
%	    }{
%	    \Gamma;\, \emptyset ;\, \Delta_3 \proves  \binp{n}{x} Q_2 \hastype \Proc
%	   }
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_1 \cat \{v:S\} \cat \Delta_3 \proves \bout{n}{v} Q_1 \Par \binp{n}{x} Q_2 \hastype \Proc
	    }
	    \]
	    
	    where \eqref{eq:sound1} and \eqref{eq:sound2} are as follows:
	    \begin{eqnarray}
	      & \tree{
	     \Gamma' \cat n:\chtype{S};\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{S}
	     \quad
	      \Gamma;\, \emptyset ;\, \Delta_1    \proves   Q_1  \hastype \Proc
	      \quad
	       \Gamma;\, \emptyset ;\, \{v:S\}  \proves v  \hastype S	    
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_1 \cat \{v:S\}  \proves \bout{n}{v} Q_1  \hastype \Proc
	    } & \label{eq:sound1}
	    \\
	    	    	&     \tree{
	    \Gamma' \cat n:\chtype{S};\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{S}
	     \quad
	      \Gamma;\, \emptyset ;\, \Delta_3 \cat x:S    \proves   Q_2  \hastype \Proc
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_3 \proves  \binp{n}{x} Q_2 \hastype \Proc
	   } & 
		\label{eq:sound2}
	    \end{eqnarray}
	    
	    Now, by applying \lemref{l:subst}(1) on $\Gamma;\, \emptyset ;\, \Delta_3 \cat x:S    \proves   Q_2  \hastype \Proc$
			we obtain 
	   $$
	   \Gamma;\, \emptyset ;\, \Delta_3 \cat v:S    \proves   Q_2\subst{v}{x}  \hastype \Proc
	   $$
	   
	   			and the case is completed by using rule~\trule{Par} with this judgement:
							\[		~~ 
				\tree{
					\Gamma; \emptyset; \Delta_1    \proves  
 					 Q_1 \hastype \Proc
					 \quad 
					\Gamma;\, \emptyset ;\, \Delta_3 \cat v:S    \proves   Q_2\subst{v}{x}  \hastype \Proc
					}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_3  \cat v:S \proves  
 					Q_1  \Par  Q_2\subst{v}{x} \hastype \Proc
					} 
			\]
			Observe how in this case the session environment does not reduce.\\
			
			%%%%%%%%%%%%%%%%%%%%%%%%
			
		\item $n$ is a shared name and $V$ is a higher-order value. 
	    Then we have the following reduction: 
	    $$
	    P = \bout{n}{V} Q_1 \Par \binp{n}{x} Q_2  \red  Q_1 \Par Q_2 \subst{V}{x} = P'
	    $$
	    By assumption, we have 
	    the following typing derivation (below, we write 
	    $L$ to stand for $\shot{C}$ and 
	    $\Gamma$ to stand for $ \Gamma' \setminus \{x:L\}$).
	    \[	    \hspace{-12mm}
	    \tree{
	     \eqref{eq:sound3}
%	    \tree{
%	     \Gamma;\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{L}
%	     \quad
%	      \Gamma;\, \emptyset ;\, \Delta_1    \proves   Q_1  \hastype \Proc
%	      \quad
%	       \Gamma;\, \emptyset ;\, \emptyset  \proves V  \hastype L	    
%	    }{
%	    \Gamma;\, \emptyset ;\, \Delta_1    \proves \bout{n}{V} Q_1  \hastype \Proc
%	    } 
	    \quad 
	    \eqref{eq:sound4}
%	    	    \tree{
%	    \Gamma' ;\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{L}
%	     \quad
%	      \Gamma';\, \emptyset ;\, \Delta_3    \proves   Q_2  \hastype \Proc
%	      	     \quad
%	      	    \Gamma' ;\, \emptyset ;\, \emptyset  \proves x  \hastype L
%	    }{
%	    \Gamma;\, \emptyset ;\, \Delta_3 \proves  \binp{n}{x} Q_2 \hastype \Proc
%	   }
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_1 \cat \Delta_3 \proves \bout{n}{v} Q_1 \Par \binp{n}{x} Q_2 \hastype \Proc
	    }
	    \]
	    where \eqref{eq:sound3} and \eqref{eq:sound4} are as follows:
	    \begin{eqnarray}
	    & 	    \tree{
	     \Gamma;\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{L}
	     \quad
	      \Gamma;\, \emptyset ;\, \Delta_1    \proves   Q_1  \hastype \Proc
	      \quad
	       \Gamma;\, \emptyset ;\, \emptyset  \proves V  \hastype L	    
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_1    \proves \bout{n}{V} Q_1  \hastype \Proc
	    } 
 & 	    \label{eq:sound3} \\
	    & 	    	    \tree{
	    \Gamma' ;\, \emptyset ;\, \emptyset  \proves n  \hastype \chtype{L}
	     \quad
	      \Gamma';\, \emptyset ;\, \Delta_3    \proves   Q_2  \hastype \Proc
	      	     \quad
	      	    \Gamma' ;\, \emptyset ;\, \emptyset  \proves x  \hastype L
	    }{
	    \Gamma;\, \emptyset ;\, \Delta_3 \proves  \binp{n}{x} Q_2 \hastype \Proc
	   }
 & 	    \label{eq:sound4}
	    \end{eqnarray}
	    
	    Now, by applying \lemref{l:subst}(4) on 
	    $\Gamma' \setminus \{x:L\};\, \emptyset ;\, \Delta_3    \proves   Q_2  \hastype \Proc$
	    and
	    $\Gamma;\, \emptyset ;\, \emptyset  \proves V  \hastype L$
	    we obtain 
	   $$
	   \Gamma;\, \emptyset ;\, \Delta_3  \proves   Q_2\subst{V}{x}  \hastype \Proc
	   $$
	   
	   and the case is completed by using rule~\trule{Par} with this judgement:
							\[		~~ 
				\tree{
					\Gamma; \emptyset; \Delta_1    \proves  
 					 Q_1 \hastype \Proc
					 \quad 
					\Gamma;\, \emptyset ;\, \Delta_3     \proves   Q_2\subst{V}{x}  \hastype \Proc
					}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_3   \proves  
 					Q_1  \Par  Q_2\subst{V}{x} \hastype \Proc
					} 
			\]
			Observe how in this case the session environment does not reduce.\\
			

	\end{enumerate}

%		\item	Case \orule{NPass}:
%			Then there are two sub-cases, depending on whether the
%			communication subject is a shared name or a channel. 
%			In the first case, we have 
%			$$P = \bout{\dual{k}}{n} P_1 \Par \binp{k}{x} P_2 \red P_1 \Par P_2\subst{n}{x} = P'$$ 
%			Suppose $\Gamma; \es; \Delta  \proves \bout{\dual{k}}{n} P_1 \Par \binp{k}{x} P_2 \hastype \Proc$. This assumption is derived first from rules~\trule{Req} and \trule{AccS}:
%			\[
%								\tree{
%					\Gamma; \emptyset; \emptyset  \proves  k \hastype \chtype{S} ~~~
%					\Gamma ; \emptyset ; \Delta_1 \proves   P_1 \hastype \Proc ~~~
%					\Gamma ; \emptyset ; \{n:S\} \proves   n \hastype S
%					}{
%					\Gamma; \emptyset; \Delta_1 \cat \{n:S\}    \proves  
% 					\bout{\dual{k}}{n} P_1 \hastype \Proc} 
%			\]		
%			and
%			\[		~~ 
%				\tree{
%					\Gamma; \emptyset; \emptyset  \proves  k \hastype \chtype{S} \quad 
%					\Gamma ; \emptyset ; \Delta_2 \cat \{x:S\}  \proves  P_2 \hastype \Proc \quad
%					\Gamma ; \emptyset ; \{x:S\}  \proves  x \hastype S
%					}{
%					\Gamma; \emptyset; \Delta_2  \proves  
% 					\binp{k}{x} P_2 \hastype \Proc} 
%			\]
%			and then rule~\trule{Par}, we obtain: %letting $\Delta = \Delta_1 \cat \Delta_2  \cat \Delta_3$.
%				\[		~~ 
%				\tree{
%					\Gamma; \emptyset; \Delta_1 \cat \{n:S\}    \proves  
% 					\bout{\dual{k}}{n} P_1 \hastype \Proc\quad 
%					\Gamma; \emptyset;  \Delta_2 \proves  
% 					\binp{k}{x} P_2 \hastype \Proc
%					}{
%					\Gamma; \emptyset; \Delta_1 \cat \{n:S\} \cat \Delta_2 \proves  
% 					\bout{\dual{k}}{n} P_1  \Par \binp{k}{x} P_2 \hastype \Proc
%					} 
%			\]
%			
%			Now, by applying Lemma~\ref{lem:subst}(1) on $\Gamma ; \emptyset ; \Delta_2 \cat \{x:S\}  \proves  P_2 \hastype \Proc$
%			we obtain 
%			$$\Gamma ; \emptyset ; \Delta_2 \cat \{n:S\} \proves  P_2\subst{n}{x} \hastype \Proc$$
%			and the case is completed by using rule~\trule{Par} with this judgment:
%							\[		~~ 
%				\tree{
%					\Gamma; \emptyset; \Delta_1    \proves  
% 					 P_1 \hastype \Proc\quad 
%					\Gamma; \emptyset;  \Delta_2 \cat \{n:S\}  \proves  
% 					 P_2\subst{n}{x} \hastype \Proc
%					}{
%					\Gamma; \emptyset; \Delta_1 \cat \{n:S\} \cat \Delta_2 \proves  
% 					P_1  \Par  P_2\subst{n}{x} \hastype \Proc
%					} 
%			\]
%			Observe how in this case the session environment does not reduce.\\
%			
%			In the second case we have the following reduction, with   $|\mytilde{h}| = |\mytilde{x}|$:
%			$$P = \bout{\dual{k}}{\mytilde{h}} P_1 \Par \binp{k}{\mytilde{x}} P_2 \red P_1 \Par P_2\subst{\mytilde{h}}{\mytilde{x}} = P'$$ 
%			Also in this case the proof is standard, using rules~\trule{RcvS}, \trule{Send}, and \trule{Par} 
%			to type $P$, and using Lemma~\ref{lem:subst}(1) and rule~\trule{Par} to type $P'$. 
%			In this case, the session environment $\Delta$ does reduce.
%
%		\item	Case \orule{APass}:
%		Then we have
%		$$
%		P = \bout{k}{\abs{\mytilde{x}}{Q}} P_1 \Par \binp{\dual{k}}{\X} P_2  \red  P_1 \Par P_2 \subst{\abs{\mytilde{x}}{Q}}{\X} = P'
%		$$
%		and we distinguish two cases, associated to the type of the higher-order value $\abs{\tilde{x}}{Q}$.
%		We describe the proof for the case in which the type is $\lhot{\mytilde{C}}$; the proof when 
%		the type is $\shot{\mytilde{C}}$ is analogous.
%		The typing of $P$ proceeds first by using rule~\trule{Send} on the left-hand side:
%		\[
%								\tree{
%					\Gamma;\, \emptyset;\, \Delta_1 \proves  P_1 \hastype \Proc \quad
%					\Gamma ;\, \emptyset ;\, \Delta_2 \proves   \abs{\mytilde{x}}{Q} \hastype \lhot{\mytilde{C}}					}{
%					\Gamma;\, \emptyset;\, \big((\Delta_1 \cat \Delta_2) \setminus \{k:S\}\big) \cat k:\btout{\lhot{\mytilde{C}}} S     \proves  
% 					\bout{k}{\abs{\mytilde{x}}{Q}} P_1 \hastype \Proc} 
%			\]	
%			Then,
%			thanks to the well-typedness assumption for $\Delta$ (cf. Def.~\ref{d:wtenv}), 
%			 on the right-hand side we have the following typing (using rule~\trule{RcvH}  and assuming $S \dualof T$):
%					\[
%					\tree{
%					\Gamma;\, X:\lhot{\mytilde{C}} ;\, \Delta_3 \cat \dual{k}:T \proves  P_2 \hastype \Proc \quad
%					\Gamma ;\, \{X:\lhot{\mytilde{C}} \} ;\, \Delta_4 \proves   X \hastype \lhot{\mytilde{C}}					}{
%					\Gamma;\, \emptyset;\, \Delta_3 \setminus \Delta_4 \cat \dual{k}:\btinp{\lhot{\mytilde{C}}} T     \proves  
% 					\binp{\dual{k}}{X} P_2 \hastype \Proc} 
%			\]	
%			Finally, we use rule~\trule{Par} to obtain the typing for $P$.
%			The typing of $P'$ is obtained by using the appropriate substitution lemma (Lemma~\ref{lem:subst}(3)) on the typing for $P_2$.
%			
%			When the type of the higher-order value is $\shot{\mytilde{C}}$,
%			the use of rules~\trule{Send} and~\trule{RcvH} for typing $P$ is similar; 
%			 one would use Lemma~\ref{lem:subst}(4) to type $P'$. The session environment reduces.

		\item	Case \orule{Sel}:
			The proof is standard, the session environment reduces.

%		\item	Case \orule{Sess}:
%			The proof is standard, exploiting induction hypothesis.
%			The session environment may remain invariant (channel restriction)  or reduce (name restriction).

		\item	Cases \orule{Par} and \orule{Res}:
			The proof is standard, exploiting induction hypothesis. 

		\item	Case \orule{Cong}:
			follows from \thmref{t:srfull}\,(1).
	\end{enumerate}
%	\qed
\end{proof}

