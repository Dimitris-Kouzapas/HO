% !TEX root = main.tex

\noi
We develop a theory for observational equivalence over
session typed \HOp processes that follows the principles
laid in our previous works~\cite{KYHH2015,KY2015}.
We introduce \emph{higher-order bisimulation} (\defref{d:hwb})
and
\emph{characteristic bisimulation} (\defref{d:fwb}), 
denoted $\hwb$ and $\fwb$, respectively.
We prove that
they coincide with reduction-closed,
barbed congruence (\thmref{the:coincidence}, page \pageref{the:coincidence}).

We briefly summarize our strategy for obtaining \thmref{the:coincidence}.
We begin by defining an (early) labelled transition system (LTS) on
untyped processes~(\S\,\ref{ss:lts}). 
Then, using the \emph{environmental} transition semantics (\secref{ss:elts}), 
we define a typed LTS that formalises 
how a typed process interacts with a typed observer. 
Later,  we define 
reduction-closed, barbed congruence and 
context bisimilarity, respectively (\secref{subsec:rc} and~\secref{subsec:bisimulation}). 
Subsequently, 
we define the refined LTS based on characteristic values~(\secref{ss:reflts}).
Building upon this LTS, 
we define
higher-order  and  characteristic bisimilarities  (\secref{ss:hwb}).
Then, we develop an auxiliary  proof technique based on deterministic transitions (\secref{ss:deter}).
Our main result, the 
characterisation of barbed congruence in terms of $\hwb$ and $\fwb$, is stated in~\secref{ss:charact}.
Finally, we revisit our two implementations for the Hotel Booking Scenario (\exref{exam:proc}), 
using  \thmref{the:coincidence}
to show that they are behaviorally equivalent (\secref{ss:examprev}).

\subsection{Labelled Transition System for Processes}
\label{ss:lts}

We define the interaction of processes with their evnviorment using action labels $\ell$:
%
\begin{center}
	\begin{tabular}{l}
		$\ell
			\bnfis  \tau 
						\bnfbar	\news{\widetilde{m}} \bactout{n}{V}
			\bnfbar	\bactinp{n}{V} 
			\bnfbar	\bactsel{n}{l} 
			\bnfbar	\bactbra{n}{l}$
	\end{tabular}
\end{center}
%
\noi 
Label $\tau$ defines internal actions.
Action
$\news{\widetilde{m}} \bactout{n}{V}$
denotes the sending of value $V$
over channel $n$ with a possible empty set of restricted names
$\widetilde{m}$ 
(we may write $\bactout{n}{V}$ when $\widetilde{m}$ is empty).
Dually, the action for value reception is 
$\bactinp{n}{V}$.
Actions for select and branch on
a label~$l$ are denoted $\bactsel{n}{l}$ and $\bactbra{n}{l}$, resp.
We write $\fn{\ell}$ and $\bn{\ell}$ to denote the
sets of free/bound names in $\ell$, resp.
%and set $\mathsf{n}(\ell)=\bn{\ell}\cup \fn{\ell}$. 
Given $\ell \neq \tau$, we write $\subj{\ell}$
to denote the \emph{subject} of $\ell$.
This way, e.g., $\subj{\bactinp{n}{V}} = \subj{\bactbra{n}{l}} = n$.

%%%%%%%%%%%%%%%%%%%% LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
	\begin{mathpar}
		\inferrule[\ltsrule{App}]{
		}{
			\appl{(\abs{x}{P})}{V} \by{\tau} P \subst{V}{x}
		}
		\and
		\inferrule[\ltsrule{Snd}]{
		}{
			\bout{n}{V} P \by{\bactout{n}{V}} P
		}
		\and
		\inferrule[\ltsrule{Rv}]{
		}{
			\binp{n}{x} P \by{\bactinp{n}{V}} P\subst{V}{x}
		}
		\and
		\inferrule[\ltsrule{Sel}]{
		}{
			\bsel{s}{l}{P} \by{\bactsel{s}{l}} P
		}
		\and
		\inferrule[\ltsrule{Bra}]{
		}{
			\bbra{s}{l_i:P_i}_{i \in I} \by{\bactbra{s}{l_j}} P_j \ (j\in I)
		}
		\and
		\inferrule[\ltsrule{Alpha}]{
			P \scong_\alpha Q
			\and
			Q\by{\ell} P'
		}{
			P \by{\ell} P'
		}
		\and
		\inferrule[\ltsrule{Res}]{
			P \by{\ell} P'
			\and
			n \notin \fn{\ell}
		}{
			\news{n} P \by{\ell} \news{n} P'
		}
		\and
		\inferrule[\ltsrule{New}]{
			P \by{\news{\widetilde{m}} \bactout{n}{V}} P'
			\and
			m \in \fn{V}
		}{
			\news{m} P \by{\news{m\cat\widetilde{m}'} \bactout{n}{V}} P'
		}
		\and
		\inferrule[\ltsrule{Par${}_L$}]{
			P \by{\ell} P'
			\and
			\bn{\ell} \cap \fn{Q} = \es
		}{
			P \Par Q \by{\ell} P' \Par Q
		}
		\and
		\inferrule[\ltsrule{Tau}]{
			P \by{\ell_1} P'
			\and
			Q \by{\ell_2} Q'
			\and
			\ell_1 \asymp \ell_2
		}{
			P \Par Q \by{\tau} \newsp{\bn{\ell_1} \cup \bn{\ell_2}}{P' \Par Q'}
		}
		\and
		\inferrule[\ltsrule{Rec}]{
			P\subst{\recp{X}{P}}{\rvar{X}} \by{\ell} P'
		}{
			\recp{X}{P}  \by{\ell} P'
		}
	\end{mathpar}
	%
	\caption{The Untyped LTS for \HOp processes. We omit rule $\ltsrule{Par${}_R$}$.  \label{fig:untyped_LTS}}
	%
\end{figure}

%%%%%%%%%%%%%%%%%%%% End LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\emph{Dual actions}
occur on subjects that are dual between them and carry the same
object; thus, output is dual to input and 
selection is dual to branching.
Formally, duality \jpc{on actions}
is the least symmetric relation $\asymp$ that satisfies:
\[
	\bactsel{n}{l} \asymp \bactbra{\dual{n}}{l}
	\qquad \qquad 
	\news{\widetilde{m}} \bactout{n}{V} \asymp \bactinp{\dual{n}}{V}
\]
The (early) labelled transition system
(LTS) %LTS
over \emph{untyped processes}
is given in
\figref{fig:untyped_LTS}. 
We write $P_1 \by{\ell} P_2$ with the usual meaning.
The rules are standard~\cite{KYHH2015,KY2015}; we comment on some of them.
A process with an output prefix can
interact with the environment with an output action that carries a value
$V$ (rule~$\ltsrule{Snd}$).  Dually, in rule $\ltsrule{Rv}$ a
receiver process can observe an input of an arbitrary value $V$.
Select and branch processes observe the select and branch
actions in rules $\ltsrule{Sel}$ and $\ltsrule{Bra}$, resp.
Rule $\ltsrule{Res}$ closes the LTS under restriction 
if the restricted name does not occur free in the
observable action. 
If a restricted name occurs free in
the carried value of an output action,
the process performs scope opening (rule~$\ltsrule{New}$).  
Rule~$\ltsrule{Rec}$ handles recursion unfolding.
Rule~$\ltsrule{Tau}$ 
states that two parallel processes which perform
dual actions can synchronise by an internal transition.
Rules $\ltsrule{Par${}_L$}$/$\ltsrule{Par${}_R$}$ 
and $\ltsrule{Alpha}$ close the LTS
under parallel composition and $\alpha$-renaming. 

\subsection{Environmental Labelled Transition System}
\label{ss:elts}
We define a typed LTS which results by coupling the untyped LTS given before with a labeled transition relation 
on typing environments. Such a relation, given in \figref{fig:envLTS}, 
is defined on triples of environments by 
extending the LTSs
in \cite{KYHH2015,KY2015}; it is 
denoted
%
\[
	(\Gamma_1, \Lambda_1, \Delta_1) \by{\ell} (\Gamma_2, \Lambda_2, \Delta_2)
\]
%
Notice that  we have 
$
	(\Gamma', \Lambda_1, \Delta_1) \hby{\ell} (\Gamma', \Lambda_2, \Delta_2)
$
if
$
	(\Gamma, \Lambda_1, \Delta_1) \hby{\ell} (\Gamma', \Lambda_2, \Delta_2)
$, 
due to weakening of shared environments.
%
\paragraph{Input Actions} 
are defined by 
rules~$\eltsrule{SRv}$ and $\eltsrule{ShRv}$.
In rule~$\eltsrule{SRv}$
the type of value $V$
and the type of the object associated to the session type on $s$ 
should coincide. 
The resulting type tuple must contain the environments 
associated to $V$. 
The
dual endpoint $\dual{s}$ cannot be
present in the session environment: if it were present
the only possible communication would be the interaction
between the two endpoints (cf. rule~$\eltsrule{Tau}$).
Rule~$\eltsrule{ShRv}$ is for shared names and follows similar principles.

\paragraph{Output Actions} are defined by rules~$\eltsrule{SSnd}$
and $\eltsrule{ShSnd}$.  
Rule $\eltsrule{SSnd}$ states the conditions for observing action
$\news{\widetilde{m}} \bactout{s}{V}$ on a type tuple 
$(\Gamma, \Lambda, \Delta\cdot \AT{s}{S})$. 
The session environment $\Delta$ with $\AT{s}{S}$ 
should include the session environment of the sent value $V$, 
{\em excluding} the session environments of names $m_j$ 
in $\widetilde{m}$ which restrict the scope of value $V$. 
Analogously, the linear variable environment 
$\Lambda'$ of $V$ should be included in $\Lambda$. 
Scope extrusion of session names in $\widetilde{m}$ requires
that the dual endpoints of $\widetilde{m}$ should appear in
the resulting session environment. Similarly for shared 
names in $\widetilde{m}$ that are extruded.  
All free values used for typing $V$ are subtracted from the
resulting type tuple. The prefix of session $s$ is consumed
by the action.
Rule $\eltsrule{ShSnd}$ is for output actions on shared names:
the name must be typed with $\chtype{U}$; conditions on $V$ are identical to those
on rule~$\eltsrule{SSnd}$.

\begin{notation}
Given a $V$ of value type $U$, we sometimes annotate the output action 
$\news{\widetilde{m}} \bactout{n}{V}$
with the type of $V$ 
as $\news{\widetilde{m}} \bactout{n}{\AT{V}{U}}$.
\end{notation}

\paragraph{Other Actions}
Rules $\eltsrule{Sel}$ and $\eltsrule{Bra}$ describe actions for
select and branch.
%Both
%rules require the absence of the dual endpoint from the session
%environment.%, and the presence of the action labels in the type.
Rule $\eltsrule{Tau}$ defines
internal transitions: 
it keeps the session environment unchanged or 
reduces it (\defref{d:wtenvred}).

%%%%%%%%%%%%%%%%%%%% Environment LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
\begin{mathpar}
	\inferrule[\eltsrule{SRv}]{
		\dual{s} \notin \dom{\Delta}
		\and
		\Gamma; \Lambda'; \Delta' \proves V \hastype U
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btinp{U} S) \by{\bactinp{s}{V}} (\Gamma; \Lambda\cat\Lambda'; \Delta\cat\Delta' \cat s: S)
	}
	\and
	\inferrule[\eltsrule{ShRv}]{
		\Gamma; \es; \es \proves a \hastype \chtype{U}
		\and
		\Gamma; \Lambda'; \Delta' \proves V \hastype U
	}{
		(\Gamma; \Lambda; \Delta) \by{\bactinp{a}{{V}}} (\Gamma; \Lambda\cat\Lambda'; \Delta\cat\Delta')
	}
	\and
	\inferrule[\eltsrule{SSnd}]{
		\begin{array}{l}
			\Gamma \cat \Gamma'; \Lambda'; \Delta' \proves V \hastype U
			\and
			\Gamma'; \es; \Delta_j \proves m_j  \hastype U_j
			\and
			\dual{s} \notin \dom{\Delta}
			\\
			\Delta'\backslash \cup_j \Delta_j \subseteq (\Delta \cat s: S)
			\and
			\Gamma'; \es; \Delta_j' \proves \dual{m}_j  \hastype U_j'
			\and
			\Lambda' \subseteq \Lambda
		\end{array}
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btout{U} S)
		\by{\news{\widetilde{m}} \bactout{s}{V}}
		(\Gamma \cat \Gamma'; \Lambda\backslash\Lambda'; (\Delta \cat s: S \cat \cup_j \Delta_j') \backslash \Delta')
	}
	\and
	\inferrule[\eltsrule{ShSnd}]{
		\begin{array}{l}
			\Gamma \cat \Gamma' ; \Lambda'; \Delta' \proves V \hastype U
			\and
			\Gamma'; \es; \Delta_j \proves m_j \hastype U_j
			\and
			\Gamma ; \es ; \es \proves a \hastype \chtype{U}
			\\
			\Delta'\backslash \cup_j \Delta_j \subseteq \Delta
			\and
			\Gamma'; \es; \Delta_j' \proves \dual{m}_j\hastype U_j'
			\and
			\Lambda' \subseteq \Lambda
		\end{array}
	}{
		(\Gamma ; \Lambda; \Delta) \by{\news{\widetilde{m}}
		\bactout{a}{V}}
		(\Gamma \cat \Gamma'; \Lambda\backslash\Lambda'; (\Delta \cat \cup_j \Delta_j') \backslash \Delta')
	}
	\and
	\inferrule[\eltsrule{Sel}]{
		\dual{s} \notin \dom{\Delta}
		\and
		j \in I
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btsel{l_i: S_i}_{i \in I}) \by{\bactsel{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)
	}
	\and
	\inferrule[\eltsrule{Bra}]{
		\dual{s} \notin \dom{\Delta} \quad j \in I
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btbra{l_i: T_i}_{i \in I}) \by{\bactbra{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)
	}
	\and
	\inferrule[\eltsrule{Tau}]{
		\Delta_1 \red \Delta_2 \vee \Delta_1 = \Delta_2
	}{
		(\Gamma; \Lambda; \Delta_1) \by{\tau} (\Gamma; \Lambda; \Delta_2)
	}
\end{mathpar}
%
\caption{Labelled Transition System for Typed Environments. 
\label{fig:envLTS}}
%
\end{figure}


%%%%%%%%%%%%%%%%%%%% End Environment LTS Figure %%%%%%%%%%%%%%%%%%%%%%

\begin{example}
	Consider environment tuple
	$
		(\Gamma;\, \es;\, s: \btout{\lhot{\btout{S} \tinact}} \tinact \cat s': S)
	$
	and typed value
	\[
		\Gamma; \es; s': S \cat m: \btinp{\tinact} \tinact \proves V \, \hastype \, \lhot{\btout{\tinact} \tinact}
	\]
	\noi with
	$
		V= \abs{x} \bout{x}{s'} \binp{m}{z} \inact
	$.
%
%	\noi Let 
%	$
%		\Delta'_1=\set{\overline{m}: \btout{\tinact} \tinact}
%	$
%	and $U=\btout{\lhot{\btout{S} \tinact}} \tinact$.
	Then by $\eltsrule{SSnd}$, we can derive:
%
	\[
		(\Gamma; \es; s: \btout{\lhot{\btout{S} \tinact}} \tinact \cat s': S) \by{\news{m} \bactout{s}{V}} (\Gamma; \es; s: \tinact \cat \dual{m}: \btout{\tinact} \tinact)
	\]
	\qed
\end{example}

\noi
The typed LTS  combines
the LTSs in \figref{fig:untyped_LTS}
and \figref{fig:envLTS}. 

\begin{definition}[Typed Transition System]
	\label{d:tlts}
	A {\em typed transition relation} is a typed relation
	$\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_2}{P_2}$
	where:
%
	\begin{enumerate}
		\item
				$P_1 \by{\ell} P_2$ and 
		\item
				$(\Gamma, \emptyset, \Delta_1) \by{\ell} (\Gamma, \emptyset, \Delta_2)$ 
				with $\Gamma; \emptyset; \Delta_i \proves P_i \hastype \Proc$ ($i=1,2$).
%				\dk{We sometimes annotated the output action with
%				the type of value $V$ as in $\widetilde{m} \bactout{n}{V: U}$.}
	\end{enumerate}
%
	We 
	%extend to $\By{}$ and $\By{\hat{\ell}}$  where we 
	write  $\By{}$ for the reflexive and transitive closure of $\by{}$,
	$\By{\ell}$ for the transitions $\By{}\by{\ell}\By{}$, and $\By{\hat{\ell}}$
	for $\By{\ell}$ if $\ell\not = \tau$ otherwise $\By{}$. 
\end{definition}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    Reduction closed barbed congruence
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Reduction-Closed, Barbed Congruence ($\cong$)}
\label{subsec:rc}

\noi We now define \emph{typed relations} and \emph{contextual equivalence} (i.e., barbed congruence).  
To define typed relations, we first define \emph{confluence}
over session environments $\Delta$:
%
\begin{definition}[Session Environment Confluence]\label{d:conf}
	Two session environments $\Delta_1$ and $\Delta_2$
	are confluent, denoted $\Delta_1 \bistyp \Delta_2$,
	if there exists $\Delta$ such that
	i)~$\Delta_1 \red^\ast \Delta$ and ii~$\Delta_2 \red^\ast \Delta$
	(here we write $\red^\ast$ for the multi-step reduction in \defref{d:wtenvred}).
\end{definition}
Typed relations relate only closed terms whose
session environments are balanced  and confluent:

\begin{definition}[Typed Relation]
	We say that a binary relation over typing judgements
	\[
		\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc\ \Re \ \Gamma; \emptyset; \Delta_2 \proves P_2 \hastype \Proc
	\]
%
	\noi
	is a {\em typed relation} whenever:
	\begin{enumerate}
		\item	$P_1$ and $P_2$ are closed;
		\item	$\Delta_1$ and $\Delta_2$ are balanced (cf. \defref{d:wtenvred}); and
		\item	$\Delta_1 \bistyp \Delta_2$ (cf. \defref{d:conf}).
	\end{enumerate}
	\end{definition}
\begin{notation}
	We write
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{P_2}
	\]
	to denote the typed relation 
		$\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc\ \Re \ \Gamma; \emptyset; \Delta_2 \proves P_2 \hastype \Proc$.
\end{notation}	
%\end{definition}


Next we define  {\em barbs}~\cite{MiSa92}
with respect to types. 

\begin{definition}[Barbs]
	Let $P$ be a closed process. We write
	\begin{enumerate}
		\item
				\begin{enumerate}
					\item	$P \barb{n}$ if $P \scong \newsp{\tilde{m}}{\bout{n}{V} P_2 \Par P_3}$, with $n \notin \tilde{m}$.
					\item	$P \barb{n}$ if $P \scong \newsp{\tilde{m}}{\bsel{n}{l} P_2 \Par P_3}$, with $n \notin \tilde{m}$.
					\item	We write $P \Barb{n}$ if $P \red^* \barb{n}$.
				\end{enumerate}

		\item	Similarly, we write
				\begin{enumerate}
					\item	$\Gamma; \emptyset; \Delta \proves P \barb{n}$ if
							$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ with $P \barb{n}$ and $\dual{n} \notin \Delta$.
					\item	We write $\Gamma; \emptyset; \Delta \proves P \Barb{n}$ if $P \red^* P'$ and
							$\Gamma; \emptyset; \Delta' \proves P' \barb{n}$.
				\end{enumerate}
	\end{enumerate}
\end{definition}

\noi A barb $\barb{n}$ is an observable on an output (resp. select) prefix with subject $n$;
a weak barb $\Barb{n}$ is a barb after zero or more reduction steps.
Typed barbs $\barb{n}$ (resp.\ $\Barb{n}$)
are observed  on typed processes $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
When $n$ is a session name we require that its dual endpoint $\dual{n}$ is not
present in the session environment $\Delta$.

To define a congruence relation, we introduce the family $\C$ of contexts:

\begin{definition}[Context]
	Context $\C$ is defined over the syntax:
%
	\begin{eqnarray*}
		\C & ::= & \hole \bnfbar \bout{u}{V} \C \bnfbar \binp{u}{x} \C \bnfbar \bout{u}{\lambda x.\C} P \bnfbar \news{n} \C
		(\lambda x.\C)u \bnfbar \recp{X}{\C}\\ 
		& \bnfbar & \C \Par P \bnfbar P \Par \C \bnfbar \bsel{u}{l} \C \bnfbar \bbra{u}{l_1:P_1,\cdots,l_i:\C,\cdots,l_n:P_n}
	\end{eqnarray*}
%
	Notation $\context{\C}{P}$ denotes the result of substituting 
	the hole $\hole$ in $\C$ with process $P$.
\end{definition}

\noi The first behavioural relation we define is reduction-closed, barbed congruence \cite{HondaKYoshida95}. 

\begin{definition}[Reduction-Closed, Barbed Congruence]
\label{def:rc}
	Typed relation
	\[
		\horel{\Gamma}{\Delta_1}{P}{\ \Re\ }{\Delta_2}{Q}
	\]
	is a {\em reduction-closed, barbed congruence} whenever:
%
	\begin{enumerate}[1)]
		\item
				\begin{enumerate}
					\item	If $P \red P'$ then there exist $Q', \Delta_2'$ such that $Q \red^* Q'$ and\\
							$\horel{\Gamma}{\Delta_1'}{P'}{\ \Re\ }{\Delta_2'}{Q'}$;
					\item	and the symmetric case;
				\end{enumerate}
		\item
				\begin{enumerate}
					\item	If $\Gamma;\Delta_1 \proves P \barb{n}$ then $\Gamma;\Delta_2 \proves Q \Barb{n}$;
					\item	and the symmetric case;
				\end{enumerate}

		\item	For all $\C$, there exist $\Delta_1'',\Delta_2''$ such that
				$\horel{\Gamma}{\Delta_1''}{\context{\C}{P}}{\ \Re\ }{\Delta_2''}{\context{\C}{Q}}$; 
	\end{enumerate}
	The largest such relation is denoted with $\cong$.
\end{definition}

\subsection{Context Bisimilarity ($\wbc$)}
\label{subsec:bisimulation}

Following Sangiorgi~\cite{San96H}, 
we now define the standard (weak) context bisimilarity. 
%
\begin{definition}[Context Bisimilarity]
	\label{def:wbc}
	A typed relation $\Re$ is {\em a context bisimulation} if
	for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$,
%
	\begin{enumerate}[1)] 
		\item
				Whenever 
				$\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}$,
				there exist $Q_2$, $V_2$, $\Delta'_2$
				such that $\horel{\Gamma}{\Delta_2}{Q_1}{\By{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}$ and 
				for all $R$ with $\fv{R}=x$:
%
			\[
				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par R\subst{V_1}{x}}}
				{\ \Re\ }
				{\Delta_2''}{\newsp{\widetilde{m_2}}{Q_2 \Par R\subst{V_2}{x}}};
			\]

		\item	
				For all $\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_2}$ such that 
				$\ell$ is not an output, there exist $Q_2$, $\Delta'_2$ such that 
				$\horel{\Gamma}{\Delta_2}{Q_1}{\By{\hat{\ell}}}{\Delta_2'}{Q_2}$
				and
				$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and  

		\item
				The symmetric cases of 1 and 2.                
	\end{enumerate}
%
	The largest such bisimulation is called \emph{context bisimilarity} and is denoted by $\wbc$.
\end{definition}

\noi As hinted at in
%\secref{subsec:intro:bisimulation}, 
\secref{sec:overview}, in the general case,
context bisimilarity is hard to compute.
Below we introduce \emph{higher-order bisimulation} and \emph{characteristic bisimulation},
which are meant to offer a \emph{tractable} proof technique over session typed
processes with higher-order communication.
%$\hwb$ and  $\fwb$.
%due to: (1) the universal
%quantification over contexts in the output case;
%and (2) a higher-order input prefix which can observe
%infinitely many different input actions (since
%infinitely many different processes can match
%the session type of an input prefix).

\subsection{Characteristic Values and the Refined LTS}
\label{ss:reflts}

\noi 
We formalise the ideas given in \secref{sec:overview}, concerning 
characteristic processes/values and the refined LTS.
%the introduction.
We first define characteristic processes/values:

\begin{definition}[Characteristic Process and Values]
	\label{def:char}
	Let $u$ and $U$ be a name and a type, respectively.
	\figref{fig:char} defines the {\em characteristic process} 
	$\mapchar{U}{u}$ and the {\em characteristic value} $\omapchar{U}$.
\end{definition}

%%%%%%%%%%%%%%%%%%%%%%%% Characteristic Process Figure %%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
\[
	\begin{array}{rclcrcl}
		\mapchar{\btinp{U} S}{u}
		&\defeq&
		\binp{u}{x} (\mapchar{S}{u} \Par \mapchar{U}{x})
		&\qquad &
		\omapchar{S}  & \defeq &  s ~~ (s \textrm{ fresh})
		\\
		\mapchar{\btout{U} S}{u}
		&\defeq&
		\bout{u}{\omapchar{U}} \mapchar{S}{u}  
		&&
		\omapchar{\chtype{S}} \defeq \omapchar{\chtype{L}} &\defeq&a ~~ (a \textrm{ fresh})
		\\
		\mapchar{\btsel{l : S}}{u}
		& \defeq &
		\bsel{u}{l} \mapchar{S}{u}
		&&
		\omapchar{\shot{U}} \defeq \omapchar{\lhot{U}} & \defeq &  \abs{x}{\mapchar{U}{x}}
		\\
				\mapchar{\btbra{l_i: S_i}_{i \in I}}{u}
		& \defeq &
		\bbra{u}{l_i: \mapchar{S_i}{u}}_{i \in I}
		&&
		 
		&   &
		 
		\\
		\mapchar{\tvar{t}}{u}
		&\defeq&
		\varp{X}_{\vart{t}}
		& & 
		 
		& &
		 
		\\
		\mapchar{\trec{t}{S}}{u}
		&\defeq&
		\recp{X_{\vart{t}}}{\mapchar{S}{u}}
		&&
		 
		& &
		 
		\\
		\mapchar{\tinact}{u}
		& \defeq &
		\inact
		& & 
		  
		& &
		 
		\\
		\mapchar{\chtype{S}}{u} 
		&\defeq&
		\bout{u}{\omapchar{S}} \inact
		& & 	
					 
		&   &
		 
		\\
		\mapchar{\chtype{L}}{u}
		&\defeq&
		 
		&&
		 
		& &
 
		\\
		\mapchar{\shot{U}}{u}
		\defeq 
		\mapchar{\lhot{U}}{u}
		&\defeq &
		\appl{u}{\omapchar{U}}
		&&
		 
		& &
		 	\end{array}
	\]
%\[
%	\begin{array}{rclcrcl}
%		\mapchar{\btinp{U} S}{u}
%		&\defeq&
%		\binp{u}{x} (\mapchar{S}{u} \Par \mapchar{U}{x})
%		&&
%		\mapchar{\btout{U} S}{u}
%		&\defeq&
%		\bout{u}{\omapchar{U}} \mapchar{S}{u} %& & n \textrm{ fresh}
%		\\
%
%		\mapchar{\btsel{l : S}}{u}
%		& \defeq &
%		\bsel{u}{l} \mapchar{S}{u}
%		&&
%		\mapchar{\btbra{l_i: S_i}_{i \in I}}{u}
%		& \defeq &
%		\bbra{u}{l_i: \mapchar{S_i}{u}}_{i \in I}
%		\\
%
%		\mapchar{\tvar{t}}{u}
%		&\defeq&
%		\varp{X}_{\vart{t}}
%		& & 
%		\mapchar{\trec{t}{S}}{u}
%		&\defeq&
%		\recp{X_{\vart{t}}}{\mapchar{S}{u}}
%		\\
%
%		\mapchar{\tinact}{u}
%		& \defeq &
%		\inact
%		& & 
%		\mapchar{\chtype{S}}{u} 
%		&\defeq&
%		\bout{u}{\omapchar{S}} \inact
%		\\
%
%		\mapchar{\chtype{L}}{u}
%		&\defeq&
%		\bout{u}{\omapchar{L}} \inact
%		&&
%		\mapchar{\shot{U}}{u}
%		&\defeq &
%		\mapchar{\lhot{U}}{u}
%		\, \defeq \,
%		\appl{u}{\omapchar{U}}
%	\end{array}
%	\]
%	\[
%	\begin{array}{c}
%		\omapchar{S}  \defeq  s ~~ (s \textrm{ fresh})
%		\qquad
%		\omapchar{\chtype{S}} \defeq \omapchar{\chtype{L}} \defeq a ~~ (a \textrm{ fresh})
%		\qquad
%		\omapchar{\shot{U}} \defeq \omapchar{\lhot{U}} \,\defeq\, \abs{x}{\mapchar{U}{x}}
%	\end{array}
%	\]
%
\caption{Characteristic Processes (left) and Characteristic Values (right).\label{fig:char}}
%
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%% End Characteristic Process Figure %%%%%%%%%%%%%%%%%%%%%


\noi We can verify that characteristic processes/values  
do inhabit their associated type.

\begin{proposition}[Characteristic Processes/Values Inhabit Their Types]
	\begin{enumerate}
		\item	
				Let $S$ be a session type.
				Then $\Gamma; \es; \Delta \cat s: S \proves \mapchar{S}{s} \hastype \Proc$.
		\item	
				Let $U$ be a channel type.
				Then $\Gamma \cat a: U; \es; \Delta \proves \mapchar{U}{a} \hastype \Proc$.

		\item	Let $U$ be a type.
				Then $\Gamma; \es; \Delta \proves \omapchar{U} \hastype U$
	\end{enumerate}
\end{proposition}

\begin{proof}[Sketch]
	By induction on the definition of $\mapchar{S}{u}$
	and $\mapchar{U}{u}$. 
	\qed
\end{proof}

The following example motivates the refined 
LTS explained in \secref{sec:overview}.
%the introduction.


%\begin{example}
%	Consider the type $U = \shot{(\shot{(\shot{(\btout{S} \tinact)})})}$.
%	It is easy to verify that %the characteristic process %of the above type is:
%	$\mapchar{\btinp{U} \inact}{s} = \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{n})}}$, for some fresh $n$.
%%%
%%	\begin{eqnarray*}
%%		\mapchar{\btinp{U} \inact}{s} = && \binp{s}{x} \mapchar{\shot{(\shot{(\shot{(\btout{S} \tinact)})})}}{x}\\
%%		= && \binp{s}{x} \appl{x}{\omapchar{\shot{(\shot{(\btout{S} \tinact)})}}}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\mapchar{\shot{(\btout{S} \tinact)}}{y}})}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{\omapchar{\btout{S} \tinact}})}}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{n})}}\\
%%	\end{eqnarray*}
%%%
%	\qed
%\end{example}


\begin{example}[The Need for Refined Typed LTS]
	\label{ex:motivation}
	We show that observing a characteristic value
	input alone is not enough
	to define a sound bisimulation closure.
	Consider   processes % $P_1, P_2$:
%
	\begin{eqnarray}
		P_1 = \binp{s}{x} (\appl{x}{s_1} \Par \appl{x}{s_2}) 
		&\qquad \qquad& 
		P_2 = \binp{s}{x} (\appl{x}{s_1} \Par \binp{s_2}{y} \inact) 
		\label{equ:6}
	\end{eqnarray}
%
	where $\Delta = s_1: \btinp{C} \tinact \cat s_2: \btinp{C} \tinact$ and:
%
	\[
		\Gamma; \es; \Delta \cat s: \btinp{\shot{(\btinp{C} \tinact)}} \tinact \proves P_i \hastype \Proc \qquad (i \in \set{1,2})
	\]
%
	If $P_1$ and $P_2$ input 
	the characteristic value $\omapchar{\shot{(\btinp{C} \tinact)}} = \abs{x}{\binp{x}{y} \inact}$, 
	and substitute over $x$ then they both evolve into:
%
	\[
		\Gamma; \es; \Delta \proves \binp{s_1}{y} \inact \Par \binp{s_2}{y} \inact \hastype \Proc
	\]
%
	\noi therefore becoming context bisimilar.
	However, the processes in (\ref{equ:6}) 
	are clearly {\em not} context bisimilar: many input actions
	may be used to distinguish them.
	For example, if  $P_1$ and $P_2$ input
%
	$\abs{x} \newsp{s'}{\bout{a}{s'} \binp{x}{y} \inact}$
%
	with
%
	$\Gamma; \es; \es \proves a \hastype \chtype{\tinact}$,
%
	then their derivatives are not bisimilar:
%
\[
	\begin{array}{rcll}
		\Gamma; \es; \Delta &\proves& P_1 \by{\bactinp{s}{\abs{x} \newsp{s'}{\bout{a}{s'} \binp{x}{y} \inact}}} \red \red\\
		\Delta &\proves& \newsp{s'}{\bout{a}{s'} \binp{s_1}{y} \inact} \Par \newsp{s'}{\bout{a}{s'} \binp{s_2}{y} \inact}
		\\[4mm]
		\Gamma; \es; \Delta &\proves& P_2 \by{\bactinp{s}{\abs{x} \newsp{s'}{\bout{a}{s'} \binp{x}{y} \inact}}} \red\\
		\Delta &\proves& \newsp{s'}{\bout{a}{s'} \binp{s_1}{y} \inact} \Par \binp{s_2}{y} \inact
	\end{array}
\]

	Observing only the characteristic value 
	results in an under-discriminating bisimulation.
	However, if a trigger value
	$\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}$ 
	is received on $s$, 
	we can distinguish $P_1$, $P_2$ in~\eqref{equ:6}:  
	%
	\begin{eqnarray*}
		\Gamma; \es; \Delta \proves
		P_1 &\By{\bactinp{s}{\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}}}& \Delta \proves \binp{t}{x} (\appl{x}{s_1}) \Par \binp{t}{x} (\appl{x}{s_2})
%		\hastype \Proc
		\qquad \mbox{and}\\
		\Gamma; \es; \Delta \proves
		P_2 &\By{\bactinp{s}{\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}}}& \Delta \proves \binp{t}{x} (\appl{x}{s_1}) \Par \binp{s_2}{y} \inact 
%		\hastype \Proc
	\end{eqnarray*}
%
	One question is whether the trigger value is enough
	to distinguish two processes (hence no need of characteristic values). % as the input. 
	This is not the case: the trigger value
	alone also results in an under-discriminating bisimulation relation.
	In fact, the  trigger value can be observed on any input prefix
	of {\em any type}. For example, consider processes:
%
	\begin{eqnarray}
%		\Gamma; \es; \Delta \proves 
		\newsp{s}{\binp{n}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_1} \inact} 
%		\hastype \Proc
		\label{equ:7}
		\\
%		\qquad \mbox{and} \qquad
%		\Gamma; \es; \Delta \proves 
		\newsp{s}{\binp{n}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_2} \inact} 
%		\hastype \Proc
		\label{equ:8}
	\end{eqnarray}
%
	\noi If processes in \eqref{equ:7}/\eqref{equ:8}
	input the trigger value, we obtain:
%
	\begin{eqnarray*}
%		\Gamma; \es; \Delta \proves 
		\newsp{s}{\binp{t}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_1} \inact} 
%		\hastype \Proc
%		\qquad \mbox{ and } \qquad
		\\
%		\Gamma; \es; \Delta \proves 
		\newsp{s}{\binp{t}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_2} \inact}
%		\hastype \Proc
	\end{eqnarray*}

	\noi thus we can easily derive a bisimulation closure if we 
	assume a bisimulation definition that allows only trigger value input.
%
%	\noi It is easy to obtain a closure if allow only the
%	trigger value as the input value. 
	But if processes in \eqref{equ:7}/\eqref{equ:8}
	input the characteristic value $\abs{z}{\binp{z}{x} (\appl{x}{m})}$,  
	then they would become, under appropriate $\Gamma$ and $\Delta$:
%
	\begin{eqnarray*}
		\Gamma; \es; \Delta \proves \newsp{s}{\binp{s}{x} (\appl{x}{m}) \Par \bout{\dual{s}}{\abs{x} R_i} \inact}\ \wbc\ \Delta \proves R_i \subst{m}{x}
	\qquad (i=1,2)
%	\\
%	\Gamma; \es; \Delta \proves \newsp{s}{\binp{s}{x} (\appl{x}{m}) \Par \bout{\dual{s}}{\abs{x} Q} \inact} \wbc \Delta \proves Q \subst{m}{x}
	\end{eqnarray*}
%
	\noi which are not bisimilar if $R_1 \subst{m}{x} \not\wbc R_2 \subst{m}{x}$.
	%\qed
	
	In conclusion, these examples explain a need of both 
	trigger and characteristic values 
	as an input observation in the input transition relation (\eltsrule{RRcv})
	which will be defined in Definition~\ref{def:rlts}.
	\qed
\end{example}

\noi As explained in \secref{sec:overview}, 
%the introduction,
we define the
\emph{refined} typed LTS
by considering a transition rule for input in which admitted values are
trigger or characteristic values or names:

%\dk{(assume extension of the structural
%congruence to acommodate values: i) $\abs{x}{P} \scong \abs{x}{Q}$ if
%$P \scong Q$) and ii) $n \scong m$ if $n = n$)}: 

\begin{definition}[Refined Typed Labelled Transition Relation]
	\label{def:rlts}
	We define the environment transition rule for input actions 
	using the input rules in \figref{fig:envLTS}:
	\begin{mathpar}
		\inferrule[\eltsrule{RRcv}]{
			(\Gamma_1; \Lambda_1; \Delta_1) \by{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
			\and
			V = m 
			\vee  V \scong \omapchar{U}
			\vee V  \scong \abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}
			\textrm{ {\small with $t$ fresh}} 
		}{
			(\Gamma_1; \Lambda_1; \Delta_1) \hby{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
		}
	\end{mathpar}
	\noi Rule $\eltsrule{RRcv}$ is defined on top
	of rules $\eltsrule{SRv}$ and $\eltsrule{ShRv}$
	in \figref{fig:envLTS}.
	We  use the non-input rules in \figref{fig:envLTS}
	together with rule $\eltsrule{RRcv}$
	to define 
	$$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_2}{P_2}$$
	as in \defref{d:tlts}.
\end{definition}
 Notice that
the (refined) transition
$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_2}{P_2}$  implies  
the (ordinary) transition
$\horel{\Gamma}{\Delta_1}{P_1}{\by{\,\ell\,}}{\Delta_2}{P_2}$.
\begin{notation} 
Below we sometimes write  
$\hby{\news{\widetilde{m}} \bactout{n}{\AT{V}{U}}}$
when the type of $V$ is~$U$.
\end{notation}
%See \exref{ex:motivation} for the reason why {\em both} 
%the trigger values ($\lambda x.\binp{t}{y} (\appl{y}{{x}})$) 
%and characteristic values ($\lambda x.\map{U}^{{x}}$) are required 
%to define the following two bisimulations. 


\subsection{Higher-Order ($\hwb$) and  Characteristic  Bisimilarity ($\fwb$)}
\label{ss:hwb}

We define \emph{higher-order bisimularity} and 
\emph{characteristic bisimilarity} which are
two tractable bisimilarity relations on $\HOp$ processes.
As explained in \secref{sec:overview},
the two bisimulations 
use two different trigger processes (cf.~\eqref{eq:4}):
%
\begin{eqnarray}
	\htrigger{t}{V}	& \defeq &	\hotrigger{t}{x}{s}{V}						\label{eqb:0} \\
	\ftrigger{t}{V}{U}	& \defeq &	\fotrigger{t}{x}{s}{\btinp{U} \tinact}{V}	\label{eqb:4}
\end{eqnarray}
%
The process in \eqref{eqb:0} is called \emph{higher-order trigger process},
while process in \eqref{eqb:4} is called \emph{characteristic trigger process}.
Notice that while 
in \eqref{eqb:0} there is a higher-order input on $t$, 
in \eqref{eqb:4} variable $x$ does not play any role.

We use higher-order trigger processes to define \emph{higher-order bisimilarity}:

\begin{definition}[Higher-Order Bisimilarity]
	\label{d:hwb}
	A typed relation $\Re$ is a {\em  HO bisimulation} if 
	for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$ 
%
	\begin{enumerate}[1)]
		\item 
				Whenever 
				$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}$, there exist 
				$Q_2$, $V_2$, $\Delta'_2$ such that 
				$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}$ and, for fresh $t$, 
				\[
					\begin{array}{lrlll}
						\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
						\ \Re\ 
						\Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
					\end{array}
				\]
		\item	
				For all $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$ such that 
				$\ell$ is not an output, 
				there exist $Q_2$, $\Delta'_2$ such that 
				$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}$
				and
				$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and 

		\item	The symmetric cases of 1 and 2.                
	\end{enumerate}
%
	The largest such bisimulation is called \emph{higher-order bisimilarity}, denoted by $\hwb$.
\end{definition}


We use characteristic trigger processes to define \emph{characteristic bisimilarity}: 

\begin{definition}[Characteristic Bisimilarity]
\label{d:fwb}
	A typed relation $\Re$ is a {\em  characteristic bisimulation} if 
	for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$, 
%
	\begin{enumerate}[1)]
		\item 
				Whenever 
				$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{\dk{V_1: U}}}}{\Delta_1'}{P_2}$ 
				then there exist 
				$Q_2$, $V_2$, $\Delta'_2$ such that 
				$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}}\bactout{n}{\dk{V_2: U}}}}{\Delta_2'}{Q_2}$
				and, for fresh $t$,
%
				\[
					\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par \ftrigger{t}{V_1}{U_1}}}
	 				\ \Re\ 
					\Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \ftrigger{t}{V_2}{U_2}}}
				\]

		\item	
				For all $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$ such that 
				$\ell$ is not an output, there exist $Q_2$, $\Delta'_2$ such that 
				$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}$
				and
				$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and 

		\item	The symmetric cases of 1 and 2.                
	\end{enumerate}
%
	The largest such bisimulation is called \emph{characteristic bisimilarity}, denoted by $\fwb$.
\end{definition}


\subsection{Deterministic Transitions and Up-to Techniques}
\label{ss:deter}

As hinted at earlier, internal transitions associated to session interactions or  
$\beta$-reductions are deterministic.  We define an auxiliary proof technique that exploits this determinacy.
		
\begin{definition}[Deterministic Transitions]
\label{def:dettrans}
	Let  $\Gamma; \es; \Delta \proves P \hastype \Proc$ be a balanced \HOp process. 
	Transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is called:
%
	\begin{enumerate}[$-$]
		\item 
				a {\em \sesstran} whenever the   transition $P \by{\tau} P'$ 
				is derived using rule~$\ltsrule{Tau}$ 
				(where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise are dual endpoints), 
				possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/
				\ltsrule{Par${}_R$}$.

	%	We write $\horel{\Gamma}{\Delta}{P}{\hby{\stau}}{\Delta'}{P'}$ to denote a \sesstran.
		
		\item
				a {\em \betatran} whenever the transition $P \by{\tau} P'$
				is derived using rule $\ltsrule{App}$,
				possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/
				\ltsrule{Par${}_R$}$.

		%		We write $\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$ to denote a $\beta$-transition.

%		\item	Also, $\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ denotes				either a \sesstran or a \betatran.
	\end{enumerate}
%
%	We write $\Hby{\dtau}$ to denote a (possibly empty) sequence of deterministic steps $\hby{\dtau}$.
\end{definition}

\begin{notation} We use the following notations:
	\begin{enumerate}[$-$]
		\item 	 $\horel{\Gamma}{\Delta}{P}{\hby{\stau}}{\Delta'}{P'}$  denotes a \sesstran.
		
		\item  $\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$   denotes a $\beta$-transition.

		\item	 $\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$   denotes
				either a \sesstran or a \betatran.
\item  We write $\Hby{\dtau}$ to denote a (possibly empty) sequence of deterministic steps $\hby{\dtau}$.
	\end{enumerate}
\end{notation}


Deterministic transitions imply the $\tau$-inertness property~\cite{DBLP:journals/tcs/GrooteS96}, which
ensures behavioural invariance on deterministic transitions.

\begin{proposition}[$\tau$-inertness]
	\label{lem:tau_inert}
	Let  $\Gamma; \es; \Delta \proves P \hastype \Proc$ be a balanced \HOp process.
	Then
	\begin{enumerate}
		\item	
				$\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ implies
				$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
		\item	$\horel{\Gamma}{\Delta}{P}{\Hby{\dtau}}{\Delta'}{P'}$ implies
				$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
	\end{enumerate}
\end{proposition}
%
\begin{proof}[Sketch]
	The proof for Part 1 requires a case analysis on the structure of
	\betatran and session-transition. The proof for Part 2 is direct from Part 1.
	See \appref{app:sub_tau_inert} (\mypageref{app:sub_tau_inert}) for the full details of the proof.
	\qed
\end{proof}


Using the above determinacy properties, we can state the following up-to technique.
%We write $\Hby{\dtau}$ to denote a (possibly empty) sequence of deterministic steps $\hby{\dtau}$.

\begin{lemma}[Up-to Deterministic Transition]
	\label{lem:up_to_deterministic_transition}
	Let $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{Q_1}$ such
	that if whenever:
%
	\begin{enumerate}[1.]
		\item	$\forall \news{\tilde{m_1}} \bactout{n}{V_1}$ such that
			$
				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}} \bactout{n}{V_1}}}{\Delta_3}{P_3}
			$
			implies that $\exists Q_2, V_2$ such that
			$
				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\tilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}
			$
			and
			$
				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
			$
			and for fresh $t$:\\
			\[
				\horel{\Gamma}{\Delta_1''}{\newsp{\tilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
				{\ \Re\ }
				{\Delta_2''}{}{\newsp{\tilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
			\]
%
		\item	$\forall \ell \not= \news{\tilde{m}} \bactout{n}{V}$ such that
			$
				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_3}{P_3}
			$
			implies that $\exists Q_2$  \\ such that 
			$
				\horel{\Gamma}{\Delta_1}{Q_1}{\hat{\Hby{\ell}}}{\Delta_2'}{Q_2}
			$
			and
			$
				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
			$
			and
			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re\ }{\Delta_2'}{Q_2}$.

		\item	The symmetric cases of 1 and 2.
	\end{enumerate}
	Then $\Re\ \subseteq\ \hwb$.
\end{lemma}

\begin{proof}[Sketch]
	The proof is easy by considering the closure
	\[
		\Re^{\Hby{\dtau}} = \set{ \horel{\Gamma}{\Delta_1'}{P_2}{,}{\Delta_2'}{Q_1} \setbar \horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2'}{Q_1},
		\horel{\Gamma}{\Delta_1}{P_1}{\Hby{\dtau}}{\Delta_1'}{P_2} }
	\]
	We verify that $\Re^{\Hby{\dtau}}$ is a bisimulation with
	the use of \propref{lem:tau_inert}.
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Characterisation of rc bp congruence
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Characterisation of Higher-order and Characteristic Bisimilarities}
\label{ss:charact}

This section proves the main result; %typed bisimilarities collapse for \HOp processes. 
it allows us to use $\hwb$ and $\fwb$ as tractable reasoning
techniques for higher-order processes with sessions.


\begin{lemma}
	\label{lem:wb_eq_wbf}
	$\fwb\ =\ \hwb$.
\end{lemma}

\begin{proof}[Sketch]
	The key point is to show that
	characteristic trigger processes
	$\ftrigger{t}{V}{U}$
	and
	higher-order trigger processes
	$\htrigger{t}{V}$
	exhibit similar behaviour.
Indeed, while for the former we have
	\begin{eqnarray*}
		\fotrigger{t}{x}{s}{\btinp{U} \tinact}{V} &\hby{\bactinp{t}{s'}}& \newsp{s}{ \binp{s}{y} \mapchar{U}{y}  \Par \bout{\dual{s}}{V} \inact}
			\end{eqnarray*}
		for the latter we have:
	\begin{eqnarray*}
		\hotrigger{t}{x}{s}{V} &\hby{\bactinp{t}{\omapchar{\btinp{U} \tinact}}}& \newsp{s}{ \appl{(\abs{x}{\binp{x}{y} \mapchar{U}{y}})}{s}  \Par \bout{\dual{s}}{V} \inact}\\
		&\by{\tau}& \newsp{s}{ \binp{s}{y} \mapchar{U}{y}  \Par \bout{\dual{s}}{V} \inact}
	\end{eqnarray*}
%
	Using the above information we can show that the closures of
	$\hwb$ and $\fwb$ coincide.
	The full proof is found in 
	in \appref{app:sub_coinc}, \lemref{app:lem:wb_eq_wbf} (\mypageref{app:lem:wb_eq_wbf}).
	\qed
\end{proof}

%\begin{lemma}[Linear Process Substitution]
%	\label{lem:subst_equiv}
%	If 
%%
%	\begin{enumerate}
%		\item	$\fpv{P_2} = \fpv{Q_2} = \set{x}$.
%		\item	$\Gamma; x: U; \Delta_1''' \proves P_2 \hastype \Proc$ and $\Gamma; x: U; \Delta_2''' \proves Q_2 \hastype \Proc$.
%		\item	$\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1 \Par P_2 \subst{\auxtr{t}}{x}}}
%			{\wb}
%			{\Delta_2'}{\newsp{\widetilde{m_2}}{Q_1 \Par Q_2 \subst{\auxtr{t}}{x}}}$, 
%			for some fresh $t$.
%
%		\item	$\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_1 \Par P_2 \subst{\omapchar{U}}{x}}}
%			{\wb}{\Delta_2''}{\newsp{\widetilde{m_2}}{Q_1 \Par Q_2 \subst{\omapchar{U}}{x}}}$,
%			for some $U$.
%	\end{enumerate}
%%
%	then $\forall R$ such that $\fv{R} = \widetilde{x}$
%\[
%	\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \Par P_2 \subst{\abs{\widetilde{x}}{R}}{x}}}
%	{\wb}
%	{\Delta_2}{\newsp{\widetilde{m_2}}{Q_1 \Par Q_2 \subst{\abs{\widetilde{x}}{R}}{x}}}
%\]
%\end{lemma}
%
%\begin{proof}[Sketch]
%	\qed
%\end{proof}

The next lemma is crucial for the characterisation of
higher-order and characteristic bisimilarities.
It states that if two processes are equivalent under the
trigger value and the characteristic value substitution then
they are equivalent under any higher-order substitution.

\begin{lemma}[Process Substitution]
	\label{lem:proc_subst}
	Let $P$ and $Q$ be two processes. If 
%
	\begin{enumerate}
		\item	$\horel{\Gamma}{\Delta_1'}{P \subst{\auxtr{t}}{x}}{\hwb}{\Delta_2}{Q \subst{\auxtr{t}}{x}}$,
			for some fresh $t$.

		\item	$\horel{\Gamma}{\Delta_1''}{P \subst{\omapchar{U}}{x}}{\hwb}{\Delta_2''}{Q \subst{\omapchar{U}}{x}}$,
				for some $U$.
	\end{enumerate}
%
	then $\forall R$ such that $\fv{R} = \widetilde{x}$
	\[
		\horel{\Gamma}{\Delta_1}{P \subst{\abs{\widetilde{x}}{R}}{x}}{\hwb}{\Delta_2}{Q \subst{\abs{\widetilde{x}}{R}}{x}}
	\]
\end{lemma}

\begin{proof}[Sketch]
	The proof considers first a substitution of the linear
	case (see \lemref{app:lem:subst_equiv} in \appref{app:sub_coinc});
	The result is proved by constructing a closure on the above
	substitution properties and proving that it is a
	higher-order bisimulation, up-to \betatran (\lemref{lem:up_to_deterministic_transition}).
	The full proof is found in \appref{app:sub_coinc}, 
	\lemref{app:lem:proc_subst} (\mypageref{app:lem:proc_subst}).
	\qed
\end{proof}

We now show that higher-order bisimilarity is sound with respect to contextual bisimilarity:

\begin{lemma}
	\label{lem:wb_is_wbc}
	$\hwb\ \subseteq\ \wbc$.
\end{lemma}

\begin{proof}[Sketch]
	The proof relies on \lemref{lem:proc_subst} to prove that:
	\begin{enumerate}
		\item	Whenever two processes are higher-order bisimilar
				under the input of
				a characteristic value and a trigger value
				then they are higher-order bisimilar under the
				input of any value $\abs{x}{R}$, which is the
				requirement for context bisimilarity (cf.~\defref{def:wbc}).

		\item	The input requirement is then further used
				to prove that the output clause for $\hwb$ (cf.~\defref{d:hwb}).
				implies the output clause of $\wbc$,
				i.e.~the output clause requirement for $\hwb$:
				\[
					\begin{array}{lrlll}
						\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
						\ \Re\ 
						\Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
					\end{array}
				\]
			%
				implies the output clause requirement for $\wbc$ that,
				for all $R$ with $\fv{R}=x$:
				\[
					\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par R\subst{V_1}{x}}}
					{\ \Re\ }
					{\Delta_2''}{\newsp{\widetilde{m_2}}{Q_2 \Par R\subst{V_2}{x}}};
				\]
	\end{enumerate}
%
	The full proof is found  in \appref{app:sub_coinc}, 
	\lemref{app:lem:wb_is_wbc} (\mypageref{app:lem:wb_is_wbc}).
	\qed
\end{proof}

Context bisimilarity is included in barbed congruence:
\begin{lemma}
	\label{lem:wbc_is_cong}
	$\wbc \subseteq \cong$.
\end{lemma}

\begin{proof}[Sketch]
	We show that $\wbc$ satisfies the defining
	properties of $\cong$.
	It is easy to show that $\wbc$ is reduction-closed
	and barb preserving (cf. \defref{d:conf}).
		The challenging part is
	to show that $\wbc$ is a congruence; the most challenging
	case is parallel congruence.
	To this end, we construct the following closure:
%	a parallel congruence closure:
%
	\begin{eqnarray*}
		\mathcal{S} &=&	\set{
				(\Gamma; \emptyset; \Delta_1 \cat \Delta_3 \proves \newsp{\widetilde{n_1}}{P_1 \Par R} %\hastype \Proc
				\ ,\ 
				\Gamma; \emptyset; \Delta_2 \cat \Delta_3 \proves \newsp{\widetilde{n_2}}{P_2 \Par R})
				\setbar \\
		& &		\quad \horel{\Gamma}{\Delta_1}{P_1}{\wbc}{\Delta_2}{P_2} \quad \mbox{and} \quad
				\forall R \mbox{ such that }\Gamma; \emptyset; \Delta_3 \proves R \hastype \Proc}
	\end{eqnarray*}
%
	We show that $\mathcal{S}$ is a context bisimulation
	by  a case analysis on the transitions of the pairs in $\mathcal{S}$.
	The full proof is found  in \appref{app:sub_coinc}, 
	\lemref{app:lem:wbc_is_cong} (\mypageref{app:lem:wbc_is_cong}).
	\qed
\end{proof}

The last ingredient required is the following inclusion.

\begin{lemma}
	\label{lem:cong_is_wb}
	$\cong \subseteq \hwb$.
\end{lemma}

\begin{proof}[Sketch]	
	We prove the above result by exploiting
the \emph{definability} technique developed in~\cite[\S6.7]{Hennessy07} and
refined for session types in~\cite{KYHH2015,KY2015}.
Intuitively, this technique exploits small test processes which
reveal the presence of a visible action by reducing with a given pair of processes
and exhibiting a barb on a fresh name.
More precisely, given a fresh name $\suc$, and for each visible action $\ell$, we define 
		a  test process
	$\Gamma; \emptyset; \Delta_2 \proves T\lrangle{\ell, \suc} \hastype \Proc$
	with the following property:
%
	\[
		\Gamma; \Delta_1 \proves P \Par T\lrangle{\ell, \suc} \red \Delta_2 \proves P' \Par \bout{\suc}{\dual{m}} \inact \barb{\suc}
		\quad \mbox{iff} \quad
		\Gamma; \Delta \proves P \hby{\ell} \Gamma; \Delta' \proves P'
	\]
%
	See \defref{app:def:definibility} (\mypageref{app:def:definibility}) for the formal definition.
	The test process can therefore be used to check the
	typed labelled transition interactions of two
	processes that are related by reduction-closed,
	barbed congruence. Indeed, we have that 
	\[
		\Gamma; \Delta_1 \proves P\ \cong\ \Delta_2 \proves Q
	\]
	implies from congruence of $\cong$:
	\begin{eqnarray*}
		\Gamma; \Delta_3 \proves P \Par T\lrangle{\ell, \suc}\ \cong\ \Delta_4 \proves Q \Par T\lrangle{\ell, \suc}
%		\label{prsk:1}
	\end{eqnarray*}
	which implies from reduction-closeness of $\cong$ and the definition of $T\lrangle{\ell, \suc}$:
	\begin{eqnarray}
		\Gamma; \Delta_3' \proves P' \Par \bout{\suc}{\dual{m}} \inact\ \cong\ \Delta_4' \proves Q' \Par \bout{\suc}{\dual{m}} \inact
		\label{prsk:2}
	\end{eqnarray}
	which in turn means that whenever $\Gamma; \Delta_1 \proves P \hastype \Proc$ can
	perform an action $\hby{\ell}$ then we can derive that $\Gamma; \Delta_2 \proves Q \hastype \Proc$
	can also perform action $\Hby{\ell}$ because of the result in \eqref{prsk:2}. With further
	reasoning on \eqref{prsk:2} we can deduce that
	$\Gamma; \Delta_1' \proves P'\ \cong\ \Delta_2' \proves Q'$.
	This concludes the requirements of the $\wbc$ bisimulation closure:
	\[
		\Gamma; \Delta \proves P\ \hwb\ \Delta' \proves Q
	\]
	The full details can be found in  \appref{app:sub_coinc}, \lemref{app:lem:cong_is_wb} (\mypageref{app:lem:cong_is_wb}).
	\qed
\end{proof}

We can finally state our main result:
\begin{theorem}[Coincidence]
	\label{the:coincidence}
	$\cong$, $\wbc$, $\hwb$ and $\fwb$ coincide in $\HOp$. 
\end{theorem}

\begin{proof}
	The proof is a direct consequence from our previous results:
	\lemref{lem:wb_eq_wbf} (which proves $\hwb\ =\ \fwb$), 
	\lemref{lem:wb_is_wbc} (which proves $\hwb\ \subseteq\ \wbc$),
	\lemref{lem:wbc_is_cong} (which proves $\wbc\ \subseteq\ \cong$), and	
	\lemref{lem:cong_is_wb} (which proves $\cong\ \subseteq\ \hwb$).
%
%\begin{enumerate}[$-$]
%		\item	\lemref{lem:wb_eq_wbf} proves $\wb\ =\ \wbf$.
%		\item	\lemref{lem:cong_is_wb} proves $\cong\ \subseteq\ \wb$.
%		\item	\lemref{lem:wb_is_wbc} proves $\wb\ \subseteq\ \wbc$.
%		\item \lemref{lem:wbc_is_cong} proves $\wbc\ \subseteq\ \cong$.
%		\end{enumerate}
Indeed, we may conclude $$\cong\ \subseteq\ \hwb\ =\ \fwb\ \subseteq\ \wbc\ \subseteq\ \cong$$
	\qed
\end{proof}
 
\subsection{Revisiting the Hotel Booking Scenario (\exref{exam:proc})}
\label{ss:examprev}

Now we prove that  processes $\Client_1$ and $\Client_2$ 
in \exref{exam:proc} are behaviourally equivalent.

\begin{proposition}\label{p:examp}
	Let
	\begin{eqnarray*}
		S &=& \btout{\rtype} \btinp{\Quote} \btsel{\accept: \btout{\creditc} \tinact, \reject: \tinact}\\
		\Delta &=& s_1: \btout{\lhot{S}} \tinact \cat s_2: \btout{\lhot{S}} \tinact
	\end{eqnarray*}
	Then
	$\horel{\es}{\Delta}{\Client_1}
	{\hwb}
	{\Delta}{\Client_2}$, where $\Client_1$ and $\Client_2$ are as in \exref{exam:proc}. 
\end{proposition}

\begin{proof}[Sketch]
	\noi We show a higher-order bisimulation closure by following transitions on each $\Client$;
	%We show the initial higher order transitions.
	see \appref{hotel_closure} for details.
	First, the characteristic process is given as:
	$\mapchar{\btinp{\lhot{S}} \tinact}{s} = \binp{s}{x} (\appl{x}{k})$.
	We show that the clients can simulate each other on
	the first two output transitions, that also generate the trigger
	processes:
%
\[
	\begin{array}{lll}
		&	\es; \es; \Delta \proves \Client_1
		&
			\by{\bactout{s_1}{\abs{x}{P_{xy} \subst{h_1}{y}}}}
			\qquad
			\by{\bactout{s_2}{\abs{x}{P_{xy} \subst{h_2}{y}}}}
		\\
		&	\es; \es; k_1: S \cat k_2: S \proves
		&
			\newsp{h_1, h_2}{\binp{\dual{h_1}}{x} \binp{\dual{h_2}}{y}
		\\
		&
		&	\If\ x \leq y\ \Then (\bsel{\dual{h_1}}{\accept} \bsel{\dual{h_2}}{\reject} \inact
			\Else \bsel{\dual{h_1}}{\reject} \bsel{\dual{h_2}}{\accept} \inact)
		\\
		&
		&	\Par \ftrigger{t_1}{\abs{x}{P_{xy} \subst{h_1}{y}}}{\lhot{S}} \Par \ftrigger{t_2}{\abs{x}{P_{xy} \subst{h_2}{y}}}{\lhot{S}}}
%		& \Par \binp{t_1}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_1} \Par \bout{\dual{s}}{\abs{x}{P \subst{h_1}{y}}} \inact }\\
%		& \Par \binp{t_2}{x} \newsp{s}{\mapchar{\btinp{\lhot{S}}}{s} \Par \bout{\dual{s}}{\abs{x}{P \subst{h_2}{y}}} \inact }}
		\\[2mm]
		& \mbox{and}
		\\[2mm]
		&	\es; \es; \Delta \proves \Client_2
		&
			\by{\bactout{s_1}{\abs{x}{Q_1 \subst{h}{y}}}}
			\qquad
			\by{\bactout{s_2}{\abs{x}{Q_2 \subst{\dual{h}}{y}}}}
		\\
		&	\es; \es; k_1: S \cat k_2: S \proves & \newsp{h}{
			\ftrigger{t_1}{\abs{x}{Q_1 \subst{h}{y}}}{\lhot{S}} \Par \ftrigger{t_2}{\abs{x}{Q_2 \subst{\dual{h}}{y}}}{\lhot{S}}}
%		\binp{t_1}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_1} \Par \bout{\dual{s}}{\abs{x}{P_1 \subst{h}{y}}} \inact }\\
%		&\Par \binp{t_2}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_2} \Par \bout{\dual{s}}{\abs{x}{P_2 \subst{\dual{h}}{y}}} \inact }}
	\end{array}
\]
	\noi 
	After these transitions, 
	we can analyse that 
	the resulting processes are behaviourally equivalent
	since they have the same visible transitions; the rest 
	is internal deterministic transitions. 
	\qed
\end{proof}

%\smallskip 

%\noi 
%Thus, we may use $\hwb$ for tractable reasoning %is the most tractable 
%in the higher-order setting;  
%%the calculus is limited  
%%the $\sessp$-calculus, 
%%into~\jpc{\sessp}
%in the first-order setting of $\sessp$
%we can still use~$\fwb$. 



%PERHAPS REVISIT EXAMPLE \ref{ex:motivation}??


%\smallskip  
%
%\noi Processes that do not use shared names are inherently deterministic. 
%The following \jpc{determinacy property will be} useful 
%\dk{for proving our expressiveness results (\secref{sec:positive})}.
%%for both positive and negative results. 
%We require an auxiliary definition. 
%A transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is said
%		{\em deterministic} if it is derived using~$\ltsrule{App}$ or~$\ltsrule{Tau}$ 
%		(where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise 
%		are dual endpoints), 
%		possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/\ltsrule{Par${}_R$}$.
%
%
%%\smallskip 
%
%\begin{lemma}[$\tau$-Inertness]\rm
%	\label{lem:tau_inert}
%	\begin{enumerate}[1)]
%		\item %(deterministic transitions) 
%		Let $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ be a deterministic transition,
%		with balanced $\Delta$. Then 
%		$\Gamma; \Delta \proves P \cong \Delta'\proves P'$ 
%		with $\Delta \red^\ast \Delta'$ balanced.
%%		Transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is called
%%		{\em deterministic} if it is derived by $\ltsrule{App}$ or 
%%		$\ltsrule{Tau}$ where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise 
%%		are dual session names. Suppose $\Delta$ is balanced. Then 
%%		$\Gamma; \Delta \proves P \cong \Delta'\proves P'$ 
%%		with $\Delta \red^\ast \Delta'$ balanced. 
%		\item 
%		%Let $P$ is the $\HOp^{-\mathsf{sh}}$-calculus. 
%		Let $P$ be an $\HOp^{-\mathsf{sh}}$ process. 
%		Assume $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. Then 
%		$P \red^\ast P'$ implies $\Gamma; \Delta \proves 
%		P \cong \Delta'\proves P'$ with $\Delta \red^\ast \Delta'$. 
%	\end{enumerate}
%\end{lemma}


%\smallskip 


%\begin{IEEEproof}
%	The full details of the proof are in Appendix~\ref{app:sub_coinc}.
%	The theorem is split into a hierarchy of Lemmas. Specifically
%	Lemma~\ref{lem:wb_eq_wbf} proves 
%	$\wb$ coincides with $\fwb$; 
%	Lemma~\ref{lem:wb_is_wbc} exploits the process substitution result
%	(Lemma~\ref{lem:proc_subst}) to prove that $\hwb \subseteq \wbc$.
%	Lemma~\ref{lem:wbc_is_cong} shows that $\wbc$ is a congruence
%	which implies $\wbc \subseteq \cong$.
%	The final result comes from Lemma~\ref{lem:cong_is_wb} where
%	we use label testing to show that $\cong \subseteq \fwb$ using
%	the technique in developed in~\cite{Hennessy07}. The formulation of input
%	triggers in the bisimulation relation allows us to prove
%	the latter result without using a matching operator.
%\end{IEEEproof}

%\smallskip 

%\noi Processes that do not use shared names, are inherently $\tau$-inert.

%\smallskip 

%\begin{lemma}[$\tau$-inertness]\rm
%	\label{lem:tau_inert}
%	Let $P$ is the $\HOp^{-\mathsf{sh}}$-calculus. 
%Assume $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. Then 
%$P \red^\ast P'$ implies $\Gamma; \Delta \proves 
%P \cong \Delta'\proves P'$ with $\Delta \red^\ast \Delta'$. 
%\end{lemma}


%\begin{IEEEproof}
%	The proof is relied on the fact that processes of the
%	form $\Gamma; \es; \Delta \proves_s \bout{s}{V} P_1 \Par \binp{k}{x} P_2$
%	cannot have any typed transition observables and the fact
%	that bisimulation is a congruence.
%	See details in Appendix~\ref{app:sub_tau_inert}.
%	\qed
%\end{IEEEproof}

