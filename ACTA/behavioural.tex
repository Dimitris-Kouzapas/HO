% !TEX root = main.tex
\noi We develop a theory for observational equivalence over
session typed \HOp processes that follows the principles
laid in our previous works~\cite{KYHH2015,KY2015}.
We introduce 
%three different bisimulations 
\emph{characteristic bisimulation} (\defref{d:fwb})
and prove
\jpc{that}
%all of them coincide 
it coincides
with reduction-closed,
barbed congruence (\thmref{the:coincidence}).

We begin by defining an (early) labelled transition system (LTS) on
untyped processes~(\S\,\ref{ss:lts}). 
Then, using the \emph{environmental} transition semantics (\S\,\ref{ss:elts}), 
we define a typed LTS to formalise 
how a typed process interacts with a typed observer. 

\subsection{Labelled Transition System for Processes}\label{ss:lts}
%\myparagraph{Labels.}
%\noi 

%process in its environment. 
Interaction is defined on action labels $\ell$:
\begin{center}
\begin{tabular}{l}
	$\ell	\bnfis   \tau 
		\bnfbar	\bactinp{n}{V} 
		\bnfbar	\news{\widetilde{m}} \bactout{n}{V}
		\bnfbar	\bactsel{n}{l} 
		\bnfbar	\bactbra{n}{l} $
\end{tabular}
\end{center}
\noi 
Label $\tau$ defines internal actions.
Action $\news{\widetilde{m}} \bactout{n}{V}$ denotes the sending of value $V$
over channel $n$ with
a possible empty set of restricted names $\widetilde{m}$ 
(we may write $\bactout{n}{V}$ when $\widetilde{m}$ is empty).
%and 
%$\news{\widetilde{m}} \bactout{n}{\AT{V}{U}}$
%when the type of $V$ is~$U$.
Dually, the action for value reception is 
$\bactinp{n}{V}$.
Actions for select
and branch on
a label~$l$ are denoted $\bactsel{n}{l}$ and $\bactbra{n}{l}$, resp.
We write $\fn{\ell}$ and $\bn{\ell}$ to denote the
 sets of free/bound names in $\ell$, resp.
%and set $\mathsf{n}(\ell)=\bn{\ell}\cup \fn{\ell}$. 
Given $\ell \neq \tau$, we write 
$\subj{\ell}$
to denote the \emph{subject} of $\ell$.


\emph{Dual actions} %, defined below, 
occur on subjects that are dual between them and carry the same
object; thus, output is dual to input and 
selection is dual to branching.
Formally, duality 
\jpc{on actions}
is the symmetric relation $\asymp$ that satisfies:
\jpc{(i)~$\bactsel{n}{l} \asymp \bactbra{\dual{n}}{l}$ 
and (ii)~$\news{\widetilde{m}} \bactout{n}{V} \asymp \bactinp{\dual{n}}{V}$}.
%
%\begin{tabular}{c}
%	$\bactsel{n}{l} \asymp \bactbra{\dual{n}}{l}
%	\qquad \qquad \qquad
%	\news{\widetilde{m}} \bactout{n}{V} \asymp \bactinp{\dual{n}}{V}$s
%
%\end{tabular}


%%%%%%%%%%%%%%%%%%%% LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[t]
\[
	\begin{array}{c}
%	\inferrule[ ]{ }{b}
	\inferrule*[left=\ltsrule{App}]{ }{(\abs{x}{P}) \, V   \by{\tau} P \subst{V}{x}}
%		\ltsrule{App} \ 		(\abs{x}{P}) \, V   \by{\tau} P \subst{V}{x}
		\qquad
		\inferrule*[left=\ltsrule{Snd}]{ }{\bout{n}{V} P \by{\bactout{n}{V}} P}
%		\ltsrule{Snd}\	\bout{n}{V} P \by{\bactout{n}{V}} P 
		\qquad
		\inferrule*[left=\ltsrule{Rv}]{ }{\binp{n}{x} P \by{\bactinp{n}{V}} P\subst{V}{x} }
%		\ltsrule{Rv}\	\binp{n}{x} P \by{\bactinp{n}{V}} P\subst{V}{x} 
		\\[2mm]
		\inferrule*[left=\ltsrule{Sel}]{ }{\bsel{s}{l}{P} \by{\bactsel{s}{l}} P}
		%\ltsrule{Sel}\ \bsel{s}{l}{P} \by{\bactsel{s}{l}} P
		\qquad \quad
		\inferrule*[left=\ltsrule{Bra}]{ }{\bbra{s}{l_i:P_i}_{i \in I} \by{\bactbra{s}{l_j}} P_j \ (j\in I)}
		%\ltsrule{Bra}\ \bbra{s}{l_i:P_i}_{i \in I} \by{\bactbra{s}{l_j}} P_j \ (j\in I)
		\\[2mm]
		\inferrule[\ltsrule{Alpha}]{P \scong_\alpha Q \quad Q\by{\ell} P'}{P \by{\ell} P'}
%		\ltsrule{Alpha}
%		\tree{
%			P \scong_\alpha Q \quad Q\by{\ell} P'
%		}{
%			P \by{\ell} P'
%		}
		\qquad \quad
		\inferrule[\ltsrule{Res}]{P \by{\ell} P' \quad n \notin \fn{\ell}}{\news{n} P \by{\ell} \news{n} P'}
%		\ltsrule{Res}
%		\tree{
%			P \by{\ell} P' \quad n \notin \fn{\ell}
%		}{
%			\news{n} P \by{\ell} \news{n} P' 
%		}
		%\\[5mm]
		\qquad \quad
		\inferrule[\ltsrule{New}]{P \by{\news{\widetilde{m}} \bactout{n}{V}} P' \quad m \in \fn{V}}{\news{m} P \by{\news{m\cat\widetilde{m}'} \bactout{n}{V}} P'}
%		\ltsrule{New}
%		\tree{
%			P \by{\news{\widetilde{m}} \bactout{n}{V}} P' \quad m \in \fn{V}
%		}{
%			\news{m} P \by{\news{m\cat\widetilde{m}'} \bactout{n}{V}} P'
%		}
		\\[4mm]
		\inferrule[\ltsrule{Par${}_L$}]{P \by{\ell} P' \quad \bn{\ell} \cap \fn{Q} = \es}{P \Par Q \by{\ell} P' \Par Q}
%		\ltsrule{Par${}_L$}
%		\tree{
%
%			P \by{\ell} P' \quad \bn{\ell} \cap \fn{Q} = \es
%		}{
%			P \Par Q \by{\ell} P' \Par Q
%		}
%		\\[5mm]
\quad ~~
		\inferrule[\ltsrule{Tau}]{P \by{\ell_1} P' \qquad Q \by{\ell_2} Q' \qquad \ell_1 \asymp \ell_2}{P \Par Q \by{\tau} \newsp{\bn{\ell_1} \cup \bn{\ell_2}}{P' \Par Q'}}
%		\ltsrule{Tau}
%		\tree{
%			P \by{\ell_1} P' \qquad Q \by{\ell_2} Q' \qquad \ell_1 \asymp \ell_2
%		}{
%			P \Par Q \by{\tau} \newsp{\bn{\ell_1} \cup \bn{\ell_2}}{P' \Par Q'}
%		} 
		\quad ~~
		\inferrule[\ltsrule{Rec}]{P\subst{\recp{X}{P}}{\rvar{X}} \by{\ell} P'}{\recp{X}{P}  \by{\ell} P'}
%		\ltsrule{Rec}
%		\tree{
%			P\subst{\recp{X}{P}}{\rvar{X}} \by{\ell} P' 
%		}{
%			\recp{X}{P}  \by{\ell} P'
%		}
	\end{array}
\]
\vspace{-5mm}
	\caption{The Untyped LTS for \HOp processes. We omit rule $\ltsrule{Par${}_R$}$.  \label{fig:untyped_LTS}}
\vspace{-2mm}
\end{figure}
%%%%%%%%%%%%%%%%%%%% End LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\myparagraph{LTS over Untyped Processes.}
The %labelled transition system (LTS) 
LTS
over \emph{untyped processes}
is given in
\figref{fig:untyped_LTS}. 
We write $P_1 \by{\ell} P_2$ with the usual meaning.
The rules are standard~\cite{KYHH2015,KY2015}.
A process with an output prefix can
interact with the environment with an output action that carries a value
$V$ (rule~$\ltsrule{Snd}$).  Dually, in rule $\ltsrule{Rv}$ a
receiver process can observe an input of an arbitrary value $V$.
Select and branch processes observe the select and branch
actions in rules $\ltsrule{Sel}$ and $\ltsrule{Bra}$, resp.
Rule $\ltsrule{Res}$ closes the LTS under restriction 
if the restricted name does not occur free in the
observable action. 
%If a restricted name occurs free,  
If a restricted name occurs free in
the carried value of an output action,
the process performs scope opening (rule~$\ltsrule{New}$).  
Rule~$\ltsrule{Rec}$ handles recursion unfolding.
Rule~$\ltsrule{Tau}$ 
states that two parallel processes which perform
dual actions can synchronise by an internal transition.
%states that if two parallel processes can perform
%dual actions then the two actions can synchronise by 
%an internal transition. 
Rules $\ltsrule{Par${}_L$}$/$\ltsrule{Par${}_R$}$ 
and $\ltsrule{Alpha}$ close the LTS
under parallel composition and $\alpha$-renaming. 
%provided that the observable
%action does not share any bound names with the parallel processes.

\subsection{Environmental Labelled Transition System}
\label{ss:elts}
\noi 
\figref{fig:envLTS}
defines a labelled transition relation between 
a triple of environments, 
denoted
$(\Gamma_1, \Lambda_1, \Delta_1) \by{\ell} (\Gamma_2, \Lambda_2, \Delta_2)$.
It extends the LTSs
in \cite{KYHH2015,KY2015} 
to higher-order sessions. 
Notice that due to weakening %of shared environments 
we have 
$(\Gamma', \Lambda_1, \Delta_1) \hby{\ell} (\Gamma', \Lambda_2, \Delta_2)$
if
$(\Gamma, \Lambda_1, \Delta_1) \hby{\ell} (\Gamma', \Lambda_2, \Delta_2)$.



\myparagraph{Input Actions} 
are defined by 
rules~$\eltsrule{SRv}$ and $\eltsrule{ShRv}$.
%describe the input action
In rule~$\eltsrule{SRv}$
%($n$ session or shared channel respectively $\bactinp{n}{V}$). 
the type of value $V$
and the type of the object associated to the session type on $s$ 
should coincide. 
%Moreover, 
The resulting type tuple must contain the environments 
associated to $V$. 
The %condition $\dual{s} \notin \dom{\Delta}$
%rule requires that 
dual endpoint $\dual{s}$ cannot be
present in the session environment: if it were present
the only possible communication would be the interaction
between the two endpoints (cf. rule~$\eltsrule{Tau}$).
Rule~$\eltsrule{ShRv}$ is for shared names and follows similar principles.

\myparagraph{Output Actions} are defined by rules~$\eltsrule{SSnd}$
and $\eltsrule{ShSnd}$.  
Rule $\eltsrule{SSnd}$ states the conditions for observing action
$\news{\widetilde{m}} \bactout{s}{V}$ on a type tuple 
$(\Gamma, \Lambda, \Delta\cdot \AT{s}{S})$. 
The session environment $\Delta$ with $\AT{s}{S}$ 
should include the session environment of the sent value $V$, 
{\em excluding} the session environments of names $m_j$ 
in $\widetilde{m}$ which restrict the scope of value $V$. 
Analogously, the linear variable environment 
$\Lambda'$ of $V$ should be included in $\Lambda$. 
Scope extrusion of session names in $\widetilde{m}$ requires
that the dual endpoints of $\widetilde{m}$ should appear in
the resulting session environment. Similarly for shared 
names in $\widetilde{m}$ that are extruded.  
All free values used for typing $V$ are subtracted from the
resulting type tuple. The prefix of session $s$ is consumed
by the action.
Rule $\eltsrule{ShSnd}$ is for output actions on shared names:
the name must be typed with $\chtype{U}$; conditions on $V$ are identical to those
% the requirements 
on rule~$\eltsrule{SSnd}$.
%\NY{Given a $V$ of type $U$, we sometimes annotate the output action 
%$\news{\widetilde{m}} \bactout{n}{V}$
%%with the type of $V$ 
%as $\news{\widetilde{m}} \bactout{n}{\AT{V}{U}}$.}

\myparagraph{Other Actions}
Rules $\eltsrule{Sel}$ and $\eltsrule{Bra}$ describe actions for
select and branch.
%Both
%rules require the absence of the dual endpoint from the session
%environment.%, and the presence of the action labels in the type.
Rule $\eltsrule{Tau}$ defines
internal transitions: 
it keeps the session environment unchanged or 
reduces it (\defref{d:wtenvred}).

%A second environment LTS, denoted $\hby{\ell}$,
%is defined in the lower part of \figref{fig:envLTS}.
%The definition substitutes rules
%$\eltsrule{SRecv}$ and $\eltsrule{ShRecv}$
%of relation $\by{\ell}$ with rule $\eltsrule{RRcv}$.
%% the corresponding input cases
%%of $\by{\ell}$ with the definitions of $\hby{\ell}$.
%All other cases remain the same as the cases for
%relation $\by{\ell}$.
%Rule $\eltsrule{RRcv}$ restricts the higher-order input
%in relation $\hby{\ell}$;
%only characteristic processes and trigger processes
%are allowed to be received on a higher-order input.
%Names can still be received as in the definition of
%the $\by{\ell}$ relation.
%The conditions for input follow the conditions
%for the $\by{\ell}$ definition.

%%%%%%%%%%%%%%%%%%%% Environment LTS Figure %%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[t]
\[
\begin{array}{c}
\inferrule[\eltsrule{SRv}]{
		\dual{s} \notin \dom{\Delta}
		\quad
		\Gamma; \Lambda'; \Delta' \proves V \hastype U
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btinp{U} S) \by{\bactinp{s}{V}} (\Gamma; \Lambda\cat\Lambda'; \Delta\cat\Delta' \cat s: S)
	}
	%\\[7mm]
	\quad
	\inferrule[\eltsrule{ShRv}]{
		\Gamma; \es; \es \proves a \hastype \chtype{U}
		\quad
		\Gamma; \Lambda'; \Delta' \proves V \hastype U
	}{
		(\Gamma; \Lambda; \Delta) \by{\bactinp{a}{{V}}} (\Gamma; \Lambda\cat\Lambda'; \Delta\cat\Delta')
	}
	\\[6mm]
%%	\eltsrule{SSnd} &
	\inferrule*[left=\eltsrule{SSnd}]{
		\begin{array}{lll}
			\Gamma \cat \Gamma'; \Lambda'; \Delta' \proves V \hastype U
			&				
			\Gamma'; \es; \Delta_j \proves m_j  \hastype U_j
			& 
			\dual{s} \notin \dom{\Delta}
			\\
			\Delta'\backslash \cup_j \Delta_j \subseteq (\Delta \cat s: S)
			& 
			\Gamma'; \es; \Delta_j' \proves \dual{m}_j  \hastype U_j'
			& 
			\Lambda' \subseteq \Lambda
		\end{array}
	}{
		(\Gamma; \Lambda; \Delta \cat s: \btout{U} S)
		\by{\news{\widetilde{m}} \bactout{s}{V}}
		(\Gamma \cat \Gamma'; \Lambda\backslash\Lambda'; (\Delta \cat s: S \cat \cup_j \Delta_j') \backslash \Delta')
	}
	\\[2mm]
	\inferrule*[left=\eltsrule{ShSnd}]{
		\begin{array}{lll}
			\Gamma \cat \Gamma' ; \Lambda'; \Delta' \proves V \hastype U
			&  
			\Gamma'; \es; \Delta_j \proves m_j \hastype U_j
			&
			\Gamma ; \es ; \es \proves a \hastype \chtype{U}
			\\
			\Delta'\backslash \cup_j \Delta_j \subseteq \Delta
			&
			\Gamma'; \es; \Delta_j' \proves \dual{m}_j\hastype U_j'
			& 
			\Lambda' \subseteq \Lambda
		\end{array}
	}{
		(\Gamma ; \Lambda; \Delta) \by{\news{\widetilde{m}}
		\bactout{a}{V}}
		(\Gamma \cat \Gamma'; \Lambda\backslash\Lambda'; (\Delta \cat \cup_j \Delta_j') \backslash \Delta')
	}
	\\[2mm]
	\inferrule*[left=\eltsrule{Sel}]{\dual{s} \notin \dom{\Delta} \quad j \in I}{(\Gamma; \Lambda; \Delta \cat s: \btsel{l_i: S_i}_{i \in I}) \by{\bactsel{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)}
%	\eltsrule{Sel}~~
%	\tree{
%		\dual{s} \notin \dom{\Delta} \quad j \in I
%	}{
%		(\Gamma; \Lambda; \Delta \cat s: \btsel{l_i: S_i}_{i \in I}) \by{\bactsel{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)
%	}
	\\[2mm]
	\inferrule*[left=\eltsrule{Bra}]{\dual{s} \notin \dom{\Delta} \quad j \in I}{(\Gamma; \Lambda; \Delta \cat s: \btbra{l_i: T_i}_{i \in I}) \by{\bactbra{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)}
%	\eltsrule{Bra}~~
%	\tree{
%		\dual{s} \notin \dom{\Delta} \quad j \in I
%	}{
%		(\Gamma; \Lambda; \Delta \cat s: \btbra{l_i: T_i}_{i \in I}) \by{\bactbra{s}{l_j}} (\Gamma; \Lambda; \Delta \cat s:S_j)
%	}
%	\\[7mm]
%	\eltsrule{Tau}~~
%	\tree{
%		\Delta_1 \red \Delta_2 \vee \Delta_1 = \Delta_2
%	}{
%		(\Gamma; \Lambda; \Delta_1) \by{\tau} (\Gamma; \Lambda; \Delta_2)
%	}
\qquad
	\inferrule*[left=\eltsrule{Tau}]{
		\Delta_1 \red \Delta_2 \vee \Delta_1 = \Delta_2
	}{
		(\Gamma; \Lambda; \Delta_1) \by{\tau} (\Gamma; \Lambda; \Delta_2)
	}

\end{array}
\]
\vspace{-5mm}
\caption{Labelled Transition System for Typed Environments. 
\label{fig:envLTS}}
%\Hlinefig
\vspace{-2mm}
\end{figure}
%%%%%%%%%%%%%%%%%%%% End Environment LTS Figure %%%%%%%%%%%%%%%%%%%%%%

\begin{example}
	Consider environment %tuple
	$
		(\Gamma; \es; s: \btout{\lhot{\btout{S} \tinact}} \tinact \cat s': S)
	$
	and typed value
	\[
		\Gamma; \es; s': S \cat m: \btinp{\tinact} \tinact \proves V \, \hastype \, 
\lhot{\btout{\tinact} \tinact} \quad \mbox{with} \quad 
V= \abs{x} \bout{x}{s'} \binp{m}{z} \inact
	\]
Let 
$\Delta'_1=\{\overline{m}: \btout{\tinact} \tinact\}$ and 
$U=\btout{\lhot{\btout{S} \tinact}} \tinact$.
	Then by $\eltsrule{SSnd}$, we can derive:
	\[
		(\Gamma; \es; s: \btout{\lhot{\btout{S} \tinact}} \tinact \cat s': S) \by{\news{m} \bactout{s}{V}} (\Gamma; \es; s: \tinact)
	\]
\end{example}

\noi
Our typed LTS  combines
the LTSs in \figref{fig:untyped_LTS}
and \figref{fig:envLTS}. 




\begin{definition}[Typed Transition System]\label{d:tlts}\rm
A {\em typed transition relation} is a typed relation
%\begin{enumerate}
%\item 
$\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_2}{P_2}$
%$\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc \by{\ell} \Gamma; \emptyset; \Delta_2 \proves P_2 \hastype \Proc$
	where:
%
(1) $P_1 \by{\ell} P_2$ and (2) 
$(\Gamma, \emptyset, \Delta_1) \by{\ell} (\Gamma, \emptyset, \Delta_2)$ 
with $\Gamma; \emptyset; \Delta_i \proves P_i \hastype \Proc$ 
($i=1,2$).
%\dk{We sometimes annotated the output action with
%the type of value $V$ as in $\widetilde{m} \bactout{n}{V: U}$.}
%
% Efficient 
%\item 
%$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_2}{P_2}$
%whenever: 
%$P_1 \by{\ell} P_2$, 
%$(\Gamma, \emptyset, \Delta_1) \hby{\ell} (\Gamma, \emptyset, \Delta_2)$, 
%and $\Gamma; \emptyset; \Delta_i \proves P_i \hastype \Proc$ 
%($i=1,2$)
%\end{enumerate}
%
We extend to $\By{}$ 
%(resp.\ $\Hby{}$) and  
and $\By{\hat{\ell}}$ 
%(resp.\ $\Hby{\hat{\ell}}$) 
where we write 
$\By{}$ for the reflexive and
transitive closure of $\by{}$, $\By{\ell}$ for the transitions
$\By{}\by{\ell}\By{}$, and $\By{\hat{\ell}}$ for $\By{\ell}$ if
$\ell\not = \tau$ otherwise $\By{}$. 
%We extend to $\By{}$ 
%(resp.\ $\Hby{}$) and  and 
%$\By{\hat{\ell}}$ 
%(resp.\ $\Hby{\hat{\ell}}$) 
%in the standard way.
\end{definition}

\subsection{Reduction-Closed, Barbed Congruence ($\cong$)}
\label{subsec:rc}
\noi We now define \emph{typed relations} and \emph{contextual equivalence} (i.e., barbed congruence).  
%\begin{definition}[Session Environment Confluence]\rm
We first define \emph{confluence}
over session environments $\Delta$:
we denote $\Delta_1 \bistyp \Delta_2$ if there exists $\Delta$ such that
	$\Delta_1 \red^\ast \Delta$ and $\Delta_2 \red^\ast \Delta$
	\jpc{(here we write $\red^\ast$ for the multi-step reduction in \defref{d:wtenvred})}.
%\end{definition}

\begin{definition}\rm %[Typed Relation]\rm
	We say that
	$\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc\ \Re \ \Gamma; \emptyset; \Delta_2 \proves P_2 \hastype \Proc$
	is a {\em typed relation} whenever $P_1$ and $P_2$ are closed;
		$\Delta_1$ and $\Delta_2$ are balanced; and 
		$\Delta_1 \bistyp \Delta_2$.
We write
$\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{P_2}$
for the typed relation $\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc\ \Re \ \Gamma; \emptyset; \Delta_2 \proves P_2 \hastype \Proc$.
\end{definition}

\noi Typed relations relate only closed terms whose
session environments %and the two session environments
are balanced  and confluent.
Next we define  {\em barbs}~\cite{MiSa92}
with respect to types. 

%\begin{definition}[Barbs]\rm
%Let $P$ be a closed process. We define:
%\begin{enumerate}
%		\item	(a) $P \barb{n}$ if $P \scong \newsp{\widetilde{m}}{\bout{n}{V} P_2 \Par P_3}, n \notin \widetilde{m}$; %; $P \Barb{n}$ if $P \red^* \barb{n}$. and $\Gamma; \Delta \proves P \barb{n}$ if
%(b)			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ with $P \barb{n}$ and $\dual{n} \notin \dom{\Delta}$
%\item  
%	$\Gamma; \Delta \proves P \Barb{n}$ if $P \red^* P'$ and
%			$\Gamma; \Delta' \proves P' \barb{n}$.			
%	\end{enumerate}
%\end{definition}

\begin{definition}[Barbs]\rm
	Let $P$ be a closed process. We write
	%\begin{enumerate}
		%\item 
		$P \barb{n}$ if $P \scong \newsp{\tilde{m}}{\bout{n}{V} P_2 \Par P_3}$, with $n \notin \tilde{m}$.
		Also: $P \Barb{n}$ if $P \red^* \barb{n}$.
		%\item 
		Similarly, we write
		$\Gamma; \emptyset; \Delta \proves P \barb{n}$ if
			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ with $P \barb{n}$ and $\dual{n} \notin \Delta$.
			Also: $\Gamma; \emptyset; \Delta \proves P \Barb{n}$ if $P \red^* P'$ and
			$\Gamma; \emptyset; \Delta' \proves P' \barb{n}$.			
	%\end{enumerate}
\end{definition}

\noi A barb $\barb{n}$ is an observable on an output prefix with subject $n$;
a weak barb $\Barb{n}$ is a barb after a number of reduction steps.
Typed barbs $\barb{n}$ (resp.\ $\Barb{n}$)
occur on typed processes $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
When $n$ is a session name we require that its dual endpoint $\dual{n}$ is not %present
in %the session environment 
$\Delta$.

To define a congruence relation, we introduce the family $\C$ of contexts:
\begin{eqnarray*}
	\C & ::= & \hole \bnfbar \bout{u}{V} \C \bnfbar \binp{u}{x} \C \bnfbar \bout{u}{\lambda x.\C} P \bnfbar \news{n} \C
	(\lambda x.\C)u \bnfbar \recp{X}{\C}\\ 
	& \bnfbar & \C \Par P \bnfbar P \Par \C \bnfbar \bsel{u}{l} \C \bnfbar \bbra{u}{l_1:P_1,\cdots,l_i:\C,\cdots,l_n:P_n}
\end{eqnarray*}

Notation $\context{\C}{P}$ denotes the result of substituting 
\jpc{the hole}
$\hole$ in $\C$ with process $P$.
%\end{definition}


\noi The first behavioural relation we define is reduction-closed, barbed congruence \cite{HondaKYoshida95}. 

\begin{definition}[Reduction-Closed, Barbed Congruence]\rm
\label{def:rc}
	Typed relation
	$\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{P_2}$
	is a {\em reduction-closed, barbed congruence} whenever:
	\begin{enumerate}[1)]
		\item	If $P_1 \red P_1'$ then there exist $P_2', \Delta_2'$ such that $P_2 \red^* P_2'$ and
			$\horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}$;%		and its symmetric case;
%		\item	If $P_2 \red P_2'$ then $\exists P_1', P_1 \red^* P_1'$ and
%		$\horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}$
%		\end{itemize}

%		\item
%		\begin{itemize}
			\item	If $\Gamma;\Delta_1 \proves P_1 \barb{n}$ then $\Gamma;\Delta_2 \proves P_2 \Barb{n}$;% and its symmetric case; 

%			\item	If $\Gamma;\emptyset;\Delta \proves P_2 \barb{s}$ then $\Gamma;\emptyset;\Delta \proves P_1 \Barb{s}$.
%		\end{itemize}

		\item	For all $\C$, there exist $\Delta_1'',\Delta_2''$: $\horel{\Gamma}{\Delta_1''}{\context{\C}{P_1}}{\ \Re\ }{\Delta_2''}{\context{\C}{P_2}}$; 
		                      \item	The symmetric cases of 1 and 2.                
	\end{enumerate}
	The largest such relation is denoted with $\cong$.
\end{definition}


\subsection{Context Bisimilarity ($\wbc$)}
\label{subsec:bisimulation}
\noi 
Following Sangiorgi~\cite{San96H}, 
%The first bisimulation that 
we now define 
the standard (weak) context bisimilarity. 
%
\begin{definition}[Context Bisimilarity]\rm
\label{def:wbc}
A typed relation $\Re$ is {\em a context bisimulation} if
for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$, 
	\begin{enumerate}[1)] 
	\item Whenever 
$\horel{\Gamma}{\Delta_1}{P_1}
        {\by{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}$,
there exist 
$Q_2$, $V_2$, $\Delta'_2$
such that 
$\horel{\Gamma}{\Delta_2}{Q_1}{\By{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}$ and 
for all $R$ with $\fv{R}=x$:
\[\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par R\subst{V_1}{x}}}
				{\ \Re\ }
				{\Delta_2''}{\newsp{\widetilde{m_2}}{Q_2 \Par R\subst{V_2}{x}}};\]  
%\item	$\forall \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}$ such that
%			\[
%				\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}}}{\Delta_1'}{P_2}
%			\]
%			implies that $\exists Q_2, \widetilde{m_2}$ such that
%			\[
%				\horel{\Gamma}{\Delta_2}{Q_1}{\By{\news{\widetilde{m_2}'} \bactout{n}{\widetilde{m_2}}}}{\Delta_2'}{Q_2}
%			\]
%			and $\forall R$ with $\widetilde{x} = \fn{R}$, 
%			then
%			\[
%				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_2 \Par R \subst{\widetilde{m_1}}{\widetilde{x}}}}
%				{\ \Re \ }
%				{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q_2 \Par R \subst{\widetilde{m_2}}{\widetilde{x}}}}
%			\]
		\item	
For all $\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_2}$ such that 
$\ell$ is not an output, 
 there exist $Q_2$, $\Delta'_2$ such that 
$\horel{\Gamma}{\Delta_2}{Q_1}{\By{\hat{\ell}}}{\Delta_2'}{Q_2}$
			and
			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and  

                      \item	The symmetric cases of 1 and 2.                
	\end{enumerate}
	The largest such bisimulation is called \emph{context bisimilarity} \jpc{and} denoted by $\wbc$.
\end{definition}

\noi As hinted at in %\secref{subsec:intro:bisimulation}, 
%\secref{sec:overview},
the Introduction,
in the general case,
context bisimilarity 
is hard to compute. Below we introduce 
\emph{characteristic bisimulations}, which are meant to be a \emph{tractable} proof technique over session typed  processes with higher-order communication.
%$\hwb$ and  $\fwb$.
%due to: (1) the universal
%quantification over contexts in the output case;
%and (2) a higher-order input prefix which can observe
%infinitely many different input actions (since
%infinitely many different processes can match
%the session type of an input prefix).

\subsection{%Higher-Order  and  
Characteristic  Bisimilarity ($\fwb$)}\label{ss:hwb}
\noi 
We formalise the ideas given in % \secref{sec:overview}.
the introduction.
%Our main result is \thmref{the:coincidence}.
We define characteristic processes/values:

\begin{definition}[Characteristic Process and Values]\rm
\label{def:char}
%	Let names $\widetilde{k}$ and type $\widetilde{C}$; then we define a {\em characteristic process}:
%	$\map{\widetilde{C}}^{\widetilde{k}}$:
%	\[
%		\map{C_1, \cdots, C_n}^{k_1 \cdots k_n} = \map{C_1}^{k_1} \Par \dots \Par \map{C_n}^{k_n}		
%	\]
%	with 
	Let $u$ and $U$ be a name and a type, respectively.
	\figref{fig:char} defines the {\em characteristic process} 
	$\mapchar{U}{u}$ and the {\em characteristic value} $\omapchar{U}$.
\end{definition}

%%%%%%%%%%%%%%%%%%%%%%%% Characteristic Process Figure %%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[t]
\[
	\begin{array}{rclcrcl}
		\mapchar{\btinp{U} S}{u}
		&\defeq&
		\binp{u}{x} (\mapchar{S}{u} \Par \mapchar{U}{x})
		&&
		\mapchar{\btout{U} S}{u}
		&\defeq&
		\bout{u}{\omapchar{U}} \mapchar{S}{u} %& & n \textrm{ fresh}
		\\

		\mapchar{\btsel{l : S}}{u}
		& \defeq &
		\bsel{u}{l} \mapchar{S}{u}
		&&
		\mapchar{\btbra{l_i: S_i}_{i \in I}}{u}
		& \defeq &
		\bbra{u}{l_i: \mapchar{S_i}{u}}_{i \in I}
		\\

		\mapchar{\tvar{t}}{u}
		&\defeq&
		\varp{X}_{\vart{t}}
		& & 
		\mapchar{\trec{t}{S}}{u}
		&\defeq&
		\recp{X_{\vart{t}}}{\mapchar{S}{u}}
		\\

		\mapchar{\tinact}{u}
		& \defeq &
		\inact
		& & 
		\mapchar{\chtype{S}}{u} 
		&\defeq&
		\bout{u}{\omapchar{S}} \inact
		\\

		\mapchar{\chtype{L}}{u}
		&\defeq&
		\bout{u}{\omapchar{L}} \inact
		&&
		\mapchar{\shot{U}}{u}
		&\defeq &
		\mapchar{\lhot{U}}{u}
		\, \defeq \,
		\appl{u}{\omapchar{U}}
		\end{array}
		\]
		\vspace{-3mm}
		\[
		\begin{array}{c}
		\omapchar{S}  \defeq  s ~~ (s \textrm{ fresh})
		\qquad
		\omapchar{\chtype{S}} \defeq \omapchar{\chtype{L}} \defeq a ~~ (a \textrm{ fresh})
		\qquad
		\omapchar{\shot{U}} \defeq \omapchar{\lhot{U}} \,\defeq\, \abs{x}{\mapchar{U}{x}}
	\end{array}
\]
\vspace{-5mm}
\caption{Characteristic Processes \jpc{(top)} and Values \jpc{(bottom)}.\label{fig:char}}
%\Hlinefig
\vspace{-3mm}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%% End Characteristic Process Figure %%%%%%%%%%%%%%%%%%%%%

%	\[
%	\begin{array}{rcllrcll}
%		\map{\btinp{C} S}^{u} &=& \binp{u}{x} (\map{S}^{u} \Par 
%\map{{C}}^{x})\\
%		\map{\btout{C} S}^{u} &=& \bout{u}{n} \map{S}^{u} & n\textrm{ fresh}
%		\\
%		\map{\btsel{l : S}}^{u} &=& \bsel{u}{l} \map{S}^{u}
%\\
%		\map{\btbra{l_i: S_i}_{i \in I}}^{u} &=& \bbra{k}{l_i: \map{S_i}^{u}}_{i \in I}
%		\\

%		\map{\tvar{t}}^{u} &=& \rvar{X}_{\tvar{t}}
%\\
%		\map{\trec{t}{S}}^{u} &=& \mu \rvar{X}_{\tvar{t}}.\map{S}^{u}
%		\\

%		\map{\btout{\lhot{C}} S}^{u} &=& \bout{u}{\abs{x}{\map{C}^{x}}} \map{S}^u
%\\
%		\map{\btinp{\lhot{C}} S}^{u} &=& \binp{u}{x} (\map{S}^u \Par \appl{x}{n}) & {n}\textrm{ fresh}
%		\\
%		\map{\btout{\shot{C}} S}^{u} &=& \bout{u}{\abs{x}{\map{C}^{x}}}
%\map{S}^u \\
%		\map{\btinp{\shot{C}} S}^{u} &=& \binp{u}{x} (\map{S}^u \Par \appl{x}{n}) & n\textrm{ fresh}
%		\\

%%		\map{\btinp{\chtype{S}} S}^{k} &=& \binp{k}{x} (\map{S}^k \Par \map{\chtype{S}}^y)
%%		&&
%%		\map{\btout{\chtype{S}} S}^{k} &=& \bout{k}{a} \map{S}^k  & a\textrm{ fresh}
%%		\\
%		\map{\tinact}^{u} &=& \inact
%\\
%		\map{\chtype{S}}^{u} &=& \bout{u}{s} \inact &s\textrm{ fresh}
%\\
%		\map{\chtype{\lhot{C}}}^{u} &=& \bout{u}{\abs{x} \map{C}^{x}} \inact
%		\\
%		\map{\chtype{\shot{C}}}^{u} &=& \bout{u}{\abs{x} \map{C}^{x}} \inact
%	\end{array}
%	\]
%\end{definition}


%\noi Characteristic processes are inhabitants of their associated type:

%\begin{proposition}[Characteristic Processes]\rm
%\label{pro:characteristic}
%\begin{enumerate}
%\item $\Gamma; \emptyset; \Delta \cat u:S \proves \mapchar{S}{u} \hastype \Proc$; and $\Gamma \cat u:\chtype{S}; \emptyset; \Delta \proves \mapchar{\chtype{S}}{u} \hastype \Proc$; and 
%\item  	If $\Gamma; \emptyset; \Delta \proves \mapchar{C}{u} \hastype \Proc$
%	then
%	$\Gamma; \es; \Delta \proves u \hastype C$.
%\end{enumerate}
%\end{proposition}
%%\begin{IEEEproof}
%%	By induction on $\mapchar{S}{u}$, $\mapchar{\chtype{S}}{u}$
%%and $\mapchar{C}{u}$. 
%%\end{IEEEproof}

%\noi We can verify that characteristic processes/values  
%do inhabit their associated type. %; the proof is by induction on types. 
\begin{proposition}%[Characteristic Processes/Values Inhabit Their Types]
%	\begin{itemize}
		%\item	
		Let $S$ be a session type. Then $\Gamma; \es; \Delta \cat s: S \proves \mapchar{S}{s} \hastype \Proc$.
		%\item	
		Also, let $\chtype{U}$ be a first-order (channel) type. Then $\Gamma \cat a: \chtype{U}; \es; \Delta \proves \mapchar{\chtype{U}}{a} \hastype \Proc$.
%	\end{itemize}
\end{proposition}

The following example motivates the refined 
LTS explained in %\secref{sec:overview}.
the introduction.




%\begin{proof}
%	By induction on the definition of $\mapchar{U}{n}$.
%\end{proof}

%\begin{example}
%	Consider the type $U = \shot{(\shot{(\shot{(\btout{S} \tinact)})})}$.
%	It is easy to verify that %the characteristic process %of the above type is:
%	$\mapchar{\btinp{U} \inact}{s} = \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{n})}}$, for some fresh $n$.
%%%
%%	\begin{eqnarray*}
%%		\mapchar{\btinp{U} \inact}{s} = && \binp{s}{x} \mapchar{\shot{(\shot{(\shot{(\btout{S} \tinact)})})}}{x}\\
%%		= && \binp{s}{x} \appl{x}{\omapchar{\shot{(\shot{(\btout{S} \tinact)})}}}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\mapchar{\shot{(\btout{S} \tinact)}}{y}})}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{\omapchar{\btout{S} \tinact}})}}\\
%%		= && \binp{s}{x} \appl{x}{(\abs{y}{\appl{y}{n})}}\\
%%	\end{eqnarray*}
%%%
%\end{example}


\begin{example}[The Need for Refined Typed LTS]
\label{ex:motivation}
We show that observing a characteristic value
input alone is not enough
\dk{to define a sound bisimulation closure}.
Consider   processes % $P_1, P_2$:
%
\begin{eqnarray}
	P_1 = \binp{s}{x} (\appl{x}{s_1} \Par \appl{x}{s_2}) 
	& & 
	P_2 = \binp{s}{x} (\appl{x}{s_1} \Par \binp{s_2}{y} \inact) 
	\label{equ:6}
\end{eqnarray}
%
%We can show that 
where
$\Gamma; \es; \Delta \cat s: \btinp{\shot{(\btinp{C} \tinact)}} \tinact \proves P_i \hastype \Proc$ ($i \in \{1,2\}$).
If $P_1$ and $P_2$ input and substitute over $x$
the characteristic value $\dk{\omapchar{\shot{(\btinp{C} \tinact)}} =} \abs{x}{\binp{x}{y} \inact}$, 
then they evolve into:%(\ref{eq:5}) and (\ref{eq:6}) in become:
\begin{center}
%\begin{tabular}{c}
	$\Gamma; \es; \Delta \proves \binp{s_1}{y} \inact \Par \binp{s_2}{y} \inact \hastype \Proc$
%\end{tabular}
\end{center}
\noi therefore becoming 
context bisimilar.
%after the input of $\abs{x}{\binp{x}{y}} \inact$.
However, the processes in (\ref{equ:6}) 
are clearly {\em not} context bisimilar: many input actions
may be used to distinguish them.
For example, if 
$P_1$ and $P_2$ input 
$\abs{x} \newsp{s}{\bout{a}{s} \binp{x}{y} \inact}$ with
$\Gamma; \es; \Delta \proves s \hastype \tinact$,
then their derivatives are not bisimilar. 

Observing only the characteristic value 
results in an under-discriminating bisimulation.
However, if a trigger value
$\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}$ 
is received on $s$, 
 we can distinguish $P_1$, $P_2$ 
%processes 
in~\eqref{equ:6}:  
%
\begin{eqnarray*}
%	\Gamma; \es; \Delta &\proves& 
	P_1 \By{\ell} \binp{t}{x} (\appl{x}{s_1}) \Par 
\binp{t}{x} (\appl{x}{s_2})
%\hastype \Proc
	\mbox{~and~}
%	\Gamma; \es; \Delta &\proves& 
	P_2 \By{\ell} \binp{t}{x} (\appl{x}{s_1}) \Par \binp{s_2}{y} \inact 
%\hastype \Proc
\quad \textrm{($\ell = s?\ENCan{\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}}$)}
\end{eqnarray*}
\normalsize
%\noi resulting two distinct processes.  
%
%\noi where 
%$\ell = s?\ENCan{\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}}$.
One question is whether the trigger value is enough
to distinguish two processes (hence no need of 
characteristic values). % as the input. 
This is not the case: the trigger value
alone also results in an under-discriminating bisimulation relation.
In fact, the  trigger value can be observed on any input prefix
of {\em any type}. For example, consider processes
%
\begin{eqnarray}
%	\Gamma; \es; \Delta \proves 
\newsp{s}{\binp{n}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_1} \inact} 
%\hastype \Proc
\ \mbox{and}\ 
%	\Gamma; \es; \Delta \proves 
\newsp{s}{\binp{n}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_2} \inact} 
%\hastype \Proc
\label{equ:7}\label{equ:8}
\end{eqnarray}
%
\noi If these processes %in \eqref{equ:7}/\eqref{equ:8}
input the trigger value, we obtain: % they evolved to 
\begin{eqnarray*}
%\Gamma; \es; \Delta \proves 
	\newsp{s}{\binp{t}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_1} \inact} 
%\hastype \Proc
	\mbox{ and }
%      \\
%\Gamma; \es; \Delta \proves 
	\newsp{s}{\binp{t}{x} (\appl{x}{s}) \Par \bout{\dual{s}}{\abs{x} R_2} \inact}
%\hastype \Proc
\end{eqnarray*}

\noi thus we can easily derive a bisimulation closure if we 
assume a bisimulation definition that allows only trigger value input.
%
%\noi It is easy to obtain a closure if allow only the
%trigger value as the input value. 
But if processes in \eqref{equ:7}
input the characteristic value $\abs{z}{\binp{z}{x} (\appl{x}{m})}$,  
then they would become, under appropriate $\Gamma$ and $\Delta$:
%
\begin{eqnarray*}
	\Gamma; \es; \Delta \proves \newsp{s}{\binp{s}{x} (\appl{x}{m}) \Par \bout{\dual{s}}{\abs{x} R_i} \inact} \wbc \Delta \proves R_i \subst{m}{x}
\quad (i=1,2)
%	\\
%	\Gamma; \es; \Delta \proves \newsp{s}{\binp{s}{x} (\appl{x}{m}) \Par \bout{\dual{s}}{\abs{x} Q} \inact} \wbc \Delta \proves Q \subst{m}{x}
\end{eqnarray*}
\noi which are not bisimilar if $R_1 \subst{m}{x} \not\wbc R_2 \subst{m}{x}$.
%\qed
%In conclusion, these examples explain a need of both 
%trigger and characteristic values 
%as an input observation in the input transition relation (\eltsrule{RRcv})
%which will be defined in Definition~\ref{def:rlts}.  
\end{example}

%\noi We define the \emph{refined} typed LTS. 
\noi As explained in 
%\secref{sec:overview}, 
the introduction,
we define the
\emph{refined} typed LTS
by considering a transition rule for input in which admitted values are
trigger or characteristic values or names:

%\noi We define the \emph{refined} typed LTS. 
%As explained in \secref{subsec:intro:bisimulation}, this new LTS is defined 
%by considering a transition rule for input in which admitted values are
%trigger or characteristic values:
%\dk{(assume extension of the structural
%congruence to acommodate values: i) $\abs{x}{P} \scong \abs{x}{Q}$ if
%$P \scong Q$) and ii) $n \scong m$ if $n = n$)}: 

\begin{definition}[Refined Typed Labelled Transition Relation]
	\label{def:rlts}
	We define the environment transition rule for input actions 
	%restricted environment transition relation using the
	%following rule %using the environment transition relation defined in 
	using the input rules in \figref{fig:envLTS}:
	\[ \!\!\!
	\begin{array}{l}
%			\eltsrule{RRcv}&\tree {
%	\begin{array}{c}
%	(\Gamma_1; \Lambda_1; \Delta_1) \by{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
%	\\
%				\begin{array}{lll}
%					V = m \vee V  \scong
%					\abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}
%					\vee  V \scong \omapchar{U}%\abs{{x}}{\map{U}^{{x}}}
%					\textrm{ with } t \textrm{ fresh} 
%				\end{array}
%				\end{array}
%			}{
%				(\Gamma_1; \Lambda_1; \Delta_1) \hby{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
%			}
			
						\eltsrule{RRcv}\,\tree {
	%\begin{array}{c}
	(\Gamma_1; \Lambda_1; \Delta_1) \by{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
	\quad
					V = m 
					\vee  V \scong \omapchar{U}%\abs{{x}}{\map{U}^{{x}}}
										\vee V  \scong \abs{{x}}{\binp{t}{y} (\appl{y}{{x}})}
					\textrm{ {\small with $t$ fresh}} 
				%\end{array}
			}{
				(\Gamma_1; \Lambda_1; \Delta_1) \hby{\bactinp{n}{V}} (\Gamma_2; \Lambda_2; \Delta_2)
			}
			
			
	\end{array}
	\]
	\noi Rule $\eltsrule{RRcv}$ is defined on top
	of rules $\eltsrule{SRv}$ and $\eltsrule{ShRv}$
	in \figref{fig:envLTS}.
%	uses the environment transition
%	$(\Gamma, \Lambda_1, \Delta_1) \hby{\ell} (\Gamma, \Lambda_2, \Delta_2)$
%	in \figref{fig:envLTS}. 
\dk{	We  use the non-receiving rules in \figref{fig:envLTS}
	together with rule $\eltsrule{RRcv}$
	to define 
	$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_2}{P_2}$
	as in \defref{d:tlts}.}
%	by replacing $\by{\ell}$ by $\hby{\ell}$ in \defref{d:tlts}. 
\end{definition}

\noi Notice that
$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_2}{P_2}$ (refined transition) implies  
$\horel{\Gamma}{\Delta_1}{P_1}{\by{\,\ell\,}}{\Delta_2}{P_2}$ (ordinary transition).
Below we sometimes write  
$\hby{\news{\widetilde{m}} \bactout{n}{\AT{V}{U}}}$
when the type of $V$ is~$U$.

%See \exref{ex:motivation} for the reason why {\em both} 
%the trigger values ($\lambda x.\binp{t}{y} (\appl{y}{{x}})$) 
%and characteristic values ($\lambda x.\map{U}^{{x}}$) are required 
%to define the following two bisimulations. 

\smallskip 

\myparagraph{Characteristic Bisimulations.} We define 
%\emph{higher-order} and
\emph{characteristic
bisimulations}, 
%two tractable bisimulations for $\HO$ and $\HOp$.
a tractable bisimulation for $\HOp$.
As 
%explained in %\secref{sec:overview},
%the Introduction,
hinted at above, 
%the two bisimulations 
%characteristic bisimulations
their definition
uses trigger processes (cf.~\eqref{eq:4}):
%the key difference between them is in the trigger processes they use:
\begin{eqnarray*}
%\htrigger{t}{V_1}  & \defeq &  \hotrigger{t}{V} \label{eqb:0} \\
	\ftrigger{t}{V}{U} & \defeq &  \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V} 	\label{eqb:4}
\end{eqnarray*}
%\noi
%Notice that while 
%in~\eqref{eqb:0} there is a higher-order input on $t$, 
%in~\eqref{eqb:4} variable $x$ does not play any role.
% \dk{The two bisimulations differ on the fact that
%they use the different 
%trigger processes: $\htrigger{t}{V}$ and $\ftrigger{t}{V}{U}$.}

%\begin{definition}[Higher-Order Bisimilarity]\rm
%	\label{d:hbw}
%A typed relation $\Re$ is a {\em  HO bisimulation} if 
%for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$ 
%\begin{enumerate}[1)]
%\item 
%Whenever 
%$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}$, there exist 
%$Q_2$, $V_2$, $\Delta'_2$ such that 
%$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}$ and, for fresh $t$, 
%\[
%\begin{array}{lrlll}
%\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par 
%\htrigger{t}{V_1}}}
%\ \Re 
%\ \Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
%\end{array}
%\]
%		\item	
%For all $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$ such that 
%$\ell$ is not an output, 
% there exist $Q_2$, $\Delta'_2$ such that 
%$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}$
%			and
%			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and 
%
%                      \item	The symmetric cases of 1 and 2.                
%	\end{enumerate}
%	The largest such bisimulation
%	is called \emph{higher-order bisimilarity} \jpc{and} denoted by $\hwb$.
%\end{definition}

 
%We define characteristic bisimilarity:
% is given using characteristic trigger processes. 

\begin{definition}[Characteristic Bisimilarity]\rm
	\label{d:fwb}
A typed relation $\Re$ is a {\em  characteristic bisimulation} if 
for all $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re \ }{\Delta_2}{Q_1}$, 
\begin{enumerate}[1)]
\item 
	Whenever 
	$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{\dk{V_1: U}}}}{\Delta_1'}{P_2}$ %with $\Gamma; \es; \Delta \proves V_1 \hastype U$,  
	then there exist 
	$Q_2$, $V_2$, $\Delta'_2$ such that 
	$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}}\bactout{n}{\dk{V_2: U}}}}{\Delta_2'}{Q_2}$ %with $\Gamma; \es; \Delta' \proves V_2 \hastype U$,  
	and, for fresh $t$, \\ 
	$%\begin{array}{lrlll}
	\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par 
	\ftrigger{t}{V_1}{U_1}}}
	  \,\Re\,
	 \Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \ftrigger{t}{V_2}{U_2}}}
%\end{array}
$
		
\item	
For all $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$ such that 
$\ell$ is not an output, 
 there exist $Q_2$, $\Delta'_2$ such that 
$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}$
			and
			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re \ }{\Delta_2'}{Q_2}$; and 

                      \item	The symmetric cases of 1 and 2.                
	\end{enumerate}
	The largest such bisimulation
	is called \emph{characteristic bisimilarity} \jpc{and} denoted by $\fwb$.
\end{definition}

%\smallskip 

%\begin{definition}[Characteristic Bisimilarity]\rm
%	\label{d:fwb}
%	Characteristic bisimilarity, denoted by $\fwb$, is defined \jpc{by} replacing 
%	Clause 1) in \defref{d:hbw} with the following clause:\\[1mm]
%	Whenever 
%	$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{\dk{V_1: U}}}}{\Delta_1'}{P_2}$ %with $\Gamma; \es; \Delta \proves V_1 \hastype U$,  
%	then there exist 
%	$Q_2$, $V_2$, $\Delta'_2$ such that 
%	$\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}}\bactout{n}{\dk{V_2: U}}}}{\Delta_2'}{Q_2}$ %with $\Gamma; \es; \Delta' \proves V_2 \hastype U$,  
%	and, for fresh $t$, \\[1mm]
%	$\begin{array}{lrlll}
%	\!\!\Gamma; \Delta''_1  \proves  {\newsp{\widetilde{m_1}}{P_2 \Par 
%	\ftrigger{t}{V_1}{U_1}}}
%	\ \!\!\Re\!\!
%	\ \Delta''_2 \proves {\newsp{\widetilde{m_2}}{Q_2 \Par \ftrigger{t}{V_2}{U_2}}}
%\end{array}
%$
%\end{definition}
%
%\smallskip 

\noi Internal transitions associated to session interactions or  
$\beta$-reductions are deterministic.  
		
\begin{definition}[Deterministic Transition]\myrm
\label{def:dettrans}
	Let  $\Gamma; \es; \Delta \proves P \hastype \Proc$ be a balanced \HOp process. 
	Transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is called
%\vspace{-2mm}
%	\begin{enumerate}[$-$]
%		\item 
		{\em session transition} whenever the   transition $P \by{\tau} P'$ 
		is derived using 
			rule~$\ltsrule{Tau}$ 
		(where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise 
		are dual endpoints), 
		possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/
		\ltsrule{Par${}_R$}$.
		
		%\item
		Transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is called
			{\em \betatran}	whenever the   transition $P \by{\tau} P'$
			is derived using rule $\ltsrule{App}$,
			possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/
		\ltsrule{Par${}_R$}$. \\
%	\end{enumerate}
%
%We write
%$\horel{\Gamma}{\Delta}{P}{\hby{\stau}}{\Delta'}{P'}$
%and 
%$\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$
%to denote session and $\beta$-transitions, resp. Also, 
	 $\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ denotes
	either a session transition or a \betatran.
\end{definition}
%Deterministic transitions imply the $\tau$-inertness property, which
%is a property that ensures behavioural invariance on deterministic
%transitions.

\begin{proposition}[$\tau$-inertness]\myrm
	\label{lem:tau_inert}
Let  $\Gamma; \es; \Delta \proves P \hastype \Proc$ be a balanced \HOp process.
	Then
%	\begin{enumerate}[1.]
%\item	
$\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ implies
			$\horel{\Gamma}{\Delta}{P}{\fwb}{\Delta'}{P'}$.
%		\item	$\horel{\Gamma}{\Delta}{P}{\Hby{\dtau}}{\Delta'}{P'}$ implies
%			$\horel{\Gamma}{\Delta}{P}{\wb}{\Delta'}{P'}$.
%	\end{enumerate}
\end{proposition}
\noi 
See App.~\ref{app:sub_tau_inert} for the proofs. 
Our main theorem follows: %typed bisimilarities collapse for \HOp processes. 
it allows us to use $\fwb$ as a tractable reasoning %is the most tractable 
technique for higher-order processes with sessions.

%\smallskip 

\begin{theorem}[Coincidence]\rm
%	\label{the:coincidence}
%$\cong$, $\wbc$, $\hwb$ and $\fwb$ coincide in $\CAL\in \{\HOp, \HO\}$
%and 
%$\cong$, $\wbc$ and $\fwb$ coincide in $\CAL\in \{\HOp, \HO, \sessp\}$. 
	\label{the:coincidence}
$\cong$, $\wbc$,  and $\fwb$ coincide in $\HOp$. 
\vspace{-1mm}
\end{theorem}
\begin{proof}[Proof (Sketch)]
We use 
\emph{higher-order bisimilarity} ($\hwb$, see \defref{def:bisim}), 
an auxiliary equivalence that
is defined as $\fwb$ but by
using  trigger processes with higher-order communication (cf.~\eqref{equ:2}).
We first show that $\fwb$ and $\hwb$ coincide by using~\propref{lem:tau_inert}; 
then, we show that $\hwb$ coincides with $\wbc$ and $\cong$. 
A key result is a  substitution lemma which simplifies reasoning 
for $\hwb$
by exploiting characteristic processes/values.
See
\appref{app:beh}
and~\cite{KouzapasPY15} for full details.
\end{proof}
Now we prove 
that  processes 
$\Client_1$ and $\Client_2$ 
in Example \ref{exam:proc}
are behaviourally equivalent.

\begin{proposition}\label{p:examp}
	Let
	$S = \btout{\rtype} \btinp{\Quote} \btsel{\accept: \btout{\creditc} \tinact, \reject: \tinact}$ and 
$\Delta = s_1: \btout{\lhot{S}} \tinact \cat s_2: \btout{\lhot{S}} \tinact$. 
Then
	$ \horel
	{\es}{\Delta}{\Client_1}
	{\wbf}
	{\Delta}{\Client_2}$. %and $\Client_1$, $\Client_2$ in Example \ref{exam:proc}. 
\vspace{-2mm}
\end{proposition}
\begin{proof}[Proof (Sketch)]
	\noi We show a bisimulation closure by following transitions on each $\Client$.
	%We show the initial higher order transitions.
	See \appref{hotel_closure} for details.
	First, the characteristic process is given as:
	$\mapchar{\btinp{\lhot{S}} \tinact}{s} = \binp{s}{x} (\appl{x}{k})$.
We show that the clients can simulate each other on
the first two output transitions, that also generate the trigger
processes:
%
\[
	\begin{array}{lll}
&	\es; \es; \Delta \proves \Client_1
	&
		\by{\bactout{s_1}{\abs{x}{P_{xy} \subst{h_1}{y}}}}
		\by{\bactout{s_2}{\abs{x}{P_{xy} \subst{h_2}{y}}}}
		\\
&		\es; \es; k_1: S \cat k_2: S \proves
		&
		\newsp{h_1, h_2}{\binp{\dual{h_1}}{x} \binp{\dual{h_2}}{y}\\
&		& \If\ x \leq y\ \Then (\bsel{\dual{h_1}}{\accept} \bsel{\dual{h_2}}{\reject} \inact
		\Else \bsel{\dual{h_1}}{\reject} \bsel{\dual{h_2}}{\accept} \inact)\\
&		& \Par \ftrigger{t_1}{\abs{x}{P_{xy} \subst{h_1}{y}}}{\lhot{S}} \Par \ftrigger{t_2}{\abs{x}{P_{xy} \subst{h_2}{y}}}{\lhot{S}}}
%		& \Par \binp{t_1}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_1} \Par \bout{\dual{s}}{\abs{x}{P \subst{h_1}{y}}} \inact }\\
%		& \Par \binp{t_2}{x} \newsp{s}{\mapchar{\btinp{\lhot{S}}}{s} \Par \bout{\dual{s}}{\abs{x}{P \subst{h_2}{y}}} \inact }}
		\\[1mm]
\mbox{and} &
		\es; \es; \Delta \proves \Client_2
		&\by{\bactout{s_1}{\abs{x}{Q_1 \subst{h}{y}}}}
		\by{\bactout{s_2}{\abs{x}{Q_2 \subst{\dual{h}}{y}}}}
		\\
&		\es; \es; k_1: S \cat k_2: S \proves & \newsp{h}{
		\ftrigger{t_1}{\abs{x}{Q_1 \subst{h}{y}}}{\lhot{S}} \Par \ftrigger{t_2}{\abs{x}{Q_2 \subst{\dual{h}}{y}}}{\lhot{S}}}
%		\binp{t_1}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_1} \Par \bout{\dual{s}}{\abs{x}{P_1 \subst{h}{y}}} \inact }\\
%		&\Par \binp{t_2}{x} \newsp{s}{\binp{s}{x} \appl{x}{k_2} \Par \bout{\dual{s}}{\abs{x}{P_2 \subst{\dual{h}}{y}}} \inact }}
	\end{array}
\]
	\noi 
After these transitions, 
we can analyse that 
the resulting processes are behaviourally equivalent
since they have the same visible transitions; the rest 
is internal deterministic transitions. 
\end{proof}

%\smallskip 

%\noi 
%Thus, we may use $\hwb$ for tractable reasoning %is the most tractable 
%in the higher-order setting;  
%%the calculus is limited  
%%the $\sessp$-calculus, 
%%into~\jpc{\sessp}
%in the first-order setting of $\sessp$
%we can still use~$\fwb$. 



%PERHAPS REVISIT EXAMPLE \ref{ex:motivation}??


%\smallskip  
%
%\noi Processes that do not use shared names are inherently deterministic. 
%The following \jpc{determinacy property will be} useful 
%\dk{for proving our expressiveness results (\secref{sec:positive})}.
%%for both positive and negative results. 
%We require an auxiliary definition. 
%A transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is said
%		{\em deterministic} if it is derived using~$\ltsrule{App}$ or~$\ltsrule{Tau}$ 
%		(where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise 
%		are dual endpoints), 
%		possibly followed by uses of  $\ltsrule{Alpha}$, $\ltsrule{Res}$, $\ltsrule{Rec}$, or $\ltsrule{Par${}_L$}/\ltsrule{Par${}_R$}$.
%
%
%%\smallskip 
%
%\begin{lemma}[$\tau$-Inertness]\rm
%	\label{lem:tau_inert}
%	\begin{enumerate}[1)]
%		\item %(deterministic transitions) 
%		Let $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ be a deterministic transition,
%		with balanced $\Delta$. Then 
%		$\Gamma; \Delta \proves P \cong \Delta'\proves P'$ 
%		with $\Delta \red^\ast \Delta'$ balanced.
%%		Transition $\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ is called
%%		{\em deterministic} if it is derived by $\ltsrule{App}$ or 
%%		$\ltsrule{Tau}$ where $\subj{\ell_1}$ and $\subj{\ell_2}$ in the premise 
%%		are dual session names. Suppose $\Delta$ is balanced. Then 
%%		$\Gamma; \Delta \proves P \cong \Delta'\proves P'$ 
%%		with $\Delta \red^\ast \Delta'$ balanced. 
%		\item 
%		%Let $P$ is the $\HOp^{-\mathsf{sh}}$-calculus. 
%		Let $P$ be an $\HOp^{-\mathsf{sh}}$ process. 
%		Assume $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. Then 
%		$P \red^\ast P'$ implies $\Gamma; \Delta \proves 
%		P \cong \Delta'\proves P'$ with $\Delta \red^\ast \Delta'$. 
%	\end{enumerate}
%\end{lemma}


%\smallskip 


%\begin{IEEEproof}
%	The full details of the proof are in Appendix~\ref{app:sub_coinc}.
%	The theorem is split into a hierarchy of Lemmas. Specifically
%	Lemma~\ref{lem:wb_eq_wbf} proves 
%	$\wb$ coincides with $\fwb$; 
%	Lemma~\ref{lem:wb_is_wbc} exploits the process substitution result
%	(Lemma~\ref{lem:proc_subst}) to prove that $\hwb \subseteq \wbc$.
%	Lemma~\ref{lem:wbc_is_cong} shows that $\wbc$ is a congruence
%	which implies $\wbc \subseteq \cong$.
%	The final result comes from Lemma~\ref{lem:cong_is_wb} where
%	we use label testing to show that $\cong \subseteq \fwb$ using
%	the technique in developed in~\cite{Hennessy07}. The formulation of input
%	triggers in the bisimulation relation allows us to prove
%	the latter result without using a matching operator.
%\end{IEEEproof}

%\smallskip 

%\noi Processes that do not use shared names, are inherently $\tau$-inert.

%\smallskip 

%\begin{lemma}[$\tau$-inertness]\rm
%	\label{lem:tau_inert}
%	Let $P$ is the $\HOp^{-\mathsf{sh}}$-calculus. 
%Assume $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. Then 
%$P \red^\ast P'$ implies $\Gamma; \Delta \proves 
%P \cong \Delta'\proves P'$ with $\Delta \red^\ast \Delta'$. 
%\end{lemma}


%\begin{IEEEproof}
%	The proof is relied on the fact that processes of the
%	form $\Gamma; \es; \Delta \proves_s \bout{s}{V} P_1 \Par \binp{k}{x} P_2$
%	cannot have any typed transition observables and the fact
%	that bisimulation is a congruence.
%	See details in Appendix~\ref{app:sub_tau_inert}.
%	\qed
%\end{IEEEproof}

