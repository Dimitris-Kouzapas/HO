% !TEX root = main.tex

%\section{Behavioural Semantics}

We present the proofs for 
\thmref{the:coincidence} (Page \pageref{the:coincidence}).
We require an auxiliary result on 
deterministic transitions (\lemref{lem:up_to_deterministic_transition}).
Some notions needed to prove this auxiliary result are presented next.
%Then we present the proof of \thmref{the:coincidence}, based on \emph{higher-order bisimilarity}.

%As mentioned in the paper, 
%the proof of \thmref{the:coincidence}
%relies on an auxiliary typed behavioral equivalence, \emph{higher-order bisimilarity}:

%\begin{definition}[Higher-Order Bisimulation]\myrm
%	\label{def:bisim}
%	Typed relation
%	$\Re$ is a {\em higher-order bisimulation} if for all
%	$\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{Q_1}$, % implies:
%%
%	\begin{enumerate}[1.]
%		\item	%$\forall \news{\widetilde{m_1}} \bactout{n}{V_1}$ such that
%		   Whenever 
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}
%			$
%			there exist $Q_2$, $V_2$, $\Delta_2'$ such that
%			\[
%				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}
%			\]
%			and, for a fresh $t$, 
%			$
%				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
%				{\ \Re\ }
%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}$.
%			
%%
%		\item	For all 
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
%			$
%			such that $\ell \not= \news{\widetilde{m}} \bactout{n}{V}$, there exist
%			 $\exists Q_2$ and $\Delta_2'$ such that 
%			\[
%				\horel{\Gamma}{\Delta_1}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re\ }{\Delta_2'}{Q_2}$.
%
%		\item	The symmetric cases of 1 and 2.
%	\end{enumerate}
%	The Knaster-Tarski theorem ensures that the largest higher-order bisimulation exists;
%	it is called \emph{higher-order bisimilarity} and is denoted by $\hwb$.
%\end{definition}
In this appendix, we use the polyadic abstractions and name passing 
for shorthand notations. 

%\smallskip


%the theorem in \secref{sec:behavioural}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% tau - Innertness
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Deterministic Transitions}
\label{app:sub_tau_inert}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    TAU - INNERTNESS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{proposition}[$\tau$-inertness]
	\label{app:lem:tau_inert}
	Let  $\Gamma; \es; \Delta \proves P \hastype \Proc$ be a balanced \HOp process.
	Then
	\begin{enumerate}[1.]
		\item	$\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ implies
			$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
		\item	$\horel{\Gamma}{\Delta}{P}{\Hby{\dtau}}{\Delta'}{P'}$ implies
			$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
	\end{enumerate}
\end{proposition}

%\jp{This proof seems to be by induction on deterministic transition; but then the analysis is on the structure of processes,
%which is confusing. In general: I would have done this proof by coinduction, constructing a closure containing $(P, P')$.}

\begin{proof}
	\noi 
	We prove Part 1 --- the proof for Part 2 follows straightforwardly.
	The proof is by induction on the structure of $\by{\tau}$
	which coincides the reduction $\red$.

	\noi Basic step:
	\begin{enumerate}
		\item %Case: $P = \appl{(\abs{x}{P})}{n}$:
	%
		\[
			\horel{\Gamma}{\Delta}{\appl{(\abs{x}{P})}{n}}{\hby{\btau}}{\Delta'}{P \subst{n}{x}}
		\]
	%
		\noi Bisimulation requirements hold because there is no other transition to observe than ${\hby{\btau}}$.

		\item %Case: $P = \bout{s}{V} P_1 \Par \binp{\dual{s}}{x} P_2$:
	%
		\[
			\horel{\Gamma}{\Delta}{\bout{s}{V} P_1 \Par \binp{\dual{s}}{x} P_2}{\hby{\stau}}{\Delta'}{P_1 \Par P_2}
		\]
	%
		\noi The proof follows from the fact that we can only observe a $\tau$
		action on typed process
		$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
		Actions $\bactout{s}{V}$ and $\bactinp{\dual{s}}{V}$
		are forbidden by the LTS for typed environments;
		\dk{this is because
		$s: \btout{U} S_1 \cat \dual{s}: \btinp{U} S_2 \in \Delta$ and
		rule \eltsrule{SSnd} (resp., \eltsrule{SRv}) cannot be applied
		in order to observe action $(\Gamma; \es; \Delta) \by{\bactout{s}{V}} (\Gamma; \es; \Delta')$
		(resp., action $(\Gamma; \es; \Delta) \by{\bactinp{\dual{s}}{V}} (\Gamma; \es; \Delta'')$)
		because of the requirement $\dual{s} \notin \dom{\Delta}$ (resp., $s \notin \dom{\Delta}$).
		}

		\noi It is easy to conclude then that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.

		\item %Case:
			\[
				\horel{\Gamma}{\Delta}{\bsel{s}{l_k} P \Par \bbra{\dual{s}}{l_i: P_i}_{i \in I}}{\hby{\stau}}{\Delta'}{P \Par P_k}
			\]

		\noi Similar arguments as the previous case.
	\end{enumerate}
	
	\noi Induction hypothesis:

	\noi If $P_1 \red P_2$ then $\horel{\Gamma_1}{\Delta_1}{P_1}{\hwb}{\Delta_2}{P_2}$.
	\noi Induction Step:
	\begin{enumerate}
		\item %Case: $P = \news{s} P_1$
	%
		\[
			\horel{\Gamma}{\Delta}{\news{s}{P_1}}{\hby{\stau}}{\Delta'}{\news{s} P_2}
		\]
	%
		\noi From the induction hypothesis and the fact that bisimulation is a congruence
		we get that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.

		\item  %Case: $P = P_1 \Par P_3$
	%
		\[
			\horel{\Gamma}{\Delta}{P_1 \Par P_3}{\hby{\stau}}{\Delta'}{P_2 \Par P_3}
		\]
	%
		\noi From the induction hypothesis and the fact that bisimulation is a congruence
		we get that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.

		\item   %Case:
			\[
				P \scong P_1 \text{ and }\horel{\Gamma}{\Delta}{P_1}{\hby{\stau}}{\Delta'}{P'}
			\]
%
		From the induction hypothesis and the fact that bisimulation is a congruence \dk{(\thmref{the:coincidence})}
		and structural congruence preserves $\hwb$
		we get that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
	\end{enumerate}
%	The proof for part two is an induction on the length of $\red^*$.
%	The basic step is trivial and the inductive step
%	deploys part 1 of this lemma and the fact that bisimulation is
%	transitive to conclude.
%	We can now conclude that
%	$P \wbc P'$ because $P \wbc P''$ and $P'' \wbc P'$.
	\qed
\end{proof}


%\begin{lemma}[Up-to Deterministic Transition]\myrm
%	\label{lem:up_to_deterministic_transition}
%	Let $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{Q_1}$ such
%	that if whenever:
%%
%	\begin{enumerate}
%		\item	$\forall \news{\widetilde{m_1}} \bactout{n}{V_1}$ such that
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_3}{P_3}
%			$
%			implies that $\exists Q_2, V_2$ such that
%			\[
%				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			\[
%				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
%			\]
%			and for fresh $t$:
%			\[
%				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
%				{\ \Re\ }
%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
%%				\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \hotrigger{t}{x}{s}{V_1}}}
%%				{\ \Re\ }
%%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \hotrigger{t}{x}{s}{V_2}}}
%			\]
%%
%		\item	$\forall \ell \not= \news{\widetilde{m}} \bactout{n}{V}$ such that
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_3}{P_3}
%			$
%			implies that $\exists Q_2$ such that 
%			\[
%				\horel{\Gamma}{\Delta_1}{Q_1}{\hat{\Hby{\ell}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			\[
%				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
%			\]
%			and
%			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re\ }{\Delta_2'}{Q_2}$
%
%		\item	The symmetric cases of 1 and 2.
%	\end{enumerate}
%	Then $\Re\ \subseteq\ \wb$.
%\end{lemma}
%
%
%\begin{proof}
%	The proof is easy by considering the closure
%	\[
%		\Re^{\Hby{\dtau}} = \set{ \horel{\Gamma}{\Delta_1'}{P_2}{,}{\Delta_2'}{Q_1} \setbar \horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2'}{Q_1},
%		\horel{\Gamma}{\Delta_1}{P_1}{\Hby{\dtau}}{\Delta_1'}{P_2} }
%	\]
%	We verify that $\Re^{\Hby{\dtau}}$ is a bisimulation with
%	the use of \propref{app:lem:tau_inert}.
%	\qed
%\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%          COINCIDENCE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Proof of \thmref{the:coincidence}}
\label{app:sub_coinc}


\noi We split the proof of \thmref{the:coincidence} (Page \pageref{the:coincidence}) into 
several lemmas:
\begin{enumerate}[$-$]
\item	\lemref{app:lem:wb_eq_wbf} establishes $\hwb\ =\ \fwb$.
\item	\lemref{app:lem:wb_is_wbc} exploits the process substitution result
		(\lemref{app:lem:proc_subst}) to prove that $\hwb \subseteq \wbc$.
\item	\lemref{app:lem:wbc_is_cong} shows that $\wbc$ is a congruence
		which implies $\wbc \subseteq \cong$.
\item	\lemref{app:lem:cong_is_wb} shows  that $\cong \subseteq \hwb$.
\end{enumerate}

%By the combination of the lemmas, we can obtain the theorem.

\noi
We now proceed to state and prove these lemmas, together with some auxiliary results.
%\thmref{app:thm:coincidence} (Page~\pageref{app:thm:coincidence}) summarises the coincidence result.

The next lemma states a form of equivalence between the characteristic
and higher order trigger processes.

\begin{lemma}[Trigger Process Equivalence]
	\label{lem:trigger_equiv}
	Let $P$ and $Q$ be processes, $t$ be a fresh name, and
	let $\Gamma; \es; \Delta \proves V_i \hastype U, i \in \set{1, 2}$

	\begin{enumerate}[1)]
		\item	If
				\[
					\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
					{\hwb}
					{\Delta_2}{}{\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2} }}
				\]
				then for $\Delta_1', \Delta_2'$
				\[
					\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
					{\hwb}
					{\Delta_2'}{}{\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
				\]

		\item	If
				\[
					\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
					{\fwb}
					{\Delta_2}{}{\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
				\]
				then for $\Delta_1', \Delta_2'$
				\[
					\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
					{\fwb}
					{\Delta_2'}{}{\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2} }}
				\]
	\end{enumerate}
\end{lemma}

\begin{proof}
	\begin{enumerate}
		\item	Part 1

				\noi Consider the typed relation (for readability, we omit type information):
				\begin{eqnarray*}
					\Re	&=&		\set{	(\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1} },
										\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}})
								\setbar\\
						&&			\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
									{\hwb}
									{\Delta_2'}{}{\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2}}}
						\\
						&&		}
				\end{eqnarray*}
				%
				We show that $\Re \subseteq \hwb$.
				We distinguish four cases, depending on the source/kind of visible action: 
				\begin{enumerate}
					\item	Case
						%
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1} }}
							{\hby{\ell_1}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}'}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2} }}
						\]
						%
							then following the requirements of $\Re$ and the freshness of $t$
							we can conclude that there exists $\Delta_1''$ such that
						%
						\[
							\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
							{\hby{\ell_1}}
							{\Delta_1''}{}{\newsp{\widetilde{m_1}'}{P' \Par \hotrigger{t}{x}{s}{V_2}}}
						\]
						%
							implies from the characteristic bisimilarity requirement of $\Re$ and
							the freshness of $t$ that $\exists Q', \Delta_2''$ such that
						%
							\nhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2}}}
							{\Hby{\ell_2}}
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par \hotrigger{t}{x}{s}{V_2}}}
							{proof:trig_equiv00}
						%
							and
							\nhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P' \Par \hotrigger{t}{x}{s}{V_1} \Par C_1}}
							{\hwb}
							{\Delta_2'''}{\newsp{\widetilde{m_2}''}{Q' \Par \hotrigger{t}{x}{s}{V_2} \Par C_2}}
							{proof:trig_equiv11}
						%
							with $C_1$ (resp., $C_2$) being the characteristic trigger process
							in the cases where $\ell_1 = \news{\widetilde{m}} \bactout{n}{V_1'}$ (resp., $\ell_2 = \news{\widetilde{m}'} \bactout{n}{V_2'}$)
							and $C_1 = C_2 = \inact$ otherwise.
						%
							From \eqref{proof:trig_equiv00} we can conclude that $\exists \Delta_4$ such that
						\[
							\mhorel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
							{\Hby{\ell_2}}
							{\Delta_4}{}{\newsp{\widetilde{m_2}'}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
						\]
						%
							Equation \eqref{proof:trig_equiv11} then concludes that
						\[
							\mhorel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'''}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1} \Par C_1}}
							{\Re}
							{\Delta_4'}{}{\newsp{\widetilde{m_2}'''}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2} \Par C_2}}
						\]
						%
							as required.

					\item	Case
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
%							{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}
							{\hby{\bactinp{t}{m}}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							Following requirements of $\Re$ and the freshness of $t$
							we can conclude that there exists $\Delta_1''$ such that
						%
						\[
							\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
							{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}
%							{\hby{\bactinp{t}{m}}}
							{\Delta_1''}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							implies from the higher order bisimilarity requirement of the $\Re$ definition and
							the freshness of $t$ that $\exists Q', \Delta_2''$ such that
						%
							\begin{eqnarray}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2 & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \hotrigger{t}{x}{s}{V_2}}
									\\
%									{\hby{\bactinp{t}{m}}}& & &
									{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}} & & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_2'' & \proves & Q'
								\end{array}
								\label{proof:trig_equiv22}
							\end{eqnarray}
						%
							and
						%
							\nhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
							{\hwb}
							{\Delta_2''}{\newsp{\widetilde{m_2}}{Q'}}
							{proof:trig_equiv33}
						%
							The freshness of $t$ allows us to mimic the transitions
							in \eqref{proof:trig_equiv22} to get that for $\Delta_4$
						%
							\begin{eqnarray*}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2' & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}
									\\
%									{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}& & &
									{\hby{\bactinp{t}{m}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_4 & \proves & Q'
								\end{array}
							\end{eqnarray*}
						%
							The conclusion is immediate from \eqref{proof:trig_equiv33}.


				\item \jasks{The action comes from the interaction of $P$ and $\hotrigger{t}{x}{s}{V_1}$: This case is not possible, due to the freshness of $t$.}
				\end{enumerate}


		\item	Part 2 

				\noi Consider the typed relation (for readability, we omit type information):
				\begin{eqnarray*}
					\Re	&=&		\set{	(\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}},
										\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2}})
								\setbar\\
						&&			\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
									{\fwb}
									{\Delta_2'}{}{\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
						\\
						&&		}
				\end{eqnarray*}
				%
				We show that $\Re \subseteq \fwb$. We distinguish four cases, depending on the source/kind of visible action: 
				\begin{enumerate}
					\item	Case
						%
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
							{\hby{\ell_1}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}'}{P' \Par \hotrigger{t}{x}{s}{V_1}}}
						\]
						%
							then following the requirements of $\Re$ and the freshness of $t$
							we can conclude that there exists $\Delta_1''$ such that
						%
						\[
							\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
							{\hby{\ell_1}}
							{\Delta_1''}{}{\newsp{\widetilde{m_1}'}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
						\]
						%
							implies from the characteristic bisimilarity requirement of $\Re$ and
							the freshness of $t$ that $\exists Q', \Delta_2''$ such that
						%
							\nhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
							{\Hby{\ell_2}}
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
							{proof:trig_equiv0}
						%
							and
							\nhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1} \Par C_1}}
							{\fwb}
							{\Delta_2'''}{\newsp{\widetilde{m_2}''}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2} \Par C_2}}
							{proof:trig_equiv1}
						%
							with $C_1$ (resp., $C_2$) being the characteristic trigger process
							in the cases where $\ell_1 = \news{\widetilde{m}} \bactout{n}{V_1'}$ (resp., $\ell_2 = \news{\widetilde{m}'} \bactout{n}{V_2'}$)
							and $C_1 = C_2 = \inact$ otherwise.
						%
							From \eqref{proof:trig_equiv0} we can conclude that $\exists \Delta_4$ such that
						\[
							\mhorel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \hotrigger{t}{x}{s}{V_2}}}
							{\Hby{\ell_2}}
							{\Delta_4}{}{\newsp{\widetilde{m_2}'}{Q' \Par \hotrigger{t}{x}{s}{V_2}}}
						\]
						%
							Equation \eqref{proof:trig_equiv1} then concludes that
						\[
							\mhorel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'''}{P' \Par \hotrigger{t}{x}{s}{V_1} \Par C_1}}
							{\Re}
							{\Delta_4'}{}{\newsp{\widetilde{m_2}'''}{Q' \Par \hotrigger{t}{x}{s}{V_2} \Par C_2}}
						\]
						%
							as required.

					\item	\jasks{I would probably put cases 2 and 3 within a single case, which is the case when the right-hand side process moves. }Case
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
							{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							Following requirements of $\Re$ and the freshness of $t$
							we can conclude that there exists $\Delta_1''$ such that
						%
						\[
							\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
							{\hby{\bactinp{t}{m}}}
							{\Delta_1''}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							implies from the higher order bisimilarity requirement of the $\Re$ definition and
							the freshness of $t$ that $\exists Q', \Delta_2''$ such that
						%
							\begin{eqnarray}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2 & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}
									\\
									{\hby{\bactinp{t}{m}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_2'' & \proves & Q'
								\end{array}
								\label{proof:trig_equiv2}
							\end{eqnarray}
						%
							and
						%
							\nhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_1} \inact}}}
							{\fwb}
							{\Delta_2''}{\newsp{\widetilde{m_2}}{Q'}}
							{proof:trig_equiv3}
						%
							The freshness of $t$ allows us to mimic the transitions
							in \eqref{proof:trig_equiv2} to get that for $\Delta_4$
						%
							\begin{eqnarray*}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2' & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \hotrigger{t}{x}{s}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \hotrigger{t}{x}{s}{V_2}}
									\\
									{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\map{\btinp{U} \tinact}^{s} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_4 & \proves & Q'
								\end{array}
							\end{eqnarray*}
						%
							The conclusion is immediate from \eqref{proof:trig_equiv3}.

					\item	Case
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t}{x}{s}{V_1}}}
							{\hby{\bactinp{t}{ \abs{x}{\binp{t'}{y}{\appl{y}{x}}  }}}}
							{\Delta_3'}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{  \appl{(\abs{x}{\binp{t'}{y}{\appl{y}{x}})}{s}  \Par \bout{\dual{s}}{V_1} \inact }}}}
						\]
						We show that there $\exists, \Delta_4, \newsp{\widetilde{m_1}}{Q \Par \hotrigger{t'}{x}{s}{V_1}}$ such that
						\[
							\mhorel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \hotrigger{t}{x}{s}{V_1}}}
							{\Hby{\bactinp{t}{ \abs{x}{\binp{t'}{y}{\appl{y}{x}}  }}}}
							{\Delta_4}{}{\newsp{\widetilde{m_1}}{Q \Par \hotrigger{t'}{x}{s}{V_1}}}
						\]
						and
						\[
							\mhorel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{  \appl{(\abs{x}{\binp{t'}{y}{\appl{y}{x}})}{s}  \Par \bout{\dual{s}}{V_1} \inact }}}}
							{\Hby{\tau_d}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t'}{x}{s}{V_1}}}
						\]
						The result
						\[
							\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \hotrigger{t'}{x}{s}{V_1}}}
							{\Re}
							{\Delta_4}{}{\newsp{\widetilde{m_1}}{Q \Par \hotrigger{t'}{x}{s}{V_1}}}
						\]
						is immediate from the definition of $\Re$.

				\item \jasks{The action comes from the interaction of $P$ and $\hotrigger{t}{x}{s}{V_1}$: This case is not possible, due to the freshness of $t$.}
				\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    Higher Weak Bisimilarity = Characteristic Weak Bisimilarity  (\hwb = \fwb)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{lemma}
	\label{app:lem:wb_eq_wbf}
	$\hwb = \fwb$.
\end{lemma}

\begin{proof}
	\noi
	We split the proof into the direction
	$\hwb \subseteq \fwb$ and the direction
	$\fwb \subseteq \hwb$.
 Since the two equivalences differ only in the output case, in both cases our analysis focuses on output actions.

	\begin{enumerate}
		\item	Direction $\hwb \subseteq \fwb$.

				\noi Consider the typed relation (for readability, we omit type information):
		%
				\[
					\Re = \set{
								%\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} 
								(P, Q) 
								\setbar
								\horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}}
				\]
		%
				We show that $\Re$ is a characteristic bisimulation.
				Suppose
				$
						\horel{\Gamma}{\Delta_1}{P}{\hby{ \ell}}{\Delta_1'}{P'}
		%				\label{lem:wb_eq_wbf1}
				$.
				The proof proceeds by a case analysis on the transition label $\ell$.
				As stated earlier, we only detail the case 
				$\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$, which is the only non-trivial case.

							\smallskip
							
							 From the definition of $\Re$ we have that if:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1''}{P'}
								\label{lem:wb_eq_wbf1}
							\end{eqnarray}
							then $\exists Q, V_2$ such that:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_2}{Q}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2''}{Q'}
								\label{lem:wb_eq_wbf2}
							\end{eqnarray}
						%
							and for fresh $t$:
								\nhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P' \Par \hotrigger{t}{x}{s}{V_1}}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \hotrigger{t}{x}{s}{V_2} }}
								{lem:wb_eq_wbf3}
						%
							\noi 
							To show that $\Re$ is a characteristic bisimulation
							after the fact that transition~\eqref{lem:wb_eq_wbf1} implies transition~\eqref{lem:wb_eq_wbf2},
							we need to show that for fresh $t$:
						%
							\begin{eqnarray}
								\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
								{\Re}
								{\Delta_4}{}{\newsp{\widetilde{m_2}}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2}}}
								\label{lem:wb_eq_wbf4}
							\end{eqnarray}
						%
							\noi which follows from \eqref{lem:wb_eq_wbf3}, \lemref{lem:trigger_equiv}(1),
							and the definition of $\Re$.

					%\item	The other cases are trivial.
				%\end{itemize}

		\item	Direction $\fwb \subseteq \hwb$.
				\noi Consider the typed relation (for readability, we omit type information):
		%
				\[
					\Re = \set{
								%\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} 
								(P, Q) 
								\setbar
								\horel{\Gamma}{\Delta_1}{P}{\fwb}{\Delta_2}{Q}}
				\]
		%
				We show that $\Re$ is a higher-order bisimulation.
				Suppose
				$
						\horel{\Gamma}{\Delta_1}{P}{\hby{ \ell}}{\Delta_1'}{P'}
		%				\label{lem:wb_eq_wbf1}
				$.
				The proof does a case analysis on the transition label $\ell$.
				%\begin{itemize}
				%	\item	
				Here again we only detail the case $\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$.
				
				\smallskip

							\noi From the definition of $\Re$ we have that if:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1''}{P'}
								\label{lem:fwb_sub_hbf1}
							\end{eqnarray}
							then $\exists Q, V_2$ such that:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_2}{Q}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2''}{Q'}
								\label{lem:fwb_sub_hbf2}
							\end{eqnarray}
						%
							and for fresh $t$:
								\nhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_1}}}
								{\fwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \fotrigger{t}{x}{s}{\btinp{U} \tinact}{V_2} }}
								{lem:fwb_sub_hbf3}
						%
							\noi 
							To show that $\Re$ is a higher-order bisimulation
							after the fact that transition~\eqref{lem:fwb_sub_hbf1} implies transition~\eqref{lem:fwb_sub_hbf2},
							we need to show that for fresh $t$:
						%
							\begin{eqnarray}
								\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P' \Par \hotrigger{t}{x}{s}{V_1}}}
								{\Re}
								{\Delta_4}{}{\newsp{\widetilde{m_2}}{Q' \Par \hotrigger{t}{x}{s}{V_2}}}
								\label{lem:fwb_sub_hbf4}
							\end{eqnarray}
						%
							which follows from \eqref{lem:fwb_sub_hbf3}, \lemref{lem:trigger_equiv}(2),
							and the definition of $\Re$.

					%\item	The other cases are trivial.
				%\end{itemize}
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PROCESS SUBSTITUTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We state an auxiliary lemma that captures a property of trigger
processes in terms of process equivalence.
\begin{lemma}[Trigger Process Application]
	\label{lem:trigger_application}
	Let $P$ and $Q$ be processes. Also, let $t$ be a fresh name.
	\begin{enumerate}
		\item
			If $n_1 \not= n_2$ and
			\[
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
				{\hwb}
				{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2} }}
			\]
			then $n_1, n_2$ sessions and $\dual{n_1} \in \fn{P}$ and $\dual{n_2} \in \fn{Q}$.

		\item
			If
			\[
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par  \appl{\omapchar{U}}{n_2} }}%\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
				{\hwb}
				{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{\omapchar{U}}{n_1} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
			\]
			then whenever
			\[
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{\omapchar{U}}{n_1} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
				{\hby{\ell_1}}
				{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par \appl{(\trvalx{t})}{n_1} }}
			\]
			implies
			\[
				\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}}{Q \Par \appl{\omapchar{U}}{n_2} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_2}} }}
				{\Hby{\hat{\ell_2}}}
				{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{\omapchar{U}}{n_2} }} % }}
			\]
	\end{enumerate}
\end{lemma}

A process substitution lemma is useful for showing the
contextual for higher-order and characteristic bisimilarities.
Before we state and prove a process substitution lemma
we give an intermediate result.

\begin{lemma}[Trigger Substitution]
	\label{lem:trigger_subst}
	Let $P$ and $Q$ be processes. Also, let $t$ be a fresh name. If
	\[
		\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
		{\hwb}
		{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2} }}
	\]
	then $\forall \abs{x}{R}, \exists \Delta_1', \Delta_2'$ such that
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \appl{(\abs{x}{R})}{n_1} }}
		{\hwb}
		{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\abs{x}{R})}{n_2} }}
	\]
\end{lemma}

\begin{proof}
	We proof the result up-to the deterministic application
	transition that substitutes names $n_1$ and $n_2$ to
	processes $R_1$ and $R_2$, respectively.
	Let relation
	\begin{eqnarray*}
		\Re	&=&	\set{	(\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{n_1}{x} }}
						{\ ,\ }
						{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{n_2}{x} }})
					\setbar\\
					&& \forall \abs{x}{R}, \exists \Delta_1', \Delta_2', \land \\
					&&	\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
						{\hwb}
						{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2}}}\\
				&&}
	\end{eqnarray*}
	We show that $\Re$ is a higher-order bisimilarity.
	The proof is done by a case analysis on the actions that can be observed
	on the pairs of processes, so to check their higher-order bisimulation requirements.

	\begin{enumerate}
		\item	\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{n_1}{x} }}
					{\hby{\ell_1}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R \subst{n_1}{x} }}
				\]
				implies
				\[
					\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}{P}}
					{\hby{\ell_1}}
					{\Delta_3'}{\news{\widetilde{m_1}'}{P'}}
				\]
				implies
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
					{\hby{\ell_1}}
					{\Delta_5}{\newsp{\widetilde{m_1}'}{P' \Par \appl{(\trvalx{t})}{n_1} }}
				\]
				implies from the higher-order bisimilarity requirement of relation $\Re$ and the
				freshness of $t$
				\[
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2} }}
					{\Hby{\ell_2}}
					{\Delta_6}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\trvalx{t})}{n_1} }}
				\]
				and
				\begin{eqnarray}
					\mhorel{\Gamma}{\Delta_5}{\newsp{\widetilde{m_1}'}{P' \Par \appl{(\trvalx{t})}{n_1} \Par C_1}}
					{\hwb}
					{\Delta_6}{}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\trvalx{t})}{n_2} \Par C_2}}
					\label{lem:trig_subst1}
				\end{eqnarray}
				where $C_1, C_2$ are the trigger processes if $\ell_1, \ell_2$ are output actions
				and $C_1 = C_2 = \inact$ otherwise.

				The former transition implies
				\[
					\horel{\Gamma}{\Delta_4}{\newsp{\widetilde{m_2}}{Q }}
					{\Hby{\ell_2}}
					{\Delta_4'}{\news{\widetilde{m_2}'}{Q'}}
				\]
				which implies
				\[
					\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{n_2}{x} }}
					{\Hby{\ell_2}}
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par R \subst{n_2}{x} }}
				\]
				Equation \eqref{lem:trig_subst1} and the definition of $\Re$ implies
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R \subst{n_1}{x} \Par C_1}}
					{\hwb}
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par R \subst{n_2}{x} \Par C_2 }}
				\end{eqnarray*}
				that concludes the case.

		\item	\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{n_1}{x} }}
					{\hby{\ell}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P \Par R' \subst{n_1}{x} }}
				\]
				We identify three sub-cases:
				\begin{enumerate}[i.]
					\item	$\subj{\ell} \not= n_1$. The case is similar as above.

					\item	$\subj{\ell} = n_1$ and $n_1 = n_2$.
							From the definition of $\Re$ we get that
							\[
								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \binp{t}{x} \appl{x}{n_1}}}
								{\hby{ \bactinp{t}{\omapchar{U}}}}
								{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \appl{\omapchar{U}}{n_1}}}
							\]
							implies
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \binp{t}{x} \appl{x}{n_2}}}
								{\Hby{ \bactinp{t}{\omapchar{U}}}}
								{\Delta_4}{\newsp{\widetilde{m_1}}{Q' \Par \mapchar{U}{x} \subst{n_2}{x} }}
							\]
							and
							\begin{eqnarray*}
								&& \Gamma; \Delta_3 \proves \newsp{\widetilde{m_1}}{P \Par \appl{\omapchar{U}}{n_1}}
								\\
								&\hby{\tau_{\beta}}&
									\Delta_3 \proves \newsp{\widetilde{m_1}}{P \Par \mapchar{U}{x} \subst{n_1}{x}  }
								\\
								&\hwb&
									\Delta_4 \proves \newsp{\widetilde{m_1}}{Q' \Par \mapchar{U}{x} \subst{n_2}{x}}
							\end{eqnarray*}

							The proof follows Part 2 of \lemref{lem:trigger_application} where
							\[
								\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \mapchar{U}{x} \subst{n_1}{x}  }}
								{\hby{\ell}}
								{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \binp{t'}{y}{\appl{y}{n_1}}}}
							\]
							implies
							\[
								\horel{\Gamma}{\Delta_4}{\newsp{\widetilde{m_2}}{Q' \Par \mapchar{U}{x} \subst{n_1}{x}  }}
								{\Hby{\ell}}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q'' \Par \binp{t'}{y}{\appl{y}{n_2}}}}
							\]
							and furthermore, from the definition of $\Re$
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \binp{t'}{y}{\appl{y}{n_1}}}}
								{\hwb}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q'' \Par \binp{t'}{y}{\appl{y}{n_2}}}}
							\]
							that implies from the definition of $\Re$ that $\forall R$ such that $x \in \fn{R}$
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par R \subst{n_1}{x} }}
								{\ \Re\ }
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q'' \Par R \subst{n_2}{x}}}
							\]
							The proof concludes when we verify that 
							\[
								\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{n_2}{x} }}
								{\Hby{\ell}}
								{\Delta_2''}{\newsp{\widetilde{m_1}'}{Q'' \Par R' \subst{n_2}{x} }}
							\]
							

					\item	$\subj{\ell} = n_1$ and $n_1 \not= n_2$. This case
							is not possible. \lemref{lem:trigger_application} implies
							that $n_1$ is a session and $\dual{n_1} \in \fn{P}$. From the
							definition of typed transition (\defref{d:tlts}) we get that we cannot observe $\ell$
							on $R$, because $\dual{n_1} \in \fn{P}$ and $(\Gamma; \es; \Delta) \not\hby{\ell}$.
				\end{enumerate}

		\item	\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{n_1}{x} }}
					{\hby{}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R' \subst{n_1}{x} }}
				\]
				From the typed reduction definition (\defref{d:tlts}) we get that
				\begin{eqnarray*}
					&&	\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}{P}}
						{\hby{\ell_1}}
						{\Delta_R}{\news{\widetilde{m_1}}{P}}
					\\
					&&	\horel{\Gamma}{\Delta_1'}{R \subst{n_1}{x} }
						{\hby{\ell_2}}
						{\Delta_R'}{R' \subst{n_1}{x} }
					\\
					&&	\ell_1 \comp \ell_2
				\end{eqnarray*}
				We distinguish several subcases
				\begin{enumerate}[i.]
					\item	$\subj{\ell_1} \not= n_1$. \dk{put proof} %The case is similar with the previous cases.
					\item	$\subj{\ell_1} = n_1$.  \dk{put proof} %The case is similar with sub-case (ii) of case 2.
					\item	$\obj{\ell_1} = n_1$. \dk{put proof}
				\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PROCESS SUBSTITUTION - Second Lemma
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\jasks{I can't parse this sentence:}

We can now state a process substitution lemma.
Given a higher-order bisimulation under a trigger value
substitution, we can generalise for any value substitution.

%We can now state a process substitution lemma, where given
%a higher order equivalence under a trigger value substitution,
%we can generalise for any process substitution that makes
%the equivalence typable.

\begin{lemma}[Process Substitution]
	\label{lem:process_subst}
	Let $P_1$ and $P_2$ be processes, with $z \in \fn{P_1}, z \in \fn{P_2}$.
	Also, let $t$ be a fresh name. 
%	\jasks{Don't we need to say that $x$ occurs free in in $P_i$? Also, we have $x$ both in $P$ and in the parameter of the abstraction,
%	it is better to have different variables, just to avoid confusion.}
	If
	\[
		\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
		{\hwb}
		{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}
	\]
	then $\forall \abs{x}{R}, \exists \Delta_1', \Delta_2'$ such that
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z} }}
		{\hwb}
		{\Delta_2'}{\newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z} }}
	\]
\end{lemma}


\begin{proof}
	Consider the typed relation (for readability, we omit type information):
	\begin{eqnarray*}
		\Re	&=&	\set{
					(\newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z}}, \newsp{\widetilde{m_2}}{P_1 \subst{{\abs{x}{R}}}{z}})
					\setbar\\
			&&		\qquad \horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}
			\\
			&&		}
	\end{eqnarray*}
	We show that $\Re$ is a higher-order bisimilarity. Suppose that 
	%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z} }}
		{\hby{\ell_1}}
		{\Delta_3}{\newsp{\widetilde{m_1}}{P_1' \subst{{\abs{x}{R}}}{z} }}
		\label{lem:proc_subst1}
	\end{eqnarray}

	Our analysis distinguishes two cases, depending on whether the substitution $\subst{{\abs{x}{R}}}{z}$ has an effect on the action denoted by $\ell_1$:
	\begin{enumerate}
		\item	Case $P_1 \not\scong Q \Par \appl{x}{n}$ that is, the substitution does not affect top-level processes. 

				From the freshness of $t$ we can imply that $\subj{\ell_1} \not= t$.
				\jasks{(This sentence on freshness seems misplaced - it makes sense only below.)}
				Furthermore, from the requirements of $\Re$
				we get that
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
					{\hby{\ell_1}}
					{\Delta_1''}{\newsp{\widetilde{m_1}}{P_1' \subst{\trvalx{t}}{z} }}
				\end{eqnarray*}
				which implies that there exists $\ell_2, \Delta_2'', P_2'$ such that
				\begin{eqnarray}
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}'}{P_2 \subst{\trvalx{t}}{z} }}
					{\Hby{\ell_2}}
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \subst{\trvalx{t}}{z} }}
					\label{lem:proc_subst0}
				\end{eqnarray}
				and
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}''}{P_1' \subst{\trvalx{t}}{z} \Par C_1}}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}''}{P_2' \subst{\trvalx{t}}{z} \Par C_2}}
				\end{eqnarray*}
				with $C_1$ (resp., $C_2$) being the higher order trigger process
				in the cases where $\ell_1 = \news{\widetilde{m}} \bactout{n}{V_1}$ (resp., $\ell_2 = \news{\widetilde{m}'} \bactout{n}{V_2}$)
				and $C_1 = C_2 = \inact$ otherwise.
				Because $C_1$ and $C_2$ are closed terms we can rewrite the substitution as:
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}''}{(P_1'\Par C_1) \subst{\trvalx{t}}{z}}}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}''}{(P_2'\Par C_2) \subst{\trvalx{t}}{z}}}
				\end{eqnarray*}
				Since $\ell_1, \ell_2$ do not pertain to the substitution,
				we can consider any $\abs{x}{R}$ instead of $\trvalx{t}$.
				Thus we further imply that
				\begin{eqnarray}
					\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}''}{(P_1'\Par C_1) \subst{{\abs{x}{R}}}{z}}}
					{\ \Re\ }
					{\Delta_4'}{\newsp{\widetilde{m_2}''}{(P_2'\Par C_2) \subst{{\abs{x}{R}}}{z}}}
					\label{lem:proc_subst33}
				\end{eqnarray}

				From \eqref{lem:proc_subst2} we can derive the transition
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z} }}
					{\Hby{\ell_2}}
					{\Delta_4}{\newsp{\widetilde{m_2}'}{P_2' \subst{{\abs{x}{R}}}{z} }}
				\end{eqnarray*}
				Equation \eqref{lem:proc_subst33} concludes the case.
%				\jasks{There is a problem with equation labels above!}


		\item	Case $P_1 \scong Q \Par \appl{x}{n_1}$ and $Q \not\scong Q' \Par \appl{x}{n'}$.
		\jasks{That is, $P_1$ has exactly one occurrence of $x$ at top-level. But we should explain why these two cases exclude other (non linear) possibilities, such as, e.g., $Q' \Par \appl{x}{n_1} \Par \appl{x}{n_2}$.} 

				We identify two sub-cases, depending on the source of the action $\ell_1$:
				\begin{itemize}
					\item	Sub-case
							\begin{eqnarray*}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{(Q \Par \appl{x}{n_1}) \subst{{\abs{x}{R}}}{z} }}
								{\hby{\ell_1}}
								{\Delta_3}{\newsp{\widetilde{m_1}}{(Q' \Par \appl{x}{n_1}) \subst{{\abs{x}{R}}}{z} }}
							\end{eqnarray*}
							%
							This sub-case is similar as the previous case.

					\item	Sub-case \jasks{(I am not sure if I follow: is this case just the (deterministic) application of $n_1$?)}
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{(Q \Par \appl{x}{n_1}) \subst{{\abs{x}{R}}}{z} }}
								{\hby{\tau}}
								{\Delta_3}{\newsp{\widetilde{m_1}}{Q \subst{{\abs{x}{R}}}{z} \Par R \subst{n_1}{z}  }}
								\label{lem:proc_subst1}
							\end{eqnarray}
							%
							From the requirements of $\Re$ we imply that
			\jasks{(General comment: I notice that often you write `we conclude' but you mean `we infer' or `we obtain'. One ``concludes'' only at the very end.)}
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{(Q \Par \appl{x}{n_1}) \subst{\trvalx{t}}{z} }}
								{\hby{\tau}}
								{\Delta_1''}{}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
							\end{eqnarray*}
							which implies that there $\exists P_2', \Delta_2''$ such that
							%
								\nhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}
								{\Hby{}}
								{\Delta_2''}{\newsp{\widetilde{m_2}}{P_2' \subst{\trvalx{t}}{z}}}
								{lem:proc_subst2}
							%
							and
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
								{\hwb}
								{\Delta_2''}{}{\newsp{\widetilde{m_2}}{P_2' \subst{\trvalx{t}}{z}}}
							\end{eqnarray*}
							%
							From the last pair we can see that for fresh $t'$ if
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
								{\hby{\bactinp{t}{\trvalx{t'}}}}
								{\Delta_1'''}{}{\newsp{\widetilde{m_2}}{Q \subst{\trvalx{t}}{z} \Par \appl{\trvalx{t'}}{n_1}}}
							\end{eqnarray*}
							that implies that $\exists P_2'', \Delta_2'''$ such that
							\begin{eqnarray}
								\begin{array}{crll}
											& \Gamma; \es; \Delta_2'' &\proves& \newsp{\widetilde{m_2}}{P_2'\subst{\trvalx{t}}{z}}
									\\
									\Hby{}	&	&&	\newsp{m_2}{(P_3 \Par \appl{x}{n_2}) \subst{\trvalx{t}}{z}}
									\\
									{\hby{\bactinp{t}{\trvalx{t'}}}} &
												&&	\newsp{m_2}{P_3 \subst{\trvalx{t}}{z} \Par \appl{\trvalx{t'}}{n_2}}
									\\
									\Hby{}	& \Delta_2''' & \proves & \newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{\trvalx{t'}}{n_2}}
								\end{array}
								\label{lem:proc_subst3}
							\end{eqnarray}
							and
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \appl{\trvalx{t'}}{n_1}}}
								{\hwb}
								{\Delta_2'''}{}{\newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{\trvalx{t'}}{n_2}}}
							\end{eqnarray*}
							%
							From \lemref{lem:trigger_subst} we can deduce that $\forall \abs{x}{R}$, if $\exists \Delta_5, \Delta_6$ then
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_5}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \appl{(\abs{x}{R})}{n_1}}}
								{\hwb}
								{\Delta_6}{}{\newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{(\abs{x}{R})}{n_2}}}
							\end{eqnarray*}
							from the definition of $\Re$ we have that for all $\forall \abs{x}{R}$, if $\exists \Delta_3, \Delta_4$
							%
								\nhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{Q \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_1}}}
								{\ \Re\ }
								{\Delta_4}{\newsp{\widetilde{m_2}}{P_2'' \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_2}}}
								{lem:proc_subst4}
							%	
							We show that we can mimic first the
							transition in \eqref{lem:proc_subst2} and then the silent part of
							transitions \eqref{lem:proc_subst3} to get:
							\begin{eqnarray}
								\begin{array}{crll}
											& \Gamma; \es; \Delta_2' &\proves& \newsp{\widetilde{m_2}}{P_2 \subst{(\abs{x}{R})}}
									\\
									\Hby{}	&	\Delta_2'			& \proves&	\newsp{\widetilde{m_2}}{P_2' \subst{\trvalx{t}}{z}}
									\\
									\Hby{} &	\Delta_4			& \proves&	\newsp{m_2}{P_2'' \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_2}}
								\end{array}
								\label{lem:proc_subst5}
							\end{eqnarray}
							We showed that if \eqref{lem:proc_subst0} then \eqref{lem:proc_subst5} and \eqref{lem:proc_subst4}
							as required to show that $\Re$ is a higher-order bisimilarity.
							\qed
				\end{itemize}
	\end{enumerate}
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  WB IS WBC
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\jp{Below we should be consistent and describe an $\Re$ that we use as closure.}
\begin{lemma}
	\label{app:lem:wb_is_wbc}
	$\hwb\ \subseteq\ \wbc$.
\end{lemma}

\begin{proof}
	Let $\Re$ be the typed relation (for readability, we omit typing judgements from the definition):
	\[
		\Re = \set{(P_1, Q_1) \setbar \horel{\Gamma}{\Delta_1}{P_1}{\hwb}{\Delta_2}{Q_1}}
	\]
	We show that $\Re$ is a context bisimulation.
	The proof is divided on cases on the label $\ell$ for the transition:
%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
		\label{lem:wb_is_wbc1}
	\end{eqnarray}
%
We distinguish four cases: $\ell$ is not an output or an input action; $\ell$ is an input action;
$\ell$ is an higher-order output; $\ell$ is a first-order output.
	\begin{enumerate}
		\item
				Case $\ell \notin \set{ \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{P}},  \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}, \bactinp{n}{\abs{\widetilde{x}}{P}} }$:

				\noi For the latter $\ell$ and transition in \eqref{lem:wb_is_wbc1} we impy that:	
			%
				\[
					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\ell}}{\Delta_2'}{Q_2}
				\]
			%
				\noi and
			%
				\[
					\horel{\Gamma}{\Delta_1'}{P_2}{\hwb}{\Delta_2'}{Q_2}
				\]
			%
				The above premise and conclusion coincides with defining cases for $\ell$ in $\wbc$.

		\item	Case $\ell = \bactinp{n}{\abs{\widetilde{x}}{P}}$:

				\noi Transition in \eqref{lem:wb_is_wbc1} implies:
			%
				\[
					\begin{array}{l}
						\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}}}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
						\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{\auxtr{t}}}}{\Delta_1''}{P_2 \subst{\auxtr{t}}{x}}
					\end{array}
				\]
			%
				\noi The last two transitions imply:
			%
			\[
				\begin{array}{l}
					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}}}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{\auxtr{t}}}}{\Delta_2''}{Q_2 \subst{\auxtr{t}}{x}}
				\end{array}
			\]
			%
				\noi and
			%
			\[
				\begin{array}{l}
					\horel{\Gamma}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}{\hwb}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
					\horel{\Gamma}{\Delta_1''}{P_2 \subst{\auxtr{t}}{x}}{\hwb}{\Delta_2''}{Q_2 \subst{\auxtr{t}}{x}}
				\end{array}
			\]
			%
				\noi To conclude from (\lemref{app:lem:proc_subst}) that
				$\forall P$ with $\fv{P} = \widetilde{x}$
			%
			\[
				\horel{\Gamma}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{P}}{x}}{\hwb}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{P}}{x}}
			\]
			%
				\noi as required.

		\item	Case $\ell = \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{P}}$:

				\noi From transition \eqref{lem:wb_is_wbc1} we conclude:
			%
			\[
				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q}}}}{\Delta_2'}{Q_2}
			\]
			%
				\noi and for fresh $t$
			%
			\[
				\mhorel	{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_2 \Par \binp{t}{x} \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact}}}
					{\hwb}
					{\Delta_2'}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \binp{t}{x} \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact}}}
			\]
			%
				\noi From the  second case of this proof we can conclude that $\forall R$ with $\fpv{R} = \set{x}$:
			%
			\[
				\begin{array}{rl}
					\Gamma; \es; &\Delta_1' \proves \newsp{\widetilde{m_1}}{P_2 \Par \binp{t}{x} \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact}} \\
					\by{\bactinp{t}{\abs{z}{\binp{z}{x} R}}}& \newsp{\widetilde{m_1}}{P_2 \Par \newsp{s}{\binp{s}{x} R \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact}}\\
					\by{\tau} \quad &\Delta_1'' \proves \newsp{\widetilde{m_1}}{P_2 \Par  R \subst{\abs{\widetilde{x}}{P}}{x}}
				\end{array}
			\]
			%
				\noi and
			%
			\[
				\begin{array}{rl}
					\Gamma; \es; &\Delta_2' \proves \newsp{\widetilde{m_2}}{Q_2 \Par \binp{t}{x} \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact}} \\
					\by{\bactinp{t}{\abs{z}{\binp{z}{x} R}}} &\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\binp{s}{x} R \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact}}\\
					\by{\tau} &\Delta_2'' \proves \newsp{\widetilde{m_2}}{Q_2 \Par  R \subst{\abs{\widetilde{x}}{Q}}{x}}
				\end{array}
			\]
			%
				\noi and furthermore it is easy to see that $\forall R$ with $\fpv{R} = \set{x}$:
			%
			\[
				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par  R \subst{\abs{\widetilde{x}}{P}}{x}}}{\hwb}{\Delta_2}{\newsp{\widetilde{m_2}}{Q_2 \Par R \subst{\abs{\widetilde{x}}{Q}}{x}}}
			\]
			%
				\noi as required by the definition of $\wbc$.

		\item	Case $\ell = \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}$: 

				This case shares a similar argumentation with the previous case.
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  WBC IS CONG
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}
	\label{app:lem:wbc_is_cong}
	$\wbc \subseteq \cong$.
\end{lemma}


\begin{proof}
	\noi We prove that $\wbc$ satisfies the three defining properties of $\cong$:
	reduction closure, barb preservation, congruence (cf. \defref{def:rc}).
%

\noi	{\bf Reduction Closed:}
	Let
		$\horel{\Gamma}{\Delta_1}{P_1}{\wbc}{\Delta_2}{P_2}$. The reduction

	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\by{}}{\Delta_1'}{P_1'}
	\]
%
	\noi implies that 
	$\exists P_2'$ such that 
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta_2}{P_2}{\By{}}{\Delta_2'}{P_2'}\\
		\horel{\Gamma}{\Delta_1}{P_1'}{\wbc}{\Delta_2'}{P_2'}
	\end{eqnarray*}
%
	\noi Same arguments hold for the symmetric case, thus $\wbc$ is reduction closed.

	\noi {\bf Barb Preservation:} We have that
%
	\begin{eqnarray*}
		\Gamma; \emptyset; \Delta_1 \proves P_1 \barb{n}
	\end{eqnarray*}
%
	implies that
	\begin{eqnarray*}
		P &\cong& \newsp{\widetilde{m}}{\bout{n}{V_1} P_3 \Par P_4}\\
		\dual{n} &\notin& \Delta_1
	\end{eqnarray*}
%
	\noi From the definition of $\wbc$ we get that
%
\[
	\horel	{\Gamma}{\Delta_1}{\newsp{\widetilde{m}}{\bout{n}{V_1} P_3 \Par P_4}}
		{\by{\news{s_1} \bactout{n}{V_1}}}
		{\Delta_1'}
		{\newsp{\widetilde{m'}}{P_3 \Par P_4}}
\]
%
	\noi implies
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta_2}{P_2}{\By{\news{m_2} \bactout{n}{V_2}}}{\Delta_2'}{P_2'}\\
	\end{eqnarray*}
%
	\noi From the last result we obtain
%
	\begin{eqnarray*}
		\Gamma; \emptyset; \Delta_2 \proves P_2 \Barb{n}
	\end{eqnarray*}
%
	\noi as required.

	\noi {\bf Congruence:}

	\noi The congruence property requires that we check that $\wbc$
	is preserved under any context.
	The most interesting context case is parallel composition.

	\noi We construct a congruence relation. Let
	\[
	\begin{array}{rcl}
		\mathcal{S} &=&	\set{
				(\Gamma; \emptyset; \Delta_1 \cat \Delta_3 \proves \newsp{\widetilde{n_1}}{P_1 \Par R} \hastype \Proc,
				\Gamma; \emptyset; \Delta_2 \cat \Delta_3 \proves \newsp{\widetilde{n_2}}{P_2 \Par R})
				\setbar \\
		& &		\horel{\Gamma}{\Delta_1}{P_1}{\wbc}{\Delta_2}{P_2}, \forall \Gamma; \emptyset; \Delta_3 \proves R \hastype \Proc\\
		& &}
	\end{array}
	\]
	\noi We need to show that 
	%the above congruence is a bisimulation.
	%To show that 
	$\mathcal{S}$ is a bisimulation:  we do a case analysis on the structure
	of the $\by{\ell}$ transition. There are three main cases.


	\begin{enumerate}
	%%%%%%%%%%%%%%%
	% Case 1
	%%%%%%%%%%%%%%%

		\item Suppose
				%
				\[
					\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{n_1}}{P_1 \Par R}}
					{\by{\ell}}
					{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{n_1'}}{P_1' \Par R}}
				\]
				%
				\noi The case is divided into three subcases:

				\begin{enumerate}[i.]
					\item Sub-case	$\ell \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$:
					
							\noi From the definition of typed transition we get:
					%
							\[
								\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}
							\]
							\noi which implies that
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P_2}{\By{\ell}}{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong1}\\
								\horel{\Gamma}{\Delta_1'}{P_1'}{\wbc}{\Delta_2''}{P_2'}
								\label{lem:wbc_is_cong2}
							\end{eqnarray}
					%
							\noi From transition in~\eqref{lem:wbc_is_cong1} we conclude that 
							\[
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}}{P_2 \Par R}}
								{\By{\ell}}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]
					%
							\noi Furthermore from \eqref{lem:wbc_is_cong2} and the definition of $\mathcal{S}$ we conclude that
					%
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{n_1}'}{P_1' \Par R}}
								{\ \mathcal{S}\ }
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]

					\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}$:

							\noi From the definition of typed transition we get
							\[
								\horel{\Gamma}{\Delta_1}{P_1}
								{\by{\news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}}}
								{\Delta_1'}{P_1'}
							\]
							\noi which implies that
					%
							\begin{eqnarray}
								&& \horel{\Gamma}{\Delta_1}{P_2}{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong3} \\
								&&\forall Q, \set{x} \in \fpv{Q} \nonumber \\
						%		\forall s'
								&& \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
								{\ \wbc\ }
								{\Delta_2''}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
								\label{lem:wbc_is_cong4}
							\end{eqnarray}
					%
							\noi From transition~\eqref{lem:wbc_is_cong3} conclude that 
							\[
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}}{P_2 \Par R}}
								{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]
					%
							\noi Furthermore from~\eqref{lem:wbc_is_cong4} we conclude that $\forall Q$ with $\set{x} = \fpv{Q}$
					%
							\[
								\horel{\Gamma}{\Delta_1'' \cat \Delta_3}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{(\widetilde{x}) Q_1}{x} \Par R}}
								{\ \mathcal{S}\ }
								{\Delta_2'' \cat \Delta_3}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x} \Par R}}
							\]
					%

					\item	Sub-case $\ell = \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}$:

							\noi From the definition of typed transition we get that
							\[
								\horel{\Gamma}{\Delta_1}{P_1}
								{\by{\news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}}
								{\Delta_1'}{P_1'}
							\]
							\noi which implies that $\exists P_2', s_2$ such that
					%
							\begin{eqnarray}
								&& \horel{\Gamma}{\Delta_1}{P_2}
								{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
								{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong5}\\
								&&\forall Q, x = \fn{Q}, \nonumber \\%  &&
								&& \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{n_1}}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}}}}
								{\ \wbc\ }
								{\Delta_2''}{\newsp{\widetilde{n_2}}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}}}}
								\label{lem:wbc_is_cong6}
							\end{eqnarray}
					%
						\noi From transition~\eqref{lem:wbc_is_cong5} conclude that 
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2 \Par R}}
							{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
							{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'''}{P_2' \Par R}}
						\]
					%
						\noi Furthermore from~\eqref{lem:wbc_is_cong6} we conclude that $\forall Q, x = \fn{Q}$
					%
						\[
							\horel{\Gamma}{\Delta_1'' \cat \Delta_3}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}} \Par R}}
							{\ \mathcal{S}\ }
							{\Delta_2'' \cat \Delta_3}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}} \Par R}}
						\]
					%
				\end{enumerate}
	%%%%%%%%%%%%%%%
	% Case 2
	%%%%%%%%%%%%%%%

		\item Suppose
			%
				\[
					\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
					{\by{\ell}}
					{\Delta_1 \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1 \Par R'}}
				\]
				\noi This case is divided into three subcases:

				\begin{enumerate}[i.]
			%
					\item Sub-case 	$\ell \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$:

							\noi From the LTS we get that:
							\[
								\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
							\]
						%
							\noi Which in turn implies
							\begin{eqnarray*}
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
								{\by{\ell}}
								{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}'}{P_2 \Par R'}}
							\end{eqnarray*}
						%
							\noi From the definition of $\mathcal{S}$ we conclude that
							\[
								\horel{\Gamma}{\Delta_1 \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1 \Par R'}}
								{\ \mathcal{S}\ }
								{\Delta_2 \cat \Delta_3''}{\newsp{\widetilde{m_2}'}{P_2 \Par R'}}
							\]
							\noi as required.

				\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q}}$:

						\noi From the LTS we get that:
						\begin{eqnarray}
							& &	\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
								\label{lem:wbc_is_cong7}\\
							& & 	\forall R_1, \set{x} = \fpv{R_1},
								\nonumber\\
					%		\forall s'
							& &	\Gamma; \emptyset; \Delta_3'' \proves \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}} \hastype \Proc
								\label{lem:wbc_is_cong8}
						\end{eqnarray}
					%
						\noi From~\eqref{lem:wbc_is_cong7} we get that
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}'}{P_2 \Par R}}{\by{\ell}}{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}}{P_2 \Par R'}}
						\]
						\noi Furthermore from~\eqref{lem:wbc_is_cong8} and the definition of $\mathcal{S}$ we conclude that
						$\forall R_1$ with $\set{x} \in \fpv{R_1}$
						\[
							\horel{\Gamma}{\Delta_1 \cat \Delta_3''}{\newsp{\widetilde{m_1}}{P_1 \Par \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}}}}
							{\ \mathcal{S}\ }
							{\Delta_2 \cup \Delta_3''}{\newsp{\widetilde{m_2}}{P_2 \Par \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}}}}
						\]
						\noi as required.

				\item	Sub-case $\ell = \news{\widetilde{mm}} \bactout{n}{\widetilde{m}}$:

					\noi From the typed LTS we get that:
					\begin{eqnarray}
						& &	\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
							\label{lem:wbc_is_cong9} \\
						& &	\forall Q, \widetilde{x} = \fn{Q}, \nonumber\\
						& &	\Gamma; \emptyset; \Delta_3'' \proves \newsp{\widetilde{m}'}{R' \Par Q \subst{\widetilde{m}}{\widetilde{x}}} \hastype \Proc
							\label{lem:wbc_is_cong10}
					\end{eqnarray}
				%
					\noi From~\eqref{lem:wbc_is_cong9}, we obtain that
					\[
						\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}{\by{\ell}}{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}}{P_2 \Par R'}}
					\]
					\noi Furthermore from~\eqref{lem:wbc_is_cong10} and the definition of $\mathcal{S}$ we conclude that
					$\forall Q, \widetilde{x} = \fn{Q}$
					\[
						\horel{\Gamma}{\Delta_1 \cat \Delta_3''}{\newsp{\widetilde{m_1}}{P_1 \Par \newsp{\widetilde{m}}{R' \Par Q \subst{\widetilde{m}'}{\widetilde{x}}}}}
						{\ \mathcal{S}\ }
						{\Delta_2 \cat \Delta_3''}{\newsp{\widetilde{m_2}}{P_2 \Par \newsp{\widetilde{m}'}{R' \Par Q \subst{\widetilde{m}}{\widetilde{x}}}}}
					\]
					\noi as required.
			\end{enumerate}

	%%%%%%%%%%%%%%%
	% Case 3
	%%%%%%%%%%%%%%%

	\item For the last case, suppose:
			\[
				\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
				{\by{\tau}}
				{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1' \Par R'}}
			\]

			\noi This case is divided into three subcases:

			\begin{enumerate}[i.]

				\item	$\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}$
						and $\ell \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$
						implies
					%
						\begin{eqnarray}
							\horel{\Gamma}{\Delta_3}{R}{\by{\dual{\ell}}}{\Delta_3}{R'}
							\label{lem:wbc_is_cong11} \\
							\horel{\Gamma}{\Delta_2}{P_2}{\By{\hat{\ell}}}{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong12}\\
							\horel{\Gamma}{\Delta_1'}{P_1'}{\wbc}{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong13}
						\end{eqnarray}
					%
						\noi From~\eqref{lem:wbc_is_cong11} and~\eqref{lem:wbc_is_cong12} we get
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3'}{\newsp{\widetilde{m_2}'}{P_2' \Par R'}}
						\]
					%
						\noi From~\eqref{lem:wbc_is_cong13} and the definition of ($\mathcal{S}$) we get that
						\[
							\horel{\Gamma}{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1' \Par R'}}
							{\ \mathcal{S}\ }
							{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{m_2}'}{P_2' \Par R'}}
						\]
						\noi as required.

				\item
						$\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}}}{\Delta_1'}{P_1'}$
						implies
					%
						\begin{eqnarray}
							& & \horel{\Gamma}{\Delta_3}{R}
							{\by{\bactinp{n}{\abs{\widetilde{x}} {Q_1}}}}{\Delta_3'}
							{R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}
							\label{lem:wbc_is_cong14}\\
							& & \horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
							{\by{}}{\Delta_1' \cat \Delta_3'}
							{\newsp{\widetilde{m_1}''}{P_1' \Par R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
							\nonumber \\
							& & \horel{\Gamma}{\Delta_2}{P_2}
							{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}
							{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong15}\\
							& & \forall Q, \set{x} = \fpv{Q}, \nonumber \\
							& & \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par Q \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
							{\ \wbc\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
							\label{lem:wbc_is_cong16}
						\end{eqnarray}
					%
						From~\eqref{lem:wbc_is_cong14} and the Substitution Lemma~(\lemref{l:subst}) we obtain that
						\[
							\horel{\Gamma}{\Delta_3}{R}{\by{\bactinp{n}{\abs{\widetilde{x}} {Q_2}}}}{\Delta_3''}{R' \subst{\abs{\widetilde{x}}{Q_2}}{x}}
						\]
						%\dk{(prove that $\forall V, R \by{\bactinp{s}{V}} R'\subst{V}{x}$)}
						\noi to combine with~\eqref{lem:wbc_is_cong15} and get
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3''}{\newsp{\widetilde{m_2}''}{P_2' \Par R' \subst{\abs{\widetilde{x}}{Q_2}}{X}}}
						\]
					%
						\noi In result in~\eqref{lem:wbc_is_cong16}, set $Q$ as $R'$ to obtain:
					%
					%	\noi From~\eqref{lem:wbc_is_cong16} and the definition of $\mathcal{S}$ we get that
						\[
							\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
							{\ \mathcal{S}\ }{ \Delta_2''}
							{\newsp{\widetilde{m_2}'}{P_2' \Par R' \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
						\]

				\item
						$\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}}{\Delta_1'}{P_1'}$
					%
						\begin{eqnarray}
							& & \horel{\Gamma}{\Delta_3}{R}
							{\by{\bactinp{n}{\widetilde{m_1}}}}
							{\Delta_3'}{R' \subst{\widetilde{m_1}}{\widetilde{x}}}
							\label{lem:wbc_is_cong24}\\
							& & \horel{\Gamma}{\Delta_1 \cup \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
							{\by{}}
							{\Delta_1' \cup \Delta_3'}{\newsp{\widetilde{m_1}''}{P_1' \Par R' \subst{m_1}{x}}}
							\nonumber \\
							& & \horel{\Gamma}{\Delta_2}{P_2}
							{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
							{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong25}\\
							& & \forall Q, \set{x} = \fpv{Q}, \nonumber \\
							& & \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}}}}
							{\ \wbc\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}}}}
							\label{lem:wbc_is_cong26}
						\end{eqnarray}
					%
						From~\eqref{lem:wbc_is_cong24} and the Substitution Lemma~(\lemref{l:subst}) we get that
						\[
							\horel{\Gamma}{\Delta_3}{R}{\by{\bactinp{n}{\widetilde{m_2}}}}{\Delta_3''}{R' \subst{\widetilde{m_2}}{\widetilde{x}}}
						\]
						%\dk{(prove that $\forall V, R \by{\bactinp{s}{V}} R'\subst{V}{x}$)}
						\noi to combine with~\eqref{lem:wbc_is_cong25} and get
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3''}{\newsp{\widetilde{m_2}''}{P_2' \Par R' \subst{\widetilde{m_2}}{\widetilde{x}}}}
						\]
					%
						\noi Set $Q$ as $R'$ in result in \eqref{lem:wbc_is_cong26} to obtain
					%
					%	\noi From~\eqref{lem:wbc_is_cong16} and the definition of $\mathcal{S}$ we get that
						\[
							\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par R' \subst{\widetilde{m_1}}{\widetilde{x}}}}
							{\ \mathcal{S}\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par R' \subst{\widetilde{m_2}}{\widetilde{x}}}}
						\]
		\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  CONG IS WB
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We prove the result $\cong \subseteq \hwb$ following
the technique developed in~\cite{Hennessy07} and
refined for session types in~\cite{KYHH2015,KY2015}.

%\jp{Below I slightly modify the structure of items.}

\begin{definition}[Definability]\myrm
	\label{app:def:definibility}
	Let $\Gamma; \emptyset; \Delta_1 \proves P \hastype \Proc$.
	A visible action [Dimitris] $\ell$ is \emph{definable} whenever
	there exists (testing) process
	$\Gamma; \emptyset; \Delta_2 \proves T\lrangle{\ell, \suc} \hastype \Proc$
	with $\suc$ fresh name % and $N$ a set of names.
	such that:
%
	\begin{enumerate}
		\item	Let $\ell \in \set{\bactsel{n}{\ell}, \bactbra{n}{\ell}, \bactinp{n}{\widetilde{m}}, \bactinp{n}{(\widetilde{x}) Q}}$.
		
			\begin{enumerate}[i.]
				\item	If $\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}$
				%		and
				%		$\ell \in \set{\bactsel{n}{\ell}, \bactbra{n}{\ell}, \bactinp{n}{\widetilde{m}}, \bactinp{n}{\abs{\widetilde{x}}{Q}}}$
						then:
				%
						\[
							P \Par T\lrangle{\ell, \suc} \red P' \Par \bout{\suc}{\dual{n}} \inact \textrm{ and }
							\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves P' \Par \bout{\suc}{\dual{n}} \inact
						\]

				\item
						If $P \Par T\lrangle{\ell, \suc} \red Q$ with			
						$\Gamma; \emptyset; \Delta \proves Q \barb{\suc}$ then \\
						$\horel{\Gamma}{\Delta_1}{P}{\Hby{\ell}}{\Delta_1'}{P'}$
						and $Q \scong P' \Par \bout{\suc}{\dual{n}} \inact$.
			\end{enumerate}
%
 		\item Let	(i) $\ell = \news{\widetilde{m}}\bactout{n}{V}$,
					and (ii) fresh $t$%, and
					%(iii) $\widetilde{m}'$ such that $ \widetilde{m}' \subseteq \widetilde{m}$

			\begin{enumerate}[i.]
				\item	If $\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m}}\bactout{n}{V}}}{\Delta_1'}{P'}$
						then:
%
						\begin{itemize}
							\item $P \Par T\lrangle{\news{\widetilde{m}}\bactout{n}{V}, \suc} \red
							\newsp{\widetilde{m}}{P' \Par \hotrigger{t}{x}{s}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$
							\item $\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves
							\newsp{\widetilde{m}}{P' \Par \hotrigger{t}{x}{s}{V} \Par  \bout{\suc}{\dual{n}, V} \inact} \hastype \Proc$
						\end{itemize}

				\item	If $P \Par T\lrangle{\news{\widetilde{m}}\bactout{n}{V}, \suc} \red Q$
						with $\Gamma; \emptyset; \Delta \proves Q \barb{\suc}$ then 
						\begin{itemize}
							\item $\horel{\Gamma}{\Delta_1}{P}{\Hby{\news{\widetilde{m}}\bactout{n}{V}}}{\Delta_1'}{P'}$
							\item $Q \scong \newsp{\widetilde{m}}{P' \Par \hotrigger{t}{x}{s}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$
						\end{itemize}
			\end{enumerate}
	\end{enumerate}	
%
\end{definition}

We first show that every visible action $\ell$ is definable.

\begin{lemma}[Definability]
	\label{lem:definibility}
	Every action $\ell$ is definable.
\end{lemma}

\begin{proof}
	\noi We define $T\lrangle{\ell, \suc}$:
	\begin{eqnarray*}
		T\lrangle{\bactinp{n}{V}, \suc} &=&
		\bout{\dual{n}}{V} \bout{\suc}{\dual{n}} \inact
		\\
		T\lrangle{\bactbra{n}{l}, \suc} &=&
		\bsel{\dual{n}}{l} \bout{\suc}{\dual{n}} \inact
		\\
%		T\lrangle{\news{\widetilde{m}} \bactout{n}{\widetilde{m}}, \suc} &=&
%		\binp{\dual{n}}{\widetilde{y}} (\hotrigger{t}{x}{s}{\widetilde{y}} \Par \bout{\suc}{\dual{n}, \widetilde{y}} \inact)
%		\\
%		T\lrangle{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \suc} &=&
%		\binp{\dual{n}}{y} (\hotrigger{t}{x}{s}{\abs{\widetilde{x}}{(\appl{y}{\widetilde{x}}})} \Par \bout{\suc}{\dual{n}, y} \inact)
%		\\
		T\lrangle{\news{\widetilde{m}} \bactout{n}{V}, \suc} &=&
		\binp{\dual{n}}{y} (\hotrigger{t}{x}{s}{y} \Par \bout{\suc}{\dual{n}, y} \inact)
		\\
		T\lrangle{\bactsel{n}{l}, \suc} &=&
		\bbra{\dual{n}}{l: \bout{\suc}{\dual{n}} \inact), l_i: \newsp{a}{\binp{a}{y} \bout{\suc}{\dual{n}} \inact}}_{i \in I}
	\end{eqnarray*}
%		
	\noi Let process 
	\[
		\Gamma; \emptyset; \Delta \proves P \hastype \Proc
	\]
	%
	\noi	It is straightforward to do a case analysis
			on all actions $\ell$ such that
			\[
				\Gamma; \emptyset; \Delta \proves P \hby{\ell} \Delta' \proves P'
			\]
			to show that $\ell$ is definable.
%	\noi it is straightforward to verify that $\forall \ell$, $\ell$ is definable.
	\qed
\end{proof}

%\jp{Here again I think that the closure should not mention environments in the  LHS.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  EXTRUSION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{lemma}[Extrusion]\rm
	\label{lem:extrusion}
	Let $m_1 = \fn{V_1}$ and $m_2 = \fn{V_2}$ and fresh name $\suc$. 
	If 
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}{\cong}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}}
	\]
	then $\exists \Delta_1, \Delta_2$ such that
	\[
		\horel{\Gamma}{\Delta_1}{P}{\cong}{\Delta_2}{Q}.
	\]
\end{lemma}

\begin{proof}
	\noi Let
%
	\begin{eqnarray*}
		\mathcal{S}	&=&
					\set{(\Gamma; \es; \Delta_1 \proves P \hastype \Proc\ ,\ \Gamma; \es; \Delta_2 \proves Q \hastype \Proc) \setbar \\
				& &	\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}
					{\cong}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}},\\
				&&   \land m_1 = \fn{V_1} \land m_2 = \fn{V_2} \\
		&&}
	\end{eqnarray*}
%
	\noi We show that $\mathcal{S}$ is a reduction-closed, barbed congruence.


	\begin{itemize}
		\item	{\bf Reduction-closed:}

				$P \red P'$
				implies
				\[
					\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
					\red
					\newsp{\widetilde{m_1}}{P' \Par \bout{\suc}{\dual{n}, V_1} \inact}
				\]
				which implies from the freshness of $\suc$
				\[
					\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_2} \inact}
					\red^{*}
					\newsp{\widetilde{m_1}}{Q' \Par \bout{\suc}{\dual{n}, V_2} \inact}
				\]
				which in turn implies
				$Q \red^{*} Q'$ as required.

	\item	{\bf Barb Preserving:}

			Let $\Gamma; \es; \Delta_1 \proves P \barb{m}$. We analyse three cases.
			%
		    \begin{itemize}
				\item	Case: $m \not= s$ ($m$ is not a session name)

						$\Gamma; \es; \Delta_1 \proves P \barb{m}$
						implies
					%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
							\barb{m}
						\]
					%
						which implies
						\[
							\Gamma; \es; \Delta_2' \proves
							\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}
							\Barb{m}
						\]
						which implies from the freshness of $\suc$ that
						$\Gamma; \es; \Delta_2 \proves Q \Barb{m}$ as required.

				\item	Case: $m = s$ ($m$ is a session name) and $m \not= n$.
						Similar proof as the previous case.

				\item	Case: $m = s$ ($m$ is a session name) and $m = n$ and
						$\Gamma; \es; \Delta_1 \proves P \barb{n}$
						
						The fact that $n$ is a session 
						implies that $n, \dual{n} \in \dom{\Delta_1'}$
						which implies from the definition
						of barbs (\defref{def:barbs}) that:
						%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
							\not\barb{n}
						\]
						%
						This is because both endpoints of the session $n$
						are present in $\Delta_1'$.


						We compose $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ with
						$\binp{\dual{\suc}}{x, y} T\lrangle{\ell, \suc'}$
						with $\subj{\ell} = x$ and fresh $\suc'$ to get
						%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par
							\binp{\dual{\suc}}{x, y} T\lrangle{\ell, \suc'}
						\]
						%
						The definition of definibility and the fact that $\Gamma; \es; \Delta_1 \proves P \barb{n}$
						implies that
						%
						\[
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par
							\binp{\dual{\suc}}{x, \widetilde{y}} T\lrangle{\ell, \suc'}
							\red^{*} 
							\newsp{\widetilde{m_1}}{P' \Par \bout{\suc'}{\dual{n}, V_1'} \inact}
						\]
						%
						\noi and furthermore
						%
						\[
							\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact} \Par
							\binp{\dual{\suc}}{x, \widetilde{y}} T\lrangle{\ell, \suc'}
							\red^{*} 
							\newsp{\widetilde{m_2}}{Q' \Par \bout{\suc'}{\dual{n}, V_2'} \inact}
						\]
						%
						\noi The last reduction implies that
						$\Gamma; \es; \Delta_2 \proves Q \Barb{n}$ as required.
				\end{itemize}
    
		\item	{\bf Congruence:}

				The key case of congruence is parallel composition.
				The other cases are easier due to the fact that we are
				working with closed process terms (i.e.~input congruence is straightforward
				on closed process terms).
				We define relation $\mathcal{C}$ as
				%
				\begin{eqnarray*}
					\mathcal{C} &=&
					\set{	(\Gamma; \es; \Delta_1 \cat \Delta_3 \proves P \Par R \hastype \Proc,
							\Gamma; \es; \Delta_2 \cat \Delta_3 \proves Q \Par R \hastype \Proc) \setbar
					\\
					& &	\forall R \textrm{ such that } \exists \Delta_3, \Gamma;\es; \Delta_3 \proves R \hastype \Proc \land\\
					& &	\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}
						{\cong}
						{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}}}
				\end{eqnarray*}
		%
				We show that $\mathcal{C}$ is a congruence with respect to parallel composition.
				We distinguish two cases:
				\begin{itemize}
					\item	Case: $(\dual{n} \cup \fn{V_1} \cup \fn{V_2}) \cap \fn{R} = \es$

							From the contextual definition of $\cong$ we can deduce that
							$\forall \Gamma; \es; \Delta_3 \proves R \hastype \Proc$:
							%
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par R}
								{\cong}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact} \Par R}
							\]
							%
							Because of the requirement
							$(\dual{n} \cup \fn{V_1} \cup \fn{V_2}) \cap \fn{R} = \es$
							the above is up to structural congruence with
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact \Par R}}
								{\cong}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact \Par R}}
							\]
							From the definition of $\mathcal{C}$ the conclusion is trivial.

					\item	Case: $\widetilde{s} = \set{\dual{n}, \widetilde{m_1}} \cap \set{\dual{n}, \widetilde{m_2}} \in \fn{R}$.

							Let $R^{\widetilde{y}}$ such that $R = R^{y}\subst{\widetilde{s}}{\widetilde{\widetilde{y}}}$.


							From the contextual definition of $\cong$ we can deduce that for fresh $\suc'$
							$\forall \Gamma; \es; \Delta_3' \proves \binp{\dual{\suc}}{\widetilde{y}} (R^{\widetilde{y}} \Par \bout{\suc'}{\widetilde{y}} \inact) \hastype \Proc$:
							%
							\[
								\mhorel{\Gamma}
								{\Delta_1''}
									{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
									\Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y} \Par \bout{\suc'}{\widetilde{y}} \inact)}
								{\cong}
								{\Delta_2''}{}
									{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}
									\Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y} \Par \bout{\suc'}{\widetilde{y}} \inact)}
							\]

%							From the definition of $\mathcal{C}$
%							we can deduce that $\forall R^{y_1}$ such that $R = R^{y_1}\subst{\widetilde{s}}{\widetilde{y_1}}$
%							and $\suc'$ fresh and $\set{\widetilde{y}} = \set{\widetilde{y_1}} \cup \set{\widetilde{y_2}}$:
							%
%							\[
%								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P \Par \bout{\suc}{\dual{n}, \widetilde{m_1}''} \inact} \Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y_1} \Par \bout{\suc'}{\widetilde{y_2}} \inact)}
%								{\cong}
%								{\Delta_2''}{}{\newsp{\widetilde{m_2}'}{Q \Par \bout{\suc}{\dual{n}, \widetilde{m_2}''} \inact} \Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y_1} \Par \bout{\suc'}{\widetilde{y_2}} \inact)}
%							\]
							%
							\noi Applying reduction closeness to the above pair we get:
							%
							\[
								\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P \Par R \Par \bout{\suc'}{\dual{n}, V_1} \inact}}{\cong}{\Delta_2''}{\newsp{\widetilde{m_2}}{Q \Par R \Par \bout{\suc'}{\dual{n}, V_2} \inact}}
							\]
						%
						\noi The conclusion then follows from the definition of $\mathcal{C}$.
	    \end{itemize}
	\end{itemize}
	\qed
\end{proof}


\begin{lemma}\rm
	\label{app:lem:cong_is_wb}
	$\cong \subseteq \hwb$.
\end{lemma}

\begin{proof}
	\noi Let $\Re$ be the typed relation (we omit the typing information in the definition):
	\[
		\Re = \set{(P_1, P_2) \setbar \horel{\Gamma}{\Delta_1}{P_1}{\cong}{\Delta_2}{P_2}}
	\]

	To prove that $\Re$ is a higher-order bisimulation
	we do a case analysis on the transition:
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}
	\]
	We distinguish two cases: one for the $\tau$ transition and one case for
	the visible transitions $\ell$.

%% Case tau
\begin{enumerate}
	\item Suppose 
			\[
				\horel{\Gamma}{\Delta_1}{P_1}{\by{\tau}}{\Delta_1'}{P_1'}
			\]
			\noi The result follows the reduction closeness property of $\cong$ since
			\[
				\horel{\Gamma}{\Delta_2}{P_2}{\By{\tau}}{\Delta_2'}{P_2'}
			\]
			\noi and
			\[
				\horel{\Gamma}{\Delta_1'}{P_1'}{\cong}{\Delta_2'}{P_2'} \text{ implies } \horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}
			\]

%% Case ell
	\item Suppose
		%
			\begin{eqnarray}
				\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}
				\label{lem:cong_is_wb1}
			\end{eqnarray}
		%
			\noi We choose test $T\lrangle{\ell, \suc}$ to get
		%
			\begin{eqnarray}
				\horel{\Gamma}{\Delta_1 \cat \Delta_3}{P_1 \Par T\lrangle{\ell, \suc}}{\cong}{\Delta_2 \cat \Delta_3}{P_2 \Par T\lrangle{\ell, \suc}}
				\label{lem:cong_is_wb2}
			\end{eqnarray}
		%
			\noi From this point we distinguish two subcases:

			\begin{enumerate}[i.]
			%% Subcase i
				\item	Sub-case $\ell \in \set{\bactinp{n}{V_1}, \bactsel{n}{l}, \bactbra{n}{l}}$:

						\noi By reducing~(\ref{lem:cong_is_wb1}), we obtain
					%
						\begin{eqnarray*}
							&& P_1 \Par T\lrangle{\ell, \suc} \red P_1' \Par \bout{\suc}{\dual{n}} \inact \\
							&& \Gamma; \es; \Delta_1' \cat \Delta_3' \proves P_1' \Par \bout{\suc}{\dual{n}} \inact \barb{\suc}
						\end{eqnarray*}
					%
						\noi implies from~(\ref{lem:cong_is_wb2})
					%
						\begin{eqnarray*}
							&& \Gamma; \es; \Delta_2 \cat \Delta_3 \proves P_2 \Par T\lrangle{\ell, \suc} \Barb{\suc}
						\end{eqnarray*}
					%
						\noi implies from Lemma~\ref{lem:definibility},
					%
						\begin{eqnarray*}
							&& \horel{\Gamma}{\Delta_2}{P_2}{\By{\ell}}{\Delta_2'}{P_2'}\\
							&& P_2 \Par T \lrangle{\ell, \suc} \red^{*} P_2' \Par \bout{\suc}{\dual{n}} \inact
						\end{eqnarray*}
					%
						\noi and
					%
						\[
							\horel{\Gamma}{\Delta_1' \cat \Delta_3'}{P_1' \Par \bout{\suc}{\dual{n}}\inact}{\cong}{\Delta_2' \cat \Delta_3'}{P_2' \Par \bout{\suc}{\dual{n}} \inact}
						\]
						We then apply \lemref{lem:extrusion} to get
					%
						\[
							\horel{\Gamma}{\Delta_1'}{P_1'}{\cong}{\Delta_2'}{P_2'} \text{ implies } \horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}
						\]
					%
						\noi as required.

			%% Subcase ii
				\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$:

						\noi Note that $T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc} = T\lrangle{\news{\widetilde{m_2}} \bactout{n}{V_2}, \suc}$

						\noi Transition~in (\ref{lem:cong_is_wb1}) becomes
					%
						\begin{eqnarray}
							\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_1'}
							\label{lem:cong_is_wb3}
						\end{eqnarray}
					%
						\noi If we use the test process $T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc}$ we reduce to:%~\ref{lem:cong_is_wb1} we get
					%
						\begin{eqnarray*}
							&& P_1 \Par T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc}
							\red
							\newsp{\widetilde{m_1}}{P_1' \Par \hotrigger{t}{x}{s}{V_1}} \Par \bout{\suc}{\dual{n}, V_1} \inact \\
							&& \Gamma; \es; \Delta_1' \cat \Delta_3' \proves \newsp{\widetilde{m_1}}{P_1' \Par \hotrigger{t}{x}{s}{V_1}} \Par \bout{\suc}{\dual{n}, V_1} \inact \barb{\suc}
						\end{eqnarray*}
					%
						\noi implies from~(\ref{lem:cong_is_wb2})
					%
						\[
							\Gamma; \es; \Delta_2 \cat \Delta_3 \proves P_2 \Par T\lrangle{\news{\widetilde{m_2}} \bactout{n}{V_2}, \suc} \Barb{\suc}
						\]
					%
						\noi implies from \lemref{lem:definibility}
					%
						\begin{eqnarray}
							&& \horel{\Gamma}{\Delta_2}{P_2}{\By{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{P_2'}
							\label{lem:cong_is_wb4}\\
							&& P_2 \Par T \lrangle{\ell, \suc} \red^{*} \newsp{\widetilde{m_2}}{P_2' \Par \hotrigger{t}{x}{s}{V_2}} \Par \bout{\suc}{\dual{n}, V_2} \inact \nonumber
						\end{eqnarray}
					%
						\noi and
					%
						\[
							\mhorel{\Gamma}{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}}{P_1' \Par \hotrigger{t}{x}{s}{\abs{\widetilde{x}}{Q_1}}} \Par \bout{\suc}{\dual{n}, V_1} \inact}
							{\cong}
							{\Delta_2' \cat \Delta_3'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \hotrigger{t}{x}{s}{\abs{\widetilde{x}}{Q_2}}} \Par \bout{\suc}{\dual{n}, V_2} \inact}
						\]
					%
						\noi We then apply \lemref{lem:extrusion} to get:
					%
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1' \Par \hotrigger{t}{x}{s}{V_1}}}
							{\cong}
							{\Delta_2'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \hotrigger{t}{x}{s}{V_2}}}
						\]
					%
						\noi From the last result and definition of $\Re$ we get:
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1' \Par \hotrigger{t}{x}{s}{V_1}}}
							{\ \Re\ }
							{\Delta_2'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \hotrigger{t}{x}{s}{V_2}}}
						\]
						\noi as required.

%				\item	Sub-case $\ell = \news{\widetilde{s}} \bactout{n}{\widetilde{m}}$:
%
%						\noi Follows similar arguments as the previous case.
			\end{enumerate}
\end{enumerate}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proof of the main theorem
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\begin{theorem}[Concidence]\label{app:thm:coincidence} We have:
%	\begin{enumerate}
%		\item	$\wbc\ =\ \hwb$.
%		\item	$\wbc\ =\ \cong$.
%	\end{enumerate}
%\end{theorem}
%
%\begin{proof}
%	\noi	\lemref{app:lem:wb_eq_wbf} proves $\hwb\ =\ \fwb$.
%			\lemref{app:lem:cong_is_wb} proves $\cong\ \subseteq\ \hwb$.
%			\lemref{app:lem:wb_is_wbc} proves $\hwb\ \subseteq\ \wbc$.
%			\lemref{app:lem:wbc_is_cong} proves $\wbc\ \subseteq\ \cong$.
%			From the above results, we conclude $\cong\ \subseteq\ \hwb\ =\ \fwb\ \subseteq\ \wbc\ \subseteq\ \cong$. 
%			\qed
%\end{proof}



