% !TEX root = main.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Types inhabit their characteristic process
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Typability of Characteristic Processes}
\newcommand{\delete}[1]{\mathsf{del}(#1)}
\newcommand{\unfold}[1]{\mathsf{unfold}(#1)}
\dkmargin{Read next 2 definitions}



\noi We state and prove a more detailed form of \propref{p:inhabit} (Page~\pageref{p:inhabit}).
The case of recursive session types requires the following two auxiliary definitions for session type unfolding and prefix deletion.
\begin{definition}[Session Type Unfolding]
	Given a session type $S$, the function $\unfold{S}$ is defined as:
	\[
	\begin{array}{c}
		\unfold{\btout{U} S} = \btout{U} S
		\qquad
		\unfold{\btinp{U} S} = \btinp{U} S
		\\
		\unfold{\btsel{l_i: S_i}_{i \in I}} = \btsel{l_i: S_i}_{i \in I}
		\qquad
		\unfold{\btbra{l_i: S_i}_{i \in I}} = \btbra{l_i: S_i}_{i \in I}
		\\
				\unfold{\trec{t}{S}} = \unfold{S \subst{\trec{t}{S}}{\tvar{t}}  }
		\qquad
		\unfold{\tinact} = \tinact
		\end{array}
	\]
\end{definition}

\begin{lemma}
	Let $S$ be a session type. Then $\unfold{S} = S'$ and
	$S' \not= \trec{t}{S''}$.
\end{lemma}

\begin{proof}
	A straightforward induction on the syntax of $S$. \qed
\end{proof}

We state session type prefix deletion relation:
\begin{definition}[Session Type Prefix Deletion]
	Given a session type $S$, the set $\delete{S}$ is defined inductively as follows:
	\[
	\begin{array}{c}
		\delete{\btout{U} S} = \set{S}
		\qquad 
		\delete{\btinp{U} S} = \set{S}
		\\
		\delete{\btsel{l_i: S_i}_{i \in I}} = \set{S_i}_{i \in I}
		\qquad
		\delete{\btbra{l_i: S_i}_{i \in I}} = \set{S_i}_{i \in I}
		\\
				\delete{\trec{t}{S}} = \delete{\unfold{\trec{t}{S}}}
\qquad
		\delete{\tinact} = \set{\tinact}
	\end{array}
	\]
\end{definition}

\label{app:inhabit}

We may now finally state and prove the following proposition:

\begin{proposition}[Characteristic Processes/Values Inhabit Their Types]
	\dkmargin{Check this proposition. \newc{JP: I have checked, now it is OK.}}
	\label{app:characteristic_inhabit}
	\begin{enumerate}
		\item	Let $U$ and $\omapchar{U}$ be a type and its characteristic value, respectively. 
		\begin{enumerate}
			\item	If $U = S$ then, for some s, we have $\es; \es; s: S \proves \omapchar{S} \hastype S$.
	
			\item	If $U = \chtype{S}$ then, for some $a$, we 
have $a: \chtype{S}; \es; \es \proves \omapchar{\chtype{S}} \hastype \chtype{S}$.
	
			\item	If $U = \chtype{L}$ then, for some $a$, we have $a: \chtype{L}; \es; \es \proves \omapchar{\chtype{L}} \hastype \chtype{L}$.

			\item	If $U = \shot{U'}$ and  
					$\Gamma; \es; \Delta \proves \mapchar{U'}{x} \hastype \Proc$
					 then we have 
					$\Gamma \backslash x ; \es; \Delta \backslash x \proves \omapchar{\shot{U'}} \hastype \shot{U'}$.

			\item	If $U = \lhot{U'}$ and
					$\Gamma; \es; \Delta \proves \mapchar{U'}{x} \hastype \Proc$
					 then we have 
					$\Gamma \backslash x ; \es; \Delta \backslash x \proves \omapchar{\lhot{U'}} \hastype \lhot{U'}$.

		\end{enumerate}

		\item	Let $S$ and \mapchar{S}{s} be a session type and its characteristic process, respectively. 
		\begin{enumerate}
			\item	If $S = \tinact$ then $\es; \es; \es; \proves \mapchar{\tinact}{s} \hastype \Proc$.
	
			\item	If $S = \btout{U} S'$ and  
					$\Gamma; \es; \Delta \proves \omapchar{U} \hastype U$ then 
					$\Gamma; \es; \Delta \cat t: \btout{S'} \tinact \cat s: \btout{U} S' \proves \mapchar{\btout{U} S'}{s} \hastype \Proc$.
	
			\item	If $S = \btinp{U} S'$ and
					$\Gamma; \es; \Delta \proves \mapchar{U}{x}  \hastype \Proc$ then 
					$\Gamma \backslash x; \es; (\Delta\backslash x) \cat t: \btinp{S'} \tinact \cat s: \btout{U} S' \proves \mapchar{\btinp{U} S'}{s} \hastype \Proc$.
	
			\item	If $S = \btsel{l_i: S_i}_{i \in I}$ then 
					$\es; \es; \set{t_i: \btout{S_i} \tinact}_{i \in I} \cat s: \btsel{l_i: S_i}_{i \in I} \proves \mapchar{\btsel{l_i: S_i}_{i \in I}}{s} \hastype \Proc$.
	
			\item	If $S = \btbra{l_i: S_i}_{i \in I}$ then 
					$\es; \es; \set{t_i: \btout{S_i} \tinact}_{i \in I} \cat s: \btbra{l_i: S_i}_{i \in I} \proves \mapchar{\btbra{l_i: S_i}_{i \in I}}{s} \hastype \Proc $.
	
			\item	If $S = \trec{t}{S'}$ then either
					\begin{itemize}
%						\item whenever $\es; \es; \es \proves \mapchar{S' \subst{\tinact}{\vart{t}}}{s} \hastype \Proc$
%						then $\es; \es; \es \proves \mapchar{\trec{t}{S'}}{s} \hastype \Proc$
%
%						\item whenever $\forall S_i \in \delete{S}$,
%						$\exists, \Gamma, \Delta, S_i'$ such that
%						$\Gamma; \es; \Delta \cat \set{t_i: S_i'}_{i \in I} \cat s: S' \subst{\tinact}{\vart{t}} \proves \mapchar{S' \subst{\tinact}{\vart{t}}}{s} \hastype \Proc$
%						then
%						$\Gamma; \es; \Delta \cat \set{t_i: \btout{S_i} \tinact}_{i \in I} \cat s: \trec{t}{S'} \proves \mapchar{\trec{t}{S'}}{s} \hastype \Proc$.

						\item \newc{$\es; \es; \es \proves \mapchar{\trec{t}{S'}}{s} \hastype \Proc$}

						\item \newc{for all $S_i \in \delete{S}$ there exist $\Gamma, \Delta$, and $S_i'$ such that $$\Gamma; \es; \Delta \cat \set{t_i: S_i'}_{i \in I} \cat s: S' \subst{\tinact}{\vart{t}} \proves \mapchar{S' \subst{\tinact}{\vart{t}}}{s} \hastype \Proc$$						and 
						$\Gamma; \es; \Delta \cat \set{t_i: \btout{S_i} \tinact}_{i \in I} \cat s: \trec{t}{S'} \proves \mapchar{\trec{t}{S'}}{s} \hastype \Proc$.}
						
						
					\end{itemize}
			\end{enumerate}

		\item	Let $U$ and $\mapchar{U}{a}$  be a channel type and its characteristic process, respectively.
		\begin{enumerate}
			\item	If $U = \chtype{S}$ and $\es; \es; \Delta \proves \omapchar{S} \hastype S$ then \\
					$a: \chtype{S}; \es; \Delta \cat t: \btout{\chtype{S}} \tinact \proves \mapchar{\chtype{S}}{a} \hastype \Proc$.
	
			\item	If $U = \chtype{L}$ and $\Gamma; \es; \Delta \proves \omapchar{L} \hastype L$ then \\
					$\Gamma \cat a: \chtype{L}; \es; \Delta \cat t: \btout{\chtype{L}} \tinact \proves \mapchar{\chtype{L}}{a} \hastype \Proc$.
	
			\item	If $U = \shot{U'}$ and  $\Gamma; \es; \Delta \proves \omapchar{U'} \hastype U'$ then \\
					$\Gamma \cat x: \shot{U'}; \es;\Delta \proves \mapchar{\shot{U'}}{x} \hastype \Proc$.
	
			\item
					If $U = \lhot{U'}$ and   $\Gamma; \es; \Delta \proves \omapchar{U'} \hastype U'$ then \\
					$\Gamma \cat x: \shot{U'}; \es;\Delta \proves \mapchar{\lhot{U'}}{x} \hastype \Proc$.
		\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof} The proof proceeds by mutual induction on the syntax of types. We analyze the three parts separately: 
	\begin{enumerate}
		\item	We use the results from Parts 2 and 3 in a 
				case analysis on the syntax of $U$.
			\begin{enumerate}[-]
				\item	Cases (a) $U = S$, (b) $U = \chtype{S}$, and (c) $U = \chtype{L}$: \\
The proof is straightforward from Rules $\trule{Sess}$ and $\trule{Sh}$ (cf. \figref{fig:typerulesmy}).

				\item	Case (d) $U = \shot{U'}$: By Parts 2 and 3 of this lemma we obtain 
						$\Gamma; \es; \Delta \proves \mapchar{U'}{x} \hastype \Proc$, which implies 
						$\Gamma \backslash x ; \es; \Delta \backslash x \proves \omapchar{\shot{U'}} \hastype \shot{U'}$
						by
						 Rules $\trule{Abs}$ and $\trule{EProm}$ (cf. \figref{fig:typerulesmy}).

				\item	Case (e) $U = \lhot{U'}$: Similar, using Rule $\trule{Abs}$ (cf. \figref{fig:typerulesmy}).
			\end{enumerate}
		\item	The proof is by induction on the syntax of $S$.
				We detail some notable cases:
			\begin{enumerate}
				\item	Case $S = \btout{U} S'$: Then, by \defref{def:char}, we have 
						$\mapchar{S}{s} = \bout{s}{\omapchar{U}} \bout{t}{s} \inact$ and 
						we may obtain the following derivation:
						\[
							\tree{
								\begin{array}{l}
									\Gamma; \es; s: S' \cat t: \btout{S'} \tinact \hastype \bout{t}{s} \inact \hastype \Proc \qquad \text{(Induction)}
									\\
									\Gamma; \es; \Delta \proves \omapchar{U} \hastype U
								\end{array}
							}{
								\Gamma; \es; \Delta \cat s: \btout{U} S' \cat t: \btout{S} \tinact \hastype \bout{s}{\omapchar{U}}\bout{t}{s} \inact \hastype \Proc
							}
						\]
						
				\item	Case $S = \btinp{S_1} S_2$: Then, by \defref{def:char}, we have 
						$\mapchar{S}{s} = \binp{s}{x} (\bout{t}{s} \inact \Par \mapchar{S_1}{x})$.
						 and 
						we may obtain the following derivation:
						\[
							\tree{
								\tree{
									\begin{array}{l}
										\Gamma; \es; \Delta \cat x: S_1 \proves \mapchar{S_1}{x} \hastype \Proc
										\qquad \text{(Induction)}
										\\
										\Gamma; \es; t: \btout{S_2} \tinact \cat s: S_2 \proves \bout{t}{s} \inact \hastype \Proc
									\end{array}
								}{
									\Gamma; \es; \Delta \cat x: S_1 \cat t: \btout{S_2} \tinact \cat s: S_2 \proves
									\bout{t}{s} \inact \Par \mapchar{S_1}{x} \hastype \Proc
								}
							}{
								\Gamma; \es; \Delta \cat t: \btout{S_2} \tinact \cat s: \btinp{U} S_2 \proves \binp{s}{x} (\bout{t}{s} \inact \Par \mapchar{S_1}{x}) \hastype \Proc
							}
						\]
					\item	Case $S = \trec{t}{S'}$: Then, by \defref{def:char}, $\mapchar{S} = \mapchar{S' \subst{\tinact}{\vart{t}} }{u}$.
							The proof is done by induction on the shape of $S'$. We detail two sub-cases; the rest is similar or simpler.
							\begin{enumerate}[i)]
								\item	Sub-case $S' = \btbra{l_i: S_i}_{i \in I}$: Then
										$\mapchar{S' \subst{\tinact}{\vart{t}}}{s} = \bbra{s}{l_i: \bout{t_i}{s} \inact}_{i \in I}$
										and $\delete{S} = \set{S_i}_{i \in I}$:
										\[
											\tree {
												\forall i \in I, \es; \es; t_i: S_i \subst{\tinact}{\vart{t}} \proves \bout{t_i}{s} \inact \hastype \Proc
											}{
												\es; \es; t_i: S_i \subst{\tinact}{\vart{t}} \cat s: S' \subst{\tinact}{\vart{t}} \proves \bbra{s}{l_i: \bout{t_i}{s} \inact}_{i \in I} \hastype \Proc
											}
										\]
										We may then type $\mapchar{\trec{t}{ \btbra{l_i: S_i}_{i \in I} }}{s}$:
										\[
											\tree {
												\forall i \in I, \es; \es; t_i: S_i \proves \bout{t_i}{s} \inact \hastype \Proc
											}{
												\es; \es; t_i: S_i \cat s: \trec{t}{ \btbra{l_i: S_i}_{i \in I} } \proves \bbra{s}{l_i: \bout{t_i}{s} \inact}_{i \in I} \hastype \Proc
											}
										\]

								\item	Sub-case $S' = \trec{t'}{S''}$: Then 
										$\mapchar{\trec{t'}{S''} \subst{\tinact}{\vart{t}}}{s} = \mapchar{S'' \subst{\tinact}{\vart{t}} \subst{\tinact}{\vart{t'}}  }{s}$. 
								
										If $\mapchar{S'' \subst{\tinact}{\vart{t}} \subst{\tinact}{\vart{t'}}  }{s} = \inact$ then the proof is straightforward. If $\delete{S} = \set{S_i}_{i \in I}$ then by induction
										\[
											\tree {
												\textrm{Induction}
											}{
												\Gamma; \es; \Delta \cat t_i: S_i \subst{\tinact}{\vart{t}} \subst{\tinact}{\vart{t'}} \cat s: S'' \subst{\tinact}{\vart{t}} \subst{\tinact}{\vart{t'}} \proves \mapchar{S'' \subst{\tinact}{\vart{t}} \subst{\tinact}{\vart{t'}}  }{s} \hastype \Proc
											}
										\]
										We may then type $\mapchar{S}{s}$:
										\[
											\tree {
												\textrm{Induction} %\forall i \in I, \es; \es; t_i: S_i \proves \bout{t_i}{s} \inact \hastype \Proc
											}{
												\Gamma; \es; \Delta \cat t_i: S_i \cat s: S \proves \mapchar{\trec{t}{ \trec{t'}{S''}}}{s} \hastype \Proc
											}
										\]

							\end{enumerate}

					%\item	Other cases are similar.
			\end{enumerate}

		\item	The proof  uses the result of Part 1.
				We do a case analysis on the structure of $U$.
			\begin{enumerate}
				\item	Case $U = \chtype{S}$:
						From Part 1 we have that $\es; \es; \Delta \proves \omapchar{S} \hastype S$.
						By applying Rule $\trule{Req}$ (cf. \figref{fig:typerulesmy}) we obtain:
						\[
							\tree{
								a: \chtype{S}; \es; \Delta \proves \omapchar{S} \hastype S
								\qquad
								a: \chtype{S}; \es; t: \btout{\chtype{S}} \tinact \proves \bout{t}{a} \inact \hastype \Proc
							}{
								a: \chtype{S}; \es; \Delta \cat t: \btout{\chtype{S}} \tinact \proves \mapchar{\chtype{S}}{a} \hastype \Proc
							}
						\]

				\item	Case $U = \chtype{S}$: Similar argumentation as in the previous case.

				\item
						Case $U = \lhot{U'}$: From Part 1 we know that
						$\Gamma; \es; \Delta \proves \omapchar{U'} \hastype U'$.
						By applying Rules~$\trule{App}$ and  $\trule{EProm}$ (cf. \figref{fig:typerulesmy}) we obtain:
						\[
							\tree {
								\tree {
									\Gamma; \es; \Delta \proves \omapchar{U'} \hastype U'
									\qquad
									\Gamma; x: \lhot{U'}; \es \proves x \hastype \lhot{U'}
								}{
									\Gamma; x: \lhot{U'}; \Delta \proves \appl{x}{\omapchar{U'}} \hastype \Proc 
								}
							}{
								\Gamma \cat x: \shot{U'}; \es;\Delta \proves \mapchar{\lhot{U'}}{x} \hastype \Proc
							}
						\]

				\item	Case $U = \shot{U'}$: Similar argumentation as in the previous case
						without applying Rule~$\trule{EProm}$ (cf. \figref{fig:typerulesmy}).
			\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}

\begin{comment}
\dk{NY: I propose to comment out this example after Jorge check
	\begin{example}
		\begin{itemize}
			\item	$\trec{t}{\btout{U} \vart{t}}$
					%
					\[
						\tree{
							\Gamma; \es; \Delta \hastype \omapchar{U} \hastype U\\
							\Gamma; \es; t: \btout{\tinact} \tinact \cat s: \tinact \proves \bout{t}{s} \inact \hastype \Proc
						}{
							\Gamma; \es; \Delta \cat t: \btout{\tinact} \tinact \cat s: \btout{U} \tinact \proves
							\mapchar{\btout{U} \tinact}{s} = \bout{s}{\omapchar{U}} \bout{t}{s} \inact \hastype \Proc
						}
					\]
					and
					\[
						\tree {
							\Gamma; \es; \Delta \cat t: \btout{\trec{t}{\btout{U} \vart{t}}} \tinact \cat s: \trec{t}{\btout{U} \vart{t}} \proves
							\bout{t}{s} \inact \hastype \Proc
						}{
							\Gamma; \es; \Delta \cat t: \btout{\trec{t}{\btout{U} \vart{t}}} \tinact \cat s: \trec{t}{\btout{U} \vart{t}} \proves
							\mapchar{\trec{t}{\btout{U} \vart{t} }}{s} =
							\mapchar{(\btout{U} \vart{t}) \subst{\tinact}{\vart{t}}}{s} =
							\mapchar{\btout{U} \tinact}{s} = \bout{s}{\omapchar{U}} \bout{t}{s} \inact \hastype \Proc
						}
					\]

					\item	$\trec{t}{\btout{U_1} \btinp{U_2} \vart{t}}$
					%
					\[
						\tree{
							\Gamma; \es; \Delta \hastype \omapchar{U_1} \hastype U_2\\
							\Gamma; \es; t: \btout{\btinp{U_2} \tinact} \tinact \cat s: \btinp{U_2} \tinact \proves \bout{t}{s} \inact \hastype \Proc
						}{
							\Gamma; \es; \Delta \cat t: \btout{\btinp{U_2} \tinact} \tinact \cat s: \btout{U_1} \btinp{U_2} \tinact \proves
							\mapchar{\btout{U_1} \btinp{U_2} \tinact}{s} = \bout{s}{\omapchar{U_1}} \bout{t}{s} \inact \hastype \Proc
						}
					\]
					and
					\[
						\tree {
							\Gamma; \es; \Delta \cat t: \btout{\btinp{U_2} \trec{t}{\btout{U_1} \btinp{U_2} \vart{t}}} \tinact
							\cat s: \btinp{U_2} \trec{t}{\btout{U} \vart{t}} \proves
							\bout{t}{s} \inact \hastype \Proc
						}{
							\Gamma; \es; \Delta \cat t: \btout{\btinp{U_2} \trec{t}{\btout{U} \vart{t}}} \tinact \cat s: \trec{t}{\btout{U} \vart{t}} \proves
							\bout{s}{\omapchar{U_1}} \bout{t}{s} \inact \hastype \Proc
						}
					\]
					
			\item	$\trec{t}{  \btbra{l_1: \vart{t}, l_2: \tinact}  }$
					\[
					\tree{
					}{
						\es; \es; t_1: \btout{\tinact} \tinact \cat t_2: \btout{\tinact} \tinact \cat
						s: \btbra{l_1: \tinact, l_2: \tinact} \proves
						\mapchar{\btbra{l_1: \tinact, l_2: \tinact}}{s} = \bbra{s}{l_1: \bout{t_1}{s} \inact, l_2: \bout{t_2}{s} \inact}
						\hastype \Proc
					}
					\]
					and
					\[
					\tree{
						\begin{array}{l}
			\es; \es; t_1: \btout{\trec{t}{  \btbra{l_1: \vart{t}, l_2: \tinact}}} \tinact
		\cat s: \trec{t}{  \btbra{l_1: \vart{t}, l_2: \tinact}} \proves
					\bout{t_1}{s} \inact \hastype \Proc
							\\
		\es; \es; t_2: \btout{\tinact} \tinact \cat \tinact \proves
				\bout{t_2}{s} \inact \hastype \Proc
						\end{array}
					}{
						\es; \es; t_1: \btout{\trec{t}{  \btbra{l_1: \vart{t}, l_2: \tinact}}} \tinact \cat t_2: \btout{\tinact} \tinact \cat
						s: \trec{t}{  \btbra{l_1: \vart{t}, l_2: \tinact}} \proves
						\mapchar{\trec{t}{\btbra{l_1: \vart{t}, l_2: \tinact}}}{s} = \bbra{s}{l_1: \bout{t_1}{s} \inact, l_2: \bout{t_2}{s} \inact}
						\hastype \Proc
					}
					\]
		\end{itemize}
	\end{example}
}
\end{comment}

%\section{Behavioural Semantics}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% tau - Innertness
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Deterministic Transitions}
\label{app:sub_tau_inert}


The proofs for 
\thmref{the:coincidence} (Page \pageref{the:coincidence}) require an auxiliary result on 
deterministic transitions (\lemref{lem:up_to_deterministic_transition}, Page \pageref{lem:up_to_deterministic_transition}).
Some notions needed to prove this auxiliary result are presented next.
%Then we present the proof of \thmref{the:coincidence}, based on \emph{higher-order bisimilarity}.

%As mentioned in the paper, 
%the proof of \thmref{the:coincidence}
%relies on an auxiliary typed behavioral equivalence, \emph{higher-order bisimilarity}:

%\begin{definition}[Higher-Order Bisimulation]\myrm
%	\label{def:bisim}
%	Typed relation
%	$\Re$ is a {\em higher-order bisimulation} if for all
%	$\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{Q_1}$, % implies:
%%
%	\begin{enumerate}[1.]
%		\item	%$\forall \news{\widetilde{m_1}} \bactout{n}{V_1}$ such that
%		   Whenever 
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_2}
%			$
%			there exist $Q_2$, $V_2$, $\Delta_2'$ such that
%			\[
%				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}
%			\]
%			and, for a fresh $t$, 
%			$
%				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
%				{\ \Re\ }
%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}$.
%			
%%
%		\item	For all 
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
%			$
%			such that $\ell \not= \news{\widetilde{m}} \bactout{n}{V}$, there exist
%			 $\exists Q_2$ and $\Delta_2'$ such that 
%			\[
%				\horel{\Gamma}{\Delta_1}{Q_1}{\Hby{\hat{\ell}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re\ }{\Delta_2'}{Q_2}$.
%
%		\item	The symmetric cases of 1 and 2.
%	\end{enumerate}
%	The Knaster-Tarski theorem ensures that the largest higher-order bisimulation exists;
%	it is called \emph{higher-order bisimilarity} and is denoted by $\hwb$.
%\end{definition}
In the following we sometimes use polyadic abstractions 
(denoted $\abs{\tilde{x}}{P}$)
and polyadic name passing 
(denoted $\bout{u}{\tilde{V}}{P}$ and  $\binp{u}{\tilde{x}}{P}$, respectively)
as shorthand notations. 

%\smallskip


%the theorem in \secref{sec:behavioural}.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    TAU - INNERTNESS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We now prove \propref {lem:tau_inert}, as stated in Page~\pageref{lem:tau_inert}:


\begin{proposition}[$\tau$-inertness]
	\label{app:lem:tau_inert}
	Suppose $\Gamma; \es; \Delta \proves P \hastype \Proc$  with balanced $\Delta$.
	Then
	\begin{enumerate}[1.]
		\item	$\horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}$ implies
			$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
		\item	$\horel{\Gamma}{\Delta}{P}{\Hby{\dtau}}{\Delta'}{P'}$ implies
			$\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
	\end{enumerate}
\end{proposition}

%\jp{This proof seems to be by induction on deterministic transition; but then the analysis is on the structure of processes,
%which is confusing. In general: I would have done this proof by coinduction, constructing a closure containing $(P, P')$.}

\begin{proof}
We only prove Part 1; the proof for Part 2 follows straightforwardly.
The proof proceeds by showing that the relation 
$$
\Re = \{ (P,P') ~|~ \horel{\Gamma}{\Delta}{P}{\hby{\dtau}}{\Delta'}{P'}\}
$$
is a higher-order bisimulation. 

Suppose first that 
$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P''}$, for some $P''$; we have to show that $P'$ can produce an appropriate matching action.
There are two main cases: $\ell \neq \tau$ (a visible action) and  $\ell = \tau$ (an unobservable, possibly deterministic action). 
The first case follows easily by typing conditions and type soundness, which ensure that $P'$ has the same potential as $P$ for performing visible actions. 
The second case can be divided into two sub-cases: first, if $\tau = \dtau$ then $P' = P''$ and the thesis trivially follows; second, if $\tau \neq \dtau$ (i.e., $P$ has the possibility of performing both $\dtau$ and some other $\tau$) 
then either $P'$ has the same $\tau$ or $P'$ does not have it, because $\dtau$ excluded the occurrence of $\tau$. 
The thesis follows by noticing that, in the first case, $P'$ can match the move from $P$; the second case cannot occur because of typing and the definition of deterministic transitions. 

Suppose now  that 
$\horel{\Gamma}{\Delta}{P'}{\hby{\ell}}{\Delta'}{P''}$, for some $P''$.
This case follows immediately by noticing that $P$ can always match action $\ell$ by performing the deterministic action $\dtau$ first, i.e., we can always have
$\horel{\Gamma}{\Delta}{P}{\hby{\dtau}\hby{\ell}}{\Delta'}{P''}$.
This concludes the proof.
%
%OLD PROOF:
%	The proof is by induction on the structure of $\by{\tau}$
%	which coincides with the reduction $\red$.
%
%	\noi Basic step: 
%	\begin{enumerate}
%		\item %Case: $P = \appl{(\abs{x}{P})}{n}$:
%	%
%		\[
%			\horel{\Gamma}{\Delta}{\appl{(\abs{x}{P})}{n}}{\hby{\btau}}{\Delta'}{P \subst{n}{x}}
%		\]
%	%
%		\noi Bisimulation requirements hold because there is no other transition to observe than ${\hby{\btau}}$.
%
%		\item %Case: $P = \bout{s}{V} P_1 \Par \binp{\dual{s}}{x} P_2$:
%	%
%		\[
%			\horel{\Gamma}{\Delta}{\bout{s}{V} P_1 \Par \binp{\dual{s}}{x} P_2}{\hby{\stau}}{\Delta'}{P_1 \Par P_2}
%		\]
%	%
%		\noi The proof follows from the fact that we can only observe a $\tau$
%		action on typed process
%		$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
%		Actions $\bactout{s}{V}$ and $\bactinp{\dual{s}}{V}$
%		are forbidden by the LTS for typed environments;
%		\dk{this is because
%		$s: \btout{U} S_1 \cat \dual{s}: \btinp{U} S_2 \in \Delta$ and
%		Rule \eltsrule{SSnd} (resp., \eltsrule{SRv}) cannot be applied
%		in order to observe action $(\Gamma; \es; \Delta) \by{\bactout{s}{V}} (\Gamma; \es; \Delta')$
%		(resp., action $(\Gamma; \es; \Delta) \by{\bactinp{\dual{s}}{V}} (\Gamma; \es; \Delta'')$)
%		because of the requirement $\dual{s} \notin \dom{\Delta}$ (resp., $s \notin \dom{\Delta}$).
%		}
%
%		\noi It is easy to conclude then that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
%
%		\item %Case:
%			\[
%				\horel{\Gamma}{\Delta}{\bsel{s}{l_k} P \Par \bbra{\dual{s}}{l_i: P_i}_{i \in I}}{\hby{\stau}}{\Delta'}{P \Par P_k}
%			\]
%
%		\noi Similar arguments as the previous case.
%	\end{enumerate}
%	
%	\noi Induction hypothesis:
%
%	\noi If $P_1 \red P_2$ then $\horel{\Gamma_1}{\Delta_1}{P_1}{\hwb}{\Delta_2}{P_2}$.
%	\noi Induction Step:
%	\begin{enumerate}
%		\item %Case: $P = \news{s} P_1$
%	%
%		\[
%			\horel{\Gamma}{\Delta}{\news{s}{P_1}}{\hby{\stau}}{\Delta'}{\news{s} P_2}
%		\]
%	%
%		\noi From the induction hypothesis and the fact that bisimulation is a congruence
%		we infer that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
%
%		\item  %Case: $P = P_1 \Par P_3$
%	%
%		\[
%			\horel{\Gamma}{\Delta}{P_1 \Par P_3}{\hby{\stau}}{\Delta'}{P_2 \Par P_3}
%		\]
%	%
%		\noi From the induction hypothesis and the fact that bisimulation is a congruence
%		we infer that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
%
%		\item   %Case:
%			\[
%				P \scong P_1 \text{ and }\horel{\Gamma}{\Delta}{P_1}{\hby{\stau}}{\Delta'}{P'}
%			\]
%%
%		From the induction hypothesis and the fact that bisimulation is a congruence \dk{(\thmref{the:coincidence})}
%		and structural congruence preserves $\hwb$
%		we infer that $\horel{\Gamma}{\Delta}{P}{\hwb}{\Delta'}{P'}$.
%	\end{enumerate}
%%	The proof for part two is an induction on the length of $\red^*$.
%%	The basic step is trivial and the inductive step
%%	deploys part 1 of this lemma and the fact that bisimulation is
%%	transitive to conclude.
%%	We can now conclude that
%%	$P \wbc P'$ because $P \wbc P''$ and $P'' \wbc P'$.
	\qed
\end{proof}


%\begin{lemma}[Up-to Deterministic Transition]\myrm
%	\label{lem:up_to_deterministic_transition}
%	Let $\horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2}{Q_1}$ such
%	that if whenever:
%%
%	\begin{enumerate}
%		\item	$\forall \news{\widetilde{m_1}} \bactout{n}{V_1}$ such that
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_3}{P_3}
%			$
%			implies that $\exists Q_2, V_2$ such that
%			\[
%				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			\[
%				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
%			\]
%			and for fresh $t$:
%			\[
%				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \htrigger{t}{V_1}}}
%				{\ \Re\ }
%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}}
%%				\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par \hotrigger{t}{x}{s}{V_1}}}
%%				{\ \Re\ }
%%				{\Delta_2''}{}{\newsp{\widetilde{m_2}}{Q_2 \Par \hotrigger{t}{x}{s}{V_2}}}
%			\]
%%
%		\item	$\forall \ell \not= \news{\widetilde{m}} \bactout{n}{V}$ such that
%			$
%				\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_3}{P_3}
%			$
%			implies that $\exists Q_2$ such that 
%			\[
%				\horel{\Gamma}{\Delta_1}{Q_1}{\hat{\Hby{\ell}}}{\Delta_2'}{Q_2}
%			\]
%			and
%			\[
%				\horel{\Gamma}{\Delta_3}{P_3}{\Hby{\dtau}}{\Delta_1'}{P_2}
%			\]
%			and
%			$\horel{\Gamma}{\Delta_1'}{P_2}{\ \Re\ }{\Delta_2'}{Q_2}$
%
%		\item	The symmetric cases of 1 and 2.
%	\end{enumerate}
%	Then $\Re\ \subseteq\ \wb$.
%\end{lemma}
%
%
%\begin{proof}
%	The proof is easy by considering the closure
%	\[
%		\Re^{\Hby{\dtau}} = \set{ \horel{\Gamma}{\Delta_1'}{P_2}{,}{\Delta_2'}{Q_1} \setbar \horel{\Gamma}{\Delta_1}{P_1}{\ \Re\ }{\Delta_2'}{Q_1},
%		\horel{\Gamma}{\Delta_1}{P_1}{\Hby{\dtau}}{\Delta_1'}{P_2} }
%	\]
%	We verify that $\Re^{\Hby{\dtau}}$ is a bisimulation with
%	the use of \propref{app:lem:tau_inert}.
%	\qed
%\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%          COINCIDENCE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Proof of \thmref{the:coincidence}}
\label{app:sub_coinc}


\noi We split the proof of \thmref{the:coincidence} (Page \pageref{the:coincidence}) into 
several lemmas:
\begin{enumerate}[$-$]
\item	\lemref{app:lem:wb_eq_wbf} establishes $\hwb\ =\ \fwb$.
\item    \lemref{lem:trigger_subst} establishes a trigger substitution lemma (\lemref{lem:trigger_substmt} in the main text), using 
\lemref{lem:trigger_application} (Page \pageref{lem:trigger_application}).
\item	\lemref{app:lem:wb_is_wbc} exploits the process substitution result
		given by \lemref{lem:process_subst} (\lemref{lem:proc_substmt} in the main text) to prove that $\hwb\ \subseteq\ \wbc$.
\item	\lemref{app:lem:wbc_is_cong} shows that $\wbc$ is a congruence
		which implies $\wbc\ \subseteq\ \cong$.
\item	\lemref{app:lem:cong_is_wb} shows  that $\cong\ \subseteq\ \hwb$ using 
\lemref{lem:definibility} (definability) and \lemref{lem:extrusion} (extrusion).
\end{enumerate}

\newcommand{\ntrigger}[2]{#1 \leftharpoonup #2}
\newcommand{\newtrigger}[2]{\binp{#1}{x} \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{#2} \inact} }

We introduce a useful notation for action labels, which will be used in the following to represent matching actions.

\begin{definition}
Let $\ell$ be an action label (cf. \secref{ss:lts}). We define the action $\mact{\ell}$ as 
	\[
		\mact{\ell} =
		\left\{
		\begin{array}{lcl}
			\newsp{\widetilde{m_2}}{\bactout{n}{V_2}} & \quad & \text{if  $\ell = \newsp{\widetilde{m_1}}{\bactout{n}{V_1}}$, for some $V_2, \widetilde{m_2}$} 
			\\
			\ell &&  \text{otherwise}
		\end{array}
		\right.
	\]
\end{definition}

Thus, given $\ell$, its corresponding action $\mact{\ell}$ is either identical to $\ell$, or an output on the same name, possibly with different object and extruded names.

We now introduce an alternative trigger process
that is used to simplify the proofs. Let
\begin{equation}
	\ntrigger{t}{V} = \newtrigger{t}{V}
	\label{eq:ntrig}
\end{equation}
\noindent
The first auxiliary lemma states the equivalence (up to $\hwb$) between
higher-order trigger processes $\htrigger{t}{V}$ (cf.~\eqref{eqb:0}) and $\ntrigger{t}{V}$.
\begin{lemma}[Alternative Trigger Process]
Let $P$ and $Q$ be processes.
	\label{lem:alt_tr}
	\begin{enumerate}
		\item	Let $t$ be a fresh name, $\Delta_1 = \Delta_3 \cat t: \btout{\tinact} \tinact$, and
				$\Delta_2 = \Delta_4 \cat t: \btout{\tinact} \tinact$. Then
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}  } }
				\]
				if and only if%,  for some $\Delta_3, \Delta_4$
				\[
					\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}P  }
					{\hwb}
					{\Delta_4}{\news{\widetilde{m_2}}Q}
				\]

		\item	Let $t$ a fresh name, $\Delta_1 = \Delta_3 \cat t: \btout{\tinact} \tinact$ and
				$\Delta_2 = \Delta_4 \cat t: \btout{\tinact} \tinact$. Then
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\fwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}  } }
				\]
				if and only if%, for some $\Delta_3, \Delta_4$
				\[
					\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}P}
					{\fwb}
					{\Delta_4}{\news{\widetilde{m_2}}Q}
				\]

		\item	Let $t$ be a fresh name. Then
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}  } }
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}  } }
				\]
				if and only if, for some $\Delta_3, \Delta_4$, 
				\[
					\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
					{\hwb}
					{\Delta_4}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}}
				\]
	\end{enumerate}
\end{lemma}

\begin{proof}
We analyze each of the three parts:
\begin{enumerate}[$-$]
	\item Part 1. We split the proof into the two directions
	of the if and only if requirements.
	\begin{enumerate}[a)]
		\item	First direction. Consider the typed relation (we omit the type information):
				\begin{eqnarray*}
					\Re &=& \set{	(\news{\widetilde{m_1}}P\ , \ 
									\news{\widetilde{m_2}}Q) \setbar\\
					&&
									\quad \horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
									{\hwb}
									{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}  } }
					}
				\end{eqnarray*}
				We check the requirements of higher-order bisimulation
				for  $\Re$.
				Suppose that
				\[
					\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}P    }
					{\hby{\ell}}
					{\Delta_3'}{\news{\widetilde{m_1}'}P'}
				\]
				\newc{then we need to show a matching action from $\news{\widetilde{m_2}}Q$. }
				We can derive that
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\hby{\ell}}
					{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par \newsp{s}{\bout{t}{s} \inact}  } }
				\]
				for some $\Delta_1'$
				which, from the freshness of $t$, implies that there exist $Q'$ and $\Delta_2'$
%				with $\ell_2 = \ell_1$ in the case $\ell_1$ not being an output,
				such that
				\begin{eqnarray}
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\Hby{\mact{\ell}}}
					{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \newsp{s}{\bout{t}{s} \inact}  } }
					\label{help_tr_1}
				\end{eqnarray}
%				\JP{ We need to say that $\ell_2$ is only different from $\ell_1$ in the output case!}
				and
				\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par C_1 \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\hwb}
					{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par C_2 \Par \newsp{s}{\bout{t}{s} \inact}  } }
				\]
				with $C_1 = \htrigger{t'}{V_1}$ and $C_2 = \htrigger{t'}{V_2}$ (if $\ell$ and $\mact{\ell}$ are output actions
				with objects $V_1$ and $V_2$, respectively) and $C_1 = C_2 = \inact$ (otherwise).
				The latter equation implies from the definition of $\Re$
				\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par C_1 \Par \newsp{s}{\bout{t}{s} \inact}  } }
					{\ \Re\ }
					{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par C_2 \Par \newsp{s}{\bout{t}{s} \inact}  } }
				\]
				and \eqref{help_tr_1} implies
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_2}{\news{\widetilde{m_2}}Q}
					{\Hby{\mact{\ell}}}
					{\Delta_2'}{\news{\widetilde{m_2}'} Q'}
				\end{eqnarray*}
				to complete the proof of the case.

		\item	Second direction. Consider the typed relation (we omit the type information):
				\begin{eqnarray*}
					\Re &=& \set{	(\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}}\ , \ 
									\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}}) \setbar\\
					&&
									\qquad \qquad \qquad \qquad \qquad \qquad \horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P  } }
									{\hwb}
									{\Delta_4}{\newsp{\widetilde{m_2}}{Q  } }
					}	
				\end{eqnarray*}
				We check the requirements of higher-order bisimulation
				for $\Re$. \\
				\newc{Suppose that $\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}}$ moves;
				we need to infer an appropriate matching action from $\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}}$.}
				We analyse three cases:
				\begin{enumerate}[i)]
					\item Process $P$ moves autonomously, i.e., for some $\Delta_1'$ we have:
							\[
								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
								{\hby{\ell}}
								{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par \newsp{s}{\bout{t}{s} \inact}}}
							\]
							Then the proof is similar to the previous case.

					\item An action on the fresh name $t$, , i.e., for some $\Delta_1'$ we have:
					\[
								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\bout{t}{s} \inact}  } }
								{\hby{\bactout{t}{s}} }
								{\Delta_1'}{\news{\widetilde{m_1}} P}
							\]
							First notice that the typing derivation
							reveals that $\Delta_1(t) = \Delta_2(t) = \btout{\tinact} \tinact$.
							This is because the dual endpoint of the (restricted) session $s$ does not appear
							in $\newsp{s}{\bout{t}{s} \inact}$ and thus it has the inactive type $\tinact$.
							We can then observe that,  for some $\Delta_2'$ we have:
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \newsp{s}{\bout{t}{s} \inact}  } }
								{\Hby{\bactout{t}{s}} }
								{\Delta_2'}{\news{\widetilde{m_2}} Q'}
							\]
							We need to show that
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t'}{s}  } }
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \htrigger{t'}{s}  } }
							\]
							The proof is easy if we consider that both processes can perform the
							up-to deterministic transitions $\hby{\bactinp{t'}{\abs{z}{\inact}}} \Hby{\dtau}$:
							\begin{eqnarray*}
								&&\Gamma; \es; \Delta_1' \proves \newsp{\widetilde{m_1}}{P \Par \htrigger{t'}{s}  } \\
								\hby{\bactinp{t'}{\abs{z}{\inact}}} &&
								\Delta_1' \proves \newsp{\widetilde{m_1}}{P \Par \newsp{s'}{\binp{s'}{y} (\appl{(\abs{z}{\inact})}{y}) \Par \bout{\dual{s'}}{s} \inact}}
								\\
								\hby{\dtau} &&
								\Delta_1' \proves \news{\widetilde{m_1}}{P}
							\end{eqnarray*}
							and
							\begin{eqnarray*}
								&&\Gamma; \es; \Delta_2' \proves \newsp{\widetilde{m_2}}{Q \Par \htrigger{t'}{s}  } \\
								\hby{\bactinp{t'}{\abs{z}{\inact}}} &&
								\Delta_2' \proves \newsp{\widetilde{m_2}}{Q' \Par \newsp{s'}{\binp{s'}{y} (\appl{(\abs{z}{\inact})}{y}) \Par \bout{\dual{s'}}{s} \inact}}
								\\
								\hby{\dtau} &&
								\Delta_2' \proves \news{\widetilde{m_2}}{Q'}
							\end{eqnarray*}
							The result is then immediate from the definition of $\Re$ that
							requires
							\[
								\horel{\Gamma}{\Delta_1'}{\news{\widetilde{m_1}}{P  } }
								{\hwb}
								{\Delta_2'}{\news{\widetilde{m_2}}{Q'  } }
							\]
					\item	A synchronization along name $t$: this is not possible
							due to the freshness of $t$.
				\end{enumerate}
	\end{enumerate}
    This concludes the proof of Part 1.
    	
	\item Part 2 follows same arguments and structure as	the proof for Part 1.

	\item Part 3 relies on Part 1. We analyse the two	directions of the if and only if requirement.
	\begin{enumerate}[(a)]
		\item First direction. Let $\Re$ be the typed relation (we omit the type information):
				\begin{eqnarray*}
					\Re &=&	\set{	(\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}\ ,\ 
									\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}) \setbar\\
						&&
									\qquad \horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}  } }
									{\hwb}
									{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}  } }
					}
				\end{eqnarray*}
				We show that $\Re\ \subseteq\ \hwb$, with a case analysis on the defining requirements
				of higher-order bisimulation. Suppose that $\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}$ moves;
				we need to show an appropriate matching action from $\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}$.
				We analyze three possibilities:
				\begin{enumerate}[i)]
					\item $P$ moves on its own, i.e., for some $\Delta'_1$ we have:
							\[
								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
								{\hby{\ell}}
								{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par \htrigger{t}{V_2}  } }
							\]
							The proof is similar to case (a) of Part 1 of this lemma.
					\item	An input action of the form $\bactinp{t}{n}$ along fresh name $t$.
							Let $U$ such that $\omapchar{U} = n$ and $V_1$ a higher-order value.  There exist $\Delta'_1$ such that:
%					\item	An input action of the form $\bactinp{t}{n}$ along a fresh name $t$.
%							In this case, we have that there exist $\Delta'_1$ and $U$ such that $\omapchar{U} = n$:
							$$
							\begin{array}{rcl}
							\Gamma; \Delta_1 \proves \newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } & \hby{\bactinp{t}{n}}& 
							\Delta_1' \proves \newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y} (\appl{y}{n}) \Par \bout{\dual{s}}{V_1} \inact}} \\
							& \hby{\dtau} & 
								\Delta_1' \proves \newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}
							\end{array}
							$$
%							\[
%								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
%								{\hby{\bactinp{t}{n}}}
%								{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y} (\appl{y}{n}) \Par \bout{\dual{s}}{V_1} \inact}}}
%							\]
							Furthermore, we can see that, for some $\Delta'_2$, we have
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{n}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n})}}
							\]
%							\JP{Why $Q$ doesn't move to some $Q'$ in the above weak transition?} and
%							\[
%								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y}{(\appl{y}{n})} \Par \bout{\dual{s}}{V_1} \inact}}}
%								{\hby{\dtau}}
%								{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}}
%							\]
							We therefore need to show that
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n})}}
							\]
							This is done by considering the requirements of $\Re$.
							Since $\omapchar{U} = n$, we have that
							$\omapchar{\shot{\btinp{U} \tinact}} = \abs{z}{ \binp{z}{y} ( \bout{t'}{z} \inact \Par (\appl{y}{n}) ) } $:
							\[
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}  } }
								{\hby{\bactinp{t}{\omapchar{\shot{\btinp{U} \tinact}}}}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\appl{\abs{z}{ \binp{z}{y} ( \bout{t'}{z} \inact \Par (\appl{y}{n}) ) }}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
							\]
							Furthermore, we can see that
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{\omapchar{\shot{\btinp{U} \tinact}}}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
%							\JP{Why $Q$ doesn't move to some $Q'$ in the above weak transition?} 
							with
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\appl{\abs{z}{ \binp{z}{y} ( \bout{t'}{z} \inact \Par (\appl{y}{n}) ) }}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
								{\hby{\dtau} \hby{\dtau}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\end{eqnarray*}
							to imply from the up-to determinate (\lemref{lem:up_to_deterministic_transition}) that
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
							which implies, by Part 1 of this lemma,
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n}) }}
							\]
							as required.

						\item	An action of the form $\bactinp{t}{\abs{z}{\mapchar{U'}{z}}}$ along fresh name $t$.
								Let $U$ such that $\omapchar{U} = \abs{z}{\mapchar{U'}{z}}$.
								There exist $U$ and  $\Delta_1'$ such that 

%						\item	An action of the form $\bactinp{t}{\abs{z}{\mapchar{U'}{z}}}$ along a fresh name $t$.
%								This means that there exist $U$ and  $\Delta_1'$ such that $\omapchar{U} = \abs{z}{\mapchar{U'}{z}}$ and

							\[
							\begin{array}{rcl}
							& & \Gamma; \Delta_1 \proves \newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } \\
							&  \hby{\bactinp{t}{\abs{z}{\mapchar{U'}{z}}}} & 
							\Delta_1' \proves \newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y} {(\appl{(\abs{z}{\mapchar{U'}{z}})}{y}}) \Par \bout{\dual{s}}{V_1} \inact}}
							\\
							& \hby{\dtau} & \Delta_1' \proves \newsp{\widetilde{m_1}'}{P \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_1}}
								\end{array}
							\]
							Furthermore, we have the following, for some $\Delta'_2$:
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{\abs{z}{\mapchar{U'}{z}}}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_2}}}
							\]
%%							\JP{Also above $Q$ should move. I think the parenthesis for the abstraction are not OK.} and
%							\[
%								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y}{(\appl{y}{n})} \Par \bout{\dual{s}}{V_1} \inact}}}
%								{}
%								{\Delta_3'}{}
%							\]
							We need to show that, for some $\Delta'_3, \Delta'_4$, we have
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_1}}}
								{\hwb}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_2}}}
							\]
							This is done by considering the requirements of $\Re$.
							From the fact that $\omapchar{U} = \abs{z}{\mapchar{U'}{z}}$ we obtain that
							$\omapchar{\shot{\btinp{U} \tinact}} = \abs{w}{ \binp{w}{y} ( \bout{t'}{w} \inact \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{y} ) }$
							and
							\[
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}  } }
								{\hby{\bactinp{t}{\omapchar{\shot{\btinp{U} \tinact}}}}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\appl{(\abs{w}{ \binp{w}{y} ( \bout{t'}{w} \inact \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{y} ) })}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
							\]
							Furthermore, we can see that for some $\Delta'_2$
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{\shot{\omapchar{\btinp{U} \tinact}}}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_2} \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
%							\JP{Why $Q$ doesn't move to some $Q'$ in the above weak transition?}
							with
							\[
								\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\appl{(\abs{w}{ \binp{w}{y} ( \bout{t'}{w} \inact \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{y} ) })}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
								{\hby{\dtau} \hby{\dtau}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_1} \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
							to imply from the up-to determinate (\lemref{lem:up_to_deterministic_transition}) that
							\[
							\begin{array}{c}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_1} \Par \newsp{s}{\bout{t'}{s} \inact}}}
								{\hwb} \\
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_2} \Par \newsp{s}{\bout{t'}{s} \inact}}}
								\end{array}
							\]
							which implies, by Part 1 of this lemma, the desired conclusion:
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_1}}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\abs{z}{\mapchar{U'}{z}})}{V_2}}}
							\]
				\end{enumerate}
		\item	Second direction.
				Let $\Re$ be the typed relation (we omit the type information):
				\begin{eqnarray*}
		\Re &=&	\set{	(\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}}\ ,\ 
									\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}}) \setbar\\
						&&
							\qquad \qquad \qquad		\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
									{\hwb}
									{\Delta_4}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}  } }
					}
				\end{eqnarray*}
				We show that $\Re\ \subseteq\ \hwb$, with a case analysis on the defining requirements
				of higher-order bisimulation.
				We concentrate on the cases of an input action on a fresh name $t$; 
				other cases are similar.
				\begin{enumerate}
					\item	Value $V_1$ is a higher-order value: This implies that there exist $U$ and $\Delta'_1$
							such that $\omapchar{\btinp{U} \tinact} = \abs{z}{ \binp{z}{y} (\bout{t'}{z} \inact \Par \appl{y}{n})}$ and
							\[
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}  } }
								{\hby{\bactinp{t}{\omapchar{\btinp{U} \tinact}}}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{ \appl{(\abs{z}{ \binp{z}{y} (\bout{t'}{z} \inact \Par (\appl{y}{n}))})}{s} \Par \bout{\dual{s}}{V_1} \inact}}} 
							\]
														and
							\[
								\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{ \appl{(\abs{z}{ \binp{z}{y} (\bout{t'}{z} \inact \Par (\appl{y}{n}))})}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
								{\hby{\dtau} \hby{\dtau}}
								{\Delta_1'}{}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
							Furthermore we can see that there exists $\Delta_2'$ such that
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{\omapchar{\btinp{U} \tinact}}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
%							\JP{Why $Q$ doesn't move to some $Q'$ in the above weak transition?}
							We need to show that
							\[
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q \Par (\appl{V_2}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]
							This is done by considering the requirements of $\Re$.
							We know that $\omapchar{U} = n$:
							\[
								\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
								{\hby{\bactinp{t}{n}}}
								{\Delta_3'}{}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y} (\appl{y}{n}) \Par \bout{\dual{s}}{V_1} \inact}  \hby{\dtau} \Delta'_3 \proves \newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})} }} 
							\]
							for some $\Delta'_3$.
							Furthermore we can see that for some $\Delta'_4$
							\[
								\horel{\Gamma}{\Delta_4}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}  } }
								{\Hby{\bactinp{t}{n}}}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n})}}
							\]
%							\JP{Why $Q$ doesn't move to some $Q'$ in the above weak transition?}
%							with
%							\[
%								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\binp{s}{y}{(\appl{y}{n})} \Par \bout{\dual{s}}{V_1} \inact}}}
%								{\hby{\dtau}}
%								{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}}
%							\]
							and
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n})}}
								{\hwb}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n})}}
							\]
							which imply, by Part 1 of this lemma, the desired conclusion:
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par (\appl{V_1}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
								{\hwb}
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q' \Par (\appl{V_2}{n}) \Par \newsp{s}{\bout{t'}{s} \inact}}}
							\]

						\item	Value $V_1$ is a first-order value: This implies that there exist $U$ and $\Delta'_3$
								such that $\omapchar{\btinp{U} \tinact} = \abs{w}{ \binp{w}{y} ( \bout{t'}{w} \inact \Par \appl{\abs{z}{\mapchar{U'}{z}}}{y} ) } $
								and
								\[	
									\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}  } }
									{\hby{\omapchar{\btinp{U}\tinact}}}
									{\Delta_3'}{}
									{\newsp{\widetilde{m_1}'}{P \Par \newsp{s}{\appl{\abs{w}{ \binp{w}{y} ( \bout{t'}{w} \inact \Par \appl{\abs{z}{\mapchar{U'}{z}}}{y} ) }}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
								\]
							This case follows a similar proof structure as the previous case.
				\end{enumerate}
				This concludes the proof of Part 3. 
	\end{enumerate}
\end{enumerate}
\qed
\end{proof}

%By the combination of the lemmas, we can obtain the theorem.

%\noi
%We now proceed to state and prove these lemmas, together with some auxiliary results.
%\thmref{app:thm:coincidence} (Page~\pageref{app:thm:coincidence}) summarises the coincidence result.

The next lemma states the equivalence between the characteristic
and higher-order trigger processes (cf. \eqref{eqb:0} and \eqref{eqb:4}).

\begin{lemma}[Trigger Process Equivalence]
	\dkmargin{Please read}
	\label{lem:trigger_equiv}
	Let $P$ and $Q$ be processes, $t$ be a fresh name, and
	let $\Gamma; \es; \Delta \proves V_i \hastype U, i \in \set{1, 2}$.

	\begin{enumerate}[1)]
		\item	If
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2} }}
				\]
				then there exist $\Delta_1', \Delta_2'$ such that 
				\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
					{\hwb}
					{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}}.
				\]

		\item	If
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
					{\fwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}}
				\]
				then there exist $\Delta_1', \Delta_2'$ such that
				\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}}
					{\fwb}
					{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2} }}.
				\]
	\end{enumerate}
\end{lemma}

\begin{proof}
We analyse both parts separately:
	\begin{enumerate}[1.]
		\item  Consider the typed relation (for readability, we omit type information):
				\begin{eqnarray*}
					\Re	&=&		\set{	(\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U} },
										\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}})
								\setbar\\
						&&		\qquad	\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}}
									{\hwb}
									{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}} }
				\end{eqnarray*}
				%
				We show that $\Re\ \subseteq\ \hwb$.
				Suppose that $\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U} }$ moves; we need
				to find a matching move from $\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U} }$.
				We distinguish three cases, depending on the source/kind of visible action: 
				\begin{enumerate}
					\item	$P$ moves autonomously, i.e., for some $\Delta_3$ we have:
						%
						\[
							\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U} }}
							{\hby{\ell}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}'}{P' \Par \ftrigger{t}{V_1}{U} }}
						\]
						%
							We follow the requirements of $\Re$ and the freshness of $t$
							to conclude that there exists a $\Delta_1''$ such that
						%
						\[
							\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}}
							{\hby{\ell}}
							{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par \htrigger{t}{V_1}}}
						\]
						%
							which implies, from the \newc{higher-order bisimilarity} requirement of $\Re$ and
							the freshness of $t$, that there exist $Q'$ and $\Delta_2''$ such that
						%
						\begin{eqnarray}
							\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}}
							{\Hby{\mact{\ell}}}
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par \htrigger{t}{V_2}}}
							\label{proof:trig_equiv00}
						\end{eqnarray}
						%
							and, for some $\Delta_1'''$ and $\Delta_2'''$, that
						\begin{eqnarray}
							\horel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P' \Par \htrigger{t}{V_1} \Par C_1}}
							{\hwb}
							{\Delta_2'''}{\newsp{\widetilde{m_2}''}{Q' \Par \htrigger{t}{V_2} \Par C_2}}
							\label{proof:trig_equiv11}
						\end{eqnarray}
						%
							with $C_1$ (resp., $C_2$) being the higher-order trigger process
							in the cases where $\ell = \news{\widetilde{m}} \bactout{n}{V_1'}$ (resp., $\mact{\ell} = \news{\widetilde{m}'} \bactout{n}{V_2'}$)
							and $C_1 = C_2 = \inact$ otherwise.
						%
							From \eqref{proof:trig_equiv00} and the definition of $\Re$
							we can conclude that there exists a $ \Delta_4$ such that
						\[
							\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \ftrigger{t}{V_2}{U}}}
							{\Hby{\mact{\ell}}}
							{\Delta_4}{\newsp{\widetilde{m_2}'}{Q' \Par \ftrigger{t}{V_2}{U}}}
						\]
						%
							Equation \eqref{proof:trig_equiv11} then allows us to infer the required conclusion, for some $\Delta_3', \Delta_4'$:
						\[
							\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'''}{P' \Par \ftrigger{t}{V_1}{U} \Par C_1}}
							{\ \Re\ }
							{\Delta_4'}{\newsp{\widetilde{m_2}'''}{Q' \Par \ftrigger{t}{V_2}{U} \Par C_2}}
						\]

					\item	$\ftrigger{t}{V_1}{U}$ moves autonomously, i.e., for some $\Delta_3$ we have:
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
%							{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}
							{\hby{\bactinp{t}{m}}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							Following requirements of $\Re$ and the freshness of $t$
							we can infer that there exists a $\Delta_1''$ such that
						%
						\[
							\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}}}
							{\hby{\bactinp{t}{\omapchar{U}}}}
%							{\hby{\bactinp{t}{m}}}
							{\Delta_1''}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							which implies, from the higher-order bisimilarity requirement of $\Re$ and
							the freshness of $t$, that there exist $Q'$ and $\Delta_2''$ such that
						%
							\begin{eqnarray}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2 & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \htrigger{t}{V_2}}
									\\
%									{\hby{\bactinp{t}{m}}}& & &
									{\hby{\bactinp{t}{\omapchar{U}}}} & & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_2'' & \proves & Q'
								\end{array}
								\label{proof:trig_equiv22}
							\end{eqnarray}
						%
							and
						%
							\nhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_1} \inact}}}
							{\hwb}
							{\Delta_2''}{\news{\widetilde{m_2}}Q'}
							{proof:trig_equiv33}
						%
							The freshness of $t$ allows us to mimic the transitions
							in \eqref{proof:trig_equiv22}; for some $\Delta_4$ we obtain:
						%
							\begin{eqnarray*}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2' & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \ftrigger{t}{V_2}{U}}
									\\
%									{\hby{\bactinp{t}{\map{\btinp{U} \tinact}^{x}}}}& & &
									{\hby{\bactinp{t}{m}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_4 & \proves & Q'
								\end{array}
							\end{eqnarray*}
						%
							The conclusion is immediate from \eqref{proof:trig_equiv33}.


				\item The action comes from the interaction of $P$ and $\htrigger{t}{V_1}$: This case is not possible, due to the freshness of $t$.
				\end{enumerate}


		\item	Consider the typed relation (for readability, we omit type information):
				\begin{eqnarray*}
					\Re'	&=&		\set{	(\newsp{\widetilde{m_1}}{P \Par \htrigger{t}{V_1}},
										\newsp{\widetilde{m_2}}{Q \Par \htrigger{t}{V_2}})
								\setbar\\
						&&			\qquad \horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
									{\fwb}
									{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}}~~}
				\end{eqnarray*}
				To prove that $\Re'\ \subseteq\ \fwb$ we
				first consider relation $\Re$ (for readability, we omit type information):
				\begin{eqnarray*}
					\Re	&=&		\set{	(\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}},
										\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}})
								\setbar\\
						&&			\qquad \horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
									{\fwb}
									{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}}~~}
				\end{eqnarray*}
				%
				By proving that $\Re\ \subseteq\ \fwb$ we can apply \lemref{lem:alt_tr} (Part 3), to
				obtain that $\Re'\ \subseteq\ \fwb$.
				%
%			\JP{How does this new relation help? This is not clear.}
Suppose that $\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}}$ moves; we must exhibit a matching move from
$\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}}$.
			We distinguish three cases, depending on the source/kind of visible action: 
				\begin{enumerate}
					\item $P$ moves autonomously, i.e., for some $\Delta_3$ we have:
						%
						\[
							\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}}}
							{\hby{\ell}}
							{\Delta_3}{\newsp{\widetilde{m_1}'}{P' \Par \ntrigger{t}{V_1}}}
						\]
						%
							Then, following the requirements of $\Re$ and the freshness of $t$, 
							we infer that there exists some $\Delta_1''$ such that
						%
						\[
							\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}}
							{\hby{\ell}}
							{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par \ftrigger{t}{V_1}{U}}}
						\]
						%
							which implies, from the characteristic bisimilarity requirement of $\Re$ and
							the freshness of $t$, that there exist $Q'$ and $\Delta_2''$ such that
						%
							\begin{eqnarray}
							\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}}
							{\Hby{\mact{\ell}}}
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par \ftrigger{t}{V_2}{U}}}
							\label{proof:trig_equiv0}
							\end{eqnarray}
						%
							and
							\nhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P' \Par \ftrigger{t}{V_1}{U} \Par C_1}}
							{\fwb}
							{\Delta_2'''}{\newsp{\widetilde{m_2}''}{Q' \Par \ftrigger{t}{V_2}{U} \Par C_2}}
							{proof:trig_equiv1}
						%
							with $C_1$ (resp., $C_2$) being the characteristic trigger process
							in the cases where $\ell = \news{\widetilde{m}} \bactout{n}{V_1'}$ (resp., $\mact{\ell} = \news{\widetilde{m}'} \bactout{n}{V_2'}$)
							and $C_1 = C_2 = \inact$ otherwise.
						%
							From \eqref{proof:trig_equiv0} we can infer that there exists $\Delta_4$ such that
						\[
							\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \ntrigger{t}{V_2}}}
							{\Hby{\mact{\ell}}}
							{\Delta_4}{\newsp{\widetilde{m_2}'}{Q' \Par \ntrigger{t}{V_2}}}
						\]
						%
							Equation \eqref{proof:trig_equiv1} then allows us to obtain the desired conclusion:
						\[
							\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'''}{P' \Par \ntrigger{t}{V_1} \Par C_1}}
							{\ \Re\ }
							{\Delta_4'}{}{\newsp{\widetilde{m_2}'''}{Q' \Par \ntrigger{t}{V_2} \Par C_2}}
						\]

					\item	%\jasks{I would probably put cases 2 and 3 within a single case, which is the case when the right-hand side process moves. }
						$\ntrigger{t}{V_1}$ moves autonomously, i.e., for some $\Delta_3$ we have:
						\[
							\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}}}
							{\hby{\bactinp{t}{\omapchar{\shot{\btinp{U} \tinact}}}}}
							{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{ \appl{\omapchar{\shot{\btinp{U} \tinact}}}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
						\]
						%
							Following requirements of $\Re$ and the freshness of $t$
							we infer that there is a $\Delta_1''$ such that
						%
						\begin{eqnarray*}
							&& \Gamma; \es; \Delta_1 \proves \newsp{\widetilde{m_1}}{P \Par \ftrigger{t}{V_1}{U}}\\
							\hby{\bactinp{t}{m}} &&
							\Delta_1'' \proves \newsp{\widetilde{m_1}}{P \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_1} \inact}}\\
							\Hby{\dtau} &&
							\Delta_1'' \proves \news{\widetilde{m_1}}P'
						\end{eqnarray*}
						%
							which implies from the \newc{characteristic bisimulation} requirement of $\Re$ and
							the freshness of $t$ that there exist $Q'$ and $\Delta_2''$ such that
						%
							\begin{eqnarray}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2 & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \ftrigger{t}{V_2}{U}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \ftrigger{t}{V_2}{U}}
									\\
									{\hby{\bactinp{t}{m}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_2'' & \proves & Q'
								\end{array}
								\label{proof:trig_equiv2}
							\end{eqnarray}
						%
							and
						%
							\begin{eqnarray*}
								\horel{\Gamma}{\Delta_1''}{\news{\widetilde{m_1}}P'}
								{\fwb}
								{\Delta_2''}{\news{\widetilde{m_2}}Q'}
							\end{eqnarray*}
							which implies from \lemref{lem:alt_tr} (Part 2) that
							for a fresh $t'$
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P' \Par \newsp{s}{\bout{t'}{s} \inact} }}
								{\fwb}
								{\Delta_2''}{\newsp{\widetilde{m_2}}{Q'}  \Par \newsp{s}{\bout{t'}{s} \inact}}
								\label{proof:trig_equiv3}
							\end{eqnarray}
						%
							The freshness of $t$ allows us to mimic the transitions
							in \eqref{proof:trig_equiv2} to infer that, for some $\Delta_4$,
							we have
						%
							\begin{eqnarray*}
								\begin{array}{crll}
									& \Gamma; \es; \Delta_2' & \proves &		
									\newsp{\widetilde{m_2}}{Q \Par \ntrigger{t}{V_2}}
									\\
									\Hby{} &&&
									\newsp{\widetilde{m_2}}{Q_2 \Par \ntrigger{t}{V_2}}
									\\
									{\hby{\bactinp{t}{\omapchar{\btinp{U} \tinact}}}}& & &
									\newsp{\widetilde{m_2}}{Q_2 \Par \newsp{s}{\appl{\omapchar{\btinp{U} \tinact}}{s} \Par \bout{\dual{s}}{V_2} \inact}}
									\\
									\Hby{} & \Delta_4 & \proves & \newsp{\widetilde{m_2}'}{Q' \Par \newsp{s}{\bout{t'}{s} \inact} }
								\end{array}
							\end{eqnarray*}
						%
							and 
							\[
								\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{ \appl{\omapchar{\btinp{U} \tinact}}{s} \Par \bout{\dual{s}}{V_1} \inact}}}
								{\Hby{\dtau}}
								{\Delta_3}{\newsp{\widetilde{m_1}'}{P' \Par \newsp{s}{ \bout{t'}{s} \inact}}}
							\]
							The conclusion is immediate from \eqref{proof:trig_equiv3}.

					\item	$\ntrigger{t}{V_1}$ moves autonomously, i.e., for some $\Delta_3$ we have:
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t}{V_1}}}
							{\hby{\bactinp{t}{ \abs{x}{\binp{t'}{y}{(\appl{y}{x})}  }}}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{  \appl{(\abs{x}{\binp{t'}{y}{(\appl{y}{x})})}{s}  \Par \bout{\dual{s}}{V_1} \inact }}}}
						\]
						We show that there
                                                exist $\Delta_4$ and  $\newsp{\widetilde{m_1}}{Q \Par \newsp{s}{  \appl{(\abs{x}{\binp{t'}{y}{(\appl{y}{x})})}{s}  \Par \bout{\dual{s}}{V_2} \inact }}}$ such that
						\[
							\mhorel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_1}}{Q \Par \ntrigger{t}{V_2}}}
							{\Hby{\bactinp{t}{ \abs{x}{\binp{t'}{y}{(\appl{y}{x})}  }}}}
							{\Delta_4}{}{\newsp{\widetilde{m_1}}{Q \Par \ntrigger{t'}{V_2} }}
						\]
						and
						\[
							\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \newsp{s}{ \appl{(\abs{x}{\binp{t'}{y}{\appl{y}{x}})}{s}  \Par \bout{\dual{s}}{V_1} \inact }}}}
							{\Hby{\dtau}}
							{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t'}{V_1}}}
						\]
						The result
						\[
							\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \ntrigger{t'}{V_1}}}
							{\ \Re\ }
							{\Delta_4}{\newsp{\widetilde{m_1}}{Q \Par \ntrigger{t'}{V_2}}}
						\]
						is immediate from the definition of $\Re$.

				\item The action comes from the interaction of $P$ and $\ntrigger{t}{V_1}$: This case is not possible, due to the freshness of $t$.
				\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    Higher Weak Bisimilarity = Characteristic Weak Bisimilarity  (\hwb = \fwb)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{lemma}
\dkmargin{Please Read \\ \newc{JP: Looks fine.}}
	\label{app:lem:wb_eq_wbf}
	$\hwb\ =\ \fwb$.
\end{lemma}

\begin{proof}
	\noi
	We split the proof into two parts: the direction
	$\hwb\ \subseteq\ \fwb$ and the direction
	$\fwb\ \subseteq\ \hwb$.
 Since the two equivalences differ only in the output case, our analysis focuses on output actions.

	\begin{enumerate}[1.]
		\item	Direction $\hwb\ \subseteq\ \fwb$. Consider the typed relation (for readability, we omit type information):
		%
				\[
					\Re = \set{
								%\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} 
								(P, Q) 
								\setbar
								\horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}}
				\]
		%
				We show that $\Re$ is a characteristic bisimulation.
				Suppose
				$
						\horel{\Gamma}{\Delta_1}{P}{\hby{ \ell}}{\Delta_1'}{P'}
		%				\label{lem:wb_eq_wbf1}
				$.
				We need to show that $\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$
				can match  $\ell$.
				The proof proceeds by a case analysis on the transition label $\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$, which is the only non-trivial case.

							\smallskip
							
							 From the definition of $\Re$ we have that if:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1''}{P'}
								\label{lem:wb_eq_wbf1}
							\end{eqnarray}
							then there exist $\Delta_2''$, $Q$, and $V_2$ such that:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_2}{Q}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2''}{Q'}
								\label{lem:wb_eq_wbf2}
							\end{eqnarray}
						%
							and for a fresh $t$:
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P' \Par \htrigger{t}{V_1}}}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \htrigger{t}{V_2} }}
								\label{lem:wb_eq_wbf3}
							\end{eqnarray}
						%
							\noi 
							To show that $\Re$ is a characteristic bisimulation
							after the fact that transition~\eqref{lem:wb_eq_wbf1} implies transition~\eqref{lem:wb_eq_wbf2},
							we need to show that for a fresh $t$ and for some $\Delta_3, \Delta_4$:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P' \Par \ftrigger{t}{V_1}{U}}}
								{\ \Re\ }
								{\Delta_4}{\newsp{\widetilde{m_2}}{Q' \Par \ftrigger{t}{V_2}{U}}}
								\label{lem:wb_eq_wbf4}
							\end{eqnarray}
						%
							\noi which follows from \eqref{lem:wb_eq_wbf3}, \lemref{lem:trigger_equiv}(1),
							and the definition of $\Re$.

					%\item	The other cases are trivial.
				%\end{itemize}

		\item	Direction $\fwb\ \subseteq\ \hwb$.
				\noi Consider the typed relation (for readability, we omit type information):
		%
				\[
					\Re = \set{
								%\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} 
								(P, Q) 
								\setbar
								\horel{\Gamma}{\Delta_1}{P}{\fwb}{\Delta_2}{Q}}
				\]
		%
				We show that $\Re$ is a higher-order bisimulation.
				Suppose
				$
						\horel{\Gamma}{\Delta_1}{P}{\hby{ \ell}}{\Delta_1'}{P'}
		%				\label{lem:wb_eq_wbf1}
				$.
				We need to show that $\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$
				can match action $\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$.
				
				\smallskip

							\noi From the definition of $\Re$ we have that if:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1''}{P'}
								\label{lem:fwb_sub_hbf1}
							\end{eqnarray}
							then there exist $\Delta''_2$, $Q$, and $V_2$ such that:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_2}{Q}{\Hby{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2''}{Q'}
								\label{lem:fwb_sub_hbf2}
							\end{eqnarray}
						%
							and for a fresh $t$ and some $\Delta'_2$:
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P' \Par \ftrigger{t}{V_1}{U}}}
								{\fwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \ftrigger{t}{V_2}{U} }}
								\label{lem:fwb_sub_hbf3}
							\end{eqnarray}
						%
							\noi 
							To show that $\Re$ is a higher-order bisimulation
							after the fact that transition~\eqref{lem:fwb_sub_hbf1} implies transition~\eqref{lem:fwb_sub_hbf2},
							we need to show that for a fresh $t$ and some $\Delta_3, \Delta_4$:
						%
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P' \Par \htrigger{t}{V_1}}}
								{\ \Re\ }
								{\Delta_4}{\newsp{\widetilde{m_2}}{Q' \Par \htrigger{t}{V_2}}}
								\label{lem:fwb_sub_hbf4}
							\end{eqnarray}
						%
							which follows from \eqref{lem:fwb_sub_hbf3}, \lemref{lem:trigger_equiv}(2),
							and the definition of $\Re$.

					%\item	The other cases are trivial.
				%\end{itemize}
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PROCESS SUBSTITUTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We state an auxiliary lemma that captures a property of trigger
processes in terms of process equivalence.
\begin{lemma}[Trigger Process Application]
	\dkmargin{Please Read. \newc{JP: looks ok, not yet convinced.}}
	\label{lem:trigger_application}
	Let $P$ and $Q$ be processes. Also, let $t$ be a fresh name.
	\begin{enumerate}
		\item
			If $n_1 \not= n_2$ with $\Gamma; \emptyset; \Delta \proves n_i \hastype U$ with $U \not= \tinact$
			and
			\[
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
				{\hwb}
				{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2} }}
			\]
			then $n_1, n_2$ are session names and $\dual{n_1} \in \fn{P}$ and $\dual{n_2} \in \fn{Q}$.

		\item
			If
			$
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par  \appl{\omapchar{U}}{n_1} }}%\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
				{\hwb}
				{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{\omapchar{U}}{n_2} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
			$
			then for all $\ell$ whenever
			\[
				\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{\omapchar{U}}{n_1} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_1}} }}
				{\hby{\ell}}
				{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \Par \appl{(\trvalx{t})}{n_1} }}
			\]
			then there exist $\Delta_2'$, $\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\trvalx{t})}{n_2} }$ such that
			\[
				\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}}{Q \Par \appl{\omapchar{U}}{n_2} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_2}} }}
				{\Hby{\hat{\ell_2}}}
				{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\trvalx{t})}{n_2} }} % }}
			\]
%			\JP{Why don't you need some condition on the relation between $\ell_1$ and $\ell_2$ (e.g. $\ell_1 \asymp \ell_2$)? The statement seems a bit loose as it is.}
with $\ell_2 = \mact{\ell}$.
		\item
			If
			$
				\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \bout{t}{n_1} \inact} }
				{\hwb}
				{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \bout{t}{n_2} \inact} }
			$
			then
			\[
				\horel{\Gamma}{\Delta_1}{ \newsp{m_1}{P \Par \binp{t}{x}{(\appl{x}{n_1})}} }
				{\hwb}
				{\Delta_2}{ \newsp{m_2}{Q \Par \binp{t}{x}{(\appl{x}{n_2})}}}
			\]

		\item
			If $n$ is fresh and
			\[
				\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \subst{n}{x} \Par \bout{t}{n_1} \inact }}
				{\hwb}
				{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \subst{n}{x} \Par \bout{t}{m_1} \inact }}
			\]
			then
			\[
				\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \subst{n_1}{x} }}
				{\hwb}
				{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \subst{m_1}{x} }}
			\]

%		\item
%			If
%			\[
%				\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \bout{t_1}{n_1} \inact \Par \bout{t_2}{n_2} \inact} }
%				{\hwb}
%				{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \bout{t_1}{m_1} \inact \Par \bout{t_2}{m_2} \inact} }
%			\]
%			then
%			\[
%				\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \bout{n_1}{n_2} \bout{t}{n_1} \inact} }
%				{\hwb}
%				{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \bout{m_1}{m_2} \bout{t}{m_1} \inact} }
%			\]
	\end{enumerate}
\end{lemma}

\begin{proof}
We analyse each part separately:
	\begin{enumerate}[1.]
		\item	The proof for Part 1 is done by contradiction.
				Assume that $\dual{n_1} \notin \fn{P}$ and $\dual{n_2} \notin \fn{Q}$.
				Then the bisimulation requirement allows us to observe for some $U \not= \tinact$:
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \appl{(\trvalx{t})}{n_1} }}
					{ \hby{\dtau} \hby{ \bactinp{t}{\omapchar{U}}  } \hby{\ell} }
					{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{t'}{n_1} \inact }}
				\]
%				\JP{Why do we skip the tau related to beta-reduction?}
				with $\subj{\ell} = n_1$, because of the characteristic process interaction,
%				\JP{Why? I think $\ell_1$ can come from $P$ and be different from $n_1$..}
				then from the freshness of $t$:
				\[
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\trvalx{t})}{n_2} }}
					{ \Hby{ \bactinp{t}{\omapchar{U}}  } \Hby{\mact{\ell}} }
					{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \Par \appl{\omapchar{U}}{n_2}}}
				\]
				with $\subj{\mact{\ell}} = n_1$. %\JP{Here again, why?}
				But then in the former result we can observe an action on $t'$ and on the latter
				we cannot, thus leading to a contradiction with respect to the bisimilarity assumption.

		\item	The proof for Part 2 is also done by contradiction. Assume that
				\[
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}}{Q \Par \appl{\omapchar{U}}{n_2} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_2}} }}
					{\not\Hby{\hat{\mact{\ell}}}}
					{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{(\trvalx{t})}{n_2} }} % }}
				\]
				From the bisimilarity requirement we can observe
				\[
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}}{Q \Par \appl{\omapchar{U}}{n_2} }} %\appl{\abs{x}{\mapchar{U}{x}}{n_2}} }}
					{\Hby{\hat{\mact{\ell}}}}
					{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \Par \appl{\omapchar{U}}{n_2} }} % }}
				\]
				But then we can observe an action on fresh name $t$ on process
				\[
					\Gamma; \es; \Delta_1' \proves \newsp{\widetilde{m_1}'}{P' \Par \appl{(\trvalx{t})}{n_1} } \hastype \Proc
				\]
				that cannot be observed by process
				$
					\Gamma; \es; \Delta_2' \proves \newsp{\widetilde{m_2}'}{Q' \Par \appl{\omapchar{U}}{n_2} }
				$---a contradiction.

		\item	For the proof of Part 3 we do a case analysis on the transitions for checking the bisimulation requirements. The interesting case is when, for some $\Delta''_1$:
				\[
					\Gamma; \Delta_1 \proves \newsp{\widetilde{m_1}}{P \Par \binp{t}{x} (\appl{x}{n_1})}
					\hby{\bactinp{t}{\omapchar{U}}} 
					\Gamma; \Delta_1'' \proves \newsp{\widetilde{m_1}''}{P \Par \appl{\omapchar{U}}{n_1}}
				\]
				From the freshness of $t$ we can derive that, for some $\Delta''_2$ and $Q''$
				\[
					\Gamma; \Delta_2 \proves \newsp{\widetilde{m_2}}{Q \Par \binp{t}{x}(\appl{x}{n_2})}
					\Hby{\bactinp{t}{\omapchar{U}}} 
					\Gamma; \Delta_2'' \proves \newsp{\widetilde{m_2}''}{Q'' \Par \appl{\omapchar{U}}{n_2}}
				\]
				From the bisimulation requirement of the hypothesis we have that
				\[
					\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \bout{t}{n_1} \inact} }
					{\hby{\bactout{t}{n_1} }}
					{\Delta_1'}{ \newsp{\widetilde{m_1}'}{P} }
				\]
				implies
				\[
					\horel{\Gamma}{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \bout{t}{n_2} \inact} }
					{\Hby{\bactout{t}{n_2} }}
					{\Delta_2'}{ \newsp{\widetilde{m_2}'}{Q'} }
				\]
				for some $\Delta'_1, \Delta'_2$ and
				\[
					\mhorel{\Gamma}{\Delta_1'}{ \newsp{\widetilde{m_1}'}{P \Par \binp{t}{x} \newsp{s}{ \binp{s}{y}(\appl{x}{y}) \Par \bout{\dual{s}}{n_1} \inact } } }
					{\hwb}
					{\Delta_2'}{}{ \newsp{\widetilde{m_2}'}{Q' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y}(\appl{x}{y}) \Par \bout{\dual{s}}{n_2} \inact }} }
				\]
				Whenever
				\[
				\begin{array}{rcl}
					&& \Gamma; \Delta_1' \proves \newsp{\widetilde{m_1}'}{P \Par \binp{t}{x} \newsp{s}{ \binp{s}{y}(\appl{x}{y})\Par \bout{\dual{s}}{n_1} \inact}}\\ 
					\hby{\bactinp{t}{\omapchar{U}}}&& 
					\Delta_1'' \proves \newsp{\widetilde{m_1}''}{P \Par \newsp{s}{ \binp{s}{y} (\appl{\omapchar{U}}{y}) \Par \bout{\dual{s}}{n_1} \inact }}
					\\
					\hby{\dtau} &&
					\Delta_1'' \proves \newsp{\widetilde{m_1}''}{P \Par \appl{\omapchar{U}}{n_1}}
				\end{array}
				\]
				then for some $Q_2''$
				\[
				\begin{array}{rcl}
					&&\Gamma; \Delta_1' \proves \newsp{\widetilde{m_2}'}{Q' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y}(\appl{x}{y}) \Par \bout{\dual{s}}{n_2} \inact } }
					\\
					\Hby{\bactinp{t}{\omapchar{U}}} &&
					\Delta_2'' \proves \newsp{\widetilde{m_2}''}{Q''' \Par \newsp{s}{ \binp{s}{y}(\appl{\omapchar{U}}{y}) \Par \bout{\dual{s}}{n_2} \inact }}
					\\
					\Hby{\dtau} &&
					\Delta_2'' \proves \newsp{\widetilde{m_2}''}{Q'' \Par \appl{\omapchar{U}}{n_2}}
				\end{array}
				\]
				which concludes the case.
				
		\item	Part 4. Let $\Re$ be the typed relation
				\begin{eqnarray*}
					\Re &=& \set{	\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \subst{n_1}{x} }}
									{\hwb}
									{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \subst{m_1}{x} }} \setbar \\
						&&
									\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \subst{n}{x} \Par \bout{t_1}{n_1} \inact }}
									{\hwb}
									{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \subst{n}{x} \Par \bout{t_1}{m_1} \inact }}
					}
				\end{eqnarray*}
				Suppose that $\newsp{\widetilde{m_1}}{P \subst{n_1}{x}}$ moves:
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \subst{n_1}{x}}}
					{\hby{\ell}}
					{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \subst{n_1}{x}}}
				\]
				We need to show a matching action from $\newsp{\widetilde{m_2}}{Q \subst{m_1}{x}}$;
				we proceed to show that $\Re$ is a higher-order bisimulation by a case analysis on the subject of action $\ell$.
				\begin{itemize}
					\item	If $\subj{\ell} \not= n_1$ then the proof is straightforward from the premise of the proposition.
							First observe that
							\[
								\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \subst{n}{x}} \Par \bout{t}{n_1} \inact}
								{\hby{\ell}}
								{\Delta_1'}{\newsp{\widetilde{m_1}'}{P' \subst{n}{x}} \Par \bout{t}{n_1} \inact}
							\]
							implies
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}'}{Q \subst{n}{x}} \Par \bout{t}{m_2} \inact}
								{\Hby{\mact{\ell}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}}{Q' \subst{n}{x}} \Par \bout{t}{m_2} \inact}
							\]
							for some $\Delta'_2$
							and
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}'}{P' \subst{n}{x}} \Par \bout{t}{n_2} \inact \Par C_1}
								{\hwb}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \subst{n}{x}} \Par \bout{t}{n_2} \inact \Par C_2}
							\]
							with $C_1 = \htrigger{t}{n_1}$ and $C_2 = \htrigger{t}{n_2}$ if $\ell$ and $\mact{\ell}$ are output actions,
							$C_1 = \inact$ and $C_2 = \inact$ otherwise.
							From here we can deduce that 
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}}{Q \subst{n_2}{x}}}
								{\Hby{\mact{\ell}}}
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \subst{n_2}{x}}}
							\]
							Furthermore, we can easily see that
							\[
								\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_1}'}{P \subst{n_1}{x}} \Par C_1}
								{\ \Re\ }
								{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q' \subst{n_2}{x}} \Par C_2}
							\]

					\item	$\subj{\ell} = n_1$. We distinguish two subcases
							\begin{itemize}
								\item	$n_1 = n_2$. The case is similar to the previous case.
								\item	$n_1 \not= n_2$.
										From the premise and Part 1 of this lemma we get
										that $\dual{n_1} \in \fn{P}$ and $\dual{n_2} \in \fn{Q}$.
										The latter implies that this case is not possible, since
										no external action $\ell$ would be observed, because
										of the typed transition requirement.
							\end{itemize}

					\item	$\ell = \tau$. This implies the untyped transitions
							\begin{eqnarray}
								\newsp{\widetilde{m_1}}{P \subst{n_1}{x}} &\hby{\ell_{11}'}& \newsp{\widetilde{m_{11}}}{P_1 \subst{n_1}{x}}
								\label{lem:tr_app_41}\\
								\newsp{\widetilde{m_1}}{P \subst{n_1}{x}} &\hby{\ell_{12}'}& \newsp{\widetilde{m_{12}}}{P_2 \subst{n_1}{x}}
								\label{lem:tr_app_42}\\
								\ell_{11}' &\asymp& \ell_{12}'
							\end{eqnarray}
							We distinguish two cases:
							\begin{itemize}
								\item	$\subj{\ell_{11}'} \not= n_1$. This case is similar to case 1 of this proof.
								\item	$\subj{\ell_{11}'} = n_1$.
										First observe that
										\[
											\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \subst{n}{x} \Par \bout{t}{n_1} \inact}}
											{ \hby{\ell_{11}''} }
											{\Delta_1'}{\newsp{\widetilde{m_1}'}{P_1 \subst{n}{x} \Par \bout{t}{n_1} \inact}}
										\]
										for some $\Delta'_1$
										with $\ell_{11}'' \subst{n_1}{n}  = \ell_{11}' $,
										which implies
										\[
											\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \subst{n}{x} \Par \bout{t}{n_2} \inact}}
											{ \Hby{\ell_{21}''} }
											{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q_1 \subst{n}{x} \Par \bout{t}{n_2} \inact}}
										\]
										with $\ell_{21}'' \subst{n_2}{n}  = \ell_{21}' $,
										which in turn implies
										\begin{eqnarray}
											\newsp{\widetilde{m_2}}{Q \subst{n_2}{x}} &\hby{\ell_{22}'}& \newsp{\widetilde{m_{21}}}{Q_1 \subst{n_2}{x}}
											\label{lem:tr_app_43}
										\end{eqnarray}
										Also observe that for $U = \Delta(n_1)$
										\[
											\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \subst{n}{x} \Par \bout{t}{n_1} \inact}}
											{ \hby{\bactout{t}{n_1}} \hby{\bactinp{t}{\omapchar{U}}} \Hby{\dtau} }
											{\Delta_1''}{}{\newsp{\widetilde{m_1}''}{P \subst{n}{x} \Par \omapchar{U} \subst{n_1}{x}}}
										\]
										for some $\Delta''_1$
										which implies
										\[
											\mhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \subst{n}{x} \Par \bout{t}{n_2} \inact}}
											{ \Hby{\bactout{t}{n_2}} \Hby{\bactinp{t}{\omapchar{U}}} \Hby{\dtau} }
											{\Delta_2''}{}{\newsp{\widetilde{m_2}''}{Q' \subst{n}{x} \Par \omapchar{U} \subst{n_2}{x}}}
										\]
										for some $\Delta''_2$
										with
										\[
											\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}''}{P \subst{n}{x} \Par \omapchar{U} \subst{n_1}{x}}}
											{\hwb}
											{\Delta_2''}{}{\newsp{\widetilde{m_2}''}{Q' \subst{n}{x} \Par \omapchar{U} \subst{n_2}{x}}}
										\]
										From \eqref{lem:tr_app_42} we can see that, for some $\Delta'''_1$
										\[
											\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}''}{P \subst{n}{x} \Par \omapchar{U} \subst{n_1}{x}}}
											{ \hby{\tau} }
											{\Delta_1'''}{}{\newsp{\widetilde{m_1}''}{P_2 \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
										\]
										which implies from Part 2 of this lemma
										\begin{eqnarray}
											\mhorel{\Gamma}{\Delta_2''}{\newsp{\widetilde{m_2}''}{Q' \subst{n}{x} \Par \omapchar{U} \subst{n_2}{x}}}
											{\Hby{\tau}}
											{\Delta_2'''}{}{\newsp{\widetilde{m_2}''}{Q_2 \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
											\label{lem:tr_app_44}
										\end{eqnarray}
										for some $\Delta'''_2$
										and
										\begin{eqnarray}
											\mhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P_2 \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
											{\hwb}
											{\Delta_2'''}{}{\newsp{\widetilde{m_2}''}{Q_2 \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
											\label{lem:tr_app_45}
										\end{eqnarray}
										where \eqref{lem:tr_app_44} implies the untyped transition
										\[
											\newsp{\widetilde{m_2}''}{Q' \subst{n}{x} \Par \omapchar{U} \subst{n_2}{x}}
											\Hby{ \ell_{22}'' }
											\newsp{\widetilde{m_2}''}{Q_2 \subst{n}{x} \Par \omapchar{U} \subst{n_2}{x}}
										\]
										and furthermore,
										\[
											\newsp{\widetilde{m_2}''}{Q' \subst{n_2}{x}}
											\Hby{ \ell_{22}' }
											\newsp{\widetilde{m_2}''}{Q_2 \subst{n_2}{x}}
										\]
										with $\ell_{22}'' \subst{n_2}{n} = \ell_{22}'$.
										From the last result and \eqref{lem:tr_app_43} we get
										\[
											\mhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{ Q \subst{n_2}{x}   }  }
											{\Hby{\tau}}
											{\Delta_2'}{}{\newsp{\widetilde{m_2}''}{ Q'' \subst{n_2}{x}   }  }
										\]
										Furthermore, from \eqref{lem:tr_app_45} we can get that, for some $\Delta_3$,
										\[
											\horel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}''}{P_2 \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
											{\hby{\ell_{12}''}}
											{\Delta_3}{\newsp{\widetilde{m_1}'''}{P' \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
										\]
										which implies
										\[
											\horel{\Gamma}{\Delta_2'''}{\newsp{\widetilde{m_2}''}{Q_2 \subst{n}{x} \Par \bout{t'}{n_2} \inact}}
											{\hby{\ell_{22}''}}
											{\Delta_4}{\newsp{\widetilde{m_2}'''}{Q'' \subst{n}{x} \Par \bout{t'}{n_2} \inact}}
										\]
										and
										\begin{eqnarray*}
											\horel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}'''}{P' \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
											{\hwb}
											{\Delta_4}{\newsp{\widetilde{m_2}'''}{Q'' \subst{n}{x} \Par \bout{t'}{n_1} \inact}}
										\end{eqnarray*}
										which in turn implies the required conclusion:
										\begin{eqnarray*}											\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'''}{P' \subst{n_1}{x}}}
											{\ \Re\ }
											{\Delta_2'}{\newsp{\widetilde{m_2}'''}{Q'' \subst{n_2}{x}}}
										\end{eqnarray*}
							\end{itemize}
					\end{itemize}
	\end{enumerate}
	\qed
\end{proof}

A process substitution lemma is useful for showing the
contextuality property for higher-order and characteristic bisimilarities.
Before we state and prove a process substitution lemma
we give an intermediate result.
(This is \lemref{lem:trigger_substmt} in the main text.)

\begin{lemma}[Trigger Substitution]
	\dkmargin{Please Read \\ \newc{JP: I have read, not yet convinced}.}
	\label{lem:trigger_subst}
	Let $P$ and $Q$ be processes. Also, let for all $i \in I, t_i$ is a fresh name. If
	\[
		\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} }}
		{\hwb}
		{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par\prod_{i \in I} \appl{(\trvalx{t_i})}{m_i} }}
	\]
	then for all $\abs{\widetilde{x}}{R}$ there exist $\Delta_1', \Delta_2'$ such that
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \appl{(\abs{\widetilde{x}}{R})}{\widetilde{n}} }}
		{\hwb}
		{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \appl{(\abs{\widetilde{x}}{R})}{\widetilde{m}} }}.
	\]
\end{lemma}

\begin{proof}
	We prove the result up-to the application
	%transition %that results in the substitution
	of names $n_i$ and $m_i$
	to process $R$, respectively.
	Let $\Re$ be the relation
	\begin{eqnarray*}
		\Re	&=&	\set{	(\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
						{\ ,\ }
						{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{\widetilde{m}}{\widetilde{x}} }})
					\setbar\\
					&& \forall \abs{\widetilde{x}}{R}, \exists \Delta_1', \Delta_2'.\\
					&&	\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} }}
						{\hwb}
						{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{m_i}}}\\
				&&}
	\end{eqnarray*}
	We show that $\Re$ is a higher-order bisimulation.
	The proof is done by a case analysis on the actions that can be observed
	on the pairs of processes, so to check their higher-order bisimulation requirements.

	\begin{enumerate}
		\item	Suppose an action from $P$, for some $\Delta_1''$:
		\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
					{\hby{\ell}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
				\]
				This transition implies, for some $\Delta_3'$, the following:
				\[
					\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}{P}}
					{\hby{\ell}}
					{\Delta_3'}{\news{\widetilde{m_1}'}{P'}}
				\]
				which in turn implies, for some $\Delta_5$:
				\[
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} }}
					{\hby{\ell}}
					{\Delta_5}{\newsp{\widetilde{m_1}'}{P' \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} }}
				\]
				The latter implies, from the definition of $\hwb$ and the
				freshness of $t_i, \forall i \in I$, the following,  for some $\Delta_6$:
				\[
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{m_i} }}
					{\Hby{\mact{\ell}}}
					{\Delta_6}{\newsp{\widetilde{m_2}'}{Q' \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} }}
				\]
				and
				\begin{eqnarray}
					\mhorel{\Gamma}{\Delta_5}{\newsp{\widetilde{m_1}'}{P' \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{n_i} \Par C_1}}
					{\hwb}
					{\Delta_6}{}{\newsp{\widetilde{m_2}'}{Q' \Par \prod_{i \in I} \appl{(\trvalx{t_i})}{m_i} \Par C_2}}
					\label{lem:trig_subst1}
				\end{eqnarray}
				where $C_1, C_2$ are the higher-order trigger processes if $\ell, \mact{\ell}$ are output actions
				and $C_1 = C_2 = \inact$ otherwise.
				The former transition implies, for some $\Delta_4'$:
				\[
					\horel{\Gamma}{\Delta_4}{\newsp{\widetilde{m_2}}{Q }}
					{\Hby{\mact{\ell}}}
					{\Delta_4'}{\news{\widetilde{m_2}'}{Q'}}
				\]
				which in turn implies, for some $\Delta_2''$:
				\[
					\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{\widetilde{m}}{\widetilde{x}}}}
					{\Hby{\mact{\ell}}}
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par \subst{\widetilde{m}}{\widetilde{x}} }}
				\]
				Equation \eqref{lem:trig_subst1} and the definition of $\Re$ imply the desired conclusion for the case:
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R \subst{\widetilde{n}}{\widetilde{x}} \Par C_1}}
					%{\hwb}
					{\ \Re\ }
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q' \Par R \subst{\widetilde{m}}{\widetilde{x}} \Par C_2 }}
				\end{eqnarray*}

		\item	Suppose an action from $R$:
		\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{\widetilde{n}}{\widetilde{x}}  }}
					{\hby{\ell}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P \Par R' \subst{\widetilde{n}}{\widetilde{x}} }}
				\]
				for some $\Delta_1''$.
				We identify three sub-cases:
				\begin{enumerate}[i.]
					\item	$\subj{\ell} \not= n_i$, i.e.~ the subject of $\ell$ is not any of the names $\tilde{n}$. The case is similar as above.

					\item	$\subj{\ell} = n_k$ and $n_k = m_k$.
							From the definition of $\Re$ we get that
							\[
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \binp{t_i}{x} (\appl{x}{n_i})}}
								{\hby{ \bactinp{t_k}{\omapchar{U}}}}
								{\Delta_3}{}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \appl{\omapchar{U}}{n_k}}}
							\]
							for some $\Delta_3$. This transition implies
							\[
								\mhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \prod_{i \in I} \binp{t_i}{x} (\appl{x}{m_i})}}
								{\Hby{ \bactinp{t_k}{\omapchar{U}}}}
								{\Delta_4}{}{\newsp{\widetilde{m_1}}{Q' \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \mapchar{U}{x} \subst{m_k}{x} }}
							\]
							and from bisimilarity up-to deterministic transition
							\begin{eqnarray*}
								&& \Gamma; \Delta_3 \proves \newsp{\widetilde{m_1}}{P \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \appl{\omapchar{U}}{n_k}}
								\\
								&\hby{\tau_{\beta}}&
									\Delta_3 \proves \newsp{\widetilde{m_1}}{P \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \mapchar{U}{x} \subst{n_k}{x}  }
								\\
								&\hwb&
									\Delta_4 \proves \newsp{\widetilde{m_1}}{Q' \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \mapchar{U}{x} \subst{m_k}{x}}
							\end{eqnarray*}
for some $\Delta_4$.
							The proof follows Part 2 of \lemref{lem:trigger_application} where, for some $\Delta_3'$:
							\[
								\mhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{P \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \mapchar{U}{x} \subst{n_k}{x}  }}
								{\hby{\ell} }
								{\Delta_3'}{}{\newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \bout{t'}{n_k} \inact }}
							\]
							implies, for some $\Delta_4'$:
							\[
								\mhorel{\Gamma}{\Delta_4}{\newsp{\widetilde{m_2}}{Q' \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \mapchar{U}{x} \subst{m_k}{x}  }}
								{\Hby{\ell} \dk{\dots}}
								{\Delta_4'}{}{\newsp{\widetilde{m_2}'}{Q'' \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \bout{t'}{m_k} \inact }}
							\]
							and furthermore, from Part 3 of \lemref{lem:trigger_application}
							\[
								\mhorel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par \binp{t'}{y}{(\appl{y}{n_k})}}}
								{\hwb}
								{\Delta_4'}{}{\newsp{\widetilde{m_2}'}{Q'' \Par \prod_{i \in I \backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \binp{t'}{y}{(\appl{y}{m_k})}}}
							\]
							that implies from the definition of $\Re$ that for all $R$ such that $\set{\widetilde{x}} \subseteq \fv{R}$
							\[
								\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}'}{P \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
								{\ \Re\ }
								{\Delta_4'}{\newsp{\widetilde{m_2}'}{Q'' \Par R \subst{\widetilde{m}}{\widetilde{x}}}}
							\]
							The case concludes when we verify that, for some $\Delta_2''$, we have: 
							\[
								\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{\widetilde{m}}{x} }}
								{\Hby{\ell}}
								{\Delta_2''}{\newsp{\widetilde{m_1}'}{Q'' \Par R' \subst{\widetilde{m}}{x} }}
							\]
							

					\item	$\subj{\ell} = n_k$ and $n_k \not= m_k$. This case
							is not possible. \lemref{lem:trigger_application} implies
							that $n_k$ is a session and $\dual{n_k} \in \fn{P}$. From the
							definition of typed transition (\defref{d:tlts}) we get that we cannot observe $\ell$
							on $R \subst{\widetilde{n}}{\widetilde{x}}$, because $\dual{n_k} \in \fn{P}$ and $(\Gamma; \es; \Delta) \not\hby{\ell}$.
				\end{enumerate}

		\item	Suppose the interaction of $P$ and $R$, for some $\Delta_1'$:
		\[
					\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
					{\hby{}}
					{\Delta_1''}{\newsp{\widetilde{m_1}'}{P' \Par R' \subst{\widetilde{n}}{\widetilde{x}} }}
				\]
				From the typed reduction definition (\defref{d:tlts}) we get that
				\begin{eqnarray}
					&&	\horel{\Gamma}{\Delta_3}{\news{\widetilde{m_1}}{P}}
						{\hby{\ell_1}}
						{\Delta_R}{\news{\widetilde{m_1}}{P}}
					\label{lem:trigger_subst_31}
					\\
					&&	\horel{\Gamma}{\Delta_1'}{R \subst{\widetilde{n}}{\widetilde{x}} }
						{\hby{\ell_2}}
						{\Delta_R'}{R' \subst{\widetilde{n}}{\widetilde{x}} }
					\label{lem:trigger_subst_32}
					\\
					&&	\ell_1 \comp \ell_2 \nonumber
				\end{eqnarray}

				We distinguish several subcases:
				\begin{enumerate}[i.]
	
					\item	$\ell_1 = \bactinp{n_k}{V}$ and $\ell_2 = \newsp{\widetilde{m}}{\bactout{\dual{n_k}}{V}}$.
%							The proof is a consequence of Part 3 \lemref{lem:trigger_application}.
							From the requirement of $\Re$ we get that there exists $U$
							such that, for some $\Delta_3$:
							\[
								\mhorel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \binp{t_i}{x} (\appl{x}{n_i})}}
								{ \hby{ \bactinp{t_k}{ \omapchar{U} }} \Hby{\dtau} }
								{\Delta_3}{}{  \newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i})
								\Par  \mapchar{U}{x} \subst{n_k}{x} }}
							\]
							which in turn implies, for some $\Delta_4$, that
							\[
								\mhorel{\Gamma}{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \prod_{i \in I} \binp{t_i}{x} (\appl{x}{m_i})}}
								{ \Hby{ \bactinp{t_k}{ \omapchar{U} }} \Hby{\dtau} }
								{\Delta_4}{}{  \newsp{\widetilde{m_2}'}{Q' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})
								\Par  \mapchar{U}{x} \subst{m_k}{x} }}
							\]
							and
							\[
								\mhorel{\Gamma}{\Delta_3}{  \newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i})
								\Par  \mapchar{U}{x} \subst{n_k}{x} }}
								{\hwb}
								{\Delta_4}{}{  \newsp{\widetilde{m_2}'}{Q' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})
								\Par  \mapchar{U}{x} \subst{m_k}{x} }}
							\]
							From Part 2 of \lemref{lem:trigger_application} we obtain that if, for some $\Delta_3'$, 
							\[
								\mhorel{\Gamma}{\Delta_3}{  \newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i})
								\Par  \mapchar{U}{x} \subst{n_k}{x} }}
								{ \hby{\tau} }
								{\Delta_3'}{}{  \newsp{\widetilde{m_1}''}{P' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par
								\binp{t'_k}{x} (\appl{x}{n_k})}}
							\]
							then
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_4}{  \newsp{\widetilde{m_2}'}{Q' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})
								\Par  \mapchar{U}{x} \subst{m_k}{x} }}
								{ \Hby{\tau} }
								{\Delta_4'}{}{  \newsp{\widetilde{m_2}''}{Q'' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par
								\binp{t'_k}{x} (\appl{x}{m_k}) }}
							\end{eqnarray*}
							and
							\begin{eqnarray}
								\mhorel{\Gamma}{\Delta_3'}{  \newsp{\widetilde{m_1}''}{P' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i}) \Par
								\binp{t'_k}{x} (\appl{x}{n_k})}}
								{ \hwb }
								{\Delta_4'}{}{\newsp{\widetilde{m_2}''}{Q'' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i}) \Par \binp{t'_k}{x} (\appl{x}{m_k})}}
								\label{lem:tr_subst_41}
							\end{eqnarray}
for some $\Delta_4'$.
							This means that there exists a $\omapchar{U'}$ (cf. \defref{def:char})
							\begin{eqnarray*}
								\newsp{\widetilde{m_1}'}{P \Par \prod_{i \in I\backslash{k}} \binp{t_i}{x} (\appl{x}{n_i})}
								&\hby{\bactinp{n_k}{\omapchar{U'}}}&
								\newsp{\widetilde{m_3}}{P' \subst{\omapchar{U'}}{x} \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{n_i})}
								\\
								\mapchar{U}{x} \subst{n_k}{x}
								&\hby{\bactout{n_k}{\omapchar{U'}}}&
								\bout{t'_k}{n_k} \inact
								\\
								\\
								\newsp{\widetilde{m_2}''}{Q' \Par \prod_{i \in I\backslash{k}} \binp{t_i}{x} (\appl{x}{m_i})}
								&\Hby{\bactinp{m_k}{\omapchar{U'}}}&
								\newsp{\widetilde{m_4}}{Q'' \subst{\omapchar{U'}}{x} \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})}
								\\
								\mapchar{U}{x} \subst{m_k}{x}
								&\hby{\bactout{m_k}{\omapchar{U'}}}&
								\bout{t'_k}{m_k} \inact
							\end{eqnarray*}
							But then we can generalise the above result to match actions in \eqref{lem:trigger_subst_31}
							and \eqref{lem:trigger_subst_32}:
							\begin{eqnarray*}
								\newsp{\widetilde{m_2}''}{Q' \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})}
								&\Hby{\bactinp{m_k}{V}}&
								\newsp{\widetilde{m_4}}{Q'' \subst{V}{x} \Par \prod_{i \in I\backslash{\set{k}}} \binp{t_i}{x} (\appl{x}{m_i})}
								\\
								R \subst{\widetilde{m}}{\widetilde{x}}
								&\hby{\bactout{m_k}{V}}&
								R' \subst{\widetilde{n}}{\widetilde{x}} \qquad \quad m_k \in \widetilde{m}
							\end{eqnarray*}
							to obtain, for some $\Delta_2''$, that
							\[
								\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par R \subst{\widetilde{n}}{\widetilde{x}} }}
								{\Hby{}}
								{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q'' \subst{V}{x} \Par R' \subst{\widetilde{m}}{\widetilde{x}} }}
							\]
							Furthermore the definition of $\Re$ and \eqref{lem:tr_subst_41} allow us to
							conclude the case with the implication that
							\[
								\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P'\subst{V}{x} \Par R' \subst{\widetilde{n}}{\widetilde{x}} }}
								{\ \Re\ }
								{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q'' \subst{V}{x} \Par R' \subst{\widetilde{m}}{\widetilde{x}} }}
							\]
			


					\item	An important sub-case is when
							$\ell_1 = \bactinp{n}{n_k}$ and $\ell_2 = \bactout{n}{n_k}$.
						%
							From the definition of $\Re$ we have that
							\[
								\horel{\Gamma}{\Delta_1}{ \newsp{\widetilde{m_1}}{P \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}}
								{ \hby{ \bactinp{n}{m} } }
								{\Delta_3}{  \newsp{\widetilde{m_1}}{P' \subst{m}{x} \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}   }
							\]
						for some $\Delta_3$. This transition
							implies, for some $\Delta_4$, that 
							\begin{eqnarray}
								\mhorel{\Gamma}{\Delta_2}{ \newsp{\widetilde{m_2}}{Q \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}}
								{ \Hby{ \bactinp{n}{m} } }
								{\Delta_4}{}{  \newsp{\widetilde{m_2}}{Q' \subst{m}{x} \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}   }
								\label{ lem:trigger_subst_311 }
							\end{eqnarray}
							and
							\[
								\horel{\Gamma}{\Delta_3}{  \newsp{\widetilde{m_1}}{P' \subst{m}{x} \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}   }
								{\hwb}
								{\Delta_4}{  \newsp{\widetilde{m_2}}{Q' \subst{m}{x} \Par \prod_{i \in I} \binp{t_1}{x} (\appl{x}{n_i})}   }
							\]
							We infer from Part 4 of \lemref{lem:trigger_application} that
							\[
								\mhorel{\Gamma}{\Delta_3'}{  \newsp{\widetilde{m_1}}{P' \subst{n_k}{x} \Par \prod_{i \in I\backslash\set{k}} \binp{t_1}{x}(\appl{x}{n_i})}   }
								{\hwb}
								{\Delta_4'}{}{  \newsp{\widetilde{m_2}}{Q' \subst{m_k}{x} \Par \prod_{i \in I\backslash\set{k}} \binp{t_1}{x}(\appl{x}{n_i})}   }
							\]
							which implies from the definition of $\Re$ that
							\[
								\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P' \subst{n_k}{x} \Par R \subst{\widetilde{m}}{\widetilde{x}}}}
%								{\hwb}
								{\ \Re\ }
								{\Delta_2'}{}{  \newsp{\widetilde{m_2}}{Q' \subst{m_k}{x} \Par R' \subst{\widetilde{m}}{\widetilde{x}} } }
							\]
						%
							From \eqref{ lem:trigger_subst_311 } and \eqref{lem:trigger_subst_32} we obtain, for some $\Delta_2''$, the following
							\begin{eqnarray*}
								\horel{\Gamma}{\Delta_2'}{ \newsp{\widetilde{m_2}}{Q \Par R \subst{\widetilde{m}}{\widetilde{x}} }}
								{ \Hby{  } }
								{\Delta_2''}{  \newsp{\widetilde{m_2}}{Q' \subst{m_k}{x} \Par R' \subst{\widetilde{m}}{\widetilde{x}} }   }
							\end{eqnarray*}
						%
							which concludes the case.

					\item	The most demanding sub-case is the case
							where
							$\ell_1 = \bactinp{n_k}{n_l}$ and $\ell_2 = \bactout{n_k}{n_l}$.
							The proof is a consequence of the previous two sub-cases.	


%					\dk{finish proof}							


					\item	The rest of the sub-cases are similar (or easier) to the above cases.

%					\item	$\subj{\ell_1} \not= n_1$. \dk{put proof} %The case is similar with the previous cases.
%					\item	$\subj{\ell_1} = n_1$.  \dk{put proof} %The case is similar with sub-case (ii) of case 2.
%					\item	$\obj{\ell_1} = n_1$. \dk{put proof}
%					
%					\item	 $\ell_1 = \bactinp{n_k}{n_l}$ and $\ell_2 = \bactout{n_k}{n_l}$.
				\end{enumerate}
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PROCESS SUBSTITUTION - Second Lemma
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\jasks{I can't parse this sentence:}

We can now state a process substitution lemma
(\lemref{lem:proc_substmt} in the main text).
Given a higher-order bisimulation under a trigger value
substitution, we can generalise for any value substitution.

%We can now state a process substitution lemma, where given
%a higher order equivalence under a trigger value substitution,
%we can generalise for any process substitution that makes
%the equivalence typable.

\begin{lemma}[Process Substitution]
\dkmargin{Please Read. \newc{JP: Looks fine, need to be convinced.}}
	\label{lem:process_subst}
	Let $P_1$ and $P_2$ be processes, with $z \in \fv{P_1}$ and $z \in \fv{P_2}$.
	Also, let $t$ be a fresh name.
	If
	\[
		\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
		{\hwb}
		{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}
	\]
	then for all $\abs{x}{R}$ there exist  $\Delta_1'$ and $\Delta_2'$ such that
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z} }}
		{\hwb}
		{\Delta_2'}{\newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z} }}
	\]
\end{lemma}


\begin{proof}
	Consider the typed relation (for readability, we omit type information):
	\begin{eqnarray*}
		\Re	&=&	\set{
					(\Gamma; \Delta_1' \proves \newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z}}, \Delta_2' \proves \newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z}})
					\setbar\\
			&&		\qquad \horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}~~}
	\end{eqnarray*}
	We show that $\Re$ is a higher-order bisimulation. Suppose that 
	%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1 \subst{{\abs{x}{R}}}{z} }}
		{\hby{\ell}}
		{\Delta_3}{\newsp{\widetilde{m_1}}{P_1' \subst{{\abs{x}{R}}}{z} }}
		\label{lem:proc_subst1}
	\end{eqnarray}
	for some $\Delta_3$.
   We should exhibit an appropriate matching action from $ \newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z}}$.
	Our analysis distinguishes two cases, depending on whether the
	substitution $\subst{{\abs{x}{R}}}{z}$ has an effect on the action denoted by $\ell$:
	\begin{enumerate}
		\item	Case $P_1 \not\scong Q \Par \appl{z}{n}$ that is,
				the substitution does not affect top-level processes. 

				In other words, we can infer from the freshness of $t$ that $\subj{\ell} \not= t$.
	%			\jasks{(This sentence on freshness seems misplaced - it makes sense only below.)}
				Furthermore, from the requirements of $\Re$
				we get that there exist $\Delta_1''$ and $P'_1$ such that
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{P_1 \subst{\trvalx{t}}{z} }}
					{\hby{\ell}}
					{\Delta_1''}{\newsp{\widetilde{m_1}}{P_1' \subst{\trvalx{t}}{z} }}
				\end{eqnarray*}
				which, in turn, implies that there exist $\Delta_2''$ and $P_2'$ such that
				\begin{eqnarray}
					\horel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}'}{P_2 \subst{\trvalx{t}}{z} }}
					{\Hby{\mact{\ell}}}
					{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \subst{\trvalx{t}}{z} }}
					\label{lem:proc_subst0}
				\end{eqnarray}
				and
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}''}{P_1' \subst{\trvalx{t}}{z} \Par C_1}}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}''}{P_2' \subst{\trvalx{t}}{z} \Par C_2}}
				\end{eqnarray*}
				with $C_1$ (resp., $C_2$) being the higher-order trigger process
				in the cases where $\ell = \news{\widetilde{m}} \bactout{n}{V_1}$ (resp., $\mact{\ell} = \news{\widetilde{m}'} \bactout{n}{V_2}$)
				and $C_1 = C_2 = \inact$ otherwise.
				Because $C_1$ and $C_2$ are closed terms we can rewrite the substitution as:
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}''}{(P_1'\Par C_1) \subst{\trvalx{t}}{z}}}
					{\hwb}
					{\Delta_2}{\newsp{\widetilde{m_2}''}{(P_2'\Par C_2) \subst{\trvalx{t}}{z}}}
				\end{eqnarray*}
				Since $\ell, \mact{\ell}$ do not act on the substitution,
				we can consider any $\abs{x}{R}$ instead of $\trvalx{t}$.
				Thus we further deduce that
				\begin{eqnarray}
					\horel{\Gamma}{\Delta_3'}{\newsp{\widetilde{m_1}''}{(P_1'\Par C_1) \subst{{\abs{x}{R}}}{z}}}
					{\ \Re\ }
					{\Delta_4'}{\newsp{\widetilde{m_2}''}{(P_2'\Par C_2) \subst{{\abs{x}{R}}}{z}}}
					\label{lem:proc_subst33}
				\end{eqnarray}

				From \eqref{lem:proc_subst0} we can derive the transition
				\begin{eqnarray*}
					\horel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}}{P_2 \subst{{\abs{x}{R}}}{z} }}
					{\Hby{\mact{\ell}}}
					{\Delta_4}{\newsp{\widetilde{m_2}'}{P_2' \subst{{\abs{x}{R}}}{z} }}
				\end{eqnarray*}
				Equation \eqref{lem:proc_subst33} concludes the case.
%				\jasks{There is a problem with equation labels above!}


		\item	Case $P_1 \scong P \Par \prod_{i \in I} \appl{z}{n_i} \Par \appl{z}{n_1}$ such that
				$P \not\scong P' \Par \appl{z}{n'}$. This is the case where action $\ell$ might
				happen on the process that is being substituted (note that a substituted process
				needs to be applied first).
%				This is the case where $P$ does not include the form
%				of an application on name $x$.

				We identify two sub-cases, depending on the source of the action $\ell$:
				\begin{itemize}
					\item	Consider the following transition, for some $\Delta_3$:
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{(P \Par \prod_{i \in I} \appl{z}{n_i} \Par \appl{z}{n_1}) \subst{{\abs{x}{R}}}{z} }}
								{\hby{\ell}}
								{\Delta_3}{}{\newsp{\widetilde{m_1}}{(P' \Par \prod_{i \in I} \appl{z}{n_i} \Par \appl{z}{n_1}) \subst{{\abs{x}{R}}}{z} }}
							\end{eqnarray*}
							%
							This sub-case is similar to the previous case.

					\item	Consider the following transition, for some $\Delta_3$, and assuming that $Q = P \Par \prod_{i \in I} \appl{z}{n_i}$:
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{(Q \Par \appl{z}{n_1}) \subst{{\abs{x}{R}}}{z} }}
								{\hby{\tau}}
								{\Delta_3}{\newsp{\widetilde{m_1}}{Q \subst{{\abs{z}{R}}}{z} \Par R \subst{n_1}{z}  }}
								\label{lem:proc_subst1}
							\end{eqnarray}
							which is the application of name $n_1$ on abstraction $\abs{x}{R}$.
							%
							From the requirements of $\Re$ we infer that
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1}{\newsp{\widetilde{m_1}}{(Q \Par \appl{z}{n_1}) \subst{\trvalx{t}}{z} }}
								{\hby{\tau}}
								{\Delta_1''}{}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
							\end{eqnarray*}
							for some $\Delta_1''$. This implies that there exist $P_2'$ and $\Delta_2''$ such that
							%
								\nhorel{\Gamma}{\Delta_2}{\newsp{\widetilde{m_2}}{P_2 \subst{\trvalx{t}}{z} }}
								{\Hby{}}
								{\Delta_2''}{\newsp{\widetilde{m_2}}{P_2' \subst{\trvalx{t}}{z}}}
								{lem:proc_subst2}
							%
							and
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
								{\hwb}
								{\Delta_2''}{}{\newsp{\widetilde{m_2}}{P_2' \subst{\trvalx{t}}{z}}}
							\end{eqnarray*}
							%
							From the last pair we can see that for a fresh $t'$ if
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \binp{t}{y} (\appl{y}{n_1})}}
								{\hby{\bactinp{t}{\trvalx{t'}}}}
								{\Delta_1'''}{}{\newsp{\widetilde{m_2}}{Q \subst{\trvalx{t}}{z} \Par \appl{(\trvalx{t'})}{n_1}}}
							\end{eqnarray*}
							this implies that there exist $P_2'', \Delta_2'''$ such that
							\begin{eqnarray}
								\begin{array}{crll}
											& \Gamma; \es; \Delta_2'' &\proves& \newsp{\widetilde{m_2}}{P_2'\subst{\trvalx{t}}{z}}
									\\
									\Hby{}	&	&&	\newsp{m_2}{(P_3 \Par \appl{z}{n_2}) \subst{\trvalx{t}}{z}}
									\\
									{\hby{\btau}\hby{\bactinp{t}{\trvalx{t'}}}} &
												&&	\newsp{m_2}{P_3 \subst{\trvalx{t}}{z} \Par \appl{(\trvalx{t'})}{n_2}}
									\\
									\Hby{}	& \Delta_2''' & \proves & \newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{(\trvalx{t'})}{n_2}}
								\end{array}
								\label{lem:proc_subst3}
							\end{eqnarray}
							and
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_1'''}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \appl{(\trvalx{t'})}{n_1}}}
								{\hwb}
								{\Delta_2'''}{}{\newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{(\trvalx{t'})}{n_2}}}
							\end{eqnarray*}
							%
							From \lemref{lem:trigger_subst} we can deduce that, for all $\abs{x}{R}$, if there exist $\Delta_5$ and $ \Delta_6$ then
							\begin{eqnarray*}
								\mhorel{\Gamma}{\Delta_5}{\newsp{\widetilde{m_1}}{Q \subst{\trvalx{t}}{z} \Par \appl{(\abs{x}{R})}{n_1}}}
								{\hwb}
								{\Delta_6}{}{\newsp{\widetilde{m_2}}{P_2'' \subst{\trvalx{t}}{z} \Par \appl{(\abs{x}{R})}{n_2}}}
							\end{eqnarray*}
							from the definition of $\Re$ we have that for all $\abs{x}{R}$, if there exist $\Delta_3$ and $\Delta_4$
							%
								\nhorel{\Gamma}{\Delta_3}{\newsp{\widetilde{m_1}}{Q \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_1}}}
								{\ \Re\ }
								{\Delta_4}{\newsp{\widetilde{m_2}}{P_2'' \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_2}}}
								{lem:proc_subst4}
							%	
							We show that we can mimic first the
							transition in \eqref{lem:proc_subst2} and then the silent part of
							transitions \eqref{lem:proc_subst3} to get:
							\begin{eqnarray}
								\begin{array}{crll}
										& \Gamma; \es; \Delta_2' &\proves& \newsp{\widetilde{m_2}}{P_2 \subst{(\abs{x}{R})}{z}}
									\\
									\Hby{}	&	\Delta_2'			& \proves&	\newsp{\widetilde{m_2}}{P_2' \subst{(\abs{x}{R})}{z}}
									\\
									\Hby{} &	\Delta_4			& \proves&	\newsp{m_2}{P_2'' \subst{(\abs{x}{R})}{z} \Par \appl{(\abs{x}{R})}{n_2}}
								\end{array}
								\label{lem:proc_subst5}
							\end{eqnarray}
							We showed that if \eqref{lem:proc_subst1} then \eqref{lem:proc_subst5} and \eqref{lem:proc_subst4}
							as required to show that $\Re$ is a higher-order bisimulation.							\qed
				\end{itemize}
	\end{enumerate}
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  WB IS WBC
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\jp{Below we should be consistent and describe an $\Re$ that we use as closure.}
\begin{lemma}
	\label{app:lem:wb_is_wbc}
	$\hwb\ \subseteq\ \wbc$.
\end{lemma}

\begin{proof}
	Let $\Re$ be the typed relation (for readability, we omit typing information):
	\[
		\Re = \set{(P_1, Q_1) \setbar \horel{\Gamma}{\Delta_1}{P_1}{\hwb}{\Delta_2}{Q_1}}
	\]
	We show that $\Re$ is a context bisimulation (cf. \mydefref{def:wbc}). Suppose that
		\begin{eqnarray}
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
		\label{lem:wb_is_wbc1}
	\end{eqnarray}
	We need to infer an appropriate matching transition from $Q_1$.
	The proof proceeds by a case analysis on  $\ell$.
	We distinguish four cases: $\ell$ is not an output or a higher-order input action;
	$\ell$ is a higher-order input action;
	$\ell$ is an higher-order output; $\ell$ is a first-order output.
%	\JP{What about higher-order input?}
	\begin{enumerate}[1.]
		\item Case $\ell \notin \set{ \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{P}},  \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}, \bactinp{n}{\abs{\widetilde{x}}{P}} }$: 
		We first notice that in this case the definition of $\wbc$ and $\hwb$ coincide, so 
		we have to show the existence of 
		$Q_2$ and $\Delta'_2$ such that:	
				\[
					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\ell}}{\Delta_2'}{Q_2}
				\]
			%
				\noi and
			%
				\[
					\horel{\Gamma}{\Delta_1'}{P_2}{\,\Re\,}{\Delta_2'}{Q_2}.
				\]
		This is immediate from 
		transition \eqref{lem:wb_is_wbc1} 
		and the definition of $\hwb$ (cf. \mydefref{d:hwb}). %\newc{JP - I have modified, please check.}

		\item	Case $\ell = \bactinp{n}{\abs{\widetilde{x}}{P}}$: In this case, the transition \eqref{lem:wb_is_wbc1} can be written as 
			%
				\[
					\begin{array}{l}
%						\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}}}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
						\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{\auxtr{t}}}}{\Delta_1''}{P_2 \subst{\auxtr{t}}{x}}
					\end{array}
				\]
				for some $\Delta''_1$.
			In turn, the above transition and $\Re$ imply the existence of $Q_2$ and $\Delta''_2$ such that:
			%
			\[
%					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}}}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
					\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{\auxtr{t}}}}{\Delta_2''}{Q_2 \subst{\auxtr{t}}{x}}
			\]
			%
				\noi and
			%
			\[
				\begin{array}{l}
%					\horel{\Gamma}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}{\hwb}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{\mapchar{U}{\widetilde{x}}}}{x}}\\
					\horel{\Gamma}{\Delta_1''}{P_2 \subst{\auxtr{t}}{x}}{\hwb}{\Delta_2''}{Q_2 \subst{\auxtr{t}}{x}}.
				\end{array}
			\]
			 Then, by using the previous equality and \mylemref{lem:process_subst}, we may conclude
				 that
			%
			\[
				\horel{\Gamma}{\Delta_1'}{P_2 \subst{\abs{\widetilde{x}}{P}}{x}}{\hwb}{\Delta_2'}{Q_2 \subst{\abs{\widetilde{x}}{P}}{x}}
			\]
			for some $\Delta'_1$, $\Delta'_2$,
			for all $P$ with $\fv{P} = \set{\widetilde{x}}$, as required. %\newc{JP - I have modified, please check.}

		\item	Case $\ell = \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}$: In this case, 
 transition \eqref{lem:wb_is_wbc1} and $\Re$ imply the existence of $\Delta'_2$, a process $Q_2$, and name $m_2$ such that 
			%
			\[
				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}'} \bactout{n}{m_2}}}{\Delta_2'}{Q_2}
			\]
			%
				\noi and
			%
			\[
				\horel	{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P_2 \Par \htrigger{t}{m_1}}}
				{\hwb}
				{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q_2 \Par \htrigger{t}{m_2}}}
			\]
			 for some fresh $t$.
				\noi From Case 2 (higher-order input) of this proof
				%\JP{It is not clear what case you are referring to here}
				we can conclude that for all $R$ with $\fv{R} = \set{x}$ and for some $\Delta_1''$, $\Delta_2''$:
			%
			\[
				\begin{array}{rcl}
					\Gamma; \es; \Delta_1' \proves \newsp{\widetilde{m_1}'}{P_2 \Par \htrigger{t}{m_1}} 
					& \by{\bactinp{t}{\abs{z}{\binp{z}{x} R}}}& \newsp{\widetilde{m_1}'}{P_2 \Par \newsp{s}{\binp{s}{x} R \Par \bout{\dual{s}}{m_1} \inact }}\\
					& \by{\dtau}   &\Delta_1'' \proves \newsp{\widetilde{m_1}'}{P_2 \Par  R \subst{m_1}{x}}
				\end{array}
			\]
			%
				\noi and
			%
			\[
				\begin{array}{rcl}
					\Gamma; \es; \Delta_2' \proves \newsp{\widetilde{m_2}'}{Q_2 \Par \htrigger{t}{m_2} } 
					& \by{\bactinp{t}{\abs{z}{\binp{z}{x} R}}} &\newsp{\widetilde{m_2}'}{Q_2 \Par \newsp{s}{\binp{s}{x} R \Par \bout{\dual{s}}{m_2} \inact}}\\
					& \by{\dtau} &\Delta_2'' \proves \newsp{\widetilde{m_2}'}{Q_2 \Par  R \subst{m_2}{x}}
				\end{array}
			\]
			where, due to the deterministic internal transitions (cf. \defref{def:dettrans}), it is easy to see that 
			%
			\[
				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_2 \Par  R \subst{m_1}{x}}}{\hwb}{\Delta_2''}{\newsp{\widetilde{m_2}'}{Q_2 \Par R \subst{m_2}{x}} }
			\]
			for all $R$ with $\fv{R} = \set{x}$, as required by the definition of $\wbc$ (\mydefref{def:wbc}).
%			\newc{JP - I have modified here, please check.}

		\item	Case $\ell = \news{\widetilde{m_1}'} \bactout{n}{\abs{\widetilde{x}}{P}}$: This case is similar to the previous case but makes use of the alternative trigger, $\ntrigger{t}{V}$ (cf.~\eqref{eq:ntrig}).
			The definition of $\Re$ and transition \eqref{lem:wb_is_wbc1} allow us to infer the existence of some $\Delta_2'$, $Q$, and $Q_2$ such that
			%
			\[
				\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\widetilde{m_2}'} \bactout{n}{\abs{\widetilde{x}}{Q}}}}{\Delta_2'}{Q_2}
			\]
			%
				\noi and 
			%
			\[
				\horel	{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P_2 \Par \htrigger{t}{\abs{\widetilde{x}}{P}}}}
				{\hwb}
				{\Delta_2'}{ \newsp{\widetilde{m_2}' }{Q_2 \Par \htrigger{t}{\abs{\widetilde{x}}{Q}}}}
			\]
			for some fresh $t$. Using \mylemref{lem:alt_tr}, we above equality implies that
			%
			\[
				\horel	{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P_2 \Par \ntrigger{t}{\abs{\widetilde{x}}{P}}}}
				{\hwb}
				{\Delta_2'}{ \newsp{\widetilde{m_2}' }{Q_2 \Par \ntrigger{t}{\abs{\widetilde{x}}{Q}}}}
			\]
			%
			which in turn implies
			\[
				\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}'}{P_2 \Par \ntrigger{t}{\abs{\widetilde{x}}{P}}}}
				{ \hby{ \bactinp{t}{  \abs{y}{\binp{t'}{x} (\appl{x}{y}) }    } } }
				{\Delta_1''}{}{\newsp{\widetilde{m_1}'}{P_2 \Par \newsp{s}{  \appl{(\abs{y}{\binp{t'}{x} (\appl{x}{y})) }{s}} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact } }}
			\]
			for some $\Delta_1''$ and 
			\[
				\mhorel{\Gamma}{\Delta_2'}{\newsp{\widetilde{m_2}'}{Q_2 \Par \ntrigger{t}{\abs{\widetilde{x}}{Q}}}}
				{ \Hby{ \bactinp{t}{  \abs{y}{\binp{t'}{x} (\appl{x}{y}) }    } } }
				{\Delta_2''}{}{\newsp{\widetilde{m_1}'}{Q_2' \Par \newsp{s}{\appl{(\abs{y}{\binp{t'}{x} (\appl{x}{y})) }{s}}  \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact } }}
			\]
			%
			for some $\Delta_2''$, and
			%
			\[
				\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_2 \Par \newsp{s}{  \appl{(\abs{y}{\binp{t'}{x} (\appl{x}{y})) }{s}} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact } }}
				{\hwb}
				{\Delta_2''}{}{\newsp{\widetilde{m_1}'}{Q_2' \Par \newsp{s}{\appl{(\abs{y}{\binp{t'}{x} (\appl{x}{y})) }{s}}  \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact } }}.
			\]
				\noi From the  Case 2  of this proof (higher-order input), we have
%				\JP{It is not clear what case you are referring to here} we can conclude that :
			%
			\[
				\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_2 \Par \newsp{s}{  \appl{(\abs{y}{\binp{y}{x} R})}{s} \Par \bout{\dual{s}}{\abs{\widetilde{x}}{P}} \inact } }}
				{\hwb}
				{\Delta_2''}{}{\newsp{\widetilde{m_1}'}{Q_2' \Par \newsp{s}{\appl{(\abs{y}{\binp{y}{x} R}}){s}  \Par \bout{\dual{s}}{\abs{\widetilde{x}}{Q}} \inact } }}
			\]
			for all $R$ with $\fv{R} = \set{x}$. Now, 
			using deterministic transitions (cf. \defref{def:dettrans}) is easy to see that
			%
			\[
				\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P_2 \Par  R \subst{\abs{\widetilde{x}}{P}}{y}}}{\hwb}{\Delta_2''}{\newsp{\widetilde{m_2}}{Q_2 \Par R \subst{\abs{\widetilde{x}}{Q}}{y}}}
			\]
			for all $R$ with $\fv{R} = \set{x}$, as required by the definition of $\wbc$ (cf. \defref{def:wbc}).\\
%			\newc{JP - I have modified here, pls check}
			

		\item	Case $\ell = \news{\widetilde{m_1}'} \bactout{n}{\widetilde{m_1}}$: This case is similar to the previous one.
	\end{enumerate}
	\qed
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  WBC IS CONG
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{lemma}
	\label{app:lem:wbc_is_cong}
	$\wbc\ \subseteq\ \cong$.
\end{lemma}


\begin{proof}
	\noi We prove that $\wbc$ (cf. \mydefref{def:wbc}) satisfies the three defining properties of $\cong$:
	reduction closure, barb preservation, congruence (cf. \mydefref{def:rc}).
%
\begin{enumerate}[I.]

\item	{\bf Reduction-Closed:}
	Let
		$\horel{\Gamma}{\Delta_1}{P_1}{\wbc}{\Delta_2}{P_2}$. The reduction

	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\red}{\Delta_1'}{P_1'}
	\]
%
	\noi implies that there exist $\Delta_2'$ and $P_2'$ such that 
  \[
		\horel{\Gamma}{\Delta_2}{P_2}{\By{}}{\Delta_2'}{P_2'}
		\qquad \text{and} \qquad
		\horel{\Gamma}{\Delta_1}{P_1'}{\wbc}{\Delta_2'}{P_2'}
		\]
 The same arguments hold for the symmetric case, thus $\wbc$ is reduction-closed.

	\item {\bf Barb Preservation:} Following \mydefref{def:barbs}, we have that
$		\Gamma; \emptyset; \Delta_1 \proves P_1 \barb{n}$
	implies 
	\begin{eqnarray*}
		P &\cong& \newsp{\widetilde{m}}{\bout{n}{V_1} P_3 \Par P_4}
	\end{eqnarray*}
with $\dual{n} \notin \Delta_1$.
	\noi From the definition of $\wbc$ we infer that
%
\[
	\horel	{\Gamma}{\Delta_1}{\newsp{\widetilde{m}}{\bout{n}{V_1} P_3 \Par P_4}}
		{\by{\news{s_1} \bactout{n}{V_1}}}
		{\Delta_1'}
		{\newsp{\widetilde{m'}}{P_3 \Par P_4}}
\]
	\noi implies the existence of $\Delta_2'$, $V_2$, and $P'_2$ such that
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta_2}{P_2}{\By{\news{m_2} \bactout{n}{V_2}}}{\Delta_2'}{P_2'}
	\end{eqnarray*}
   Therefore, we infer that 
$		\Gamma; \emptyset; \Delta_2 \proves P_2 \Barb{n}$, as desired.

	\item {\bf Congruence:}
	We have to show that  $\wbc$
	is preserved under any context.
	The most interesting context case is parallel composition.
	Input congruence, which is the case that generates substitution,
	is straightforward, since we are dealing with closed terms.

	To show the congruence of the paralllel composition we construct an  typed relation defined as 
	\[
	\begin{array}{rcl}
		\mathcal{S} &=&	\set{
				(\Gamma; \emptyset; \Delta_1 \cat \Delta_3 \proves \newsp{\widetilde{n_1}}{P_1 \Par R} \hastype \Proc,
				\Gamma; \emptyset; \Delta_2 \cat \Delta_3 \proves \newsp{\widetilde{n_2}}{P_2 \Par R})
				\setbar \\
		& &		\qquad \horel{\Gamma}{\Delta_1}{P_1}{\wbc}{\Delta_2}{P_2}, \forall \Gamma; \emptyset; \Delta_3 \proves R \hastype \Proc~~}\\
	\end{array}
	\]
	\noi We  show that $\mathcal{S}$ is a context bisimulation.
	Suppose that 
	$$
	\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{n_1}}{P_1 \Par R}}
					{\by{\ell}}
					{\Delta_1' \cat \Delta_3}{P'}
					$$
	for some $\Delta'_1$. We must show an appropriate matching action from $\newsp{\widetilde{n_2}}{P_2 \Par R}$.
	We proceed by a case analysis on the ``source'' of  action $\ell$ (i.e., $P_1$, $R$, an interaction between $P_1$ and $R$).

	\begin{enumerate}[1.]
	%%%%%%%%%%%%%%%
	% Case 1
	%%%%%%%%%%%%%%%

		\item Suppose that $\ell$ originates in $P_1$:
				%
				\[
					\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{n_1}}{P_1 \Par R}}
					{\by{\ell}}
					{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{n_1'}}{P_1' \Par R}}
				\]
				%
				\noi The case is divided into three sub-cases, depending on the shape of $\ell$:

				\begin{enumerate}[i.]
					\item Sub-case	$\ell \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$: Then from the definition of typed transition we infer:
					%
							\[
								\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}
							\]
							\noi which implies the existence of $P_2'$ and $\Delta_2'$ such that
							\begin{eqnarray}
								\horel{\Gamma}{\Delta_1}{P_2}{\By{\ell}}{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong1}\\
								\horel{\Gamma}{\Delta_1'}{P_1'}{\wbc}{\Delta_2'}{P_2'}.
								\label{lem:wbc_is_cong2}
							\end{eqnarray}
					%
							\noi From transition~\eqref{lem:wbc_is_cong1} we may infer that 
							\[
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}}{P_2 \Par R}}
								{\By{\ell}}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]
					%
							\noi Furthermore, from \eqref{lem:wbc_is_cong2} and the definition of $\mathcal{S}$ we infer that
					%
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{n_1}'}{P_1' \Par R}}
								{\ \mathcal{S}\ }
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]
							as desired.
							
					\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}$:
					Then we infer the typed transition 
							\[
								\horel{\Gamma}{\Delta_1}{P_1}
								{\by{\news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}}}
								{\Delta_1'}{P_1'}
							\]
							which implies the existence of $P'_2$, $\Delta_2'$, $\Delta_1''$, and $\Delta_2''$ such that 
							\begin{equation}
								 \horel{\Gamma}{\Delta_1}{P_2}{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong3}
								\end{equation}
								and 
						\begin{equation}
								  \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
								{\ \wbc\ }
								{\Delta_2''}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
								\label{lem:wbc_is_cong4}
							\end{equation}
					for all $Q$ with  $x \in \fv{Q}$.  From transition~\eqref{lem:wbc_is_cong3}, we infer that 
							\[
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}}{P_2 \Par R}}
								{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2' \Par R}}
							\]
				 Furthermore, from~\eqref{lem:wbc_is_cong4} we conclude that 
					%
							\[
								\horel{\Gamma}{\Delta_1'' \cat \Delta_3}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{\abs{\widetilde{x}}{ Q_1}}{x} \Par R}}
								{\ \mathcal{S}\ }
								{\Delta_2'' \cat \Delta_3}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x} \Par R}}
							\]
				for all $Q$, with  $x \in \fv{Q}$, as desired. \\

					\item	Sub-case $\ell = \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}$:
 From the definition of typed transition we infer that
							\[
								\horel{\Gamma}{\Delta_1}{P_1}
								{\by{\news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}}
								{\Delta_1'}{P_1'}
							\]
							which, in turn, implies that there exist $\Delta_2'$, $P_2'$, and $m_2$ such that
					%
							\begin{equation}
							\horel{\Gamma}{\Delta_1}{P_2}
								{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
								{\Delta_2'}{P_2'}
								\label{lem:wbc_is_cong5}
								\end{equation}
								and
								\begin{equation}
							\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{n_1}}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}}}}
								{\ \wbc\ }
								{\Delta_2''}{\newsp{\widetilde{n_2}}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}}}}
								\label{lem:wbc_is_cong6}
							\end{equation}
						 for some $\Delta_1''$ and $\Delta_2''$, 
						 for all $Q$ with $\{x\} = \fv{Q}$.
						\noi From transition~\eqref{lem:wbc_is_cong5} we infer that 
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{n_2}'}{P_2 \Par R}}
							{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
							{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{n_2}'''}{P_2' \Par R}}
						\]
					%
						\noi Furthermore, from~\eqref{lem:wbc_is_cong6} we conclude that 
					%
						\[
							\horel{\Gamma}{\Delta_1'' \cat \Delta_3}{\newsp{\widetilde{n_1}''}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}} \Par R}}
							{\ \mathcal{S}\ }
							{\Delta_2'' \cat \Delta_3}{\newsp{\widetilde{n_2}''}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}} \Par R}}
						\]
					for all $Q$ with $x \in \fv{Q}$, as desired.
				\end{enumerate}
	%%%%%%%%%%%%%%%
	% Case 2
	%%%%%%%%%%%%%%%

		\item Suppose that $\ell$ originates in $R$:
			%
				\[
					\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
					{\by{\ell}}
					{\Delta_1 \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1 \Par R'}}
				\]
				\noi This case is also divided into three sub-cases:

				\begin{enumerate}[i.]
			%
					\item Sub-case 	$\ell \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$: From the LTS we infer that 
							\[
								\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
							\]
						for some $\Delta_3'$, which in turn implies
							\begin{eqnarray*}
								\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
								{\by{\ell}}
								{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}'}{P_2 \Par R'}}
							\end{eqnarray*}
						Now, from the definition of $\mathcal{S}$ we may obtain the desired conclusion:
							\[
								\horel{\Gamma}{\Delta_1 \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1 \Par R'}}
								{\ \mathcal{S}\ }
								{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}'}{P_2 \Par R'}}
							\]

				\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q}}$:
					From the LTS we infer that:
						\begin{equation}
						\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
								\label{lem:wbc_is_cong7}
						\end{equation}
						for some $\Delta_3'$. We then have that 
						\begin{equation}
	\Gamma; \emptyset; \Delta_3'' \proves \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}} \hastype \Proc
								\label{lem:wbc_is_cong8}
						\end{equation}
						for some $\Delta_3''$ and for all $R_1$ with $\set{x} = \fv{R_1}$. Now, from~\eqref{lem:wbc_is_cong7} we obtain that
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}'}{P_2 \Par R}}{\by{\ell}}{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}}{P_2 \Par R'}}
						\]
						Then, from~\eqref{lem:wbc_is_cong8} and the definition of $\mathcal{S}$ we obtain that						\[
							\mhorel{\Gamma}{\Delta_1 \cat \Delta_3''}{\newsp{\widetilde{m_1}}{P_1 \Par \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}}}}
							{\ \mathcal{S}\ }
							{\Delta_2 \cdot \Delta_3''}{}{\newsp{\widetilde{m_2}}{P_2 \Par \newsp{\widetilde{m}'}{R' \Par R_1 \subst{\abs{\widetilde{x}}{Q}}{x}}}}
						\]
						 for all $R_1$ with $x \in \fv{R_1}$, as desired. \\

				\item	Sub-case $\ell = \news{\widetilde{mm}} \bactout{n}{\widetilde{m}}$: Similarly as above, 
						from the typed LTS we infer that:
					\begin{equation}
					\horel{\Gamma}{\Delta_3}{R}{\by{\ell}}{\Delta_3'}{R'}
							\label{lem:wbc_is_cong9}
							\end{equation}
							for some $\Delta_3'$. We then have that 
				\begin{equation}
				\Gamma; \emptyset; \Delta_3'' \proves \newsp{\widetilde{m}'}{R' \Par Q \subst{\widetilde{m}}{\widetilde{x}}} \hastype \Proc
							\label{lem:wbc_is_cong10}
					\end{equation}
					 for all $Q$ with $\set{\widetilde{x}} = \fv{Q}$, for some $\Delta_3''$.
				Now, from~\eqref{lem:wbc_is_cong9}, we obtain that
					\[
						\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}{\by{\ell}}{\Delta_2 \cat \Delta_3'}{\newsp{\widetilde{m_2}}{P_2 \Par R'}}
					\]
					Then, from~\eqref{lem:wbc_is_cong10} and the definition of $\mathcal{S}$ we obtain
					\[
						\mhorel{\Gamma}{\Delta_1 \cat \Delta_3''}{\newsp{\widetilde{m_1}}{P_1 \Par \newsp{\widetilde{m}}{R' \Par Q \subst{\widetilde{m}'}{\widetilde{x}}}}}
						{\ \mathcal{S}\ }
						{\Delta_2 \cat \Delta_3''}{}{\newsp{\widetilde{m_2}}{P_2 \Par \newsp{\widetilde{m}'}{R' \Par Q \subst{\widetilde{m}}{\widetilde{x}}}}}
					\]
					 for all $Q$ with $\set{\widetilde{x}} = \fv{Q}$, as required.
			\end{enumerate}

	%%%%%%%%%%%%%%%
	% Case 3
	%%%%%%%%%%%%%%%

	\item We finally suppose that $\ell$ originates from the interaction between $P_1$ and $R$:
			\[
				\horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
				{\by{\tau}}
				{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1' \Par R'}}
			\]
			for some $\Delta_1', \Delta_3'$. We then have that 
			$$\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell_1}}{\Delta_1'}{P_1'}$$
			and 
			\begin{equation}
			\horel{\Gamma}{\Delta_3}{R}{\by{\ell_2}}{\Delta_3}{R'}
			\label{lem:wbc_is_cong11}
			\end{equation}
			with $\ell_1 \asymp \ell_2$ (cf. \mydefref{def:dualact}). 
			
			This case is divided into three sub-cases:

			\begin{enumerate}[i.]

				\item	$\ell_1 \notin \set{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$: Then the transition from $P_1$
						implies
					%
						\begin{eqnarray}
%							\horel{\Gamma}{\Delta_3}{R}{\by{\dual{\ell}}}{\Delta_3}{R'}
%							\label{lem:wbc_is_cong11} \\
							\horel{\Gamma}{\Delta_2}{P_2}{\By{\hat{\ell_1}}}{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong12}\\
							\horel{\Gamma}{\Delta_1'}{P_1'}{\wbc}{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong13}
						\end{eqnarray}
for some $\Delta_2'$. From~\eqref{lem:wbc_is_cong11} and~\eqref{lem:wbc_is_cong12} we obtain
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3'}{\newsp{\widetilde{m_2}'}{P_2' \Par R'}}
						\]
					%
						Then, from~\eqref{lem:wbc_is_cong13} and the definition of  $\mathcal{S}$  we obtain the desired conclusion:
						\[
							\horel{\Gamma}{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}'}{P_1' \Par R'}}
							{\ \mathcal{S}\ }
							{\Delta_2' \cat \Delta'_3}{\newsp{\widetilde{m_2}'}{P_2' \Par R'}}
						\]

				\item   $\ell_1 = {\news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}}$: Then we have the transition
						$$\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}} \bactout{n}{\abs{\widetilde{x}}{Q_1}}}}{\Delta_1'}{P_1'}$$
						for some $\Delta'_1$, 
						which implies
					%
						\begin{eqnarray}
							 & \horel{\Gamma}{\Delta_3}{R}
							{\by{\bactinp{n}{\abs{\widetilde{x}} {Q_1}}}}{\Delta_3'}
							{R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}
							\label{lem:wbc_is_cong14}\\
							 & \horel{\Gamma}{\Delta_1 \cat \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
							{\by{\tau}}{\Delta_1' \cat \Delta_3'}
							{\newsp{\widetilde{m_1}''}{P_1' \Par R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
						\end{eqnarray}
						for some $\Delta_1'$ and $\Delta'_3$.
				In turn, the output transition from $P_1$ implies the existence of $\Delta_2'$, $Q_2$, $P'_2$ such that
							\begin{eqnarray}
							&  \horel{\Gamma}{\Delta_2}{P_2}
							{\By{\news{\widetilde{m_2}} \bactout{n}{\abs{\widetilde{x}}{Q_2}}}}
							{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong15}\\
							&  \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par Q \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
							{\ \wbc\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par Q \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
							\label{lem:wbc_is_cong16}
						\end{eqnarray}
						 for all $Q$ with $\set{x} = \fv{Q}$, and for some $\Delta_1''$ and $\Delta_2''$.
						From~\eqref{lem:wbc_is_cong14} %and the Substitution Lemma~(\lemref{l:subst})
						we obtain 
						\[
							\horel{\Gamma}{\Delta_3}{R}{\by{\bactinp{n}{\abs{\widetilde{x}} {Q_2}}}}{\Delta_3''}{R' \subst{\abs{\widetilde{x}}{Q_2}}{x}}
						\]
						%\dk{(prove that $\forall V, R \by{\bactinp{s}{V}} R'\subst{V}{x}$)}
						for some $\Delta_3''$, which may be combined with~\eqref{lem:wbc_is_cong15} to obtain
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3''}{\newsp{\widetilde{m_2}''}{P_2' \Par R' \subst{\abs{\widetilde{x}}{Q_2}}{x}}}
						\]
					%
						We conclude by setting $Q$ as $R'$  in~\eqref{lem:wbc_is_cong16} so as to obtain:
					%
					%	\noi From~\eqref{lem:wbc_is_cong16} and the definition of $\mathcal{S}$ we get that
						\[
							\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par R' \subst{\abs{\widetilde{x}}{Q_1}}{x}}}
							{\ \mathcal{S}\ }{ \Delta_2''}
							{\newsp{\widetilde{m_2}'}{P_2' \Par R' \subst{\abs{\widetilde{x}}{Q_2}}{x}}}.
						\]
%				\newc{JP - I have revised the above case, please check.}
				
				\item $\ell_1 = {\news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}$. Then we have the transition
						$$\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{mm_1}} \bactout{n}{\widetilde{m_1}}}}{\Delta_1'}{P_1'}$$
					for some $\Delta_1'$, which implies 
						\begin{eqnarray}
							&  \horel{\Gamma}{\Delta_3}{R}
							{\by{\bactinp{n}{\widetilde{m_1}}}}
							{\Delta_3'}{R' \subst{\widetilde{m_1}}{\widetilde{x}}}
							\label{lem:wbc_is_cong24}\\
							&  \horel{\Gamma}{\Delta_1 \cdot \Delta_3}{\newsp{\widetilde{m_1}}{P_1 \Par R}}
							{\by{\tau}}
							{\Delta_1' \cdot \Delta_3'}{\newsp{\widetilde{m_1}''}{P_1' \Par R' \subst{m_1}{x}}}
							\nonumber 
							\end{eqnarray}
							for some $\Delta_3'$.
							In turn, the output transition from $P_1$ implies the existence of $\Delta_2'$, $P_2$, and $\widetilde{m_2}$ such that
							\begin{eqnarray}
							 & \horel{\Gamma}{\Delta_2}{P_2}
							{\By{\news{\widetilde{mm_2}} \bactout{n}{\widetilde{m_2}}}}
							{\Delta_2'}{P_2'}
							\label{lem:wbc_is_cong25}\\
							 & \horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par Q \subst{\widetilde{m_1}}{\widetilde{x}}}}
							{\ \wbc\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par Q \subst{\widetilde{m_2}}{\widetilde{x}}}}
							\label{lem:wbc_is_cong26}
						\end{eqnarray}
						 for all $Q$ with $\set{x} = \fv{Q}$, 
						 and for some $\Delta_1''$ and $\Delta_2''$.
						From~\eqref{lem:wbc_is_cong24} and the Substitution Lemma~(\mylemref{l:subst}) we obtain
						\[
							\horel{\Gamma}{\Delta_3}{R}{\by{\bactinp{n}{\widetilde{m_2}}}}{\Delta_3''}{R' \subst{\widetilde{m_2}}{\widetilde{x}}}
						\]
						%\dk{(prove that $\forall V, R \by{\bactinp{s}{V}} R'\subst{V}{x}$)}
						for some $\Delta_3''$, 
						which may be combined with~\eqref{lem:wbc_is_cong25} to obtain
						\[
							\horel{\Gamma}{\Delta_2 \cat \Delta_3}{\newsp{\widetilde{m_2}}{P_2 \Par R}}
							{\By{}}
							{\Delta_2' \cat \Delta_3''}{\newsp{\widetilde{m_2}''}{P_2' \Par R' \subst{\widetilde{m_2}}{\widetilde{x}}}}
						\]
					%
						We conclude by setting $Q$ as $R'$  in \eqref{lem:wbc_is_cong26}:
					%
					%	\noi From~\eqref{lem:wbc_is_cong16} and the definition of $\mathcal{S}$ we get that
						\[
							\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P_1' \Par R' \subst{\widetilde{m_1}}{\widetilde{x}}}}
							{\ \mathcal{S}\ }
							{\Delta_2''}{\newsp{\widetilde{m_2}'}{P_2' \Par R' \subst{\widetilde{m_2}}{\widetilde{x}}}}
						\]
		\end{enumerate}
	\end{enumerate}
	\end{enumerate}
%	\newc{JP - I have revised above, please check.}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  CONG IS WB
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In order to prove \mylemref{lem:cong_is_wb} (i.e., $\cong\ \subseteq\ \hwb$), below we  follow
the technique developed in~\cite{Hennessy07} and
refined for session types in~\cite{KYHH2015,KY2015}.

%\jp{Below I slightly modify the structure of items.}

\begin{definition}[Definability]\myrm
	\label{app:def:definibility}
	Let $\Gamma; \emptyset; \Delta_1 \proves P \hastype \Proc$.
	A visible action $\ell$ is \emph{definable} whenever, given a fresh name $\suc$,
	there exists a (testing) process
	$$\Gamma; \emptyset; \Delta_2 \proves T\lrangle{\ell, \suc} \hastype \Proc$$
	such that:
	\begin{enumerate}[1.]
					\item	If $\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}$
						then, for some $\Delta_2'$, either
					\begin{enumerate}[a)]
						\item 
							$\ell \neq \news{\widetilde{m}}\bactout{n}{V}$ and $P \Par T\lrangle{\ell, \suc} \red P' \Par \bout{\suc}{\dual{n}} \inact$ 
							and \\
							$\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves P' \Par \bout{\suc}{\dual{n}} \inact \hastype \Proc$  
							\item 
							$\ell = \news{\widetilde{m}}\bactout{n}{V}$ and 
							$P \Par T\lrangle{\ell, \suc} \red
							\newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$
							and \\
							$\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves
							\newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par  \bout{\suc}{\dual{n}, V} \inact} \hastype \Proc$, for some fresh $t$.
							\end{enumerate}

			\item If $P \Par T\lrangle{\ell, \suc} \red Q$ with			
						$\Gamma; \emptyset; \Delta \proves Q \barb{\suc}$ then there exists a $P'$ such that
					
 $\horel{\Gamma}{\Delta_1}{P}{\Hby{\ell}}{\Delta_1'}{P'}$
						 and one of the following holds:  
							\begin{enumerate}[a)]
						\item $\ell \neq \news{\widetilde{m}}\bactout{n}{V}$ and $Q \scong P' \Par \bout{\suc}{\dual{n}} \inact$.
						\item  $\ell = \news{\widetilde{m}}\bactout{n}{V}$ and  $Q \scong \newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$, for some fresh $t$.
						\end{enumerate}
				 
						

%		\item	Let $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}, \bactinp{n}{\widetilde{m}}, \bactinp{n}{(\widetilde{x}) Q}}$.
%		
%			\begin{enumerate}[i.]
%				\item	If $\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}$
%				%		and
%				%		$\ell \in \set{\bactsel{n}{\ell}, \bactbra{n}{\ell}, \bactinp{n}{\widetilde{m}}, \bactinp{n}{\abs{\widetilde{x}}{Q}}}$
%						then:
%				%
%						\[
%							P \Par T\lrangle{\ell, \suc} \red P' \Par \bout{\suc}{\dual{n}} \inact \textrm{ and }
%							\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves P' \Par \bout{\suc}{\dual{n}} \inact
%						\]
%
%				\item
%						If $P \Par T\lrangle{\ell, \suc} \red Q$ with			
%						$\Gamma; \emptyset; \Delta \proves Q \barb{\suc}$ then \\
%						$\horel{\Gamma}{\Delta_1}{P}{\Hby{\ell}}{\Delta_1'}{P'}$
%						and $Q \scong P' \Par \bout{\suc}{\dual{n}} \inact$.
%			\end{enumerate}
%%
% 		\item Let	(i) $\ell = \news{\widetilde{m}}\bactout{n}{V}$,
%					and (ii) fresh $t$%, and
%					%(iii) $\widetilde{m}'$ such that $ \widetilde{m}' \subseteq \widetilde{m}$
%
%			\begin{enumerate}[i.]
%				\item	If $\horel{\Gamma}{\Delta_1}{P}{\hby{\news{\widetilde{m}}\bactout{n}{V}}}{\Delta_1'}{P'}$
%						then:
%%
%						\begin{itemize}
%							\item $P \Par T\lrangle{\news{\widetilde{m}}\bactout{n}{V}, \suc} \red
%							\newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$
%							\item $\Gamma; \emptyset; \Delta_1' \cat \Delta_2' \proves
%							\newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par  \bout{\suc}{\dual{n}, V} \inact} \hastype \Proc$
%						\end{itemize}
%
%				\item	If $P \Par T\lrangle{\news{\widetilde{m}}\bactout{n}{V}, \suc} \red Q$
%						with $\Gamma; \emptyset; \Delta \proves Q \barb{\suc}$ then 
%						\begin{itemize}
%							\item $\horel{\Gamma}{\Delta_1}{P}{\Hby{\news{\widetilde{m}}\bactout{n}{V}}}{\Delta_1'}{P'}$
%							\item $Q \scong \newsp{\widetilde{m}}{P' \Par \htrigger{t}{V} \Par \bout{\suc}{\dual{n}, V} \inact}$
%						\end{itemize}
%			\end{enumerate}
%			\JP{I have modified this definition to make it clearer, please check; the old one is commented.}
	\end{enumerate}	
%
\end{definition}

We first show that every visible action $\ell$ is definable.

\begin{lemma}[Definability]
	\label{lem:definibility}
	Every visible action $\ell$ is definable.
\end{lemma}

\begin{proof}
	Let $\suc$ be a fresh name. We define $T\lrangle{\ell, \suc}$ as follows:
	\begin{eqnarray*}
		T\lrangle{\bactinp{n}{V}, \suc} &=&
		\bout{\dual{n}}{V} \bout{\suc}{\dual{n}} \inact
		\\
		T\lrangle{\bactbra{n}{l}, \suc} &=&
		\bsel{\dual{n}}{l} \bout{\suc}{\dual{n}} \inact
		\\
%		T\lrangle{\news{\widetilde{m}} \bactout{n}{\widetilde{m}}, \suc} &=&
%		\binp{\dual{n}}{\widetilde{y}} (\hotrigger{t}{x}{s}{\widetilde{y}} \Par \bout{\suc}{\dual{n}, \widetilde{y}} \inact)
%		\\
%		T\lrangle{\news{\widetilde{m}} \bactout{n}{\abs{\widetilde{x}}{Q}}, \suc} &=&
%		\binp{\dual{n}}{y} (\hotrigger{t}{x}{s}{\abs{\widetilde{x}}{(\appl{y}{\widetilde{x}}})} \Par \bout{\suc}{\dual{n}, y} \inact)
%		\\
		T\lrangle{\news{\widetilde{m}} \bactout{n}{V}, \suc} &=&
		\binp{\dual{n}}{y} (\htrigger{t}{y} \Par \bout{\suc}{\dual{n}, y} \inact)
		\\
		T\lrangle{\bactsel{n}{l}, \suc} &=&
		\bbra{\dual{n}}{l: \bout{\suc}{\dual{n}} \inact), l_i: \newsp{a}{\binp{a}{y} \bout{\suc}{\dual{n}} \inact}}_{i \in I}
	\end{eqnarray*}
Consider the process 
	\[
		\Gamma; \emptyset; \Delta \proves P \hastype \Proc
	\]
	%
	\noi	It is straightforward to do a case analysis
			on all actions $\ell$ such that
			\[
				\Gamma; \emptyset; \Delta \proves P \hby{\ell} \Delta' \proves P'
			\]
			to show that $\ell$ is definable.
%	\noi it is straightforward to verify that $\forall \ell$, $\ell$ is definable.
%\JP{We need to show one case..., }
	\qed
\end{proof}

We rely on the following auxiliary result:

%\jp{Here again I think that the closure should not mention environments in the  LHS.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  EXTRUSION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{lemma}[Extrusion]\rm
	\label{lem:extrusion}
	Let $P$ and $Q$ be processes, and let $\suc$ be a fresh name. 
	If 
	\[
		\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}{\cong}{\Delta_2}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}}
	\]
	with 
	 $\set{\widetilde{m_1}}= \fn{V_1}$ and $\set{\widetilde{m_2}} = \fn{V_2}$
	then there exist $\Delta_1$ and $\Delta_2$ such that
	\[
		\horel{\Gamma}{\Delta_1}{P}{\cong}{\Delta_2}{Q}.
	\]
%	\JP{I have modified the statement $\widetilde{m_1}$ instead of ${m_1}$, is this correct?}
\end{lemma}

\begin{proof}
	\noi Let $\mathcal{S}$ be a relation defined as:
%
	\begin{eqnarray*}
		\mathcal{S}	&=&
					\set{(\Gamma; \es; \Delta_1 \proves P \hastype \Proc\ ,\ \Gamma; \es; \Delta_2 \proves Q \hastype \Proc) \setbar \\
				& &	\qquad \horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}
					{\cong}{\Delta'_2}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}},\\
				&&   \qquad \land~ m_1 \in \fn{V_1} \land m_2 \in\fn{V_2} ~~}
	\end{eqnarray*}
%
	\noi We show that $\mathcal{S}$ is a reduction-closed, barbed congruence.


	\begin{enumerate}[I.]
		\item	{\bf Reduction-closed:} The reduction  $P \red P'$
				implies
				\[
					\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
					\red
					\newsp{\widetilde{m_1}}{P' \Par \bout{\suc}{\dual{n}, V_1} \inact}
				\]
				which, due to freshness of $\suc$, in turn implies
				\[
					\newsp{\widetilde{m_1}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}
					\red^{*}
					\newsp{\widetilde{m_1}}{Q' \Par \bout{\suc}{\dual{n}, V_2} \inact}
				\]
				Therefore, $Q \red^{*} Q'$. Furthermore,
				\[
					\newsp{\widetilde{m_1}}{P' \Par \bout{\suc}{\dual{n}, V_1} \inact} \cong 
					\newsp{\widetilde{m_1}}{Q' \Par \bout{\suc}{\dual{n}, V_2} \inact}
				\]
				that implies
				\[
					\Gamma; \Delta_1'' \proves P'\ S\ \Delta_2'' \proves  Q'
				\]
				as required.

	\item	{\bf Barb Preserving:} Suppose $\Gamma; \es; \Delta_1 \proves P \barb{m}$. We analyse three cases, depending on the nature of $m$:
			%
		    \begin{enumerate}[i)]
				\item	Case $m \not= s$ ($m$ is not a session name): Then from
						$\Gamma; \es; \Delta_1 \proves P \barb{m}$
						we infer 
					%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
							\barb{m} 
						\]
					%
						for some $\Delta_1'$, which implies
						\[
							\Gamma; \es; \Delta_2' \proves
							\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}
							\Barb{m}.
						\]
						for some $\Delta_2'$.
						Then, from the freshness of $\suc$, we obtain 
						$\Gamma; \es; \Delta_2 \proves Q \Barb{m}$, as required.

				\item	Case: $m = s$ ($m$ is a session name) and $m \not= n$.
						The proof follows a similar reasoning as in the previous case.

				\item	Case: $m = s$ ($m$ is a session name) and $m = n$ and
						$\Gamma; \es; \Delta_1 \proves P \barb{n}$.
						In this case, 
						the fact that $n$ is a session name
						implies that $n, \dual{n} \in \dom{\Delta_1'}$.
						Therefore, from the definition
						of barbs (\mydefref{def:barbs}) we can infer that
						%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
							\not\barb{n}
						\]
						%
						because both endpoints of session $n$ are present in $\Delta_1'$.
						
						To observe the desired barb we exploit an additional test process, with an extra fresh name $\suc'$.
						We compose $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ with
						$\binp{\dual{\suc}}{x, y} T\lrangle{\ell, \suc'}$
						where $\subj{\ell} = x$. We then have 
						%
						\[
							\Gamma; \es; \Delta_1' \proves
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par
							\binp{\dual{\suc}}{x, y} T\lrangle{\ell, \suc'} \hastype \Proc
						\]
						%
						The definition of definability and the fact that $\Gamma; \es; \Delta_1 \proves P \barb{n}$
						imply that
						%
						\[
							\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par
							\binp{\dual{\suc}}{x,  {y}} T\lrangle{\ell, \suc'}
							\red^{*} 
							\newsp{\widetilde{m_1}}{P' \Par \bout{\suc'}{\dual{n}, V_1'} \inact}
						\]
						%
						\noi and furthermore
						%
						\[
							\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact} \Par
							\binp{\dual{\suc}}{x,  {y}} T\lrangle{\ell, \suc'}
							\red^{*} 
							\newsp{\widetilde{m_2}}{Q' \Par \bout{\suc'}{\dual{n}, V_2'} \inact}
						\]
						%
						\noi The last sequence of reductions implies that
						$\Gamma; \es; \Delta_2 \proves Q \Barb{n}$, as required.
				\end{enumerate}
    
		\item	{\bf Congruence:}
				The key case is congruence with respect to parallel composition.
				The other cases are easier due to the fact that we are
				working with closed process terms
				(i.e.~input congruence is straightforward on closed process terms).
				Let us define relation $\mathcal{C}$ as
				%
				\begin{eqnarray*}
					\mathcal{C} &=&
					\set{	(\Gamma; \es; \Delta_1 \cat \Delta_3 \proves P \Par R \hastype \Proc,
							\Gamma; \es; \Delta_2 \cat \Delta_3 \proves Q \Par R \hastype \Proc) \setbar
					\\
					& &	\qquad \forall R \textrm{ such that } \exists \Delta_3, \Gamma;\es; \Delta_3 \proves R \hastype \Proc \land\\
					& &	\qquad \horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}}
						{\cong}
						{\Delta_2'}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}}}
				\end{eqnarray*}
		%
				We want to show that $\mathcal{C} \subseteq \mathcal{S}$.
				To achieve that we show that $\mathcal{C}$ is a congruence with respect to parallel composition.
				%\JP{Perhaps we mean: ``We show that $\mathcal{C}$ is a reduction-closed barbed congruence? \dk{No we are only proving congruence in this case}}
				We distinguish two cases:
				\begin{enumerate}[i)]
					\item	Case $(\dual{n} \cup \fn{V_1} \cup \fn{V_2}) \cap \fn{R} = \es$: Then
from the contextual definition of $\cong$ we can deduce that
							 for all $\Gamma; \es; \Delta_3 \proves R \hastype \Proc$:
							%
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact} \Par R}
								{\cong}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact} \Par R}
							\]
							%
							Because of the requirement
							$(\dual{n} \cup \fn{V_1} \cup \fn{V_2}) \cap \fn{R} = \es$
							the above is structurally congruent to
							\[
								\horel{\Gamma}{\Delta_1' \cat \Delta_3}{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact \Par R}}
								{\cong}
								{\Delta_2' \cat \Delta_3}{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact \Par R}}
							\]
							The desired conclusion is then immediate from 
							 the definition of $\mathcal{C}$.

					\item	%Case $\widetilde{s} = \set{\dual{n}, \widetilde{m_1}} \cap \set{\dual{n}, \widetilde{m_2}} \subseteq \fn{R}$:
							Case $\widetilde{s} = \set{\dual{n}, \widetilde{m_1}} \cup \set{\dual{n}, \widetilde{m_2}} \cap \fn{R}$:
							Let $R^{\widetilde{y}}$ be such that $R = R^{\widetilde{y}}\subst{\widetilde{s}}{\widetilde{y}}$.


							From the contextual definition of $\cong$,
							given a fresh name $\suc'$, 
							 we can deduce that  for all $\Gamma; \es; \Delta_3' \proves \binp{\dual{\suc}}{\widetilde{y}} (R^{\widetilde{y}} \Par \bout{\suc'}{\widetilde{y}} \inact) \hastype \Proc$:
							%
							\[
								\mhorel{\Gamma}
								{\Delta_1''}
									{\newsp{\widetilde{m_1}}{P \Par \bout{\suc}{\dual{n}, V_1} \inact}
									\Par \binp{\dual{\suc}}{\widetilde{y}} (R^{\widetilde{y}} \Par \bout{\suc'}{\widetilde{y}} \inact)}
								{\cong}
								{\Delta_2''}{}
									{\newsp{\widetilde{m_2}}{Q \Par \bout{\suc}{\dual{n}, V_2} \inact}
									\Par \binp{\dual{\suc}}{\widetilde{y}} (R^{\widetilde{y}} \Par \bout{\suc'}{\widetilde{y}} \inact)}
							\]

%							From the definition of $\mathcal{C}$
%							we can deduce that $\forall R^{y_1}$ such that $R = R^{y_1}\subst{\widetilde{s}}{\widetilde{y_1}}$
%							and $\suc'$ fresh and $\set{\widetilde{y}} = \set{\widetilde{y_1}} \cup \set{\widetilde{y_2}}$:
							%
%							\[
%								\mhorel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}'}{P \Par \bout{\suc}{\dual{n}, \widetilde{m_1}''} \inact} \Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y_1} \Par \bout{\suc'}{\widetilde{y_2}} \inact)}
%								{\cong}
%								{\Delta_2''}{}{\newsp{\widetilde{m_2}'}{Q \Par \bout{\suc}{\dual{n}, \widetilde{m_2}''} \inact} \Par \binp{\dual{\suc}}{\widetilde{y}} (R^{y_1} \Par \bout{\suc'}{\widetilde{y_2}} \inact)}
%							\]
							%
							for some   $\Delta_1'', \Delta_2''$. Applying reduction closeness to the above pair we infer:
							%
							\[
								\horel{\Gamma}{\Delta_1''}{\newsp{\widetilde{m_1}}{P \Par R \Par \bout{\suc'}{\dual{n}, V_1} \inact}}{\cong}{\Delta_2''}{\newsp{\widetilde{m_2}}{Q \Par R \Par \bout{\suc'}{\dual{n}, V_2} \inact}}
							\]
						%
						\noi The conclusion then follows from the definition of $\mathcal{C}$.
	    \end{enumerate}
	\end{enumerate}
	\qed
\end{proof}

We can finally prove \mylemref{lem:cong_is_wb}:

\begin{lemma}\rm
	\label{app:lem:cong_is_wb}
	$\cong\ \subseteq\ \hwb$.
\end{lemma}

\begin{proof}
	\noi Let $\Re$ be the typed relation (we omit the typing information in the definition):
	\[
		\Re = \set{(P_1, P_2) \setbar \horel{\Gamma}{\Delta_1}{P_1}{\cong}{\Delta_2}{P_2}}
	\]

	We prove that $\Re$ is a higher-order bisimulation. 
	Suppose that 
	$\horel{\Gamma}{\Delta_1}{P_1}{\by{\ell}}{\Delta_1'}{P_1'}$; we must find a matching action from $P_2$.
	We distinguish two cases:
%% Case tau
\begin{enumerate}[1.]
	\item Suppose $\ell = \tau$. Then we have
			\[
				\horel{\Gamma}{\Delta_1}{P_1}{\by{\tau}}{\Delta_1'}{P_1'}
			\]
			\noi The result follows the reduction closeness property of $\cong$ since
			\[
				\horel{\Gamma}{\Delta_2}{P_2}{\By{\tau}}{\Delta_2'}{P_2'}
			\]
			for some $\Delta_2'$, and
			\[
				\horel{\Gamma}{\Delta_1'}{P_1'}{\cong}{\Delta_2'}{P_2'} \text{ implies } \horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}.
			\]

%% Case ell
	\item Suppose $\ell \neq \tau$. Then we choose test $T\lrangle{\ell, \suc}$ to obtain
		%
			\begin{eqnarray}
				\horel{\Gamma}{\Delta_1 \cat \Delta_3}{P_1 \Par T\lrangle{\ell, \suc}}{\cong}{\Delta_2 \cat \Delta_3}{P_2 \Par T\lrangle{\ell, \suc}}
				\label{lem:cong_is_wb2}
			\end{eqnarray}
			for some $\Delta_3$.
			\noi From this point on we distinguish two sub-cases:

			\begin{enumerate}[i.]
			%% Subcase i
				\item	Sub-case $\ell \in \set{\bactinp{n}{V_1}, \bactsel{n}{l}, \bactbra{n}{l}}$:  
				We then obtain
					%
						\begin{eqnarray*}
							&& P_1 \Par T\lrangle{\ell, \suc} \red P_1' \Par \bout{\suc}{\dual{n}} \inact \\
							&& \Gamma; \es; \Delta_1' \cat \Delta_3' \proves P_1' \Par \bout{\suc}{\dual{n}} \inact \barb{\suc}
						\end{eqnarray*}
					%
						for some $\Delta'_3$. From~(\ref{lem:cong_is_wb2}) we may now infer:
					%
						\begin{eqnarray*}
							&& \Gamma; \es; \Delta_2 \cat \Delta_3 \proves P_2 \Par T\lrangle{\ell, \suc} \Barb{\suc}
						\end{eqnarray*}
					%
						which, using \mylemref{lem:definibility}, implies
					%
						\begin{eqnarray*}
							&& \horel{\Gamma}{\Delta_2}{P_2}{\By{\ell}}{\Delta_2'}{P_2'}\\
							&& P_2 \Par T \lrangle{\ell, \suc} \red^{*} P_2' \Par \bout{\suc}{\dual{n}} \inact
						\end{eqnarray*}
					%
						\noi and
					%
						\[
							\horel{\Gamma}{\Delta_1' \cat \Delta_3'}{P_1' \Par \bout{\suc}{\dual{n}}\inact}{\cong}{\Delta_2' \cat \Delta_3'}{P_2' \Par \bout{\suc}{\dual{n}} \inact}
						\]
						We then apply \mylemref{lem:extrusion} to obtain the required result:
					%
						\[
							\horel{\Gamma}{\Delta_1'}{P_1'}{\cong}{\Delta_2'}{P_2'} \text{ implies } \horel{\Gamma}{\Delta_1'}{P_1'}{\ \Re\ }{\Delta_2'}{P_2'}
						\]

			%% Subcase ii
				\item	Sub-case $\ell = \news{\widetilde{m_1}} \bactout{n}{V_1}$:
Note that $T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc} = T\lrangle{\news{\widetilde{m_2}} \bactout{n}{V_2}, \suc}$.
The transition from $P_1$ can be then written as 
						\begin{eqnarray}
							\horel{\Gamma}{\Delta_1}{P_1}{\by{\news{\widetilde{m_1}} \bactout{n}{V_1}}}{\Delta_1'}{P_1'}
							\label{lem:cong_is_wb3}
						\end{eqnarray}
					%
						for some $\Delta_1'$. If we use the test process $T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc}$, then we may obtain:%~\ref{lem:cong_is_wb1} we get
					%
						\begin{eqnarray*}
							&& P_1 \Par T\lrangle{\news{\widetilde{m_1}} \bactout{n}{V_1}, \suc}
							\red
							\newsp{\widetilde{m_1}}{P_1' \Par \htrigger{t}{V_1}} \Par \bout{\suc}{\dual{n}, V_1} \inact \\
							&& \Gamma; \es; \Delta_1' \cat \Delta_3' \proves \newsp{\widetilde{m_1}}{P_1' \Par \htrigger{t}{V_1}} \Par \bout{\suc}{\dual{n}, V_1} \inact \barb{\suc}
						\end{eqnarray*}
					%
						for some $\Delta'_3$. Using~(\ref{lem:cong_is_wb2}) we may then infer
					%
						\[
							\Gamma; \es; \Delta_2 \cat \Delta_3 \proves P_2 \Par T\lrangle{\news{\widetilde{m_2}} \bactout{n}{V_2}, \suc} \Barb{\suc}
						\]
					%
						\noi which, using \mylemref{lem:definibility}, implies
					%
						\begin{eqnarray}
							&& \horel{\Gamma}{\Delta_2}{P_2}{\By{\news{\widetilde{m_2}} \bactout{n}{V_2}}}{\Delta_2'}{P_2'}
							\label{lem:cong_is_wb4}\\
							&& P_2 \Par T \lrangle{\ell, \suc} \red^{*} \newsp{\widetilde{m_2}}{P_2' \Par \htrigger{t}{V_2}} \Par \bout{\suc}{\dual{n}, V_2} \inact \nonumber
						\end{eqnarray}
					%
						for some $\Delta_2'$, and
					%
						\[
							\mhorel{\Gamma}{\Delta_1' \cat \Delta_3'}{\newsp{\widetilde{m_1}}{P_1' \Par \htrigger{t}{\abs{\widetilde{x}}{Q_1}}} \Par \bout{\suc}{\dual{n}, V_1} \inact}
							{\cong}
							{\Delta_2' \cat \Delta_3'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \htrigger{t}{\abs{\widetilde{x}}{Q_2}}} \Par \bout{\suc}{\dual{n}, V_2} \inact}
						\]
					%
						\noi We then apply \mylemref{lem:extrusion} to obtain:
					%
						\[
							\horel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1' \Par \htrigger{t}{V_1}}}{\cong}{\Delta_2'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \htrigger{t}{V_2}}}
						\]
					%
						\noi From the above result and the definition of $\Re$ we finally obtain:
						\[
							\mhorel{\Gamma}{\Delta_1'}{\newsp{\widetilde{m_1}}{P_1' \Par \htrigger{t}{V_1}}}
							{\ \Re\ }
							{\Delta_2'}{}{\newsp{\widetilde{m_2}}{P_2' \Par \htrigger{t}{V_2}}}
						\]
						\noi as required.

%				\item	Sub-case $\ell = \news{\widetilde{s}} \bactout{n}{\widetilde{m}}$:
%
%						\noi Follows similar arguments as the previous case.
			\end{enumerate}
\end{enumerate}
	\qed
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Proof of the main theorem
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\begin{theorem}[Concidence]\label{app:thm:coincidence} We have:
%	\begin{enumerate}
%		\item	$\wbc\ =\ \hwb$.
%		\item	$\wbc\ =\ \cong$.
%	\end{enumerate}
%\end{theorem}
%
%\begin{proof}
%	\noi	\lemref{app:lem:wb_eq_wbf} proves $\hwb\ =\ \fwb$.
%			\lemref{app:lem:cong_is_wb} proves $\cong\ \subseteq\ \hwb$.
%			\lemref{app:lem:wb_is_wbc} proves $\hwb\ \subseteq\ \wbc$.
%			\lemref{app:lem:wbc_is_cong} proves $\wbc\ \subseteq\ \cong$.
%			From the above results, we conclude $\cong\ \subseteq\ \hwb\ =\ \fwb\ \subseteq\ \wbc\ \subseteq\ \cong$. 
%			\qed
%\end{proof}



