% !TEX root = ../journal16kpy.tex
\section{Expressiveness Results}
\label{app:proofs}

\noi
In this section we give the proofs for the expressiveness
results stated in~\secref{sec:positive} and~\secref{sec:extension}.
Proving precise encodings entails proving type preservation, operational correspondence, and 
full abstraction (cf.\,\defref{def:goodenc}). For operational correspondence, 
recall that we prove a stronger statement than \defref{def:ep}(3),
		as we %follow \defref{def:lopco}.
		consider both visible and internal actions.
For full abstraction, we rely on a notational convention:

\begin{notation}[Typed Relations]
For the sake of readability, when describing typed relations we shall omit typing information for pairs of processes, which is usually clear from the context. This way, e.g., in the proof of
\propref{app:prop:fulla_HOp_to_HO}  we write
	\[
		\Re = \set{(P_1, Q_1) \setbar \horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hwb}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}}
	\]
	instead of 
		\begin{align*}
		\Re = \set{(P_1, Q_1) & \setbar 
		\Gamma; \emptyset; \Delta_1 \proves P_1 \hastype \Proc
		~~\land~~ 
		\Gamma; \emptyset; \Delta_2 \proves Q_1 \hastype \Proc
		 \\ & \land~~
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hwb}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}}
	\end{align*}
	\end{notation}


%For the purpose of proving Operational Correspondence
%in this section we prove a stronger result than the result
%suggested in \defref{def:ep}(2). We state the
%requirements below.
%
%\begin{definition}[Operational Correspondence]\rm
%	\label{app:def:opc_strong}
%	Consider typed calculi
%	$\tyl{L}_1 = \calc{\CAL_1}{{\cal{T}}_1}{\hby{\ell_1}_1}{\wb_1}{\proves_1}$
%	and $\tyl{L}_2=\calc{\CAL_2}{{\cal{T}}_2}{\hby{\ell_2}_2}{\wb_2}{\proves_2}$.
%	Let $\mathcal{A}_i$ be the set of labels from relation $\hby{\ell_i}$
%	($i=1,2$) and let mapping $\mapa{\cdot} : \mathcal{A}_1 \to \mathcal{A}_2$.
%
%	We say that $\enco{\map{\cdot}, \mapt{\cdot}}: \tyl{L}_1 \to \tyl{L}_2$ is a
%	\emph{operational corresponce}
%	if it satisfies the property:
%	If $\Gamma; \emptyset; \Delta \proves_1 P \hastype \Proc$ then
%		\begin{enumerate}
%			\item	Completeness:
%				If  $\stytraargi{\Gamma}{\ell_1}{\Delta}{P}{\Delta'}{P'}{1}{1}$
%				then\\
%				$\exists Q, \Delta''$ s.t. 
%				(i)~$\wtytraargi{\mapt{\Gamma}}{\ell_2}{\mapt{\Delta}}{\map{P}}{\mapt{\Delta''}}{Q}{2}{2}$
%				(ii)~$\ell_2 = \mapa{\ell_1}$, 
%				and \\
%				(ii)~${\mapt{\Gamma}};{\mapt{\Delta''}}\proves_2 {Q}{\wb_2}{\mapt{\Delta'}}\proves_2 {\map{P'}}$.
%				
%			\item	Soundness:   
%				If  $\wtytraargi{\mapt{\Gamma}}{\ell_2}{\mapt{\Delta}}{\map{P}}{\mapt{\Delta'}}{Q}{2}{2}$
%				then \\ $\exists P', \Delta''$ s.t.  
%				(i)~$\stytraargi{\Gamma}{\ell_1}{\Delta}{P}{\Delta''}{P'}{1}{1}$
%				(ii)~$\ell_2 = \mapa{\ell_1}$, 
%				and \\
%				(ii)~${\mapt{\Gamma}};{\mapt{\Delta''}}\proves_2 {\map{P'}}{\wb_2}{\mapt{\Delta'}}\proves_2 {Q}$.
%		\end{enumerate}
%\end{definition}
%
%\begin{proposition}
%	Consider typed calculi
%	$\tyl{L}_1 = \calc{\CAL_1}{{\cal{T}}_1}{\hby{\ell_1}_1}{\wb_1}{\proves_1}$
%	and $\tyl{L}_2=\calc{\CAL_2}{{\cal{T}}_2}{\hby{\ell_2}_2}{\wb_2}{\proves_2}$.
%	Let $\mathcal{A}_i$ be the set of labels from relation $\hby{\ell_i}$
%	($i=1,2$) and let mapping $\mapa{\cdot} : \mathcal{A}_1 \to \mathcal{A}_2$.
%
%	If $\mapa{\tau} = \tau$ then
%	the requirements of \defref{app:def:opc_strong} imply
%	the requirements of \defref{def:ep}(2).
%\end{proposition}
%
%\begin{proof}
%	The proof is trivial by substituting the $\tau$ action
%	on labels $\ell_1$ and $\ell_2$ in \defref{app:def:opc_strong}
%	to get \defref{def:ep}(2).
%\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO HO
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Properties for encoding $\tyl{L}_{\HOp}$ into $\tyl{L}_{\HO}$}
\label{app:enc_HOp_to_HO}

%We repeat the statement of \propref{prop:typepres_HOp_to_HO},
%as in Page \pageref{prop:typepres_HOp_to_HO}:

In this section we prove \thmref{f:enc:hopitoho} (Page~\pageref{f:enc:hopitoho})
that requires that encoding
$\tyl{L}_{\HOp}$ into $\tyl{L}_{\HO}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated as \propref{prop:typepres_HOp_to_HO}
	and proven here as  \propref{app:prop:typepres_HOp_to_HO}.
	\item	Operational Correspondence, 
	stated as \propref{prop:op_corr_HOp_to_HO} and proven here as
	  \propref{app:prop:op_corr_HOp_to_HO}.
	\item	Full Abstraction, stated as \propref{prop:fulla_HOp_to_HO} and proven here as \propref{app:prop:fulla_HOp_to_HO}.
\end{itemize}

%% Type Preservation

\begin{proposition}[Type Preservation, \HOp into \HO]
	\label{app:prop:typepres_HOp_to_HO}
	Let $P$ be an \HOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} \proves \pmapp{P}{1}{f} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the   inference of $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. 
	We consider four interesting cases: 	
	\begin{enumerate}[1.]
		%%%% Output of (linear) channel
		\item	Case $P = \bout{k}{n}P'$. There are two sub-cases, depending on whether $n$ is a linear or a shared name.
			In the first sub-case $n = k'$ (output of a linear channel). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P' \hastype \Proc \quad \Gamma ; \emptyset ; \{k' : S_1\} \proves  k' \hastype S_1}{
					\Gamma; \emptyset; \Delta \cat k':S_1 \cat k:\btout{S_1}S \proves  \bout{k}{k'} P' \hastype \Proc}
			\]
			}
			Thus, by IH we have:
			$$
			\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmapp{P'}{1}{f} \hastype \Proc
			$$
			Let us write $U_1$
			to stand for $\lhot{\btinp{\lhot{\tmap{S_1}{1}}}\tinact}$.
			The corresponding typing in the target language is as follows:
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t1}
				\tree{
					\tree{
		%			\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} ; \set{x : \lhot{\tmap{S_1}{1}}} ; \emptyset \proves x  \hastype \lhot{\tmap{S_1}{1}}
								\qquad 
								\tmap{\Gamma}{1} ; \emptyset ; \set{k' : \tmap{S_1}{1}} \proves  k' \hastype \tmap{S_1}{1}
							}{
								\tmap{\Gamma}{1} ; \set{x : \lhot{\tmap{S_1}{1}}} ; k' : \tmap{S_1}{1} \proves \appl{x}{k'} \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1} ; \{x : \lhot{\tmap{S_1}{1}}\} ; k' : \tmap{S_1}{1} \cat z:\tinact \proves \appl{x}{k'} \hastype \Proc
						}
%						}{
%						\tmap{\Gamma}{1} \cat x : \lhot{\tmap{S_1}{1}} ; \emptyset ; k' : \tmap{S_1}{1} \cat z:\tinact \proves \appl{x}{k'} \hastype \Proc
%						}
					}{
						\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \cat z:\btinp{\lhot{\tmap{S_1}{1}}}\tinact \proves \binp{z}{x} (\appl{x}{k'}) \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{x} (\appl{x}{k'})} \hastype U_1
				}
			\end{eqnarray}
			\begin{eqnarray*}
				\tree{
					\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmapp{P'}{1}{f} \hastype \Proc
					\qquad
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{x} (\appl{x}{k'})} \hastype U_1 \ \eqref{prop:sesspnr_to_HO_t1}
				}{
					\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k':\tmap{S_1}{1} \cat k:\btout{U_1}\tmap{S}{1} \proves  \bbout{k}{\abs{z}{\binp{z}{x} (\appl{x}{k'})}} \pmapp{P'}{1}{f} \hastype \Proc
				}
			\end{eqnarray*}
%	
		%%%% Output of (shared) channel
			In the second sub-case, we have $n = a$ (output of a shared name). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma \cat a:\chtype{S_1}; \emptyset; \Delta \cat k:S  \proves
					P' \hastype \Proc \quad \Gamma \cat a:\chtype{S_1} ; \emptyset ; \emptyset \proves  a \hastype \chtype{S_1}
				}{
					\Gamma \cat a:\chtype{S_1} ; \emptyset; \Delta  \cat k:\bbtout{\chtype{S_1}}S \proves  \bout{k}{a} P' \hastype \Proc
				}
			\]
			}
			The typing in the target language is derived similarly as in the first sub-case. 
	
		%%%% Input of (linear) channel 
		\item	Case $P = \binp{k}{x}Q$. We have two sub-cases, depending on the type of $x$ (linear or shared name).
			In the first case, $x$ stands for a linear name.
			Then we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta  \cat k:S \cat x:S_1 \proves   Q \hastype \Proc
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btinp{S_1}S \proves  \binp{k}{x} Q \hastype \Proc
				}
			\]
			 }
			 Thus, by IH we have:
			 $$
			 \tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat x:\tmap{S_1}{1} \proves  \pmapp{Q}{1}{f}   \hastype \Proc
			 $$
			 Let us write $U_1$ to stand for $\lhot{(\btinp{\lhot{\tmap{S_1}{1}}}\tinact)}$.
			 The corresponding typing in the target language is as follows; we have three auxiliary derivations:
			{%\small
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t2}
				\tree{
					\tmap{\Gamma}{1}; \{x: U_1\};   \emptyset \proves x \hastype U_1
					\qquad
					\tmap{\Gamma}{1}; \emptyset;   s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves s \, \hastype  \btinp{\lhot{\tmap{S_1}{1}}} \tinact 
				}{
					\tmap{\Gamma}{1}; \{x: U_1\};    s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{x}{s}  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t3}
				\tree{
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \emptyset \proves   \inact  \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \dual{s}: \tinact\proves   \inact  \hastype \Proc
					}
					\quad 
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat  x:\tmap{S_1}{1} \proves \pmapp{Q}{1}{f}   \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}   \proves \abs{x} \pmapp{Q}{1}{f}   \hastype \lhot{\tmap{S_1}{1}}
					}
				}{
					\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves  \bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t4}
		 		\tree{
					\begin{array}{cl}
						\tmap{\Gamma}{1}; \{x: U_1\};   s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{x}{s}  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t2}
						\\
						\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact \proves
						\bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t3}
					\end{array}
				}{
				\begin{array}{r}
					\tmap{\Gamma}{1}; \{x: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact \qquad \\
					\proves \appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact  \hastype \Proc
			\end{array}
			}
			\end{eqnarray}
			}
%
Finally we have:
{%\small
			\begin{eqnarray*}
			 \tree{
				 \tree{
					\begin{array}{r}
					\tmap{\Gamma}{1}; \{x: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact \qquad \\
					\proves \appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact  \hastype \Proc
			\end{array} \quad \eqref{prop:sesspnr_to_HO_t4}
				}{
					\tmap{\Gamma}{1}; \{x: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact}  \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1}  \cat k:\btinp{U_1}\tmap{S}{1} \proves  \binp{k}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmapp{Q}{1}{f}}} \inact}  \hastype \Proc
			}
			\end{eqnarray*}
			 }
			 
			 In the second sub-case, $x$ stands for a shared name. Then we have the following typing in the source language:
			\[
			 \tree{
				\Gamma \cat x:\chtype{S_1} ; \emptyset; \Delta  \cat k:S \proves   Q \hastype \Proc
			 }{
				\Gamma ; \emptyset; \Delta  \cat k:\btinp{\chtype{S_1}}S \proves  \binp{k}{x} Q \hastype \Proc}
			 \]
			 The typing in the target language is derived similarly as in the first sub-case.	


%%% RECURSIVE VARIABLE 
		\item	Case $P_0 = \varp{X}$.
			Then we have the following typing in the source language:
%
			\[
				\underbrace{\,\Gamma' \cat \varp{X}: \Delta\,}_{\Gamma} \,;\, \es \,;\, \Delta\proves \varp{X} \hastype \Proc
			\]
			Let $\Delta = n_1: S_1, \ldots, n_m: S_m$, with $\dom{\Delta} = \tilde{n}$. 
			By \defref{d:enc:hopitoho}, we have that 
			$$
			 \tmap{\Gamma}{1} 
			=
\tmap{\Gamma' \cat \varp{X}:\{n_i:S_i\}_{1\leq i\leq m}}{1}  
=  
\tmap{\Gamma'}{1} \cat z_X:\shot{(\,\underbrace{\tmap{S_1}{1},\ldots,\tmap{S_m}{1}}_{\widetilde{T}},S^*)}
$$
where 
$S^* = \trec{t}{\btinp{\shot{(\widetilde{T},\vart{t})}} \tinact}$,
which is equivalent to 
$\btinp{\shot{(\widetilde{T},S^*)}} \tinact$.
%
By \figref{f:enc:hopi_to_ho}, 
$$\pmapp{\varp{X}}{1}{f} = 
\newsp{s}{\appl{z_X}{(\tilde{n}, s)} \Par \bout{\dual{s}}{z_X} \inact}$$ with $\tilde{n} = f(\rvar{X})$.
We shall show that 
$$
	\tmap{\Gamma'}{1}  \cat z_X:\shot{(\widetilde{T},S^*)} ;\, \es ;\, \tmap{\Delta}{1}
				\proves 
				\pmapp{\varp{X}}{1}{f} \hastype \Proc
$$
We first have two auxiliary derivations:
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t1}
				\tree{
					\tree{
					}{
						\tmap{\Gamma}{1} ;\, \es ;\, \es \proves z_X \hastype \shot{(\widetilde{T},S^*)}
					}
					~~ 
					\begin{array}{c}
						\tmap{\Gamma}{1} ;\, \es ;\, \{n_i: \tmap{S_i}{1} \} \proves n_i \hastype \tmap{S_i}{1} \\
						\tmap{\Gamma}{1}  ;\, \es ;\, \{s: S^* \} \proves s~ \hastype \btinp{\shot{(\widetilde{T},S^*)}} \tinact \\
					\end{array}
				}{
					\tmap{\Gamma}{1} ;\, \es ;\, \tmap{\Delta}{1} \cat s:\btinp{\shot{(\widetilde{T},S^*)}} \tinact
					\proves  
					\appl{z_X}{(\tilde{n}, s)} \hastype \Proc
				} 
			\end{eqnarray}
			and
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t2}
				\tree{
					\tree{
						\tmap{\Gamma}{1}   ;\, \es ;\,   \es \proves \inact \hastype \Proc
					}{
						\tmap{\Gamma}{1}  ;\, \es ;\,   \dual{s}: \tinact \proves \inact \hastype \Proc
					} 
					\quad
					\tmap{\Gamma}{1}  ;\, \es ;\, \es \proves z_X \hastype \shot{(\widetilde{T},S^*)}
					%\quad 
%					\tree{
%						\tree{
%							\begin{array}{c}
%								\Gamma ;\, \es ;\, \{x_i: S_i \} \proves x_i \hastype S_i \\
%								\Gamma ;\, \es ;\, \{z: S^*  \} \proves z\hastype S^*  \\
%								\Gamma ;\, \es ;\, \es \proves z_X \hastype \shot{\tilde{T}}  \\
%							\end{array}
%						}{
%							\Gamma  ;\, \es ;\,   \Delta_{\tilde{x}}, \, z:S^*
%							\proves 
%							 {\appl{z_X}{( \tilde{x}, z)}} \hastype \Proc
%						}
%					}{
%						\Gamma  ;\, \es ;\,   \es
%						\proves 
%						 \abs{(\tilde{x},z)}\,\,{\appl{z_X}{( \tilde{x}, z)}} \hastype \shot{\tilde{T}}
%					} 	
				}{
					\tmap{\Gamma}{1}   ;\, \es ;\,   \dual{s}: \btout{\shot{(\widetilde{T}, S^*)}}\tinact
					\proves 
					\bout{\dual{s}}{ z_X} \inact \hastype \Proc
				}
			\end{eqnarray}
We may now derive:
			\[
			\tree{
				\tree{
					\begin{array}{rclc}
						\tmap{\Gamma}{1}  ;\, \es ;\, \tmap{\Delta}{1} \cat s:\btinp{\shot{(\widetilde{T},S^*)}} \tinact
					& \proves  & 
					\appl{z_X}{(\tilde{n}, s)} \hastype \Proc
						& \eqref{prop:sessp_to_HO_t1}
						\\ 
						\tmap{\Gamma}{1}   ;\, \es ;\,   \dual{s}: \btout{\shot{(\widetilde{T}, S^*)}}\tinact
					& \proves &
					\bout{\dual{s}}{ z_X} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t2}
					\end{array}
				}{
					\tmap{\Gamma}{1}  ;\, \es ;\, 
					\tmap{\Delta}{1} \cat s:\btinp{\shot{(\widetilde{T},S^*)}} \tinact, \, 
					\dual{s}: \btout{\shot{(\widetilde{T}, S^*)}}\tinact
					\proves 
					\appl{z_X}{(\tilde{n}, s)} 
					\Par 
					\bout{\dual{s}}{z_X} \inact \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1}  ;\, \es ;\, \tmap{\Delta}{1}
				\proves 
				\newsp{s}{\appl{z_X}{(\tilde{n}, s)} \Par 
				\bout{\dual{s}}{z_X} 
				\inact} \hastype \Proc
			}
			\]
%	RECURSION
		\item	Case $P_0 = \recp{X}{P}$. Then we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat \varp{X}:\Delta ;\, \es ;\,  \Delta \proves P \hastype \Proc
				}{
					\Gamma  ;\, \es ;\,  \Delta \proves \recp{X}{P} \hastype \Proc
				}
			\]
			
			By \figref{f:enc:hopi_to_ho}, we have:
$$\pmapp{\recp{X}{P}}{1}{f} = 
\newsp{s}{\bbout{\dual{s}}{\abs{(\vmap{\tilde{n}}, y)} \,{\binp{y}{z_\X} \auxmapp{\pmapp{P}{1}{{f,\{\rvar{X}\to \tilde{n}\}}}}{{}}{\es}}} \inact 
		 \Par  \binp{s}{z_\X} \pmapp{P}{1}{{f,\{\rvar{X}\to \tilde{n}\}}}}
$$
We shall show that 
$$
\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta}{1} 
				\proves \pmapp{\recp{X}{P}}{1}{f} \hastype \Proc
$$
Below we write $R$
			to stand for $\pmapp{P}{1}{{f,\{\varp{X}\to \tilde{n}\}} }$
			and $\tilde{x} = \vmap{\fn{P}}$ (cf. \defref{d:auxmap}).
			Moreover, we write $\Delta_{\tilde{x}}$ to denote $\Delta$ after a renaming with names $\tilde{x}$.
%

We have two auxiliary derivations:
		\begin{eqnarray}
				\label{prop:sessp_to_HO_t5}
				\tree{
					\tree{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						\inact \hastype \Proc
					}{
						\tmap{\Gamma}{1};\, \es;\, \dual{s}:\tinact
						\proves
						\inact \hastype \Proc
					} 
					\quad 
					\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} \cat z_X: \shot{(\widetilde{T},S^*)};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}
								\proves
								{{\auxmapp{R}{{}}{\es}}}  \hastype \Proc
							}{
								\tmap{\Gamma}{1} \cat z_X: \shot{(\widetilde{T},S^*)};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}
								\cat
								y: \tinact
								\proves
								{{\auxmapp{R}{{}}{\es}}}  \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1} \cat  y: \btinp{\shot{(\widetilde{T},S^*)}}\tinact
							\proves
							{{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}}  \hastype \Proc
						}
					}{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}}  \hastype \shot{(\widetilde{T},S^*)}
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{(\widetilde{T},S^*)}}\tinact
					\proves
					\bbout{\dual{s}}{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}} \inact \hastype \Proc
				}
			\end{eqnarray}
		and
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t4}
				\tree{
					\tree{
						\tmap{\Gamma}{1}\cat z_X:\shot{(\widetilde{T},S^*)};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}
						\proves
						 R  \hastype \Proc
					}{
						\tmap{\Gamma}{1}\cat z_X:\shot{(\widetilde{T},S^*)};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}
						\cat s:\tinact 
						\proves
						 R  \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta}{1} \cat s:\btinp{\shot{(\widetilde{T},S^*)}}\tinact 
					\proves
					\binp{s}{z_X} R  \hastype \Proc
				}
			\end{eqnarray}
%
We then have:	
%
			\[
			\tree{
				\tree{
					\begin{array}{rclc}
\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{(\widetilde{T},S^*)}}\tinact
				&	\proves &
					\bbout{\dual{s}}{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t5}
												\\
						\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta}{1}
						\cat s:\btinp{\shot{(\widetilde{T},S^*)}}\tinact 
					& \proves &
					\binp{s}{z_X} R  \hastype \Proc
						& \eqref{prop:sessp_to_HO_t4}
					\end{array}
				}{
				\begin{array}{c}
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta}{1}
					\cat s:\btinp{\shot{(\widetilde{T},S^*)}}\tinact , \dual{s}:\btout{\shot{(\widetilde{T},S^*)}}\tinact
					\proves
					\\
					%\qquad \qquad
					\bbout{\dual{s}}{\abs{(\tilde{x}, y )} \,{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}} \inact 
					\Par 
					\binp{s}{z_X} R 
					\hastype \Proc
					\end{array}
				}
			}{
				\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta}{1} 
				\proves
				\newsp{s}{\binp{s}{z_X} R \Par 
				\bbout{\dual{s}}{\abs{(\tilde{x},y) } \,{\binp{y}{z_X} \auxmapp{R}{{}}{\es}}} \inact} \hastype \Proc
			}
			\]
	\end{enumerate}
%	\qed
\end{proof}


%%% Operational Correspondence

%We repeat the statement of
%\propref{prop:op_corr_HOp_to_HO}, 
%as in Page \pageref{prop:op_corr_HOp_to_HO}:

%We now state and prove a detailed version of the operational corresponce in \defref{app:def:opc_strong}.



We repeat the statement in Page~\pageref{prop:op_corr_HOp_to_HO}.
We use the mapping on actions $\mapa{\cdot}^{1}$ given in \defref{d:actmap1}.

\begin{proposition}[Operational Correspondence, \HOp into \HO]\rm
	\label{app:prop:op_corr_HOp_to_HO}
	\input{figures/op_corr_HOp_to_HO}
\end{proposition}


\begin{proof}

By transition induction. We consider parts (1) and (2) separately:

\noi \textbf{Part (1) - Completeness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
	%%  Output 
	\item	Subcase  1(a): $P =\bout{s}{n} P'$ and $\ell_1 = \bactout{s}{n}$ (the case $\ell_1 = \news{n}\bactout{s}{n}$ is similar). By assumption, $P$ is well-typed. 
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat s:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{n{:} S\}  \proves   n \hastype S }{
				\Gamma; \emptyset; \Delta_0 \cat n{:}S \cat s:\btout{S}S_1 \proves \bout{s}{n} P' \hastype \Proc}
		\]
%
		\noi for some $S, S_1, \Delta_0$.
		%such that $\Delta = \Delta_0 \cat k_1{:}T  \cat k:\btout{T}S$.
		We may then have the following transition:
%
		\[
			\stytra{\Gamma}{\ell_1}{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1 }{\bout{s}{n} P'}{\Delta_0 \cat s{:}S_1 }{P'}
		\]
%
		\noi The encoding of the source judgment for $P$ is as follows:
%
		\[
			\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1}^{1} \proves \pmapp{\bout{s}{n} P'}{1}{f} \hastype \Proc
		\]
%
		\noi which, using \defref{d:enc:hopitoho}, can be expressed as:
%
		\[
			\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0} 
			\cat n{:}\mapt{S}^{1} 
			\cat s: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} (\appl{x}{n})} } \pmapp{P'}{1}{f}
			\hastype \Proc
		\]
%
		\noi Now, $\mapa{\ell_1}^{1} = \bactout{s}{\abs{z}{\,\binp{z}{x} \appl{x}{n}}\, } $. 
		We may infer the following  transition for $\pmapp{P}{1}{f}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \mapt{\Delta}^{1} 
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} (\appl{x}{n})} } \pmapp{P'}{1}{f}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}} & \mapt{\Gamma}^{1};   \mapt{\Delta_0}^{1} 
			\cat s:  \tmap{S_1}{1}
			\proves  \pmapp{P'}{1}{f}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1};  \mapt{\Delta_0 \cat s:  S_1}^{1}
			\proves  \pmapp{P'}{1}{f}
			\hastype \Proc 
		\end{eqnarray*}
%
		\noi from which the thesis follows easily.

	\item	Subcase 1(c): $P = \binp{n}{x} P'$	and $\ell_1 = \bactinp{n}{m}$.
		By assumption $P$ is well-typed.
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat x:S \cat n:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{x: S\}  \proves   x\hastype S}{
				\Gamma; \emptyset; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc}
		\]
%
		for some  $S, S_1, \Delta_0$.
%		such that $\Delta = \Delta_0 \cat k:\btinp{T}S$.
		We may infer the following typed transition:
%
		\[
			\Gamma; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc
			\hby{\bactinp{n}{m}}
			\Gamma;  s \Delta_0 \cat  n:S_1 \cat m:S \proves   P'\subst{m}{x} \hastype \Proc
		\]
%
		The encoding of the source judgment for $P$ is as follows:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 \cat   n:\btinp{S}S_1 }^{1} \proves 
			\pmapp{P}{1}{f}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact}
			\hastype \Proc
		\end{eqnarray*}
%
		Now, 
		$\mapa{\ell_1}^{1} = \bactinp{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}\, }$
		and it is immediate to infer a 
		transition for $\pmapp{P}{1}{f}$:
%
		\begin{eqnarray*}
			&  & \mapt{\Gamma}^{1};  \mapt{ \Delta_0 }^{1} \cat   
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}}  & \mapt{\Gamma}^{1};   \mapt{ \Delta_0 }^{1} \cat   
			n:  \tmap{S_1}{1} \cat m:  \tmap{S}{1} \proves 
			 %\newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}{x}
			 R
			\hastype \Proc 
		\end{eqnarray*}
%
		where $R$ stands for the process 
		$\newsp{s}{(\appl{x}{s}) 
		\Par 
		\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}{x}$. 
		%$\newsp{s}{\appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}{X}$.
		We then have:
		\begin{eqnarray*}
		R & \hby{\btau} & \newsp{s}{\binp{s}{x} (\appl{x}{m})
							\Par 
							\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact} \\
		& \hby{\stau} &  \appl{(\abs{x}{\pmapp{P'}{1}{f}})}{m} \Par \inact \\
		& \hby{\btau} & \pmapp{P'}{1}{f}\subst{m}{x}
		\end{eqnarray*}
		and so the thesis follows.

		%%%%%%%%%%%
		%%  Recursion
		%%%%%%%%%%%

%	\item	Case $P =\recp{X}{P'}$ and $P = \varp{X}$.
%
%		It follows similar arguments with the previous cases
%		and uses Prop.~\ref{prop:op_corr_HOprec_to_HO} whenever necessary.
		
\end{enumerate}
%
\noi \textbf{Part (2) - Soundness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
		%%%%%%%%%%%
		%%  Output 
		%%%%%%%%%%%
	\item Subcase 2(a): $P = \bout{n}{m} P'$ and $\ell_2 = \bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$
	(the case $\ell_2 = \news{m}\bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$ is similar).
		%,  $\map{P}^{1} = \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1}$.
		Then 
		we have: % the following typed transition for $\map{P}^{1}$:
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} (\appl{x}{m})} } \pmapp{P'}{1}{f} 
			 \hastype \Proc
		\]
%
		for some $S, S_1$, and $\Delta_0$. 
		We may infer the following typed transition for $\pmapp{P}{1}{f}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} (\appl{x}{m})} } \pmapp{P'}{1}{f} 
			 \\
			%& & \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1} \hby{\bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}} \pmap{P'}{1}  \\
			&\hby{\ell_2}& 
			\mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \tmap{S_1}{1} 
			\proves  \pmapp{P'}{1}{f} 
		\end{eqnarray*}
%
		%with $\ell_2 = \bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}$.
		Now, in the source term $P$ we can infer the following transition: 
%
		\[
		\Gamma;\,  \Delta_0 \cat n:\btout{S} S_1 \proves \bout{n}{m} P'
		 \hby{\bactout{n}{m}} 
		 \Gamma;\,  \Delta_0 \cat n: S_1 \proves P'
		\]
%
		and thus the thesis follows easily by noticing that 
		$\mapa{\bactout{n}{m}}^{1} = \bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$.


		%%%%%%%%%%%
		%% Input
		%%%%%%%%%%%
	\item	Subcase 2(b): $P = \binp{n}{x} P'$ and $\ell_2 = \bactinp{n}{\abs{y}\binp{y}{x} (\appl{x}{m})}$.
		Then we have:
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{(\appl{x}{s})
			\Par 
			\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact}
			\hastype \Proc
		\]
%
		for some $S$, $S_1$, $\Delta_0$.
		We may infer the following typed transitions for $\pmapp{P}{1}{f}$:
%
		\begin{eqnarray*}
			& & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) 
							\Par 
							\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact} \\
			& \hby{\ell_2} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n:\tmap{S_1}{1}
			\cat m:\tmap{S_1}{1}
			\proves
			\newsp{s}{(\appl{x}{s}) 
				\Par 
				\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact} \subst{\abs{z}\binp{z}{x}\appl{x}{m}}{x} \\
			& = & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\newsp{s}{\appl{(\abs{z}\binp{z}{x}\appl{x}{m})}{s}
				\Par 
				\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact}  
				\\
			& \hby{\btau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\newsp{s}{\binp{s}{x}(\appl{x}{m}) 
				\Par 
				\bbout{\dual{s}}{\abs{x}{\pmapp{P'}{1}{f}}} \inact}  
				\\
			& \hby{\stau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\appl{(\abs{x}{\pmapp{P'}{1}{f}})}{m}   \\
			& \hby{\btau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\pmapp{P'}{1}{f}\subst{m}{x}   
		\end{eqnarray*}
%
		%with $\ell_2 = \bactinp{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}$.
		Now, in the source term $P$ we can infer the following transition, from which the thesis follows:
%
		\[
			\Gamma;\,  \Delta_0 \cat n:\btinp{S} S_1 \proves \binp{n}{x} P'
			\hby{\bactinp{n}{m}} 
			\Gamma;\,  \Delta_0 \cat n: S_1 \cat m: S \proves P'\subst{m}{x}
		\]
\end{enumerate}
%\qed
\end{proof}


%%%%%%%% Full Abstraction

%We repeat the statement of
%\propref{prop:fulla_HOp_to_HO}, 
%as in Page~\pageref{prop:fulla_HOp_to_HO}:

\noindent We now present the proof of the full abstraction result (\propref{prop:fulla_HOp_to_HO}).
In the proof, we rely heavily on the (detailed) labelled correspondence given above to define 
typed bisimulation relations up-to determinacy (\ref{lem:up_to_deterministic_transition}). 
Proving that these relations indeed satisfy the requirements is immediate for most cases, where we just follow the requirements of the labelled correspondence transitions.
The most interesting cases are the output cases, where the analyses should be done up-to the characteristic process.


\begin{proposition}[Full Abstraction, \HOp into \HO]\rm
	\label{app:prop:fulla_HOp_to_HO}
	$\horel{\Gamma}{\Delta_1}{P_1}{\hwb}{\Delta_2}{Q_1}$
	if and only if
	$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta_1}{1}}{\pmapp{P_1}{1}{f}}{\hwb}{\tmap{\Delta_2}{1}}{\pmapp{Q_1}{1}{f}}$.
\end{proposition}


\begin{proof}
	\noi For the right-to-left direction we show that the following relation $\Re$:
%
	\[
		\Re = \set{
		%(\horel{\Gamma}{\Delta_1}{P_1}{,}{\Delta_2}{Q_1}) 
		(P_1, Q_1) 
		\setbar \horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hwb}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}}
	\]
	is a higher-order bisimulation (\defref{d:hbw}).
%
Suppose $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$; 
we perform a case analysis on the shape of ${\ell}$, using 
the soundness direction of operational correspondence (cf.~\propref{app:prop:op_corr_HOp_to_HO}).
		The  most interesting case is when $\ell = \news{\tilde{m_1}'} \bactout{n}{m_1}$; the other cases are similar or easier.

\bigskip

	\noi Given $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}$, 
	we have that \propref{app:prop:op_corr_HOp_to_HO} implies:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi Now, combining this transition with the definition of $\Re$ we obtain both:
%
$$
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs11}
$$
%
	\noi and
$$
		\mhorel	{\mapt{\Gamma}^{1}}
			{\mapt{\Delta_1'}^{1}}
			{\newsp{\tilde{m_1}'}{\pmapp{P_2}{1}{f}  \Par \hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}} }}
			{\hwb}
			{\mapt{\Delta_2'}^{1}}
			{}
			{\newsp{\tilde{m_2}'}{\pmapp{Q_2}{1}{f} \Par \hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}
$$
	\noi Based on the encoding \pmapp{\cdot}{1}{f} (cf. \figref{f:enc:hopi_to_ho}), we may rewrite the above equality as follows:
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 
			\Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\hwb}{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi We may then observe that:
$$
		\mhorel{\Gamma}{\Delta_1'}{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}
		{\ \Re\ }{\Delta_2'}{}{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}
$$
	which can be rewritten to coincide with the output clause of higher-order bisimilarity (\defref{d:hbw}), as required:
$$
		\horel{\Gamma}{\Delta_1'}{\newsp{\tilde{m_1}'}{P_2 \Par \htrigger{t}{m_1}}}{\ \Re\ }{\Delta_2'}{}{\newsp{\tilde{m_2}'}{Q_2 \Par \htrigger{t}{m_2}}}
$$
This concludes the proof.
\bigskip

	\noi For the left-to-right direction, we consider the following relation:
%
	\[
		\Re = \set{
		%(\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{,}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}) 
		(\pmapp{P_1}{1}{f}, \pmapp{Q_1}{1}{f})
		\setbar \horel{\Gamma}{\Delta_1}{P_1}{\hwb}{\Delta_2}{Q_1}}
	\]
%
	We show that $\Re \subset \hwb$.
	Suppose $\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}$; 
we perform a case analysis on the shape of ${\ell}$, using 
the soundness direction of operational correspondence (cf.~\propref{app:prop:op_corr_HOp_to_HO}).
			We consider three cases:
	\begin{enumerate}[1.]

	\item Case: $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{P}},\, \bactinp{n}{\abs{x}{P}}}$.
	Then, we have that 
	\propref{app:prop:op_corr_HOp_to_HO} implies
		$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$. 
From this transition and the definition of $\Re$ we infer both:
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\ell}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs1}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\hwb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs2}
	\end{eqnarray}
%
	\noi From~\eqref{prop:HOp_to_HO:full_abs1} and \propref{app:prop:op_corr_HOp_to_HO} we obtain:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\ell}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\eqref{prop:HOp_to_HO:full_abs2} and the definition of $\Re$ we obtain, as required:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
	\item Case: $\ell = \news{\tilde{m}} \bactout{n}{\abs{x}{P}}$.
    We distinguish two sub-cases, depending on whether $\abs{x}{P}$ corresponds to the encoding of a name. 
    \begin{itemize}
    \item If $\abs{x}{P}$  does not correspond to the encoding of a name, then 
	by \propref{app:prop:op_corr_HOp_to_HO} we infer that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
	\]
%
	and the rest of the argument proceeds as in the previous case.

	\item If $\abs{x}{P}$ does correspond to the encoding of a name, then by \propref{app:prop:op_corr_HOp_to_HO} we infer that 
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}
	\]
%
	for some $m_1$. From the latter transition and the definition of $\Re$ we infer both:
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\tilde{m_2}'} \bactout{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs3}
	\end{eqnarray}
%
	\noi and
%
	\begin{eqnarray}
		& \Gamma; \Delta_1' & \proves \newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}} \nonumber \\
		& \hwb & \Delta_2' \proves \newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}
		\label{prop:HOp_to_HO:full_abs4}
	\end{eqnarray}
%
	\noi for some $m_2$. From~\eqref{prop:HOp_to_HO:full_abs3} and \propref{app:prop:op_corr_HOp_to_HO}, we obtain:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\eqref{prop:HOp_to_HO:full_abs4} and the definition of $\Re$ we obtain the following:
%
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\ \Re\ }{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi which coincides with the output clause of higher-order bisimilarity, as required.
	\end{itemize}

	\item Case: $\ell = \bactinp{n}{\abs{x}{P}}$. Also here we distinguish whether the received abstraction corresponds to the encoding of a name: 
	%Then we have two subcases following \propref{app:prop:op_corr_HOp_to_HO}:

	\begin{itemize} 
	\item If $\abs{x}{P}$ does not correspond to the encoding of a name, then the proof proceeds as in previous cases.
	
	\item If $\abs{x}{P}$ does correspond to the encoding of a name, then by 
	 \propref{app:prop:op_corr_HOp_to_HO} we infer that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\bactinp{n}{\abs{z}{ \binp{z}{x} (\appl{x}{m_1})}}}}{\mapt{\Delta_1''}^{1}} R %{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{m_1}}}{\Delta_1'}{P_2}
		\label{prop:HOp_to_HO:full_abs7}
\\
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\hby{\btau} \hby{\stau}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs8}
	\end{eqnarray}
%
%	\noi With the last transition happening on a restricted session channel.
%	From \dk{Lemma~\ref{lem:tau_inert}} we can conclude that
%	\begin{eqnarray}
%		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\wb}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
%		\label{prop:HOp_to_HO:full_abs9}
%	\end{eqnarray}
%
	\noi From \eqref{prop:HOp_to_HO:full_abs7} and the definition of $\Re$ we infer:
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs5}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\hwb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs6}
	\end{eqnarray}
%
	\noi for some $m_2$. From~\eqref{prop:HOp_to_HO:full_abs5} and \propref{app:prop:op_corr_HOp_to_HO} we obtain:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\bactinp{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\eqref{prop:HOp_to_HO:full_abs6} and the definition of $\Re$ we obtain:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi If we consider result~\eqref{prop:HOp_to_HO:full_abs8} we obtain:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\hby{\btau}\hby{\stau}\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
	and then we may show that $\Re$ is a bisimulation up-to $\Hby{\stau}$,
	following \lemref{lem:up_to_deterministic_transition}. 
	\end{itemize}
	%\qed
\end{enumerate}
\end{proof}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO SESSP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Properties for encoding $\tyl{L}_{\HOp}$ into $\tyl{L}_{\sessp}$}
\label{app:enc:HOp_to_sessp}

In this section we prove \thmref{f:enc:hotopi}, in Page~\pageref{f:enc:hotopi}
that requires that encoding
$\tyl{L}_{\HOp}$ into $\tyl{L}_{\sessp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated as \propref{prop:typepres_HOp_to_p} and proven here as
	\propref{app:prop:typepres_HOp_to_p}.
	\item	Operational Correspondence, stated as \propref{prop:op_corr_HOp_to_p} 
	and proven here as \propref{app:prop:op_corr_HOp_to_p}.
	\item	Full Abstraction, stated as \propref{prop:fulla_HOp_to_p} and proven here 
	as \propref{app:prop:fulla_HOp_to_p}.
\end{itemize}

%We repeat the statement of \propref{prop:typepres_HOp_to_p},
%as in Page \pageref{prop:typepres_HOp_to_p}:

\begin{proposition}[Type Preservation, \HOp into \sessp]\rm
	\label{app:prop:typepres_HOp_to_p}
	Let $P$ be an \HOp process. \\
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$.
\end{proposition}


%\begin{proposition}[Type Preservation, Higher-Order into First-Order]
%Let $P$ be an  $\HO$ process. 
%If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
%			$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$. 
%\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
%	By induction on the structure of \HO process $P$.  \jp{TO BE ADJUSTED!}
We consider three representative cases:
	\begin{enumerate}[1.]

	%%%% Output of (linear) channel
		\item	Case $P = \bbout{k}{\abs{x}{Q}}P$. Then we have two possibilities, depending on the typing for $\abs{x}Q$.
			The first sub-case concerns a linear typing, and so  
			we have  in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta_1 \cat k:S  \proves  P \hastype \Proc
					\quad
					\tree{
						\Gamma ; \emptyset ; \Delta_2\cat x:S_1 \proves  Q \hastype \Proc
					}{
						\Gamma ; \emptyset ; \Delta_2 \proves  \abs{x}Q \hastype \lhot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
			
%			\[
%				\tree{
%					\Gamma; \emptyset; \Delta_1 \cat k:S  \proves  P \hastype \Proc
%					\quad
%					\tree{
%						\Gamma ; \emptyset ; \Delta_2\cat x:S_1 \proves  Q \hastype \Proc
%					}{
%						\Gamma ; \emptyset ; \Delta_2 \proves  \abs{x}Q \hastype \lhot{S_1}
%					}
%				}{
%					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
%				}
%			\]
%			
Following \figref{f:enc:ho_to_sessp},
we have 
$\pmap{\bbout{k}{\abs{x}{Q}} P}{2} = \newsp{a}{\bout{u}{a} (\pmap{P}{2} \Par \binp{a}{y} \binp{y}{x} \pmap{Q}{2})}$.
By IH we have:
			\begin{eqnarray*}
			\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2} \cat x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
									\\
									\tmap{\Gamma_}{2}; \es ; \tmap{\Delta_1}{2}\cat k:\tmap{S}{2} 
						  \proves  
						\pmap{P}{2}  \hastype \Proc
			\end{eqnarray*}
			Let $U_1 = \btinp{\tmap{S_1}{2}}\tinact $.
			We first have:
						\begin{eqnarray}
						\label{prop:HO_to_sessp_t00}
						\tree{
						\tmap{\Gamma}{2}; \es ; \es
										\proves 
										a \hastype \chtype{U_1}
						\qquad 
							\tree{
								\tree{
									\tree{
									}{
										\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2} \cat  x:\tmap{S_1}{2}
										\proves 
										\pmap{Q}{2} \hastype \Proc
									}
								}{
									\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2}\cat y:\tinact   \cat x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
								}
							}{
								\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2}\cat y: U_1 								\proves 
								\binp{y}{x}\pmap{Q}{2} \hastype \Proc
							} 			
						}{
							\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2}  
							\proves 
							\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \hastype \Proc
						} 
			\end{eqnarray}
			
			We then have:
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t01}
				\tree{
				\tree{
							\tmap{\Gamma}{2}; \es ; \es
										\proves 
										a \hastype \chtype{U_1}
						~~ 
				\tree{
					\begin{array}{rcl}
						\tmap{\Gamma}{2}; \es ; \tmap{\Delta_1}{2}\cat k:\tmap{S}{2} 
						& \proves &
						\pmap{P}{2}  \hastype \Proc
						\\
					\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2} 
					%\cat a:\btinp{\btinp{\tmap{S_1}{2}}\tinact}\tinact
					%\cat a:U_1
							& \proves &
							\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \hastype \Proc
						~~~ \eqref{prop:HO_to_sessp_t00}
					\end{array}
				}{
				\begin{array}{rl}
					\tmap{\Gamma}{2}; \es ; 
					\tmap{\Delta_1}{2}
					\cat \tmap{\Delta_2}{2}
					\cat k:\tmap{S}{2} 
					%\cat a:\btinp{\btinp{\tmap{S_1}{2}}\tinact}\tinact
					%\cat a: U_1
					\proves  \qquad \qquad \\
					\pmap{P}{2} \Par 
					\binp{a}{y}\binp{y}{x}\pmap{Q}{2}\hastype \Proc
					\end{array}
				}
				}
				{
					%			\begin{array}{r}
						\tmap{\Gamma}{2}; \es ; 
					\tmap{\Delta_1}{2}
					\cat \tmap{\Delta_2}{2}
					\cat k:\btout{\chtype{U_1}}\tmap{S}{2} 
					%\cat a:\btinp{\btinp{\tmap{S_1}{2}}\tinact}\tinact
					%\cat a:U_1
					\proves %\qquad \qquad \\ 
					\bout{k}{a}(
					\pmap{P}{2} \Par 
					\binp{a}{y}\binp{y}{x}\pmap{Q}{2}) \hastype \Proc
					%	\end{array}
				}
				}{
				\begin{array}{rl}
				\tmap{\Gamma}{2}\backslash a; \es ; 
					\tmap{\Delta_1}{2}
					\cat \tmap{\Delta_2}{2}
					\cat k:\btout{\chtype{U_1}}\tmap{S}{2} 
					%\cat a:\btinp{\btinp{\tmap{S_1}{2}}\tinact}\tinact
					%\cat a:U_1
					\proves \qquad \qquad \\ 
					\news{a}{(\bout{k}{a}(
					\pmap{P}{2} \Par 
					\binp{a}{y}\binp{y}{x}\pmap{Q}{2}))} \hastype \Proc
					\end{array}
				}
			\end{eqnarray}
			which concludes the proof for this sub-case. 
			
			
			===
			TO CHECK!
						In the second sub-case, $\abs{x}Q$ has a shared type. We have the following typing in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P \hastype \Proc
					\quad 
					\tree{
						\tree{
							\Gamma ; \emptyset ; \cat x:S_1 \proves  Q \hastype \Proc
						}{
							\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \lhot{S_1}
						}
					}{
						\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \shot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btout{\shot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
			
			the corresponding typing in the target language is as follows: 
%
			\begin{eqnarray*}
				\tmap{\Gamma_1}{2} & = & \tmap{\Gamma}{2} \cup \{a:\chtype{\btinp{\tmap{S_1}{2}}\tinact}\} \\
				\tmap{\Gamma_2}{2} & = & \tmap{\Gamma_1}{2} \cup \{\varp{X}:\tmap{\Delta_2}{2}\}
			\end{eqnarray*}
%
			Let  
			 $U_1 = \chtype{\btinp{\tmap{S_1}{2}}\tinact}$. Also, 
			let $(*)$ and $(**)$ stand for $\tmap{\Gamma_2}{2}; \es ; \es \proves a \hastype U_1$ and
			  $\tmap{\Gamma_2}{2}; \es ; \es \proves \varp{X} \hastype \Proc$, respectively. We first have two auxiliary derivations:
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t1}
				\tree{
					\tree{
						\tree{
							\tree{
								\tree{
									\tree{
									}{
										\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} \cat  x:\tmap{S_1}{2}
										\proves 
										\pmap{Q}{2} \hastype \Proc
									}
								}{
									\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}\cat y:\tinact\cat x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
								}
							}{
								\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}\cat y: \btinp{\tmap{S_1}{2}}\tinact
								\proves 
								\binp{y}{x}\pmap{Q}{2} \hastype \Proc
							} 
							\quad 
							\tree{
							}{
								(*)
							}
						}{
							\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
							\proves 
							\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \hastype \Proc
						} 
						\qquad \tree{
						}{
							(**)
						} 
						\quad
					}{
						\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
						\proves 
						\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X} \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
					\proves 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
and
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t2}
				\tree{
					\begin{array}{rcl}
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1}{2}\cat k:\tmap{S}{2} 
						& \proves &
						\pmap{P}{2}  \hastype \Proc
						\\
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
						& \proves &
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
						\qquad \eqref{prop:HO_to_sessp_t1}
					\end{array}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1\cat \Delta_2}{2}\cat k:\tmap{S}{2} 
					\proves 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
We now have:
			\[
				\tree{
					\tree{
						\begin{array}{rcl}
							\tmap{\Gamma_1}{2}; \es ; \es & \proves & a \hastype U_1
							\\
							\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1\cat \Delta_2}{2}\cat k:\tmap{S}{2} 
							& \proves & 
							\pmap{P}{2} \Par 
							\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t2}
						\end{array}
					}{
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1\cat \Delta_2}{2}\cat k:\bbtout{U_1}\tmap{S}{2} 
						\proves 
						\bout{k}{a}(\pmap{P}{2} \Par 
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{2}; \es ; \tmap{\Delta_1\cat \Delta_2}{2}\cat k:\bbtout{U_1}\tmap{S}{2} 
					\proves 
					\newsp{a}{\bout{k}{a}( 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))}} \hastype \Proc
				}
			\]
%

 
	
		\item	Case $P = \binp{k}{x} P$. Then there are two cases, depending on the type of $x$ (i.e., $\shot{S_1}$ or $\lhot{S_1}$). 
			In the first case,
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat x : \shot{S_1};\, \emptyset ;\, \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\shot{S_1}}S \proves  \binp{k}{x} P \hastype \Proc
				}
			\]
			Following \figref{f:enc:ho_to_sessp},
			the corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tree{}{\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc}
				}{
					\tmap{\Gamma}{2};\, \emptyset; \, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
			In the second case,  
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma;\, \{x : \lhot{S_1}\};\,   \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\lhot{S_1}}S \proves  \binp{k}{x} P \hastype \Proc
				}
			\]
%
			The corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc
				}{
					\tmap{\Gamma}{2};\, \emptyset;\, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
		\item	Case $P = \appl{x}{k}$. Also here we have two cases, depending on whether $X$ has linear or shared type.
			In the first case, $x$ is linear and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma ;\, \{x : \lhot{S_1}\};\,  \es \proves  X \hastype \lhot{S_1} \quad \Gamma; \es ; \{k:S_1\} \proves k \hastype S_1
				}{
					\Gamma;\, \{x : \lhot{S_1}\};\, k:S_1 \proves  \appl{x}{k} \hastype \Proc}
			\]
			Let us write
			$\tmap{\Gamma_1}{2}$ to stand for $\tmap{\Gamma}{2} \cat x:\chtype{\btout{\tmap{S_1}{2}}\tinact}$.
			The corresponding typing in the target language is as follows:
%
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t11}
				\tree{
					\tree{
						\tmap{\Gamma_1}{2};\, \es;\,  \es \proves  \inact \hastype \Proc
					}{
						\tmap{\Gamma_1}{2};\, \es;\,  \dual{s}:\tinact \proves  \inact \hastype \Proc
					}
					\quad 
						\tmap{\Gamma_1}{2};\, \es;\, \{k:\tmap{S_1}{2}\} \proves  k \hastype \tmap{S_1}{2} 
				}{
					\tmap{\Gamma_1}{2};\, \es;\,\, k:\tmap{S_1}{2} \cat  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves  \bout{\dual{s}}{k}\inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
				\tree{
					\tree{
						\begin{array}{c}
							\tmap{\Gamma_1}{2};\, \es;  k:\tmap{S_1}{2} \cat  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves
							\bout{\dual{s}}{k}\inact \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t11}
							\\
							\tmap{\Gamma_1}{2} ;\, \es ;\, \es \proves x \hastype \chtype{\btout{\tmap{S_1}{2}}\tinact}
						\end{array}
					}{
						\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2} \cat s:\btinp{\tmap{S_1}{2}}\tinact \cat \dual{s}:\btout{\tmap{S_1}{2}}\tinact
						\proves
						\bout{x}{s}\bout{\dual{s}}{k}\inact \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2} \proves  \news{s}{(\bout{x}{s}\bout{\dual{s}}{k}\inact)} \hastype \Proc
				}
	\]
%
			In the second case, $x$ is shared, and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat  x : \lhot{S_1} ;\,  \es ;\,  \es \proves  x \hastype \shot{S_1} \quad \Gamma; \es ; k:S_1 \proves k \hastype S_1
				}{
					\Gamma \cat x : \shot{S_1};\, \es ;\, k:S_1 \proves  \appl{x}{k} \hastype \Proc
				}
			\]
%
			The associated typing in the target language is obtained similarly as in the first case. %\qed
	\end{enumerate}
\end{proof}

%We repeat the statement of
%\propref{prop:op_corr_HOp_to_p}, 
%as in Page \pageref{prop:op_corr_HOp_to_p}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{2}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{2}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%	\begin{align*}
%		\mapa{(\nu \tilde{m})\bactout{n}{\abs{ x}{P}} }^{2} & \defeq \news{m} \bactout{n}{m}
%		&
%		\mapa{\bactinp{n}{\abs{ x}{P}} }^{2} & \defeq \bactinp{n}{m} \quad \quad m \text{ fresh}
%	\end{align*}
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}

%We now state and prove a detailed and extended version of the operational correspondence:
%in \defref{app:def:opc_strong}.

We repeat the statement in Page~\pageref{prop:op_corr_HOp_to_p}. 
Recall that we use the mapping on actions $\mapa{\cdot}^{2}$ given in \defref{d:actmap2}.

\begin{proposition}[Operational Correspondence, \HOp into \sessp]\myrm
	\label{app:prop:op_corr_HOp_to_p}
\input{figures/op_corr_HOp_to_p}
\end{proposition}


\begin{proof}
	\noi The proof proceeds by transition induction.
	We only give details for the proof of Part 1, as Part 2 proceeds straightforwardly.
%	We consider the two parts separately.
%
%	\noi \textbf{Part 1}. %Basic Step:
    We consider four representative sub-cases:
    \begin{enumerate}[1.]
	\item Case 1(a), with $\fs{Q} = \emptyset$. 
%	Subcase: $P= \bout{n}{\abs{x}{Q}} P'$ 
%	and also from \defref{d:enc:hopitopi}
%	we have that\\
%	$\pmap{P}{2} = \newsp{a}{\bout{n}{a} \pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}$
Then
		$\Gamma; \es; \Delta \proves P \hby{\bactout{n}{\abs{x}{Q}}}  \Delta' \proves P'$, 
		and so we infer
					\begin{eqnarray*}
		\tmap{\Gamma}{2};  \tmap{\Delta}{2} \proves \pmap{P}{2} &\hby{\news{a} \bactout{n}{a}}& \tmap{\Delta}{2} \proves \pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}
	\end{eqnarray*}
%
	\noi and from \defref{d:enc:hopitopi} we have 		$\mapa{\bactout{n}{\abs{x}{Q}}} = \news{a} \bactout{n}{a}$, 
as required.

	\item Case 1(a), with $\fs{Q} \neq \emptyset$. Then we have $P= \bout{n}{\abs{x}{Q}} P'$ 
and
	$$\pmap{P}{2} = \newsp{s}{\bout{n}{\dual{s}} \pmap{P'}{2} \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}}$$
	and the argument proceeds as in the previous case.

	\item Case 1(b), with with $\fs{Q} =  \emptyset$. 
%	Subcase $P = \binp{n}{x} P'$.
%\noi - From \defref{d:enc:hopitopi}
%	we have that
%	$\pmap{P}{2} = \binp{n}{x} \pmap{P'}{2}$
%
	Then
		$\Gamma; \es; \Delta \proves P \hby{\bactinp{n}{\abs{x}{Q}}} \Delta' \proves P' \subst{\abs{x}{Q}}{x}$
		and so we infer that
	\begin{equation*}
		\tmap{\Gamma}{2};  \tmap{\Delta}{2} \proves \pmap{P}{2} \by{\bactinp{n}{a}} \tmap{\Delta''}{2} \proves R \subst{a}{x}
	\end{equation*}
%
	\noi with $\mapa{\bactinp{n}{\abs{x}{Q}}}^{2} = \bactinp{n}{a}$.
%
	It remains to show that
%
	\begin{eqnarray*}
		\tmap{\Gamma}{2};  \tmap{\Delta'}{2} \proves \pmap{P' \subst{\abs{x}{Q}}{x}}{2} \fwb
		\tmap{\Delta''}{2} \proves \newsp{a}{R \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
which can be proven by structural induction on $P'$.
The most interesting case is when $P' = \appl{x}{m}$. We then have:
%
	\begin{eqnarray*}
		\pmap{\appl{x}{m} \subst{\abs{x}{Q}}{x}}{2} &=& \pmap{Q \subst{m}{x}}{2}\\
		\newsp{a}{R \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}} &=& \newsp{a}{\newsp{s}{ \bout{x}{s} \bout{\dual{s}}{m} \inact} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi The right-hand side process can evolve as follows:
%
	\begin{eqnarray*}
		\mhorel{\tmap{\Gamma}{2}}{\tmap{\Delta''}{2}}{\newsp{a}{\newsp{s}{ \bout{x}{s} \bout{\dual{s}}{m} \inact} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
		{\hby{\tau} \hby{\stau}}
		{\tmap{\Delta''}{2}}{}{\newsp{a}{\pmap{Q \subst{m}{x}}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
	\end{eqnarray*}
%
	\noi which is bisimilar with		$\pmap{Q \subst{m}{x}}{2}$ because $a$ is fresh.

	\noi An interesting inductive step case is parallel composition, i.e., $P' = P_1 \Par P_2$. We need to show:
%
	\begin{eqnarray*}
		&& \tmap{\Gamma}{2};   \tmap{\Delta'}{2} \proves \pmap{(P_1 \Par P_2) \subst{\abs{x}{Q}}{x}}{2} \fwb
		\tmap{\Delta''}{2} \proves \newsp{a}{\pmap{P_1 \Par P_2}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi We know that
%
	\begin{eqnarray*}
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_1}{2}}{\pmap{P_1\subst{\abs{x}{Q}}{x}}{2}}{&\fwb&}
		{\tmap{\Delta_1''}{2}}{\newsp{a}{\pmap{P_1}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}\\
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_2}{2}}{\pmap{P_2\subst{\abs{x}{Q}}{x}}{2}}{&\fwb&}
		{\tmap{\Delta_1''}{2}}{\newsp{a}{\pmap{P_2}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
	\end{eqnarray*}
%
	\noi and so we conclude immediately exploiting the fact that $\fwb$ is a congruence.

	\item Case 1(b), with $\fs{Q} \neq  \emptyset$. This case is similar to the previous one.
	\end{enumerate}

%\bigskip
%	\noi \textbf{Part 2.} Straightforward, following \defref{d:enc:hopitopi}.
%	We describe two representative cases:
%
%	\noi - Case $P = \bout{n}{\abs{x}{Q}} P'$
%%
%	\begin{eqnarray*}
%		\horel{\Gamma}{\Delta}{P}{&\hby{\bactout{n}{\abs{x}{Q}}}&}{\Delta'}{P'}\\
%		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}{& \hby{\news{a} \bactout{n}{a}}&}{\tmap{\Delta'}{2}}{\pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{s} \pmap{Q}{2}}
%	\end{eqnarray*}
%%
%	\noi as required.
%
%	\noi - Case $P = \binp{n}{x} P'$
%%
%	\begin{eqnarray*}
%		\horel{\Gamma}{\Delta}{P}{&\hby{\bactinp{n}{\abs{x}{Q}}}&}{\Delta'}{P' \subst{\abs{x}}{Q}}{x}\\
%		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}{& \hby{\bactinp{n}{a}}&}{\tmap{\Delta''}{2}}{\pmap{P'}{2} \subst{a}{x}}
%	\end{eqnarray*}
%%
%	\noi We now use a similar argumentation as the input case in Part 1 to prove that:
%%
%	\begin{eqnarray*}
%		\horel{\Gamma}{\Delta'}{P' \subst{\abs{x}{Q}}{x}}
%		{\fwb}
%		{\tmap{\Delta''}{2}}{\newsp{a}{\pmap{P'}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
%	\end{eqnarray*}
%%
%	%\qed
\end{proof}

\begin{proposition}[Full Abstraction, From \HOp to \sessp]\myrm
	\label{app:prop:fulla_HOp_to_p}
	Let $P_1, Q_1$ be \HOp processes.
	$\horel{\Gamma}{\Delta_1}{P_1}{\fwb}{\Delta_2}{Q_1}$
	if and only if
	$\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_1}{2}}{\pmap{P_1}{2}}{\fwb}{\tmap{\Delta_2}{2}}{\pmap{Q_1}{2}}$.
\end{proposition}

\begin{proof}
%	The proof for the soundness direction considers
%	closure that can be shown to be a bisimulation
%	following the soundness direction of Operational Correspondence
%	(\propref{prop:op_corr_HOp_to_p}). Whenever needed
%	the proof makes use of the $\tau$-inertness result
%	(\propref{lem:tau_inert}).

%	The proof for the completness direction also considers
%	a closure shown to be a bisimulation
%	up-to deterministic transition (\propref{lem:up_to_deterministic_transition})
%	following the completeness direction of Operational Correspondence
%	(\propref{prop:op_corr_HOp_to_p}).
%
	The proof follows directly from operational correspondence (\propref{app:prop:op_corr_HOp_to_p}).
	The different cases of the proposition are used to define
	bisimulation relation to prove the the right-to-left direction, and
	a bisimulation up-to determinate transition
	(\lemref{lem:up_to_deterministic_transition})
	to prove the
	left-to-right direction.

\bigskip

	\noi For the right-to-left direction, we show that the following relation:
	\[
		\Re = \set{
		%(\horel{\Gamma}{\Delta_1}{P}{,}{\Delta_2}{Q}) 
		(P,Q)
		\setbar \horel{\mapt{\Gamma}^{2}}{\mapt{\Delta_1}^2}{\pmap{P}{2}}{\fwb}{\mapt{\Delta_2}^2}{\pmap{Q}{2}}}
	\]
%
is a characteristic bisimilarity (\defref{d:fwb}).
%
Suppose $\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$; 
we perform a case analysis on the shape of ${\ell}$, using 
the soundness direction of operational correspondence (cf.~\propref{app:prop:op_corr_HOp_to_p}).
		The  most interesting case is when $\ell = \bactout{n}{\abs{x}{R_1}}$; the other cases follow
	the bisimulation game that is implied by \propref{app:prop:op_corr_HOp_to_p}.

	\noi Given $\Gamma_1; \Delta_1 \proves P \hby{\bactout{n}{\abs{x}{R_1}}} \Delta_1' \proves P'$, by 
\propref{app:prop:op_corr_HOp_to_p} (Part 1), we  infer that:
%
	\begin{eqnarray*}
		\mapt{\Gamma}^{2}; \mapt{\Delta_1}^{2} \proves \pmap{P}{2} \hby{\news{a} \bactout{n}{a_1: U}} \mapt{\Delta_1'}^{2} \proves \pmap{P'}{2} \Par \repl \bout{a_1}{y} \binp{y}{x} \pmap{R_1}{2}
	\end{eqnarray*}
%
	which implies, from the requirements of $\fwb$, both 
%
	\begin{eqnarray}
		\label{prop:fa_ho_sessp_1}
		\mapt{\Gamma}^{2}; \mapt{\Delta_2}^{2} \proves \pmap{Q}{2} \Hby{\news{a} \bactout{n}{a_2: U}} \mapt{\Delta_2'}^{2} \proves \pmap{Q'}{2} \Par \repl \bout{a_2}{y} \binp{y}{x} \pmap{R_2}{2}
	\end{eqnarray}
%
	and

	\mhorel	{\tmap{\Gamma}{2}}
		{\tmap{\Delta_1'}{2}}
		{\newsp{a_1}{\pmap{P'}{2} \Par \repl \binp{a_1}{y} \binp{y}{x} \pmap{R_1}{2} \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_1} \inact }}}
		{\fwb}
		{\tmap{\Delta_2'}{2}}
		{}
		{\newsp{a_2}{\pmap{Q'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2} \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_2} \inact } }}

	\noi Now, from~\eqref{prop:fa_ho_sessp_1} and  \propref{app:prop:op_corr_HOp_to_p} (Part 2), we infer that
	there exist $Q', R_2$ such that:
%
	\begin{eqnarray*}
		\Gamma_2; \Delta_2 \proves Q \Hby{\bactout{n}{\abs{x}{R_2}}} \Delta_2' \proves Q'
	\end{eqnarray*}
%
	By following the (deterministic) transitions from the latter pair of processes we obtain that:
	%
%	
%	\mhorel	{\mapt{\Gamma}}
%		{\mapt{\Delta_1'}}
%		{\pmap{P'}{2} \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_1} \inact }}
%		{\fwb}
%		{\mapt{\Delta_2'}}
%		{}
%		{\pmap{Q'}{2} \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_2} \inact } }
%
%	\noi so as to conclude that:  \jpc{I didn't understand this step: how/why can you get rid of the replicated processes?}
	$$
	\mhorel	{\Gamma}
		{\Delta_1'}
		{P' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_1} \inact }}
		{\Re}
		{\Delta_2'}
		{}
		{Q' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_2} \inact } }
	$$
	This suffices to conclude, because from the definition of $\pmap{\cdot}{2}$ (cf. \figref{f:enc:ho_to_sessp}) we have:
	\begin{eqnarray*}
		\pmap{P' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_1} \inact}}{2}  & = &
		\pmap{P'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2} \\ & & \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_2}} \inact
	\end{eqnarray*}
	(and similarly for $Q' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_2} \inact } $).
%\jpc{I didn't understand this step: rather than $R_1$, $R_2$ above you obtain some $R_3, R_4$ such that $R_3 =  \pmap{R_1}{2}$ and $R_4 =  \pmap{R_2}{2}$, right?}

\bigskip

	\noi For the left-to-right direction, we show that the relation:
	\[
		\Re = \set{ 
		%(\horel{\mapt{\Gamma}^{2}}{\mapt{\Delta_1}^2}{\pmap{P}{2}}{,}{\mapt{\Delta_2}^2}{\pmap{Q}{2}}) 
		(\pmap{P}{2}, \pmap{Q}{2})
		\setbar \horel{\Gamma}{\Delta_1}{P}{\fwb}{\Delta_2}{Q}}
	\]
%
	 is a characteristic bisimulation.
Suppose %$\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}$; 
$\stytra{\mapt{\Gamma}^{2}}{\ell}{\mapt{\Delta_1}^{2}}{\map{P}^{2}}{\mapt{\Delta_1'}^{2}}{R}$;
we need to exhibit a corresponding move from $\map{Q}^{2}$.
To this end, we perform a case analysis on the shape of ${\ell}$, using 
\propref{app:prop:op_corr_HOp_to_p} (Part 2).

\smallskip

One interesting case is when $\ell = \news{a_1}\bactout{n}{a_1}$ and 
$P = \bout{n}{\abs{x}{R_1}} P'$ with {$\fs{R_1} = \emptyset$}, for some $R_1, P'$; the other cases are similar or simpler. 
Given these assumptions, and considering \figref{f:enc:ho_to_sessp}, the transition from $\map{P}^{2}$ is as follows:
%	\noi Given $P = \bout{n}{\abs{x}{R_1}} P'$, we may then observe:
%	\begin{eqnarray*}
%		\Gamma; \Delta_1 \proves \bout{n}{\abs{x}{R_1}} P'
%		\hby{\bactout{n}{\abs{x}{R_1}}}
%		\Delta_1' \proves P'
%	\end{eqnarray*}
%%
%	so as to obtain the following from \propref{app:prop:op_corr_HOp_to_p} (Part 2):
%
$$
	\mhorel	{\tmap{\Gamma}{2}}
		{\tmap{\Delta_1}{2}}
		{\news{a_1}(\bout{n}{a_1} \pmap{P'}{2} \Par \repl \binp{a_1}{y} \binp{y}{x} \pmap{R_1}{2})}
		{\hby{\news{a}\bactout{n}{a_1}}}
		{\tmap{\Delta_1'}{2}}
		{}
		{\pmap{P'}{2} \Par \repl \binp{a_1}{y} \binp{y}{x} \pmap{R_1}{2}}
$$
Then, using 
\propref{app:prop:op_corr_HOp_to_p} (Part 2(a)), 
we may infer a transition from $P$:
$$\Gamma; \Delta_1 \proves \bout{n}{\abs{x}{R_1}} P'
		\hby{\bactout{n}{\abs{x}{R_1}}}
		\Delta_1' \proves P'$$
In turn, this transition, together with the definition of 
$\Re$, enable us to infer both:
	%
	\begin{eqnarray*}
		\Gamma; \Delta_2 \proves Q
		\Hby{\bactout{n}{\abs{x}{R_2}}}
		\Delta_2' \proves Q'
	\end{eqnarray*}
	%
	and
	$$
	\mhorel
		{\Gamma}
		{\Delta_1'}
		{P' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_1} \inact }}
		{\fwb}
		{\Delta_2'} 
		{}
		{Q' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_2} \inact }}
$$
for some $R_2$.
	Now, using this transition from $Q$ in combination with \propref{app:prop:op_corr_HOp_to_p} (Part 1(a)) we obtain:
%	
%	\mhorel	{\tmap{\Gamma}{2}}
%		{\tmap{\Delta_2}{2}}
%		{\pmap{Q}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2}}
%		{\Hby{\bactout{n}{a_2}}}
%		{\mapt{\Delta_2'}}
%		{}
%		{\pmap{Q'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2}}
	\begin{eqnarray*}
		\tmap{\Gamma}{2};   \tmap{\Delta_2}{2} \proves \pmap{Q}{2}
		\Hby{\news{a_2}\bactout{n}{a_2}}
		\Delta_2' \proves \pmap{Q'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2}
	\end{eqnarray*}
From the definition of $\Re$ (and the fact that the pair
	of mapped processes can observe only deterministic transitions) we may finally obtain:

	\mhorel	{\tmap{\Gamma}{2}}
		{\tmap{\Delta_1'}{2}}
		{\pmap{P'}{2} \Par \repl \binp{a_1}{y} \binp{y}{x} \pmap{R_1}{2} \Par \binp{t}{x} \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_1} \inact }}
		{\Re}
		{\tmap{\Delta_2'}{2}}
		{}
		{\pmap{Q'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2} \Par \binp{t}{x} \newsp{s}{\binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_2} \inact  }}

	\noi as required.
	This suffices, because
	\begin{eqnarray*}
		 \pmap{P' \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{R_1} \inact}}{2} & = &
		\pmap{P'}{2} \Par \repl \binp{a_2}{y} \binp{y}{x} \pmap{R_2}{2} \\
		&  & \Par \binp{t}{x} \newsp{s}{ \binp{s}{y} \mapchar{U}{y} \Par \bout{s}{a_2} \inact}
	\end{eqnarray*}
	(and similarly for $Q'$.)
%	\jpc{Why is the above pair sufficient to complete the proof - don't you need to get rid of the replicated server?}
\end{proof}




%\begin{proposition}\rm
%	\label{app:enc_HO_to_sessp_oc}
%	Encoding $\encod{\cdot}{\cdot}{2}: \HO \to \sessp$ 
%	enjoys operational correspondence (cf. Def.~\ref{def:ep}\,(2)).
%\end{proposition}
%
%\begin{proof}[Sketch]
%For completeness, we 
%consider the \HO process $P = {\bbout{k}{\abs{x}{Q}} P_1} \Par \binp{k}{X} P_2$. We have that
%\[
%P \red P_1 \Par P_2 \subst{\abs{x}Q}{X}
%\]
%In the target language, this reduction is mimicked as follows:
%\begin{eqnarray*}
%\pmap{P}{2} & = & \newsp{a}{\bout{k}{a} (\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2})\,} 
%                  \Par \binp{k}{x} \pmap{P_2}{2} \\
%            & \red & \newsp{a}{\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2} 
%                  \Par  \pmap{P_2}{2}\subst{a}{x}}
%\end{eqnarray*}
%\qed
%\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%	HOpp to HOp
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Properties for encoding $\tyl{L}_{\HOpp}$ into $\tyl{L}_{\HOp}$}
\label{app:HOpp_to_HOp}

%We study the properties of the typed encoding in
%\defref{def:enc:HOpp_to_HOp} (Page~\pageref{def:enc:HOpp_to_HOp}).

%We repeat the statement of \propref{prop:typepres_HOpp_to_HOp},
%as in Page~\pageref{prop:typepres_HOpp_to_HOp}:

In this section we prove \thmref{f:enc:hoppptohop}, in Page~\pageref{f:enc:hoppptohop}
that requires that encoding
$\tyl{L}_{\HOpp}$ into $\tyl{L}_{\HOp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated as \propref{prop:typepres_HOpp_to_HOp}
	and proven here as \propref{app:prop:typepres_HOpp_to_HOp}.
	\item	Operational Correspondence, stated as \propref{prop:op_corr_HOpp_to_HOp} and proven here as \propref{app:prop:op_corr_HOpp_to_HOp}.
	\item	Full Abstraction, stated as \propref{prop:fulla_HOpp_to_HOp}
	and proven here as \propref{app:prop:fulla_HOpp_to_HOp}.
\end{itemize}

\begin{proposition}[Type Preservation. From \HOpp to \HOp]\myrm
	\label{app:prop:typepres_HOpp_to_HOp}
	Let $P$ be an \HOpp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{3}; \emptyset; \tmap{\Delta}{3} \proves \pmap{P}{3} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the inference of 
	$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	We detail two representative cases:
	\begin{enumerate}[1.]
		\item	Case $P = \bout{u}{\abs{\underline{x}}{Q}} P'$.
			Then we may have the following typing in \HOpp:
			\[
				\tree{
					\tree{}{\Gamma; \Lambda_1; \Delta_1 \cat u:S  \proves  P' \hastype \Proc} 
					\quad
					\tree{
						\tree{}{\Gamma \cat \underline{x}:L; \Lambda_2 ; \Delta_2 \proves  Q \hastype \Proc}
						\quad
						\tree{}{\Gamma \cat \underline{x}:L; \es ; \es \proves  \underline{x} \hastype L}
					}{
						\Gamma ; \Lambda_2 ; \Delta_2 \proves  \abs{\underline{x}:L} Q \hastype \lhot{L}
					}
				}{
					\Gamma; \Lambda_1 \cat \Lambda_2; \Delta_1 \cat \Delta_2 \cat  u: \btout{\lhot{L}} S \proves \bout{u}{\abs{\underline{x}}{Q}} P' \hastype \Proc
				}
			\]
			Thus, by IH we have:
			%
			\begin{eqnarray}
				\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3}; \tmap{\Delta_1}{3} \cat u:\tmap{S}{3} & \proves &  \pmap{P'}{3} \hastype \Proc
				\label{eq:hopppre1}
				\\
				\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \tmap{\Lambda_2}{3} ; \tmap{\Delta_2}{3} & \proves & \pmap{Q}{3} \hastype \Proc
				\label{eq:hopppre2}
				\\
				\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \es ; \es & \proves & \underline{x} \hastype \tmap{L}{3}
				\label{eq:hopppre3}
			\end{eqnarray}
			%
			The corresponding typing in \HOp is as follows:
			\begin{eqnarray}
				\tree{
					\tree{
						\tree{}{\eqref{eq:hopppre2}}
					}{
						\tmap{\Gamma}{3} \cat x:\tmap{L}{3}; \tmap{\Lambda_2}{3};  \tmap{\Delta_2}{3} \cat z: \tinact \proves \pmap{Q}{3} \hastype \Proc
					}
					\qquad
					\tree{}{\eqref{eq:hopppre3}}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda_2}{3}; \tmap{\Delta_2}{3} \cat z:\btinp{\tmap{L}{3}} \tinact \proves \binp{z}{\underline{x}} \pmap{Q}{3} \hastype \Proc
				}
				\label{eq:hopppre11}
			\end{eqnarray}
			{\small
			\[
				\tree{
					\tree{}{
						\eqref{eq:hopppre1}}
						\quad
						\tree{
							\eqref{eq:hopppre11}
							\qquad 
							\tree{}{\tmap{\Gamma}{3}; \es; z:\btinp{\tmap{L}{3}} \tinact \proves z \hastype \btinp{\tmap{L}{3}} \tinact}
					}{
						\tmap{\Gamma}{3}; \tmap{\Lambda_2}{3}; \tmap{\Delta_2}{3} \proves \abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}} \hastype \lhot{(\btinp{\tmap{L}{3}} \tinact)}
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3} \cat \tmap{\Lambda_2}{3}; \tmap{\Delta_1}{3} \cat \tmap{\Delta_2}{3} \cat u:\btout{\lhot{\btinp{\tmap{L}{3}} \tinact}}\tmap{S}{3} 
					\proves  \bout{u}{\abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}}} \pmap{P'}{3}
					\hastype \Proc
				}
			\]
			}

			\item Case $P =  \appl{(\abs{x} P)}{(\abs{y} Q)}$.
			We may have different possibilities for the types of each abstraction. 
			We consider only one of them, as the rest are similar:
			\[
			\tree{
			\tree{
			\tree{}{
			\Gamma \cat x:\shot{C}; \Lambda;  \Delta_1 \proves   P \hastype \Proc}
			}{
			\Gamma; \Lambda;  \Delta_1 \proves \abs{x} P \hastype \lhot{(\lhot{C})}
			} 
			\quad
			\tree{
			\tree{}{
			\Gamma; \es;  \Delta_2\cat y:C \proves  Q \hastype \Proc}
			}{
			\Gamma; \es;  \Delta_2 \proves \abs{y} Q \hastype \lhot{C}
			}
			}{
			\Gamma; \Lambda; \Delta_1 \cdot \Delta_2 \proves\appl{(\abs{x} P)}{(\abs{y} Q)} \hastype \Proc
			}
			\]

			Thus, by IH we have:
			\begin{eqnarray}
			\tmap{\Gamma}{3} \cat x:\tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3}   & \proves &  \pmap{P}{3} \hastype \Proc
			\label{eq:hopppre4} \\
			\tmap{\Gamma}{3}  ; \es; \tmap{\Delta_1}{3} \cat y:\tmap{C}{3}   & \proves &  \pmap{Q}{3} \hastype \Proc
			\label{eq:hopppre5} 
			\end{eqnarray}

			The corresponding typing in \HOp is as follows --- recall that $\tmap{\lhot{C}}{3} = \lhot{\tmap{C}{3}}$.
			\begin{eqnarray}
				\tree{
					\tree{
						\tree{}{\eqref{eq:hopppre4}}
					}{
						\tmap{\Gamma}{3}\cat x: \tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cat s: \tinact \proves \pmap{P}{3} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cat  s:\btinp{\tmap{\lhot{C}}{3}}\tinact \proves \binp{s}{x}\pmap{P}{3} \hastype \Proc
				}
				\label{eq:hopppre12}
			\end{eqnarray}
			{\small
			\[
				\tree{
					\tree{
						\eqref{eq:hopppre12}
						\quad
						\tree{
							\tree{
								\tree{}{\eqref{eq:hopppre5}}
							}{
								\tree{
									\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \cat y:\tmap{ C}{3} \proves \pmap{Q}{3} \hastype \Proc
								}{
									\tree{
										\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \proves \abs{y}{\pmap{Q}{3}} \hastype \tmap{\lhot{C}}{3}
									}{
										\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \cat \dual{s}: \tinact \proves \abs{y}{\pmap{Q}{3}} \hastype \tmap{\lhot{C}}{3}
									}
								}
							}
						}{
							\tmap{\Gamma}{3}; \es;   \tmap{\Delta_2}{3} \cat \dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact \proves \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact \hastype \Proc
						}
					}{
						\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} \cat s:\btinp{\tmap{\lhot{C}}{3}}\tinact \cat \dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact
						\proves
						\binp{s}{x}\pmap{P}{3} \Par \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact \hastype \Proc
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} \proves \news{s}(\binp{s}{x}\pmap{P}{3} \Par \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact) \hastype \Proc
				}
			\]
			}

	\end{enumerate}
%\qed
\end{proof}


%We repeat the statement of \propref{prop:op_corr_HOpp_to_HOp},
%as in Page~\pageref{prop:op_corr_HOpp_to_HOp}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{3}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{3}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%
%\[
%	\begin{array}{c} 
%		\mapa{\news{\tilde{m}} \bactout{n}{\abs{\AT{x}{L}}{P}}}^{3} 
%		\defeq
%		\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
%		\qquad \qquad
%		\mapa{\bactinp{n}{\abs{\AT{x}{L}}{P}}}^{3}
%		\defeq \bactinp{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
%	\end{array}
%\]
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}

%We now state and prove a detailed version of the operational corresponce in \defref{app:def:opc_strong}.
We repeat the statement in Page~\pageref{prop:op_corr_HOpp_to_HOp}.
Recall that we use the mapping on actions $\mapa{\cdot}^{3}$ given in \defref{d:actmap3}.

\begin{proposition}[Operational Correspondence. From \HOpp to \HOp]\myrm
	\label{app:prop:op_corr_HOpp_to_HOp}
	\input{figures/op_corr_HOpp_to_HOp}
\end{proposition}

\begin{proof}
We consider both parts separately,
considering the mapping in \figref{f:enc:hopip_to_hopi}.

\begin{enumerate}
	\item The proof of Part 1 proceeds by transition induction. We 
		content ourselves by showing two interesting cases; other cases are similar.  
		Suppose $\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$.

	\begin{enumerate}[a)]
	
			\item	%\jpc{This was different, please check} 
			Case 1(a): 
			%Case: $P = \bout{n}{\abs{\underline{x}} Q} P$
			Then 
			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P'}$.
By following the encoding in \figref{f:enc:hopip_to_hopi}, we have 
that 
\begin{align*}
\pmap{P}{3} & = \bout{n}{\auxmap{\abs{x}{Q}}{3}} \pmap{P'}{3} \\
& = \bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P'}{3}
\end{align*}
and therefore
 			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P'}{3}}$,
			as required.

		\item	%\jpc{This was different, please check} 
		Case 1(c): Then 
		%$P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$, $\ell =  \btau$, and $P' = Q_1 \subst{\abs{x}{Q_2}}{x}$:
$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{y}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{y}{Q_2}}{x}}$.
By following the encoding in \figref{f:enc:hopip_to_hopi}, we have the following: 
\begin{align*}
\pmap{P}{3} & = \newsp{s}{\binp{s}{x} \pmap{Q_1}{3} \Par \bout{\dual{s}}{\auxmap{\abs{y}{Q_2}}{3}}\inact} \\
& = \newsp{s}{\binp{s}{x} \pmap{Q_1}{3} \Par \bout{\dual{s}}{\abs{z}{\binp{z}{y}\pmap{Q_2}{3}}}\inact} 
\end{align*}
and therefore
\[
			\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q_1}{3} \Par \bout{\dual{s}}{\abs{z}{\binp{z}{y}\pmap{Q_2}{3}}} \inact}}{\hby{\stau}}
			{\tmap{\Delta'}{3}}{\pmap{Q_1}{3} \subst{\abs{z}{\binp{z}{y}\pmap{Q_2}{3}}}{x}}
\]
We are left to show that $\pmap{Q_1 \subst{\abs{y}{Q_2}}{x}}{3}$ 
and $\pmap{Q_1}{3} \subst{\abs{z}{\binp{z}{y}\pmap{Q_2}{3}}}{x}$ are related by $\hwb$.
This follows easily from the structure of the encoding $\pmap{\cdot}{3}$, 
which mimics higher-order applications using deterministic transitions only.


	\end{enumerate}

	\item The proof of Part 2 also proceeds by transition induction.
	All cases are easy: they 
	are similar to those described for Part 1
	or
	follow directly from the 
encoding in \figref{f:enc:hopip_to_hopi}.
%	We give the most interesting cases; other cases are similar. 
%	\begin{enumerate}[a)]
%		\item	Case: $P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$.
%%
%		\[
%			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{ \appl{(\abs{z}\binp{z}{x} \pmap{Q}{3})}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\btau}}
%			{\tmap{\Delta'}{3}}{}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}
%		\]
%%
%			\noi implies
%			$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ and
%%
%		\[
%			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\stau}}
%			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
%		\]
%
%		\item	Case: $P = \bout{n}{\abs{\underline{x}} Q} P$
%
%			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$ and
%
%			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{\underline{x}}{Q}}}}{\Delta}{P}$
%%			\dk{this case is incomplete}
%	\end{enumerate}
\end{enumerate}
%\qed
\end{proof}

\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\myrm
	\label{app:prop:fulla_HOpp_to_HOp}
	Let $P, Q$ \HOpp processes with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$. \\
	Then 
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}$
\end{proposition}

\begin{proof}[Proof (Sketch)] The right-to-left direction is proven by 
	%\noi {\bf Soundness Direction.} We define 
	showing that
	the relation
%
	\[
		\Re_1 = \set{
		%(\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q}) 
		(P,Q)
		\setbar \horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\hwb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}}
	\]
%
	  is a higher-order bisimulation, following Part 2 of
		\propref{app:prop:op_corr_HOpp_to_HOp} for subcases (a) and (b).
		In subcase (c) we  use \propref{lem:tau_inert}.
		Similarly, the left-to-right direction is proven by showing that 
the relation:
%
	\[
		\Re_2 = \set{
		%(\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\ ,\ }{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}) 
		(\pmap{P}{3}, \pmap{Q}{3})
		\setbar \horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}}
	\]
 is a higher-order bisimulation up to deterministic transitions
		by following Part 1 of \propref{app:prop:op_corr_HOpp_to_HOp}.
		The proof is straightforward for subcases (a), (b), and (d).
		In subcase (c) we  use  \lemref{lem:up_to_deterministic_transition}.
	%\qed
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%	pHOp to HOp
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsection{Properties for encoding $\tyl{L}_{\PHOp}$ into $\tyl{L}_{\HOp}$}
\label{app:pHOp_to_HOp}

%We study the properties of the typed encoding in
%\defref{def:enc:pHOp_to_HOp} (Page~\pageref{def:enc:pHOp_to_HOp}).

%We repeat the statement of \propref{prop:typepres_pHOp_to_HOp}, as in Page~\pageref{prop:typepres_pHOp_to_HOp}:

In this section we prove \thmref{f:enc:phopiptohopi}, in Page~\pageref{f:enc:phopiptohopi}
that requires that encoding
$\tyl{L}_{\PHOp}$ into $\tyl{L}_{\HOp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated as \propref{prop:typepres_pHOp_to_HOp} and proven here as \propref{app:prop:typepres_pHOp_to_HOp}.
	\item	Operational Correspondence, stated as \propref{prop:op_corr_pHOp_to_HOp} and proven here as \propref{app:prop:op_corr_pHOp_to_HOp}.
	\item	Full Abstraction, stated as \propref{prop:fulla_pHOp_to_HOp} and proven here  as \propref{app:prop:fulla_pHOp_to_HOp}.
\end{itemize}


\begin{proposition}[Type Preservation. From \pHOp to \HOp]\rm
	\label{app:prop:typepres_pHOp_to_HOp}
	Let $P$ be an \pHOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta}{4} \proves \pmap{P}{4} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	We examine two representative cases, using dyadic communications:

	\begin{enumerate}[1.]
		\item	Case $P = \bout{n}{V} P'$ and 
			$\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat n:\btout{\lhot{(C_1,C_2)}} S \proves \bout{n}{V} P' \hastype \Proc$.
			Then either $V = y$ or $V = \abs{(x_1,x_2)}Q$, for some $Q$.
			The case $V = y$ is immediate; we give details for the case $V = \abs{(x_1,x_2)}Q$, for which we have the following typing:
			\[
				\tree{
					\tree{}{
						\Gamma; \emptyset; \Delta_1 \cat n:S \proves P' \hastype \Proc
					}
					\quad
					\tree{
						\Gamma; \emptyset; \Delta_2 \cat x_1: C_1 \cat x_2:C_2 \proves Q \hastype \Proc
					}{
						\Gamma; \emptyset; \Delta_2 \proves \abs{(x_1,x_2)}Q \hastype \lhot{(C_1,C_2)}
					}
				}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat n:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{\abs{(x_1,x_2)}Q} P \hastype \Proc
				}
		\]
		We now show the typing for $\pmap{P}{4}$.
		By IH we have both:
%
		\[
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n: \tmap{S}{4} \proves \pmap{P'}{4} \hastype \Proc
			\qquad
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2:\tmap{C_2}{4} \proves \pmap{Q}{4} \hastype \Proc
		\]
%
		Let $L = \lhot{(C_1,C_2)}$. 
		By \figref{f:enc:poltomon} we have  
		$\tmap{L}{4} = \lhot{\big(\btinp{\tmap{C_1}{4}} \btinp{\tmap{C_2}{4}}\tinact\big)}$
		and
		$\pmap{P}{4} = \bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4}} \pmap{P'}{4}$.
		We can now infer the following typing derivation:
%
		\begin{eqnarray}
			\label{prop:tpres:pHOp_to_HOp1}
			\tree{
				\tree{
					\tree{
						\tree{
							\tree{}{
								\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \proves \pmap{Q}{4} \hastype \Proc
							}
						}{
							\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \cat z:\tinact \proves \pmap{Q}{4} \hastype \Proc
						}
					}{
						\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4}\cat z:\btinp{\tmap{C_2}{4}}\tinact \proves \binp{z}{x_2} \pmap{Q}{4} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat z:\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact \proves \binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4} \hastype \Proc
				}
			}{
				\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \proves \abs{z}\binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4} \hastype \lhot{(\tmap{C_1}{4},\tmap{C_2}{4})}
			}
		\end{eqnarray}
%
%
		\[
		\tree{
			\tree{}{
				\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat k:\tmap{S}{4} \proves \pmap{P'}{4} \hastype \Proc
			}
			\quad
			\eqref{prop:tpres:pHOp_to_HOp1}
		}{
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat \tmap{\Delta_2}{4} \cat n:\btout{\tmap{L}{4}} \tmap{S}{4} \proves \pmap{P}{4} \hastype \Proc
		}
		\]

		\item	Case $P = \binp{n}{x_1,x_2} P'$ 
			and
			$\Gamma; \emptyset; \Delta_1 \cat n: \btinp{(C_1, C_2)} S \proves \binp{n}{x_1,x_2} P' \hastype \Proc$.
			We have the following typing derivation:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_1 \cat n:S \cat x_1: C_1 \cat x_2: C_2 \proves  P' \hastype \Proc
					\quad
					\Gamma; \emptyset;  \proves x_1, x_2 \hastype C_1,C_2
				}{
					\Gamma; \emptyset; \Delta_1 \cat n: \btinp{(C_1, C_2)} S \proves \binp{n}{x_1,x_2} P' \hastype \Proc
				}
		\]
		By \figref{f:enc:poltomon} we have 
		$\pmap{P}{4} = \binp{n}{x_1}\binp{k}{x_2} \pmap{P'}{4}$.
		By IH we have 
%
		\[
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n:\tmap{S}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \proves  \pmap{P'}{4} \hastype \Proc
		\]
%
		and the following type derivation:
		\[
			\tree{
				\tree{
					\tree{}{
						\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat x_1:\tmap{C_1}{4} \cat x_2:\tmap{C_2}{4} \cat n:\tmap{S}{4} \proves \pmap{P'}{4} \hastype \Proc
					}
					%\quad
					%\tree{}{
					%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_2:\tmap{C_2}{\mathsf{p}}  \proves  x_2 \hastype \tmap{C_2}{\mathsf{p}}}
				}{
					\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat x_1:\tmap{C_1}{4} \cat n:\btinp{\tmap{C_2}{4}}\tmap{S}{4} \proves \binp{n}{x_2}\pmap{P'}{4} \hastype \Proc
				}
				%\quad
				%\tree{}{
				%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_1:\tmap{C_1}{\mathsf{p}}  \proves  x_1 \hastype \tmap{C_1}{\mathsf{p}}}
			}{
				\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n:\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tmap{S}{4} \proves \pmap{P}{4} \hastype \Proc
			}
		\]
	\end{enumerate}
	%\qed
\end{proof}

%We repeat the statement of \propref{prop:op_cor:pHOp_to_HOp}, as in Page~\pageref{prop:op_cor:pHOp_to_HOp}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{4}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{4}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%
%\[
%	\begin{array}{c}
%		\mapa{\news{\tilde{m}} \bactout{n}{m_1,  m_2}}^4 
%		\defeq \ell_1, \ell_2
%		\textrm{ where }
%%		\left\{
%%		\begin{array}{rcl}
%			(m_i \in \tilde{m} \Leftrightarrow \ell_i = \news{m_i}\bactout{n}{m_i} ) ~ \lor %\\
%			(m_i \not\in \tilde{m} \Leftrightarrow  \ell_i = \bactout{n}{m_i})
%%		\end{array}
%%		\right.
%%		& &  (m_i \in \tilde{m}  \Leftrightarrow \ell_i = \news{m_i}\bactout{n}{m_i} ) ~ \lor \\
%%		& & (m_i \not\in \tilde{m}  \Leftrightarrow  \ell_i = \bactout{n}{m_i}) \\
%		\\
%		\mapa{\news{\tilde{m}} \bactout{n}{\abs{(x_1, x_2)}{P}} }^4 
%		\defeq
%		\news{\tilde{m}} \bactout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{P}^{4}}
%	\end{array}
%\]
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}

We repeat the statement in Page~\pageref{prop:op_corr_pHOp_to_HOp}. 
Recall that we use the mapping on actions $\mapa{\cdot}^{4}$ given in \defref{d:actmap4}.

\begin{proposition}[Operational Correspondence. From \pHOp to \HOp]\myrm
	\label{app:prop:op_corr_pHOp_to_HOp}
\input{figures/op_corr_pHOp_to_HOp}
\end{proposition}

\begin{proof}
	The proof of both parts is by transition induction, following 
	the mapping defined in  \figref{f:enc:poltomon}.
	We consider four representative cases, using dyadic communication:
	\begin{enumerate}[1.]
	%\item 
	%% Biadic Output 
\item Case (1(a)), with $P =\bout{n}{m_1, m_2} P'$ and $\ell_1 = \bactout{n}{m_1, m_2}$. 
By assumption, $P$ is well-typed. 
As one particular possibility, we may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; m_1{:} S_1 \cat m_2{:}S_2 \proves  m_1,m_2 \hastype S_1,S_2}{
					\Gamma; \emptyset; \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S \proves  
					\bout{n}{m_1,m_2} P' \hastype \Proc}
			\]
for some $\Gamma, S, S_1, S_2, \Delta_0$, 
such that $\Delta = \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S$.
We may then have the following typed transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}{\bout{n}{m_1, m_2} P'}{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgment for $P$ is as follows:
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}^{4} \proves \map{\bout{n}{m_1, m_2} P'}^{4} \hastype \Proc
$$
which, using  \figref{f:enc:poltomon}, can be expressed as: 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0} 
\cat m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} 
\cat n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} 
\hastype \Proc
$$
Now, $\mapa{\ell_1}^{4} = \bactout{n}{m_1 }, \bactout{n}{ m_2}$. 
It is immediate to infer the following typed transitions for $\map{P}^{4}  = \bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} $:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta_0} \cat  m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4}  \\
& \hby{\bactout{n}{m_1}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat  m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_2} \map{P'}^{4} \\
& \hby{\bactout{n}{m_2}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0}  \cat n{:}\mapt{S}^{4}
\proves 
 \map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat
n:S }^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%% Biadic Abstraction Output 
\item Case (1(c)) with $P = \bbout{n}{\abs{(x_1, x_2)} Q} P' $ and $\ell_1 = \bactout{n}{\abs{(x_1, x_2)}{Q}}$. 
By assumption, $P$ is well-typed. 
We may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; \Delta_1 \proves  \abs{(x_1,x_2)}Q \hastype \lhot{(C_1,C_2)}}{
					\Gamma; \emptyset; \Delta_0 \cat \Delta_1 \cat n:\btout{\lhot{(C_1,C_2)}}S \proves  
					\bout{n}{\abs{(x_1,x_2)}Q} P' \hastype \Proc}
			\]
for some $\Gamma$, $S$, $C_1$, $C_2$, $\Delta_0$, $\Delta_1$, 
such that $\Delta = \Delta_0 \cat \Delta_1 \cat  n:\btout{\lhot{(C_1,C_2)}}S$.
(For simplicity, we consider only the case of a linear function.)
We may have the following typed transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}{\bbout{n}{\abs{(x_1, x_2)} Q} P' }{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgement is:
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}^{4} \proves \map{\bbout{n}{\abs{(x_1, x_2)} Q} P' }^{4} \hastype \Proc
$$
which, using  \figref{f:enc:poltomon}, can be equivalently expressed as: 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}
\hastype \Proc
$$

Now, $\mapa{\ell_1}^{4} = \bactout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}}$. 
It is immediate to infer the following typed transition for $\map{P}^{4}  = \bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\mapa{\ell_1}^{4}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat
n:\mapt{S}^{4}, \,
\proves 
\map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; 
 \mapt{\Delta_0 \cat n:S}^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PART 2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Biadic Input 
\item Case (2(a)), with $P =  \binp{n}{x_1, x_2} P' $, 
$\map{P}^{4} = 
		\binp{n}{x_1}  \binp{n}{x_2}  \map{P'}^{4}$.
%		We show that this case falls under part~(b) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 		
%		and $\ell_2 = \bactinp{n}{m_1}, \bactinp{n}{m_2}$. Then w
		We have  the following typed transitions for $\map{P}^{4}$, for some $S$, $S_1$, $S_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_1}{4}}\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
\proves 
\binp{n}{x_1} \binp{n}{x_2}\map{P'}^{4} \\
& \hby{\bactinp{n}{m_1}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
m_1:\mapt{S_1}^{4}
\proves 
\binp{n}{x_2}\map{P'}^{4} \subst{m_1}{x_1} \\
& \hby{\bactinp{n}{m_2}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat n:\tmap{S}{4} \cat
m_1:  \mapt{S_1}^{4} \cat
m_2: \mapt{S_2}^{4}
\proves 
\map{P'}^{4} \subst{m_1}{x_1}\subst{m_2}{x_2} = Q
\end{eqnarray*}
Observe that we use substitution %lemma (Lemma~\ref{lem:subst}(1)) has been used
twice.
%Considering Remarn~\ref{r:multilabels} 
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactinp{n}{m_1,m_2}$. Indeed, $\mapa{\ell_1}^{4} = \bactinp{n}{m_1}, \bactinp{n}{m_2}$.
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta \cat n:\btinp{S_1, S_2}S}{\binp{n}{x_1, x_2} P' }{\Delta\cat n{:}S \cat m_1:S_1 \cat m_2:S_2}{P'\subst{m_1,m_2}{x_1, x_2}}
$$
which concludes the proof for this case.


%% Biadic Abstraction Output 
\item Case (2(b)), with $P =  \bbout{n}{\abs{(x_1,x_2)} Q} P' $, 
$\map{P}^{4} = 
		\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$.
		%We show that this case falls under part~(a) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 
		We have the following  typed transition, for some $S$, $C_1$, $C_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{\bbtout{\lhot{(C_1,  C_2)}} S}{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\ell'_1} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{ S}{4} 
\proves 
\map{P'}^{4} = Q
\end{eqnarray*}
where
$\ell'_1 = \bactout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}}$.
For simplicity, we consider only the case of linear functions.
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactout{n}{\abs{(x_1,  x_2)}{Q}} $. 
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta\cat n:\bbtout{\lhot{(C_1,  C_2)}} S}{ \bbout{n}{\abs{x_1,x_2} Q} P'}{\Delta\cat n{:}S}{P'}
$$
which concludes the proof for this case.
\end{enumerate}
%\iftodo{
%	\dk{do some cases}
%}\else\fi
	%\qed
\end{proof}


\begin{proposition}[Full Abstraction. From \pHOp to \HOp]\myrm
	\label{app:prop:fulla_pHOp_to_HOp}
	Let $P, Q$ be \HOpp process with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$. \\
	Then
	$\horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hwb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}$.
\end{proposition}

\begin{proof}
	The proof is coinductive, and follows as a consequence of \propref{app:prop:op_corr_pHOp_to_HOp}.

\bigskip
\noi The right-to-left direction follows by showing that the relation
%
	\[
		\Re = \set{
		%(\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q}) 
		(P, Q) 
		\setbar \horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hwb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}}
	\]
is a higher-order bisimulation, by following Part 2 of \propref{app:prop:op_corr_pHOp_to_HOp}. 
	Suppose $P$ makes a transition with label $\ell$; we must exhibit a matching move from $Q$.
	We illustrate four representative cases:
	\begin{enumerate}
		\item	If $\ell \in \set{\bactinp{n}{m}, \bactout{n}{m}, \news{m} \bactout{n}{m}}$ then
		$
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
		$
		implies
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
		\]
		From Part 2(a) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
		\[
		\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1''}{P'}
		\]
		and
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{P_1}{\hby{\ell_2} \dots \hby{\ell_n}}
		{\tmap{\Delta_1''}{4}}{\pmap{P'}{4}}
		\]
		with $\mapa{\ell}^{4} = \{\ell_1, \dots, \ell_n\}$.
				Moreover,
		$
			\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell}}{\Delta_2''}{Q'}
		$
		and
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2'}{4}}{Q_1}{\Hby{\ell_2} \dots \Hby{\ell_n}}
		{\tmap{\Delta_2''}{4}}{\pmap{Q'}{4}}
		\]
		
		If we follow the bisimulation game we conclude that
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1''}{4}}{\pmap{P'}{4}}{\hwb}{\tmap{\Delta_2''}{4}}{\pmap{Q'}{4}}
		\]
		and
		\[
		\horel{\Gamma}{\Delta_1''}{P'}{\ \Re\ }{\Delta_2''}{Q'}
		\]
		as required.
		\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}}$
				then
				$
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
				$
				implies both 
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
				\]
				and
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{P_1 \Par C}{\hwb}{\tmap{\Delta_2'}{4}}{Q_1 \Par C}
				\]
				with $C$ corresponding to the characteristic process if $\ell$ is an output action and $C = \inact$ otherwise.
				From Part 2(b) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
				$$\horel{\Gamma}{\Delta_1}{P}{\hby{\ell'}}{\Delta_1'}{P'}$$
				with $\mapa{\ell'}^{4} = \ell$ and $P_1 \scong \pmap{P'}{4}$
				and
				$\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell'}}{\Delta_2'}{Q'}$
				and $P_1 \scong \pmap{P'}{4}$ and
				\begin{eqnarray*}
					\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{\pmap{P' \Par C}{4}}{\hwb}{\tmap{\Delta_2'}{4}}{\pmap{Q' \Par C}{4}}
				\end{eqnarray*}
				because the characteristic trigger in the case where $\ell = \bactout{n}{\abs{x}{R}}$ remains the same
				for $\mapa{\ell}^{4}$.
%				\dk{we need an auxiliary result here}
				
		\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$
				then
				$
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
				$
				implies
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
				\]
				From Part 2(c) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
				$	
				\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
				$
				with $P_1 \scong \pmap{P'}{4}$
				and
				\[	
				\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell}}{\Delta_2'}{Q'}
				\]
				with $Q_1 \scong \pmap{Q'}{4}$,
				which concludes the case.

		\item	The cases for $\ell = \tau$ are similar
				and correspond to Parts 2(d), 2(e) of \propref{app:prop:op_corr_pHOp_to_HOp}.
	\end{enumerate}
			
			
%		for subcases a and b.
%		In subcase c we make use of \propref{lem:tau_inert}.

\bigskip

\noi	The left-to-right direction follows by showing that the relation: %create the closure
%
	\[
		\Re = \set{
		%(\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\ ,\ }{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}) 
		(\pmap{P}{4}, \pmap{Q}{4})
		\setbar \horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}}
	\]
is a higher-order bisimulation up to deterministic transitions, by following Part 1 of \propref{app:prop:op_corr_pHOp_to_HOp}.
	Suppose $\pmap{P}{4}$ makes a transition with label $\ell$; we should exhibit a matching move from 
	$\pmap{Q}{4}$. 
	We consider six cases:
	\begin{enumerate}
		\item
		If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
		$
		\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
		$
		implies
	$
		\horel{\Gamma}{\Delta_2}{Q}{\Hby{\ell}}{\Delta_2'}{Q'}
		$
		and
		\[
		\horel{\Gamma}{\Delta_1'}{P' \Par C}{\hwb}{\Delta_2'}{Q' \Par C}
		\]
		with $C$ corresponding to the trigger process.
		Furthermore, from Part 1 (a) of \propref{app:prop:op_corr_pHOp_to_HOp} we have that
		$$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta_1'}{4}}{\pmap{P'}{4}}$$
		with $\mapa{\ell}^{4} = \{\ell_1, \dots, \ell_n\}$
		and
		$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell_1} \dots \Hby{\ell_n}}{\tmap{\Delta_2'}{4}}{\pmap{Q'}{4}}$
		and
		\begin{eqnarray*}
			\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{\pmap{P' \Par C_1 \Par C_2}{4}}{\hwb}{\tmap{\Delta_2'}{4}}{\pmap{Q' \Par C_1 \Par C_2}{4}}
		\end{eqnarray*}
		because the characteristic triggers remain the same for $\mapa{\ell}^{4}$.
%		\dk{we need an auxiliary result}.
						
		\item	If $\ell = \bactinp{n}{\tilde{m}}$ then
				%If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
				$
				\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
				$
				implies
				$
				\horel{\Gamma}{\Delta_2}{Q}{\Hby{\ell}}{\Delta_2'}{Q'}
				$
				and
				\[
				\horel{\Gamma}{\Delta_1'}{P'}{\hwb}{\Delta_2'}{Q'}
				\]
				Furthermore, from Part 1 (b) of \propref{app:prop:op_corr_pHOp_to_HOp} we have that
				$$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta_1'}{4}}{\pmap{P'}{4}}$$
				with $\mapa{\ell}^{4} = \{\ell_1, \dots, \ell_n\}$
				and
				$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell_1} \dots \Hby{\ell_n}}{\tmap{\Delta_2'}{4}}{\pmap{Q'}{4}}$,
				as required.
		\item	The case for $\ell = \news{\tilde{m}} \bactout{n}{\abs{\tilde{x}}{R}}$
		is similar to the first case.
		
		\item	The case for $\ell = \bactinp{n}{\abs{\tilde{x}}{R}}$
		is similar to the second case.
		
		\item	The case for $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$ is similar to the second case.
		
		\item	The case for $\ell = \tau$ is similar to the second case.
		
	\end{enumerate}
%		The proof is straightforward for subcases a), b) and d).
%		In subcase c) we make use of \lemref{lem:up_to_deterministic_transition}.
	%\end{itemize}
	%\qed
\end{proof}

