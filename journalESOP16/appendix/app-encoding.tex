% !TEX root = ../journal16kpy.tex
\section{Expressiveness Results}

In this section we give the proofs for the expressiveness
results stated in Section~\ref{sec:positive}
and in Section~\ref{sec:extension}.

For the purpose of proving Operational Correspondence
in this section we prove a stronger result than the result
suggested in \defref{def:ep}(2). We state the
requirements below.

\begin{definition}[Operational Correspondence]\rm
	\label{app:def:opc_strong}
	Consider typed calculi
	$\tyl{L}_1 = \calc{\CAL_1}{{\cal{T}}_1}{\hby{\ell_1}_1}{\wb_1}{\proves_1}$
	and $\tyl{L}_2=\calc{\CAL_2}{{\cal{T}}_2}{\hby{\ell_2}_2}{\wb_2}{\proves_2}$.
	Let $\mathcal{A}_i$ be the set of labels from relation $\hby{\ell_i}$
	($i=1,2$) and let mapping $\mapa{\cdot} : \mathcal{A}_1 \to \mathcal{A}_2$.

	We say that $\enco{\map{\cdot}, \mapt{\cdot}}: \tyl{L}_1 \to \tyl{L}_2$ is a
	\emph{operational corresponce}
	if it satisfies the property:
	If $\Gamma; \emptyset; \Delta \proves_1 P \hastype \Proc$ then
		\begin{enumerate}
			\item	Completeness:
				If  $\stytraargi{\Gamma}{\ell_1}{\Delta}{P}{\Delta'}{P'}{1}{1}$
				then\\
				$\exists Q, \Delta''$ s.t. 
				(i)~$\wtytraargi{\mapt{\Gamma}}{\ell_2}{\mapt{\Delta}}{\map{P}}{\mapt{\Delta''}}{Q}{2}{2}$
				(ii)~$\ell_2 = \mapa{\ell_1}$, 
				and \\
				(ii)~${\mapt{\Gamma}};{\mapt{\Delta''}}\proves_2 {Q}{\wb_2}{\mapt{\Delta'}}\proves_2 {\map{P'}}$.
				
			\item	Soundness:   
				If  $\wtytraargi{\mapt{\Gamma}}{\ell_2}{\mapt{\Delta}}{\map{P}}{\mapt{\Delta'}}{Q}{2}{2}$
				then \\ $\exists P', \Delta''$ s.t.  
				(i)~$\stytraargi{\Gamma}{\ell_1}{\Delta}{P}{\Delta''}{P'}{1}{1}$
				(ii)~$\ell_2 = \mapa{\ell_1}$, 
				and \\
				(ii)~${\mapt{\Gamma}};{\mapt{\Delta''}}\proves_2 {\map{P'}}{\wb_2}{\mapt{\Delta'}}\proves_2 {Q}$.
		\end{enumerate}
\end{definition}

\begin{proposition}
	Consider typed calculi
	$\tyl{L}_1 = \calc{\CAL_1}{{\cal{T}}_1}{\hby{\ell_1}_1}{\wb_1}{\proves_1}$
	and $\tyl{L}_2=\calc{\CAL_2}{{\cal{T}}_2}{\hby{\ell_2}_2}{\wb_2}{\proves_2}$.
	Let $\mathcal{A}_i$ be the set of labels from relation $\hby{\ell_i}$
	($i=1,2$) and let mapping $\mapa{\cdot} : \mathcal{A}_1 \to \mathcal{A}_2$.

	If $\mapa{\tau} = \tau$ then
	the requirements of \defref{app:def:opc_strong} imply
	the requirements of \defref{def:ep}(2).
\end{proposition}

\begin{proof}
	The proof is trivial by substituting the $\tau$ action
	on labels $\ell_1$ and $\ell_2$ in \defref{app:def:opc_strong}
	to get \defref{def:ep}(2).
\end{proof}

\begin{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% POLYADIC TO MONADIC
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Properties for $\encod{\cdot}{\cdot}{\mathsf{p}}$}
\label{app:polmon}
We study the properties of the typed encoding in
Def.~\ref{d:enc:poltomon} (Page~\pageref{d:enc:poltomon}).

We repeat the statement of Prop.~\ref{prop:typepresp}, as in Page \pageref{prop:typepresp}:
\begin{proposition}[Type Preservation, Polyadic to Monadic]
Let $P$ be an  $\HOp$ process.
If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
			$\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta}^{\mathsf{p}} \proves \map{P}^{\mathsf{p}} \hastype \Proc$. 
\end{proposition}

\begin{proof}
By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
We examine two representative cases, using biadic communications.

\begin{enumerate}[1.]
\item Case 
$P = \bout{k}{V} P'$ and 
$\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{V} P' \hastype \Proc$. Then either $V = Y$ or $V = \abs{x_1,x_2}Q$, for some $Q$. The case $V = Y$ is immediate; we give details for the case $V = \abs{x_1,x_2}Q$, for which we have the following typing:
\[
\tree{
\tree{}{
\Gamma; \emptyset; \Delta_1 \cat k:S \proves P' \hastype \Proc}
\quad
\tree{
\Gamma; \emptyset; \Delta_2 \cat x_1: C_1 \cat x_2:C_2 \proves Q \hastype \Proc
}{
\Gamma; \emptyset; \Delta_2 \proves \abs{x_1,x_2}Q \hastype \lhot{(C_1,C_2)}
}
}{
\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{\abs{x_1,x_2}Q} P \hastype \Proc
}
\]
We now show the typing for $\map{P}^{\mathsf{p}}$. By IH we have both:
\[
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \proves \map{P'}^{\mathsf{p}} \hastype \Proc
\qquad
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \mapt{C_1}^{\mathsf{p}} \cat x_2:\mapt{C_2}^{\mathsf{p}} \proves \map{Q}^{\mathsf{p}} \hastype \Proc
\]
Let $L = \lhot{(C_1,C_2)}$. 
By Def.~\ref{d:enc:poltomon} 
we have  
$\mapt{L}^{\mathsf{p}} = \lhot{\big(\btinp{\tmap{C_1}{\mathsf{p}}} \btinp{\tmap{C_2}{\mathsf{p}}}\tinact\big)}$
and
$\map{P}^{\mathsf{p}} = \bbout{k}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}}} \map{P'}^{\mathsf{p}}$.
We can now infer the following typing derivation:
\[
\tree{
\tree{}
{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \proves \map{P'}^{\mathsf{p}} \hastype \Proc}
\quad
\tree{
\tree{
\tree{
\tree{
\tree{}{\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}} \proves 
 \map{Q}^{\mathsf{p}} \hastype \Proc}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}}
\cat z:\tinact \proves 
 \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}}\cat z:\btinp{\tmap{C_2}{\mathsf{p}}}\tinact \proves 
\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat z:\btinp{\tmap{C_1}{\mathsf{p}}}\btinp{\tmap{C_2}{\mathsf{p}}}\tinact \proves 
\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}}  \proves 
\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \lhot{(\tmap{C_1}{\mathsf{p}},\tmap{C_2}{\mathsf{p}})}
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat \mapt{\Delta_2}^{\mathsf{p}} \cat k:\btout{\mapt{L}^{\mathsf{p}}} \mapt{S}^{\mathsf{p}} \proves \map{P}^{\mathsf{p}} \hastype \Proc
}
\]

\item Case $P = \binp{k}{x_1,x_2} P'$ 
and
$\Gamma; \emptyset; \Delta_1 \cat k: \btinp{(C_1, C_2)} S \proves \binp{k}{x_1,x_2} P' \hastype \Proc$.
We have the following typing derivation:
\[
\tree{
\Gamma; \emptyset; \Delta_1 \cat k:S \cat x_1: C_1 \cat x_2: C_2 \proves  P' \hastype \Proc
\quad
\Gamma; \emptyset;  \proves x_1, x_2 \hastype C_1,C_2
}{
\Gamma; \emptyset; \Delta_1 \cat k: \btinp{(C_1, C_2)} S \proves \binp{k}{x_1,x_2} P' \hastype \Proc
}
\]
By Def.~\ref{d:enc:poltomon} we have 
$\map{P}^{\mathsf{p}} = \binp{k}{x_1}\binp{k}{x_2}\map{P'}^{\mathsf{p}}$.
By IH we have 
$$
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}} \proves  \map{P'}^{\mathsf{p}} \hastype \Proc
$$
and the following type derivation:
\[
\tree{
\tree{
\tree{
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat x_1:\tmap{C_1}{\mathsf{p}} \cat x_2:\tmap{C_2}{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}}  \proves  \map{P'}^{\mathsf{p}} \hastype \Proc
}
%\quad
%\tree{}{
%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_2:\tmap{C_2}{\mathsf{p}}  \proves  x_2 \hastype \tmap{C_2}{\mathsf{p}}}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat x_1:\tmap{C_1}{\mathsf{p}} \cat k:\btinp{\tmap{C_2}{\mathsf{p}}}\mapt{S}^{\mathsf{p}}  \proves  \binp{k}{x_2}\map{P'}^{\mathsf{p}} \hastype \Proc
}
%\quad
%\tree{}{
%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_1:\tmap{C_1}{\mathsf{p}}  \proves  x_1 \hastype \tmap{C_1}{\mathsf{p}}}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\btinp{\tmap{C_1}{\mathsf{p}}}\btinp{\tmap{C_2}{\mathsf{p}}}\mapt{S}^{\mathsf{p}}  \proves  \map{P}^{\mathsf{p}} \hastype \Proc
}
\]
\end{enumerate}
\qed
\end{proof}

\end{comment}

%\subsection{Properties for $\encod{\cdot}{\cdot}{1}: \sessp^{-\mu} \to \HO$}
%\label{app:enc_sesspnr_to_ho}

%\begin{proposition}\rm
%	\label{app:enc_sesspnr_to_ho_typing}
%	Encoding $\encod{\cdot}{\cdot}{1}: \sessp^{-\mu} \to \HO$  is type-preserving (cf. Def.~\ref{def:ep}\,(1)).\rm
%\end{proposition}

%We repeat the statement of Prop.~\ref{prop:typepres1}, as in Page \pageref{prop:typepres1}:

%\begin{proposition}[Type Preservation, First-Order into Higher-Order]
%Let $P$ be a  $\sessp^{-\mu}$ process.
%If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
%			$\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} \proves \map{P}^{1} \hastype \Proc$. 
%\end{proposition}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO HO
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Properties for encoding $\tyl{L}_{\HOp}$ into $\tyl{L}_{\HO}$}
\label{app:enc_HOp_to_HO}

%We repeat the statement of \propref{prop:typepres_HOp_to_HO},
%as in Page \pageref{prop:typepres_HOp_to_HO}:

In this section we prove \thmref{f:enc:hopitoho}, in Page~\pageref{f:enc:hopitoho}
that requires that encoding
$\tyl{L}_{\HOp}$ into $\tyl{L}_{\HO}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated in \propref{app:prop:typepres_HOp_to_HO}.
	\item	Operational Correspondence, stated in \propref{app:prop:op_corr_HOp_to_HO}.
		Note that we prove a stronger operational correspondence condition,
		as in \defref{app:def:opc_strong},
		than the condition suggested in \defref{def:ep}(2).
	\item	Full Abstraction, stated in \propref{app:prop:fulla_HOp_to_HO}.
\end{itemize}

%% Type Preservation

\begin{proposition}[Type Preservation, \HOp into \HO]
	\label{app:prop:typepres_HOp_to_HO}
	Let $P$ be a \HOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} \proves \pmapp{P}{1}{f} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the   inference of $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. %\jp{TO BE ADJUSTED!}
%
	\begin{enumerate}[1.]
		%%%% Output of (linear) channel
		\item	Case $P = \bout{k}{n}P'$. There are two sub-cases.
			In the first sub-case $n = k'$ (output of a linear channel). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P' \hastype \Proc \quad \Gamma ; \emptyset ; \{k' : S_1\} \proves  k' \hastype S_1}{
					\Gamma; \emptyset; \Delta \cat k':S_1 \cat k:\btout{S_1}S \proves  \bout{k}{k'} P' \hastype \Proc}
			\]
			}
			Thus, by IH we have
			$$
			\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmap{P'}{1} \hastype \Proc
			$$
			Let us write $U_1$
			to stand for $\lhot{\btinp{\lhot{\tmap{S_1}{1}}}\tinact}$.
			The corresponding typing in the target language is as follows:
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t1}
				\tree{
					\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} ; \set{x : \lhot{\tmap{S_1}{1}}} ; \emptyset \proves x  \hastype \lhot{\tmap{S_1}{1}}
								\qquad 
								\tmap{\Gamma}{1} ; \emptyset ; \set{k' : \tmap{S_1}{1}} \proves  k' \hastype \tmap{S_1}{1}
							}{
								\tmap{\Gamma}{1} ; \set{x : \lhot{\tmap{S_1}{1}}} ; k' : \tmap{S_1}{1} \proves \appl{x}{k'} \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1} ; \{x : \lhot{\tmap{S_1}{1}}\} ; k' : \tmap{S_1}{1} \cat z:\tinact \proves \appl{x}{k'} \hastype \Proc
						}
					}{
						\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \cat z:\btinp{\lhot{\tmap{S_1}{1}}}\tinact \proves \binp{z}{x} (\appl{x}{k'}) \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{x} (\appl{x}{k'})} \hastype U_1
				}
			\end{eqnarray}
			\begin{eqnarray*}
				\tree{
					\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmap{P'}{1} \hastype \Proc
					\qquad
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{x} (\appl{x}{k'})} \hastype U_1 \ \eqref{prop:sesspnr_to_HO_t1}
				}{
					\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k':\tmap{S_1}{1} \cat k:\btout{U_1}\tmap{S}{1} \proves  \bbout{k}{\abs{z}{\binp{z}{x} (\appl{x}{k'})}} \pmap{P'}{1} \hastype \Proc
				}
			\end{eqnarray*}
%
	
		%%%% Output of (shared) channel
			In the second sub-case, we have $n = a$ (output of a shared name). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma \cat a:\chtype{S_1}; \emptyset; \Delta \cat k:S  \proves
					P' \hastype \Proc \quad \Gamma \cat a:\chtype{S_1} ; \emptyset ; \emptyset \proves  a \hastype S_1
				}{
					\Gamma \cat a:\chtype{S_1} ; \emptyset; \Delta  \cat k:\bbtout{\chtype{S_1}}S \proves  \bout{k}{a} P' \hastype \Proc
				}
			\]
			}
			The typing in the target language is derived similarly as in the first sub-case. \\
	
		%%%% Input of (linear) channel 
		\item	Case $P = \binp{k}{x}Q$. We have two sub-cases, depending on the type of $x$.
			In the first case, $x$ stands for a linear channel.
			Then we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta  \cat k:S \cat x:S_1 \proves   Q \hastype \Proc
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btinp{S_1}S \proves  \binp{k}{x} Q \hastype \Proc
				}
			\]
			 }
			 Thus, by IH we have
			 $$
			 \tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat x:\tmap{S_1}{1} \proves  \pmap{Q}{1}   \hastype \Proc
			 $$
			 Let us write $U_1$ to stand for $\lhot{\btinp{\lhot{\tmap{S_1}{1}}}\tinact}$.
			 The corresponding typing in the target language is as follows:
			{\small
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t2}
				\tree{
					\tmap{\Gamma}{1}; \{X: U_1\};   \emptyset \proves X \hastype U_1
					\qquad
					\tmap{\Gamma}{1}; \emptyset;   \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves s \, \hastype  \btinp{\lhot{\tmap{S_1}{1}}} \tinact 
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};   \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{x}{s}  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t3}
				\tree{
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \emptyset \proves   \inact  \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \dual{s}: \tinact\proves   \inact  \hastype \Proc
					}
					\quad 
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  x:\tmap{S_1}{1} \proves \pmap{Q}{1}   \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}   \proves \abs{x} \pmap{Q}{1}   \hastype \lhot{\tmap{S_1}{1}}
					}
				}{
					\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves  \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t4}
		 		\tree{
					\begin{array}{cl}
						\tmap{\Gamma}{1}; \{X: U_1\}; \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{x}{s}  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t2}
						\\
						\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact \proves
						\bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t3}
					\end{array}
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves \appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
			}
			\end{eqnarray}
%
			\begin{eqnarray*}
			\\
			 \tree{
				 \tree{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves \appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc \quad \eqref{prop:sesspnr_to_HO_t4}
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}  \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1}  \cat k:\btinp{U_1}\tmap{S}{1} \proves  \binp{k}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}  \hastype \Proc
			}
			\end{eqnarray*}
			 }
			 
			 In the second sub-case, $x$ stands for a shared name. Then we have the following typing in the source language:
			\[
			 \tree{
				\Gamma \cat x:\chtype{S_1} ; \emptyset; \Delta  \cat k:S \proves   Q \hastype \Proc
			 }{
				\Gamma ; \emptyset; \Delta  \cat k:\btinp{\chtype{S_1}}S \proves  \binp{k}{x} Q \hastype \Proc}
			 \]
			 The typing in the target language is derived similarly as in the first sub-case.	

		\item	Case $P_0 = \varp{X}$.
			Then we have the following typing in the source language:
%
			\[
				\Gamma \cat \varp{X}: \Delta ;\, \es ;\, \es \proves \varp{X} \hastype \Proc
			\]
%
			Then the typing of $\pmapp{\varp{X}}{1}{f}$ is as follows,
			assuming $f(\varp{X}) = \tilde{n}$ and $\tilde{x} = \vmap{\tilde{n}}$.
			Also, we write $\Delta_{\tilde{n}}$ 
			and $\Delta_{\tilde{x}}$ 
			to stand for 
			$n_1: S_1, \ldots, n_m: S_m$ and
			$x_1: S_1, \ldots, x_m: S_m$, respectively. 
			Below, we assume that $\Gamma = \Gamma' \cat X:\shot{\tilde{T}}$, 
			where  
			%$$\tilde{T} =  \trec{t}{\big(\tilde{S}, \btinp{\vart{t}}\tinact\big)}$$.
			\[
				\tilde{T} = \big(\tilde{S}, S^*\big) \qquad \quad
				S^* = \bbtinp{A}\tinact \qquad \quad
				A = \trec{t}{(\tilde{S}, \btinp{\vart{t}}\tinact)}
			\]
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t1}
				\tree{
					\tree{
					}{
						\Gamma ;\, \es ;\, \es \proves z_X \hastype \shot{\tilde{T}}
					}
					\quad 
					\begin{array}{c}
						\Gamma ;\, \es ;\, \{n_i: S_i \} \proves n_i \hastype S_i \\
						\Gamma ;\, \es ;\, \{s: S^* \} \proves s\hastype S^*  \\
					\end{array}
				}{
					\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact
					\proves  
					\appl{z_X}{(\tilde{n}, s)} \hastype \Proc
				} 
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t2}
				\tree{
					\tree{
						\Gamma  ;\, \es ;\,   \es \proves \inact \hastype \Proc
					}{
						\Gamma  ;\, \es ;\,   \dual{s}: \tinact \proves \inact \hastype \Proc
					} 
					\quad
					\tree{
						\tree{
							\begin{array}{c}
								\Gamma ;\, \es ;\, \{x_i: S_i \} \proves x_i \hastype S_i \\
								\Gamma ;\, \es ;\, \{z: S^*  \} \proves z\hastype S^*  \\
								\Gamma ;\, \es ;\, \es \proves z_X \hastype \shot{\tilde{T}}  \\
							\end{array}
						}{
							\Gamma  ;\, \es ;\,   \Delta_{\tilde{x}}, \, z:S^*
							\proves 
							 {\appl{z_X}{( \tilde{x}, z)}} \hastype \Proc
						}
					}{
						\Gamma  ;\, \es ;\,   \es
						\proves 
						 \abs{(\tilde{x},z)}\,\,{\appl{z_X}{( \tilde{x}, z)}} \hastype \shot{\tilde{T}}
					} 	
				}{
					\Gamma  ;\, \es ;\,   \dual{s}: \btout{\shot{\tilde{T}}}\tinact
					\proves 
					\bbout{\dual{s}}{ \abs{(\tilde{x},z)}\,\,{\appl{z_X}{ (\tilde{x}, z)}}} \inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
			\tree{
				\tree{
					\begin{array}{cc}
						\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact
						\proves  
						\appl{z_X}{(\tilde{n}, s)} \hastype \Proc
						& \eqref{prop:sessp_to_HO_t1}
						\\ 
						\Gamma  ;\, \es ;\,   \dual{s}: \btout{\shot{\tilde{T}}}\tinact
						\proves 
						\bbout{\dual{s}}{ \abs{(\tilde{x},z)}\,\,{\appl{z_X}{ (\tilde{x}, z)}}} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t2}
					\end{array}
				}{
					\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact, \, \dual{s}: \btout{\shot{\tilde{T}}}\tinact
					\proves 
					\appl{z_X}{(\tilde{n}, s)} \Par 
					\bbout{\dual{s}}{ \abs{(\tilde{x},z)}\,\,{\appl{x}{ (\tilde{x}, z)}}} \inact \hastype \Proc
				}
			}{
				\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}
				\proves 
				\newsp{s}{\appl{z_X}{(\tilde{n}, s)} \Par \bbout{\dual{s}}{ \abs{(\tilde{x},z)}\,\,{\appl{z_X}{ (\tilde{x}, z}})} \inact} \hastype \Proc
			}
			\]
%	
		\item	Case $P_0 = \recp{X}{P}$. Then we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat \varp{X}:\Delta ;\, \es ;\,  \Delta \proves P \hastype \Proc
				}{
					\Gamma  ;\, \es ;\,  \Delta \proves \recp{X}{P} \hastype \Proc
				}
			\]
%	
			Then we have the following typing in the target language ---we write $R$
			to stand for $\pmapp{P}{1}{{f,\{\varp{X}\to \tilde{n}\}} }$
			and $\tilde{x}$ to stand for $\vmap{\ofn{P}}$.
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t4}
				\tree{
					\tree{
						\tmap{\Gamma}{1}\cat z_X:\shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}
						\proves
						 R  \hastype \Proc
					}{
						\tmap{\Gamma}{1}\cat z_X:\shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\tinact 
						\proves
						 R  \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact 
					\proves
					\binp{s}{z_X} R  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t5}
				\tree{
					\tree{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						\inact \hastype \Proc
					}{
						\tmap{\Gamma}{1};\, \es;\, \dual{s}:\tinact
						\proves
						\inact \hastype \Proc
					} 
					\quad 
					\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} \cat z_X: \shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}
								\proves
								{{\auxmap{R}{\es}}}  \hastype \Proc
							}{
								\tmap{\Gamma}{1} \cat z_X: \shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1},
								y: \tinact
								\proves
								{{\auxmap{R}{\es}}}  \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}, \, y: \btinp{A}\tinact
							\proves
							{{\binp{y}{z_X} \auxmap{R}{\es}}}  \hastype \Proc
						}
					}{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmap{R}{\es}}}  \hastype \shot{\tilde{T}}
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{\tilde{T}}}\tinact
					\proves
					\bbout{\dual{s}}{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmap{R}{\es}}} \inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
			\tree{
				\tree{
					\begin{array}{cc}
						\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact 
						\proves
						\binp{s}{z_X} R  \hastype \Proc
						& \eqref{prop:sessp_to_HO_t4}
						\\
						\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{\tilde{T}}}\tinact
						\proves
						\bbout{\dual{s}}{\abs{(\tilde{x}, y) } \,{\binp{y}{z_X} \auxmap{R}{\es}}} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t5}
					\end{array}
				}{
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact , \dual{s}:\btout{\shot{\tilde{T}}}\tinact
					\proves
					\binp{s}{z_X} R \Par 
					\bbout{\dual{s}}{\abs{(\tilde{x}, y )} \,{\binp{y}{z_X} \auxmap{R}{\es}}} \inact \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1} 
				\proves
				\newsp{s}{\binp{s}{z_X} R \Par 
				\bbout{\dual{s}}{\abs{(\tilde{x},y) } \,{\binp{y}{z_X} \auxmap{R}{\es}}} \inact} \hastype \Proc
			}
			\]
	\end{enumerate}
	\qed
\end{proof}


%%% Operational Correspondence

%We repeat the statement of
%\propref{prop:op_corr_HOp_to_HO}, 
%as in Page \pageref{prop:op_corr_HOp_to_HO}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{1}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{1}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%
%\[
%	\begin{array}{c}
%		\mapa{(\nu \tilde{m})\bactout{n}{m}}^{1}
%		\defeq
%		(\nu \tilde{m})\bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})} }
%		\qquad
%		\mapa{\bactinp{n}{m}}^{1}
%		\defeq
%		\bactinp{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})} }
%		\\
%		\mapa{(\nu \tilde{m})\bactout{n}{\abs{{x}}{P}}}^{1}
%		\defeq
%		(\nu \tilde{m})\bactout{n}{\abs{{x}}{\pmapp{P}{1}{\es}}}
%		\\
%		\mapa{\bactinp{n}{\abs{{x}}{P}}}^{1}
%		\defeq
%		\bactinp{n}{\abs{{x}}{\pmapp{P}{1}{\es}}}
%		\qquad
%		\mapa{\bactsel{n}{l} }^{1} \defeq \bactsel{n}{l} 
%		\qquad
%		\mapa{\bactbra{n}{l} }^{1} \defeq \bactbra{n}{l} 
%		\qquad \quad 
%		\mapa{\tau}^{1} \defeq \tau
%	\end{array}
%\]
%\end{definition}

We now state and prove a detailed version of the operational corresponce
in \defref{app:def:opc_strong}.

\begin{proposition}[Operational Correspondence, \HOp into \HO]\rm
	\label{app:prop:op_corr_HOp_to_HO}
	Let $P$ be a \HOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then:
%
	\begin{enumerate}[1.]
		\item
			Suppose $\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P'}$. Then we have:
%
			\begin{enumerate}[a)]
				\item
					If $\ell_1 \in \set{\news{\tilde{m}}\bactout{n}{m}, \,\news{\tilde{m}}\bactout{n}{\abs{x}Q}, \,\bactsel{s}{l}, \,\bactbra{s}{l}}$
					then $\exists \ell_2$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{\pmapp{P'}{1}{f}}$
					and $\ell_2 = \mapa{\ell_1}^{1}$.
			
				\item
					If $\ell_1 = \bactinp{n}{\abs{y}Q}$ and
					$P' = P_0 \subst{\abs{y}Q}{x}$
					then $\exists \ell_2$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{\pmapp{P_0}{1}{f}\subst{\abs{y}\pmapp{Q}{1}{\emptyset}}{x}}$
					and $\ell_2 = \mapa{\ell_1}^{1}$.
			
				\item
					If $\ell_1 = \bactinp{n}{m}$
					and 
					$P' = P_0 \subst{m}{x}$
					then $\exists \ell_2$, $R$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{R}$,
					with $\ell_2 = \mapa{\ell_1}^{1}$, \\
					and
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta'}{1}}{R}{\hby{\stau} \hby{\btau} \hby{\btau}}
					{\tmap{\Delta'}{1}}{\pmapp{P_0}{1}{f}\subst{m}{x}}$.
						
				\item
					If $\ell_1 = \tau$
					and $P' \scong \newsp{\tilde{m}}{P_1 \Par P_2\subst{m}{x}}$
					then $\exists R$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}{\mapt{\Delta}^{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par R}}$,
					and\\ 
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par R}}{\hby{\stau} \hby{\btau} \hby{\btau}}
					{\mapt{\Delta}^{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par \pmapp{P_2}{1}{f}\subst{m}{x}}}$.
			
				\item
					If $\ell_1 = \tau$
					and $P' \scong \newsp{\tilde{m}}{P_1 \Par P_2 \subst{\abs{y}Q}{x}}$
					then \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}
					{\tmap{\Delta_1}{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f}\Par \pmapp{P_2}{1}{f}\subst{\abs{y}\pmapp{Q}{1}{\emptyset}}{x}}}$.
			
				\item
					If $\ell_1 = \tau$
					and $P' \not\scong \newsp{\tilde{m}}{P_1 \Par P_2 \subst{m}{x}} \land P' \not\scong \newsp{\tilde{m}}{P_1 \Par P_2\subst{\abs{y}Q}{x}}$
					then \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}{\tmap{\Delta'_1}{1}}{ \pmapp{P'}{1}{f}}$.
			\end{enumerate}
			
		\item	Suppose $\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{Q}$.
			Then we have:
%
			\begin{enumerate}[a)]
				\item 
					If $\ell_2 \in
					\set{\news{\tilde{m}}\bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}, \,\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \,\bactsel{s}{l}, \,\bactbra{s}{l}}$
					then $\exists \ell_1, P'$ s.t. \\
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P'}$, 
					$\ell_1 = \mapa{\ell_2}^{1}$, 
					and
					$Q = \pmapp{P'}{1}{f}$.
			
				\item 
					If $\ell_2 = \bactinp{n}{\abs{y} R}$ %(with $R \neq \binp{y}{x} \appl{x}{m}$)
					then either:
%
					\begin{enumerate}[(i)]
						\item	$\exists \ell_1, x, P', P''$ s.t. \\
							$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P' \subst{\abs{y}P''}{x}}$, 
							$\ell_1 = \mapa{\ell_2}^{1}$, $\pmapp{P''}{1}{\es} = R$, and $Q = \pmapp{P'}{1}{f}$.

						\item	$R \scong \binp{y}{x} (\appl{x}{m})$ and 
							$\exists \ell_1, z, P'$ s.t. \\
							$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P' \subst{m}{z}}$, 
							$\ell_1 = \mapa{\ell_2}^{1}$,
							and\\
							$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta'}{1}}{Q}{\hby{\stau} \hby{\btau} \hby{\btau}}{\tmap{\Delta''}{1}}{\pmapp{P'\subst{m}{z}}{1}{f}}$
					\end{enumerate}
			
				\item 
					If $\ell_2 = \tau$ 
					then $\Delta' = \Delta$ and 
					either
%
					\begin{enumerate}[(i)]
						\item	$\exists P'$ s.t. 
							$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta}{P'}$,
							and $Q = \map{P'}^{1}_f$.	

						\item
							$\exists P_1, P_2, x, m, Q'$ s.t. 
							$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta}{\newsp{\tilde{m}}{P_1 \Par P_2\subst{m}{x}} }$, and\\
							$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{Q}{\hby{\stau} \hby{\btau} \hby{\btau}}{\tmap{\Delta}{1}}{\pmapp{P_1}{1}{f} \Par \pmapp{P_2\subst{m}{x}}{1}{f}}$ 
%							$Q = \map{P_1}^{1}_f \Par Q'$, where $Q'  \Hby{} $.

%						\item $\exists P_1, P_2, x, R$ s.t. 
%						$\stytra{ \Gamma }{\tau}{ \Delta }{ P}{ \Delta}{ \news{\tilde{m}}(P_1 \Par P_2\subst{\abs{y}R}{x}) }$, and 
%						$Q = \map{\news{\tilde{m}}(P_1 \Par P_2\subst{\abs{y}R}{x})}^{1}_f$.
			\end{enumerate}
		    \end{enumerate}
		    
%		\item   
%			If  $\wtytra{\mapt{\Gamma}^{1}}{\ell_2}{\mapt{\Delta}^{1}}{\pmapp{P}{1}{f}}{\mapt{\Delta'}^{1}}{Q}$
%			then $\exists \ell_1, P'$ s.t.  \\
%			(i)~$\stytra{\Gamma}{\ell_1}{\Delta}{P}{\Delta'}{P'}$,
%			(ii)~$\ell_2 = \mapa{\ell_1}^{1}$, 
%			(iii)~$\wbb{\mapt{\Gamma}^{1}}{\ell}{\mapt{\Delta'}^{1}}{\pmapp{P'}{1}{f}}{\mapt{\Delta'}^{1}}{Q}$.
	\end{enumerate}
\end{proposition}


\begin{proof}

By transition induction. We consider parts (1) and (2) separately:

\noi \textbf{Part (1) - Completeness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
	%%  Output 
	\item	Subcase  (a): $P =\bout{s}{n} P'$ and $\ell_1 = \bactout{s}{n}$ (the case $\ell_1 = \news{n}\bactout{s}{n}$ is similar). By assumption, $P$ is well-typed. 
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat s:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{n{:} S\}  \proves   n \hastype S }{
				\Gamma; \emptyset; \Delta_0 \cat n{:}S \cat s:\btout{S}S_1 \proves \bout{s}{n} P' \hastype \Proc}
		\]
%
		\noi for some $S, S_1, \Delta_0$.
		%such that $\Delta = \Delta_0 \cat k_1{:}T  \cat k:\btout{T}S$.
		We may then have the following transition:
%
		\[
			\stytra{\Gamma}{\ell_1}{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1 }{\bout{s}{n} P'}{\Delta_0 \cat s{:}S_1 }{P'}
		\]
%
		\noi The encoding of the source judgment for $P$ is as follows:
%
		\[
			\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1}^{1} \proves \map{\bout{s}{n} P'}^{1} \hastype \Proc
		\]
%
		\noi which, using \defref{d:enc:hopitoho} can be expressed as 
%
		\[
			\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_0} 
			\cat n{:}\mapt{S}^{1} 
			\cat s: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} (\appl{x}{n})} } \pmap{P'}{1}
			\hastype \Proc
		\]
%
		\noi Now, $\mapa{\ell_1}^{1} = \bactout{s}{\abs{z}{\,\binp{z}{x} \appl{x}{n}}\, } $. 
		We may infer the following  transition for $\map{P}^{1}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} 
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} (\appl{x}{n})} } \pmap{P'}{1}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}} & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0}^{1} 
			\cat s:  \tmap{S_1}{1}
			\proves  \pmap{P'}{1}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0 \cat s:  S_1}^{1}
			\proves  \pmap{P'}{1}
			\hastype \Proc 
		\end{eqnarray*}
%
		\noi from which the thesis follows easily.

	\item	Subcase (c): $P = \binp{n}{x} P'$	and $\ell_1 = \bactinp{n}{m}$.
		By assumption $P$ is well-typed.
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat x:S \cat n:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{x: S\}  \proves   x\hastype S}{
				\Gamma; \emptyset; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc}
		\]
%
		for some  $S, S_1, \Delta_0$.
%		such that $\Delta = \Delta_0 \cat k:\btinp{T}S$.
		We may infer the following typed transition:
%
		\[
			\Gamma; \emptyset; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc
			\hby{\bactinp{n}{m}}
			\Gamma; \emptyset; \Delta_0 \cat  n:S_1 \cat m:S \proves   P'\subst{m}{x} \hastype \Proc
		\]
%
		The encoding of the source judgment for $P$ is as follows:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 \cat   n:\btinp{S}S_1 }^{1} \proves 
			\map{P}^{1}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc
		\end{eqnarray*}
%
		Now, 
		$\mapa{\ell_1}^{1} = \bactinp{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}\, }$
		and it is immediate to infer the following 
		transition for $\map{P}^{1}$:
%
		\begin{eqnarray*}
			&  & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}}  & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   
			n:  \tmap{S_1}{1} \cat m:  \tmap{S}{1} \proves 
			 \newsp{s}{(\appl{x}{s}) \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}{x}
			\hastype \Proc 
		\end{eqnarray*}
%
		Let us write $R$ to stand for process 
		$\newsp{s}{(\appl{x}{s}) 
		\Par 
		\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}{x}$. 
		%$\newsp{s}{\appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}{X}$.
		We then have:
		\begin{eqnarray*}
		R & \by{\tau} & \newsp{s}{\binp{s}{x} (\appl{x}{m})
							\Par 
							\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \\
		& \by{\tau} &  \appl{(\abs{x}{\pmap{P'}{1}})}{m} \Par \inact \\
		& \by{\tau} & \pmap{P'}{1}\subst{m}{x}
		\end{eqnarray*}
		and so the thesis follows.

		%%%%%%%%%%%
		%%  Recursion
		%%%%%%%%%%%

%	\item	Case $P =\recp{X}{P'}$ and $P = \varp{X}$.
%
%		It follows similar arguments with the previous cases
%		and uses Prop.~\ref{prop:op_corr_HOprec_to_HO} whenever necessary.
		
\end{enumerate}
%
\noi \textbf{Part (2) - Soundness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
		%%%%%%%%%%%
		%%  Output 
		%%%%%%%%%%%
	\item Subcase (a): $P = \bout{n}{m} P'$ and $\ell_2 = \bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$
	(the case $\ell_2 = \news{m}\bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$ is similar).
		%,  $\map{P}^{1} = \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1}$.
		Then 
		we have: % the following typed transition for $\map{P}^{1}$:
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} (\appl{x}{m})} } \pmap{P'}{1} 
			 \hastype \Proc
		\]
%
		for some $S, S_1$, and $\Delta_0$. 
		We may infer the following typed transition for $\pmap{P}{1}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} (\appl{x}{m})} } \pmap{P'}{1} 
			 \\
			%& & \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1} \hby{\bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}} \pmap{P'}{1}  \\
			&\hby{\ell_2}& 
			\mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \tmap{S_1}{1} 
			\proves  \pmap{P'}{1} 
		\end{eqnarray*}
%
		%with $\ell_2 = \bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}$.
		Now, in the source term $P$ we can infer the following transition 
%
		\[
		\Gamma;\,  \Delta_0 \cat n:\btout{S} S_1 \proves \bout{n}{m} P'
		 \hby{\bactout{n}{m}} 
		 \Gamma;\,  \Delta_0 \cat n: S_1 \proves P'
		\]
%
		and thus the thesis follows easily by noticing that 
		$\mapa{\bactout{n}{m}}^{1} = \bactout{n}{\abs{z}{\,\binp{z}{x} (\appl{x}{m})}}$.


		%%%%%%%%%%%
		%% Input
		%%%%%%%%%%%
	\item	Subcase (c): $P = \binp{n}{x} P'$ and $\ell_2 = \bactinp{n}{\abs{y}\binp{y}{x} (\appl{x}{m})}$.
		Then we have
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{(\appl{x}{s})
			\Par 
			\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc
		\]
%
		for some $S$, $S_1$, $\Delta_0$.
		We may infer the following typed transitions for $\pmap{P}{1}$:
%
		\begin{eqnarray*}
			& & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{(\appl{x}{s}) 
							\Par 
							\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \\
			& \hby{\ell_2} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n:\tmap{S_1}{1}
			\cat m:\tmap{S_1}{1}
			\proves
			\newsp{s}{(\appl{x}{s}) 
				\Par 
				\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \subst{\abs{z}\binp{z}{x}\appl{x}{m}}{x} \\
			& = & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\newsp{s}{\binp{s}{x}(\appl{x}{m}) 
				\Par 
				\bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}  \\
			& \hby{\tau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\appl{(\abs{x}{\pmap{P'}{1}})}{m}   \\
			& \hby{\tau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\pmap{P'}{1}\subst{m}{x}   
		\end{eqnarray*}
%
		%with $\ell_2 = \bactinp{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}$.
		Now, in the source term $P$ we can infer the following transition 
%
		\[
			\Gamma;\,  \Delta_0 \cat n:\btinp{S} S_1 \proves \binp{n}{x} P'
			\hby{\bactinp{n}{m}} 
			\Gamma;\,  \Delta_0 \cat n: S_1 \cat m: S \proves P'\subst{m}{x}
		\]
%
		and the thesis follows.
%		 easily by noticing that $\mapa{\bactinp{k}{k_1}}^{1} = \bactinp{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}$.

		%%%%%%%%%%%
		%%  Recursion
		%%%%%%%%%%%
%	\item	Case $P =\recp{X}{P'}$ and $P = \varp{X}$.
%
%		It follows similar arguments with the previous case
%		and uses Prop.~\ref{prop:op_corr_HOprec_to_HO} whenever nescessary.
\end{enumerate}
\qed
\end{proof}


%%%%%%%% Full Abstraction

%We repeat the statement of
%\propref{prop:fulla_HOp_to_HO}, 
%as in Page~\pageref{prop:fulla_HOp_to_HO}:

\begin{proposition}[Full Abstraction, \HOp into \HO]\rm
	\label{app:prop:fulla_HOp_to_HO}
	$\horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1}$
	if and only if
	$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta_1}{1}}{\pmapp{P_1}{1}{f}}{\wb}{\tmap{\Delta_2}{1}}{\pmapp{Q_2}{1}{f}}$.
\end{proposition}

\begin{proof}
	\noi {\bf Proof of Soundness Direction.}

	\noi Let
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1} \setbar \horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\wb}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}}
	\]
%
	\noi	The proof considers a case analysis on the transition $\hby{\ell}$ and
		uses the soundness direction of operational correspondence (cf.~\propref{app:prop:op_corr_HOp_to_HO}).
		We give an interesting case. The others are similar of easier.

	\noi	- Case: $\ell = \news{\tilde{m_1}'} \bactout{n}{m_1}$.

	\noi \propref{app:prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}
	\]
%
	\noi implies
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi that in combination with the definition of $\Re$ we get
%
	\begin{eqnarray}
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs11}
	\end{eqnarray}
%
	\noi and
%
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\newsp{\tilde{m_1}'}{\pmapp{P_2}{1}{f} 
			\Par 
			\hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}} }}
		{\wb}{\mapt{\Delta_2'}^{1}}{}{\newsp{\tilde{m_2}'}{\pmapp{Q_2}{1}{f} 
			\Par 
				\hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}
	\]
%
	\noi We rewrite the last result as
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 
			\Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\wb}{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi to conclude that
%
	\[
		\mhorel{\Gamma}{\Delta_1'}{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}
		{\ \Re\ }{\Delta_2'}{}{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}
	\]
%
	\noi as required


	\noi {\bf Proof of Completeness Direction.}

	\noi Let
%
	\[
		\Re = \set{\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{,}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}} \setbar \horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1}}
	\]
%
	We show that $\Re \subset \wb$ by a case analysis on the action $\ell$

	\noi - Case: $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{P}},\, \bactinp{n}{\abs{x}{P}}}$.

	\noi The proof of \propref{app:prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
	\]
%
	\noi From the latter transition and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\ell}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs1}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\wb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs2}
	\end{eqnarray}
%
	\noi From~\ref{prop:HOp_to_HO:full_abs1} and \propref{app:prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\ell}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\ref{prop:HOp_to_HO:full_abs2} and the definition of $\Re$ we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi as required.

	\noi - Case: $\ell = \news{\tilde{m}} \bactout{n}{\abs{x}{P}}$

	\noi There are two subcases:

	\noi -Subcase:

	\noi The proof of \propref{app:prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
	\]
%
	\noi where the proof is similar with the previous case.

	\noi - Subcase:

	\noi The proof of \propref{app:prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_1})}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}
	\]
%
	\noi From the latter transition and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\tilde{m_2}'} \bactout{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs3}
	\end{eqnarray}
%
	\noi and
%
	\begin{eqnarray}
		& \Gamma; \es; \Delta_1' & \proves \newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}} \nonumber \\
		& \wb & \Delta_2' \proves \newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}
		\label{prop:HOp_to_HO:full_abs4}
	\end{eqnarray}
%
	\noi From~\eqref{prop:HOp_to_HO:full_abs3} and \propref{app:prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} (\appl{x}{m_2})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\eqref{prop:HOp_to_HO:full_abs4} and the definition of $\Re$ we get
%
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\ \Re\ }{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi as required.

	\noi - Case: $\ell = \bactinp{n}{\abs{x}{P}}$

	\noi We have two subcases.

	\noi - Subcase: Similar with the first subcase of the previous case.

	\noi - Subcase:
	\noi The proof of \propref{app:prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\bactinp{n}{\abs{z}{ \binp{z}{x} (\appl{x}{s})}}}}{\mapt{\Delta_1''}^{1}} R %{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{m_1}}}{\Delta_1'}{P_2}
		\label{prop:HOp_to_HO:full_abs7}
	\end{eqnarray}
%
	\noi and
%
	\begin{eqnarray}
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\hby{\stau}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs8}
	\end{eqnarray}
%
%	\noi With the last transition happening on a restricted session channel.
%	From \dk{Lemma~\ref{lem:tau_inert}} we can conclude that
%	\begin{eqnarray}
%		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\wb}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
%		\label{prop:HOp_to_HO:full_abs9}
%	\end{eqnarray}
%
	\noi From the transition~\eqref{prop:HOp_to_HO:full_abs7} and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs5}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\wb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs6}
	\end{eqnarray}
%
	\noi From~\eqref{prop:HOp_to_HO:full_abs5} and \propref{app:prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\bactinp{n}{\abs{z}{\binp{z}{x} (\appl{x}{s})}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\ref{prop:HOp_to_HO:full_abs6} and the definition of $\Re$ we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi If we consider result~\eqref{prop:HOp_to_HO:full_abs8} we get:
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\hby{\stau}\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
	where following \lemref{lem:up_to_deterministic_transition} we show that $R$ is a bisimulation an up to $\Hby{\stau}$.
	\qed
\end{proof}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO SESSP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Properties for encoding $\tyl{L}_{\HOp}$ into $\tyl{L}_{\sessp}$}
\label{app:enc:HOp_to_sessp}

In this section we prove \thmref{f:enc:hotopi}, in Page~\pageref{f:enc:hotopi}
that requires that encoding
$\tyl{L}_{\HOp}$ into $\tyl{L}_{\sessp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated in \propref{app:prop:typepres_HOp_to_p}.
	\item	Operational Correspondence, stated in \propref{app:prop:op_corr_HOp_to_p}.
		Note that we prove a stronger operational correspondence condition,
		as in \defref{app:def:opc_strong},
		than the condition suggested in \defref{def:ep}(2).
	\item	Full Abstraction, stated in \propref{app:prop:fulla_HOp_to_p}.
\end{itemize}

%We repeat the statement of \propref{prop:typepres_HOp_to_p},
%as in Page \pageref{prop:typepres_HOp_to_p}:

\begin{proposition}[Type Preservation, \HOp into \sessp]\rm
	\label{app:prop:typepres_HOp_to_p}
	Let $P$ be a \HOp process. \\
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$.
\end{proposition}


%\begin{proposition}[Type Preservation, Higher-Order into First-Order]
%Let $P$ be an  $\HO$ process. 
%If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
%			$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$. 
%\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
%	By induction on the structure of \HO process $P$.  \jp{TO BE ADJUSTED!}
	\begin{enumerate}[1.]

	%%%% Output of (linear) channel
		\item	Case $P = \bbout{k}{\abs{x}{Q}}P$. Then we have two possibilities, depending on the typing for $\abs{x}Q$.
			The first case concerns a linear typing, and  
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta_1 \cat k:S  \proves  P \hastype \Proc
					\quad
					\tree{
						\Gamma ; \emptyset ; \Delta_2\cat x:S_1 \proves  Q \hastype \Proc
					}{
						\Gamma ; \emptyset ; \Delta_2 \proves  \abs{x}Q \hastype \lhot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
%			
			This way, by IH we have
			$$
			\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2}, x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
			$$
			Let us write 
			 $U_1$ to stand for 
			$\chtype{\btinp{\tmap{S_1}{2}}\tinact}$.
			The corresponding typing in the target language is as follows: 
%
			\begin{eqnarray*}
				\tmap{\Gamma_1}{2} & = & \tmap{\Gamma}{2} \cup a:\chtype{\btinp{\tmap{S_1}{2}}\tinact} \\
				\tmap{\Gamma_2}{2} & = & \tmap{\Gamma_1}{2} \cup \varp{X}:\tmap{\Delta_2}{2}
			\end{eqnarray*}
%
			Also $(*)$ stands for $\tmap{\Gamma_1}{2}; \es ; \es \proves a \hastype U_1$; 
			$(**)$ stands for $\tmap{\Gamma_2}{2}; \es ; \es \proves a \hastype U_1$; and
			$(***)$ stands for $\tmap{\Gamma_2}{2}; \es ; \es \proves \varp{X} \hastype \Proc$.
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t1}
				\tree{
					\tree{
						\tree{
						}{
							(***)
						} 
						\quad 
						\tree{
							\tree{
								\tree{
									\tree{
									}{
										\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2},  x:\tmap{S_1}{2}
										\proves 
										\pmap{Q}{2} \hastype \Proc
									}
								}{
									\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}, y:\tinact, x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
								}
							}{
								\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}, y: \btinp{\tmap{S_1}{2}}\tinact
								\proves 
								\binp{y}{x}\pmap{Q}{2} \hastype \Proc
							} 
							\quad 
							\tree{
							}{
								(**)
							}
						}{
							\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
							\proves 
							\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \hastype \Proc
						} 
					}{
						\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
						\proves 
						\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X} \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
					\proves 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t2}
				\tree{
					\begin{array}{c}
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1}{2}, k:\tmap{S}{2} 
						\proves 
						\pmap{P}{2}  \hastype \Proc
						\\
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
						\proves 
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
						\quad \eqref{prop:HO_to_sessp_t1}
					\end{array}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\tmap{S}{2} 
					\proves 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
%
			\[
				\tree{
					\tree{
						\begin{array}{c}
							\tmap{\Gamma_1}{2}; \es ; \es \proves a \hastype U_1
							\\
							\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\tmap{S}{2} 
							\proves 
							\pmap{P}{2} \Par 
							\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t2}
						\end{array}
					}{
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\bbtout{U_1}\tmap{S}{2} 
						\proves 
						\bout{k}{a}(\pmap{P}{2} \Par 
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\bbtout{U_1}\tmap{S}{2} 
					\proves 
					\newsp{a}{\bout{k}{a}( 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))}} \hastype \Proc
				}
			\]
%
			In the second case, $\abs{x}Q$ has a shared type. We have the following typing in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P \hastype \Proc
					\quad 
					\tree{
						\tree{
							\Gamma ; \emptyset ; \cat x:S_1 \proves  Q \hastype \Proc
						}{
							\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \lhot{S_1}
						}
					}{
						\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \shot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btout{\shot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
%
			The corresponding typing in the target language can be derived similarly as in the first case.
	
		\item	Case $P = \binp{k}{x} P$. Then there are two cases, depending on the type of $X$. 
			In the first case,
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat x : \shot{S_1};\, \emptyset ;\, \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\shot{S_1}}S \proves  \binp{k}{x} P \hastype \Proc
				}
			\]
			The corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tree{}{\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc}
				}{
					\tmap{\Gamma}{2};\, \emptyset; \, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
			In the second case,  
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma;\, \{x : \lhot{S_1}\};\, \emptyset ;\, \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\lhot{S_1}}S \proves  \binp{k}{x} P \hastype \Proc
				}
			\]
%
			The corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc
				}{
					\tmap{\Gamma}{2};\, \emptyset;\, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
		\item	Case $P = \appl{x}{k}$. Also here we have two cases, depending on whether $X$ has linear or shared type.
			In the first case, $x$ is linear and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma ;\, \{x : \lhot{S_1}\};\,  \es \proves  X \hastype \lhot{S_1} \quad \Gamma; \es ; \{k:S_1\} \proves k \hastype S_1
				}{
					\Gamma;\, \{x : \lhot{S_1}\};\, k:S_1 \proves  \appl{x}{k} \hastype \Proc}
			\]
			Let us write
			$\tmap{\Gamma_1}{2}$ to stand for $\tmap{\Gamma}{2} \cat x:\chtype{\btout{\tmap{S_1}{2}}\tinact}$.
			The corresponding typing in the target language is as follows:
%
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t11}
				\tree{
					\tree{
						\tmap{\Gamma_1}{2};\, \es;\,  \es \proves  \inact \hastype \Proc
					}{
						\tmap{\Gamma_1}{2};\, \es;\,  \dual{s}:\tinact \proves  \inact \hastype \Proc
					}
					\quad 
						\tmap{\Gamma_1}{2};\, \es;\, \{k:\tmap{S_1}{2}\} \proves  k \hastype \tmap{S_1}{2} 
				}{
					\tmap{\Gamma_1}{2};\, \es;\,\, k:\tmap{S_1}{2},\,  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves  \bout{\dual{s}}{k}\inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
				\tree{
					\tree{
						\begin{array}{c}
							\tmap{\Gamma_1}{2};\, \es;\,\, k:\tmap{S_1}{2},\,  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves
							\bout{\dual{s}}{k}\inact \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t11}
							\\
							\tmap{\Gamma_1}{2} ;\, \es ;\, \es \proves x \hastype \chtype{\btout{\tmap{S_1}{2}}\tinact}
						\end{array}
					}{
						\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2}, s:\btinp{\tmap{S_1}{2}}\tinact , \dual{s}:\btout{\tmap{S_1}{2}}\tinact
						\proves
						\bout{x}{s}\bout{\dual{s}}{k}\inact \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2} \proves  \news{s}{(\bout{x}{s}\bout{\dual{s}}{k}\inact)} \hastype \Proc
				}
	\]
%
			In the second case, $x$ is shared, and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat  x : \lhot{S_1} ;\,  \es ;\,  \es \proves  x \hastype \shot{S_1} \quad \Gamma; \es ; k:S_1 \proves k \hastype S_1
				}{
					\Gamma \cat x : \shot{S_1};\, \es ;\, k:S_1 \proves  \appl{x}{k} \hastype \Proc
				}
			\]
%
			The associated typing in the target language is obtained similarly as in the first case. \qed
	\end{enumerate}
\end{proof}

%We repeat the statement of
%\propref{prop:op_corr_HOp_to_p}, 
%as in Page \pageref{prop:op_corr_HOp_to_p}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{2}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{2}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%	\begin{align*}
%		\mapa{(\nu \tilde{m})\bactout{n}{\abs{ x}{P}} }^{2} & \defeq \news{m} \bactout{n}{m}
%		&
%		\mapa{\bactinp{n}{\abs{ x}{P}} }^{2} & \defeq \bactinp{n}{m} \quad \quad m \text{ fresh}
%	\end{align*}
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}

We now state and prove a detailed and extended
version of the operational correspondence:
%in \defref{app:def:opc_strong}.

\begin{proposition}[Operational Correspondence, \HOp into \sessp]\myrm
	\label{app:prop:op_corr_HOp_to_p}
	Let $P$ be an  $\HOp$ process such that  $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	
	\begin{enumerate}[1.]
		\item Suppose $\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P'}$.
		Then we have:
		\begin{enumerate}[a)]
			\item
				If  $\ell_1 = \news{\tilde{m}}\bactout{n}{\abs{x}Q}$,
				then $\exists \Gamma', \Delta''$ where either:
				\begin{enumerate}[-]
					\item 
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves  \pmap{P}{2} 
						\hby{\mapa{\ell_1}^{2}}
						\Gamma' \cdot \tmap{\Gamma}{2};\, \tmap{\Delta'}{2} \proves \pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}$
					\item 
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves \pmap{P}{2} 
						\hby{\mapa{\ell_1}^{2}}
						\tmap{\Gamma}{2};\, \Delta'' \proves \pmap{P'}{2} \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}$
				\end{enumerate}

			\item
				If   
				$\ell_1 = \bactinp{n}{\abs{y}Q}$
				then $\exists R$ where
				either
				\begin{enumerate}[-]
					\item 
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves \pmap{P}{2} 
						\hby{\mapa{\ell_1}^{2}}
						\Gamma';\, \tmap{\Delta''}{2} \proves  R$, for some $ \Gamma'$
						and \\ 
						$\horel{\tmap{\Gamma}{2}}{\tmap{\Delta'}{2}}{\pmap{P'}{2}}{\wb}{\tmap{\Delta''}{2}}{\newsp{a}{R \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}$
					\item 
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves \pmap{P}{2}
						\hby{\mapa{\ell_1}^{2}}
						\tmap{\Gamma}{2};\, \tmap{\Delta''}{2} \proves R$, 
						and \\ 
						$\horel{\tmap{\Gamma}{2}}{\tmap{\Delta'}{2}}{\pmap{P'}{2}}{\wb}{\tmap{\Delta''}{2}}{\newsp{s}{R \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}}}$  		
				\end{enumerate}

			\item	If
				$\ell_1 = \tau$ then either:

				\begin{enumerate}[-]
					\item	%$\exists R$ such that
						$
						\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}
						{\hby{\tau}}
						{\tmap{\Delta'}{2}}{}{\newsp{\tilde{m}}{\pmap{P_1}{2} \Par \newsp{a}
						{\pmap{P_2}{2}\subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}}
						$, for some $P_1$, $P_2$, $Q$;

					\item	%$\exists R$ such that
						$
						\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}
						{\hby{\tau}}
						{\tmap{\Delta'}{2}}{}{\newsp{\tilde{m}}{\pmap{P_1}{2} \Par \newsp{s}
						{\pmap{P_2}{2}\subst{\dual{s}}{x} \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}}}}
						$, for some $P_1$, $P_2$, $Q$;

					\item	%$\ell_1 = \btau$ and
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves \pmap{P}{2}
						\hby{\tau}
						\tmap{\Gamma}{2};\, \tmap{\Delta'}{2} \proves \pmap{P'}{2}$


				\end{enumerate}
				
				\item	If $\ell_1 = \btau$ then
						$\tmap{\Gamma}{2};\, \tmap{\Delta}{2} \proves \pmap{P}{2}
						\hby{\stau}
						\tmap{\Gamma}{2};\, \tmap{\Delta'}{2} \proves \pmap{P'}{2}$

%			\item	 
%				If  
%				%$\stytra{\Gamma}{\ell_1}{\Delta}{P}{\Delta'}{P_1 \Par P_2\subst{\abs{x}Q}{X}}$
%				$\ell_1 = \tau$ and $P' 	\not \scong \news{\tilde{m}}(P_1 \Par P_2\subst{\abs{x}Q}{X})$
%				then \\
%				$\mapt{\Gamma}^{2};\, \mapt{\Delta}^{2} \proves  \map{P}^{2}
%				\hby{\tau}
%				\mapt{\Gamma}^{2};\, \mapt{\Delta'}^{2} \proves  \map{P'}^{2}$.
				   			   
%			   then  $\exists \ell_2$ s.t. 
%			    $\wtytra{\mapt{\Gamma}^{3}}{\ell_2}{\mapt{\Delta}^{3}}{\map{P}^{3}}{\mapt{\Delta'}^{3}}{\map{P'}^{3}}$
%			    and $\ell_2 = \mapa{\ell_1}^{3}$.

			\item	 
				If  
				$\ell_1 \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$
				%\not\in \set{\tau,\, \news{\tilde{m}}\bactout{n}{\abs{x}Q}, \, \bactinp{n}{\abs{x}Q}}$ 
				 then \\
				$\exists \ell_2 = \mapa{\ell_1}^{2}$ such that 
				$\mapt{\Gamma}^{2};\, \mapt{\Delta}^{2} \proves  \map{P}^{2}
				\hby{\ell_2}
				\mapt{\Gamma}^{2};\, \mapt{\Delta'}^{2} \proves  \map{P'}^{2}$.			
		\end{enumerate}
		
		%%%%%%% SOUNDNESSS
		\item Suppose 
		$\stytra{\mapt{\Gamma}^{2}}{\ell_2}{\mapt{\Delta}^{2}}{\map{P}^{2}}{\mapt{\Delta'}^{2}}{R}$.
			\begin{enumerate}[a)]
				\item %% soutput
					%\footnote{$\mapt{\Gamma}^{2}$ in the following three items need adjustments.}
					If  
					$\ell_2 = \news{m}\bactout{n}{m}$
					%$\stytra{\mapt{\Gamma}^{2}}{\news{m}\bactout{n}{m}}{\mapt{\Delta}^{2}}{\map{P}^{2}}{\mapt{\Delta'}^{2}}{R}$
					then 
					either 
					\begin{enumerate}[-]
					\item	$\exists P'$ such that $P \hby{\news{m} \bactout{n}{m}} P'$
						and $R = \pmap{P'}{2}$.

					\item	$\exists Q, P'$ such that $P \hby{\bactout{n}{\abs{x}Q}} P'$
						and $R = \map{P'}^{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}$

					\item	$\exists Q, P'$ such that $P \hby{\bactout{n}{\abs{x}Q}} P'$
						and $R = \map{P'}^{2} \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}$
					\end{enumerate}

				\item   %% sinput
					If  $\ell_2 = \bactinp{n}{m}$ 
					%$\stytra{\mapt{\Gamma}^{2}}{\bactinp{n}{m}}{\mapt{\Delta}^{2}}{\map{P}^{2}}{\mapt{\Delta'}^{2}}{R}$
					then either
					\begin{enumerate}[-]
					\item	$\exists P'$ such that $P \hby{\bactinp{n}{m}} P'$
						and $R = \pmap{P'}{2}$.

					\item	$\exists Q, P'$ such that
						$P \hby{\bactinp{n}{\abs{x}Q}} P'$\\
						and $\horel{\mapt{\Gamma}^{2}}{\mapt{\Delta'}^{2}}{\map{P'}^{2}}{\wb}{\mapt{\Delta'}^{2}}{\news{a}(R \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2})}$
					\item	$\exists Q, P'$ such that
						$P \hby{\bactinp{n}{\abs{x}Q}} P'$\\
						and $\horel{\mapt{\Gamma}^{2}}{\mapt{\Delta'}^{2}}{\map{P'}^{2}}{\wb}{\mapt{\Delta'}^{2}}{\news{s}(R \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2})}$  
					\end{enumerate}
		
				\item   
					If  %$\stytra{\mapt{\Gamma}^{2}}{\tau}{\mapt{\Delta}^{2}}{\map{P}^{2}}{\mapt{\Delta'}^{2}}{R}$
					$\ell_2 = \tau$ 
					then $\exists P'$ such that
					$P \hby{\tau} P'$
					and $\horel{\mapt{\Gamma}^{2}}{\mapt{\Delta'}^{2}}{\map{P'}^{2}}{\hwb}{\mapt{\Delta'}^{2}}{R}$.
				\item	 
					If  
					$\ell_2 \not\in \set{\bactout{n}{m}, \bactsel{n}{l}, \bactbra{n}{l}}$ 
					 then 
					$\exists \ell_1$ such that 
					$\ell_1 = \mapa{\ell_2}^{2}$ and \\
					$ \Gamma ;\, \Delta  \proves   P
					\hby{\ell_1}
					\Gamma ;\, \Delta  \proves   P'$.
		\end{enumerate}
	\end{enumerate}
\end{proposition}


\begin{proof}
	\noi The proof is done by transition induction.
	We conside the two parts separately.

	\noi - Part 1

	\noi - Basic Step:
 
	\noi - Subcase: $P= \bout{n}{\abs{x}{Q}} P'$ 
	and also from \defref{d:enc:hopitopi}
	we have that\\
	$\pmap{P}{2} = \newsp{a}{\bout{n}{a} \pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}$

	\noi Then
%
	\begin{eqnarray*}
		\Gamma; \es; \Delta \proves P &\hby{\bactout{n}{\abs{x}{Q}}} & \Delta' \proves P'\\
		\tmap{\Gamma}{2}; \es; \tmap{\Delta}{2} \proves \pmap{P}{2} &\hby{\news{a} \bactout{n}{a}}& \tmap{\Delta}{2} \proves \pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}
	\end{eqnarray*}
%
	\noi and from \defref{d:enc:hopitopi}
%
	\begin{eqnarray*}
		\mapa{\bactout{n}{\abs{x}{Q}}} = \news{a} \bactout{n}{a}
	\end{eqnarray*}
%
	\noi as required.

	\noi - Subcase: $P= \bout{n}{\abs{x}{Q}} P'$ 
	and also from \defref{d:enc:hopitopi}
	we have that\\
	$\pmap{P}{2} = \newsp{s}{\bout{n}{\dual{s}} \pmap{P'}{2} \Par \binp{s}{y} \binp{y}{x} \pmap{Q}{2}}$
	is similar as above. 

	\noi - Subcase $P = \binp{n}{x} P'$.

	\noi - From \defref{d:enc:hopitopi}
	we have that
	$\pmap{P}{2} = \binp{n}{x} \pmap{P'}{2}$

	\noi Then
%
	\begin{eqnarray*}
		\Gamma; \es; \Delta \proves P &\hby{\bactinp{n}{\abs{x}{Q}}}& \Delta' \proves P' \subst{\abs{x}{Q}}{x}\\
		\tmap{\Gamma}{2}; \es; \tmap{\Delta}{2} \proves \pmap{P}{2} &\by{\bactinp{n}{a}}& \tmap{\Delta''}{2} \proves R \subst{a}{x}
	\end{eqnarray*}
%
	\noi with
%
	\begin{eqnarray*}
		\mapa{\bactinp{n}{\abs{x}{Q}}}^{2} &=& \bactinp{n}{a}
	\end{eqnarray*}
%
	It remains to show that
%
	\begin{eqnarray*}
		\tmap{\Gamma}{2}; \es; \tmap{\Delta'}{2} \proves \pmap{P' \subst{\abs{x}{Q}}{x}}{2} \wb
		\tmap{\Delta''}{2} \proves \newsp{a}{R \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi The proof is an induction on the syntax structure of $P'$.
	Suppose $P' = \appl{x}{m}$, then:
%
	\begin{eqnarray*}
		\pmap{\appl{x}{m} \subst{\abs{x}{Q}}{x}}{2} &=& \pmap{Q \subst{m}{x}}{2}\\
		\newsp{a}{R \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}} &=& \newsp{a}{\newsp{s}{ \bout{x}{s} \bout{\dual{s}}{m} \inact} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi The second term can be deterministically reduced as:
%
	\begin{eqnarray*}
		\mhorel{\tmap{\Gamma}{2}}{\tmap{\Delta''}{2}}{\newsp{a}{\newsp{s}{ \bout{x}{s} \bout{\dual{s}}{m} \inact} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
		{\hby{\tau} \hby{\stau}}
		{\tmap{\Delta''}{2}}{}{\newsp{a}{\pmap{Q \subst{m}{x}}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
	\end{eqnarray*}
%
	\noi which is bisimilar with:
%
	\begin{eqnarray*}
		\pmap{Q \subst{m}{x}}{2}
	\end{eqnarray*}
%
	\noi because $a$ is fresh and cannot interact anymore.

	\noi An interesting inductive step case is parallel composition. Suppose $P' = P_1 \Par P_2$. We need to show that:
%
	\begin{eqnarray*}
		&& \tmap{\Gamma}{2}; \es; \tmap{\Delta'}{2} \proves \pmap{(P_1 \Par P_2) \subst{\abs{x}{Q}}{x}}{2} \wb
		\tmap{\Delta''}{2} \proves \newsp{a}{\pmap{P_1 \Par P_2}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi We know that
%
	\begin{eqnarray*}
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_1}{2}}{\pmap{P_1\subst{\abs{x}{Q}}{x}}{2}}{&\wb&}
		{\tmap{\Delta_1''}{2}}{\newsp{a}{\pmap{P_1}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}\\
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_2}{2}}{\pmap{P_2\subst{\abs{x}{Q}}{x}}{2}}{&\wb&}
		{\tmap{\Delta_1''}{2}}{\newsp{a}{\pmap{P_2}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
	\end{eqnarray*}
%
	\noi We conclude from the congruence of $\wb$.

	\noi - The rest of the cases for Part 1 are easy to follow using \defref{d:enc:hopitopi}.

	\noi - Part 2.

	\noi The proof for Part 2 is straightforward following \defref{d:enc:hopitopi}.
	We give some distinctive cases:

	\noi - Case $P = \bout{n}{\abs{x}{Q}} P'$
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta}{P}{&\hby{\bactout{n}{\abs{x}{Q}}}&}{\Delta'}{P'}\\
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}{& \hby{\news{a} \bactout{n}{a}}&}{\tmap{\Delta'}{2}}{\pmap{P'}{2} \Par \repl{} \binp{a}{y} \binp{y}{s} \pmap{Q}{2}}
	\end{eqnarray*}
%
	\noi as required.

	\noi - Case $P = \binp{n}{x} P'$
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta}{P}{&\hby{\bactinp{n}{\abs{x}{Q}}}&}{\Delta'}{P' \subst{\abs{x}}{Q}}{x}\\
		\horel{\tmap{\Gamma}{2}}{\tmap{\Delta}{2}}{\pmap{P}{2}}{& \hby{\bactinp{n}{a}}&}{\tmap{\Delta''}{2}}{\pmap{P'}{2} \subst{a}{x}}
	\end{eqnarray*}
%
	\noi We now use a similar argumentation as the input case in Part 1 to prove that:
%
	\begin{eqnarray*}
		\horel{\Gamma}{\Delta'}{P' \subst{\abs{x}{Q}}{x}}
		{\wb}
		{\tmap{\Delta''}{2}}{\newsp{a}{\pmap{P'}{2} \subst{a}{x} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2}}}
	\end{eqnarray*}
%
	\qed
\end{proof}

\begin{proposition}[Full Abstraction, From \HOp to \sessp]\myrm
	\label{app:prop:fulla_HOp_to_p}
	Let $P_1, Q_1$ be \HOp processes.
	$\horel{\Gamma}{\Delta_1}{P_1}{\hwb}{\Delta_2}{Q_1}$
	if and only if
	$\horel{\tmap{\Gamma}{2}}{\tmap{\Delta_1}{2}}{\pmap{P_1}{2}}{\fwb}{\tmap{\Delta_2}{2}}{\pmap{Q_1}{2}}$.
\end{proposition}

\begin{proof}
%	The proof for the soundness direction considers
%	closure that can be shown to be a bisimulation
%	following the soundness direction of Operational Correspondence
%	(\propref{prop:op_corr_HOp_to_p}). Whenever needed
%	the proof makes use of the $\tau$-inertness result
%	(\propref{lem:tau_inert}).

%	The proof for the completness direction also considers
%	a closure shown to be a bisimulation
%	up-to deterministic transition (\propref{lem:up_to_deterministic_transition})
%	following the completeness direction of Operational Correspondence
%	(\propref{prop:op_corr_HOp_to_p}).
%
	Proof follows directly from \propref{app:prop:op_corr_HOp_to_p}. The cases
	of \propref{app:prop:op_corr_HOp_to_p} are used to create a
	bisimulation closure to prove the the soundness direction and
	a bisimulation up to determinate transition (\lemref{lem:up_to_deterministic_transition})
	to prove the
	completeness direction.
	\qed
\end{proof}




%\begin{proposition}\rm
%	\label{app:enc_HO_to_sessp_oc}
%	Encoding $\encod{\cdot}{\cdot}{2}: \HO \to \sessp$ 
%	enjoys operational correspondence (cf. Def.~\ref{def:ep}\,(2)).
%\end{proposition}
%
%\begin{proof}[Sketch]
%For completeness, we 
%consider the \HO process $P = {\bbout{k}{\abs{x}{Q}} P_1} \Par \binp{k}{X} P_2$. We have that
%\[
%P \red P_1 \Par P_2 \subst{\abs{x}Q}{X}
%\]
%In the target language, this reduction is mimicked as follows:
%\begin{eqnarray*}
%\pmap{P}{2} & = & \newsp{a}{\bout{k}{a} (\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2})\,} 
%                  \Par \binp{k}{x} \pmap{P_2}{2} \\
%            & \red & \newsp{a}{\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2} 
%                  \Par  \pmap{P_2}{2}\subst{a}{x}}
%\end{eqnarray*}
%\qed
%\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%	HOpp to HOp
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Properties for encoding $\tyl{L}_{\HOpp}$ into $\tyl{L}_{\HOp}$}
\label{app:HOpp_to_HOp}

%We study the properties of the typed encoding in
%\defref{def:enc:HOpp_to_HOp} (Page~\pageref{def:enc:HOpp_to_HOp}).

%We repeat the statement of \propref{prop:typepres_HOpp_to_HOp},
%as in Page~\pageref{prop:typepres_HOpp_to_HOp}:

In this section we prove \thmref{f:enc:hopiptohopi}, in Page~\pageref{f:enc:hopiptohopi}
that requires that encoding
$\tyl{L}_{\HOpp}$ into $\tyl{L}_{\HOp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated in \propref{app:prop:typepres_HOpp_to_HOp}.
	\item	Operational Correspondence, stated in \propref{app:prop:op_corr_HOpp_to_HOp}.
		Note that we prove a stronger operational correspondence condition,
		as in \defref{app:def:opc_strong},
		than the condition suggested in \defref{def:ep}(2).
	\item	Full Abstraction, stated in \propref{app:prop:fulla_HOpp_to_HOp}.
\end{itemize}

\begin{proposition}[Type Preservation. From \HOpp to \HOp]\myrm
	\label{app:prop:typepres_HOpp_to_HOp}
	Let $P$ be a \HOpp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{3}; \emptyset; \tmap{\Delta}{3} \proves \pmap{P}{3} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the inference of 
	$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	We detail some representative cases:
	\begin{enumerate}[1.]
		\item	Case $P = \bout{u}{\abs{\underline{x}}{Q}} P'$.
			Then we may have the following typing in \HOpp:
			\[
				\tree{
					\tree{}{\Gamma; \Lambda_1; \Delta_1 \cat u:S  \proves  P' \hastype \Proc} 
					\quad
					\tree{
						\tree{}{\Gamma \cat \underline{x}:L; \Lambda_2 ; \Delta_2 \proves  Q \hastype \Proc}
						\quad
						\tree{}{\Gamma \cat \underline{x}:L; \es ; \es \proves  \underline{x} \hastype L}
					}{
						\Gamma ; \Lambda_2 ; \Delta_2 \proves  \abs{\underline{x}:L} Q \hastype \lhot{L}
					}
				}{
					\Gamma; \Lambda_1 \cat \Lambda_2; \Delta_1 \cat \Delta_2 \cat  u: \btout{\lhot{L}} S \proves \bout{u}{\abs{\underline{x}}{Q}} P' \hastype \Proc
				}
			\]
			Thus, by IH we have:
			%
			\begin{eqnarray}
				\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3}; \tmap{\Delta_1}{3} \cat u:\tmap{S}{3} & \proves &  \pmap{P'}{3} \hastype \Proc
				\label{eq:hopppre1}
				\\
				\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \tmap{\Lambda_2}{3} ; \tmap{\Delta_2}{3} & \proves & \pmap{Q}{3} \hastype \Proc
				\label{eq:hopppre2}
				\\
				\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \es ; \es & \proves & \underline{x} \hastype \tmap{L}{3}
				\label{eq:hopppre3}
			\end{eqnarray}
			%
			The corresponding typing in \HOp is as follows:
			\begin{eqnarray}
				\tree{
					\tree{
						\tree{}{\eqref{eq:hopppre2}}
					}{
						\tmap{\Gamma}{3} \cat x:\tmap{L}{3}; \tmap{\Lambda_2}{3};  \tmap{\Delta_2}{3} \cat z: \tinact \proves \pmap{Q}{3} \hastype \Proc
					}
					\qquad
					\tree{}{\eqref{eq:hopppre3}}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda_2}{3}; \tmap{\Delta_2}{3} \cat z:\btinp{\tmap{L}{3}} \tinact \proves \binp{z}{\underline{x}} \pmap{Q}{3} \hastype \Proc
				}
				\label{eq:hopppre11}
			\end{eqnarray}
			{\small
			\[
				\tree{
					\tree{}{
						\eqref{eq:hopppre1}}
						\quad
						\tree{
							\eqref{eq:hopppre11}
							\qquad 
							\tree{}{\tmap{\Gamma}{3}; \es; z:\btinp{\tmap{L}{3}} \tinact \proves z \hastype \btinp{\tmap{L}{3}} \tinact}
					}{
						\tmap{\Gamma}{3}; \tmap{\Lambda_2}{3}; \tmap{\Delta_2}{3} \proves \abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}} \hastype \lhot{(\btinp{\tmap{L}{3}} \tinact)}
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3} \cat \tmap{\Lambda_2}{3}; \tmap{\Delta_1}{3} \cat \tmap{\Delta_2}{3} \cat u:\btout{\lhot{\btinp{\tmap{L}{3}} \tinact}}\tmap{S}{3} 
					\proves  \bout{u}{\abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}}} \pmap{P'}{3}
					\hastype \Proc
				}
			\]
			}

			\item Case $P =  \appl{(\abs{x} P)}{(\abs{y} Q)}$.
			We may have different possibilities for the types of each abstraction. 
			We consider only one of them, as the rest are similar:
			\[
			\tree{
			\tree{
			\tree{}{
			\Gamma \cat x:\shot{C}; \Lambda;  \Delta_1 \proves   P \hastype \Proc}
			}{
			\Gamma; \Lambda;  \Delta_1 \proves \abs{x} P \hastype \lhot{(\lhot{C})}
			} 
			\quad
			\tree{
			\tree{}{
			\Gamma; \es;  \Delta_2, y:C \proves  Q \hastype \Proc}
			}{
			\Gamma; \es;  \Delta_2 \proves \abs{y} Q \hastype \lhot{C}
			}
			}{
			\Gamma; \Lambda; \Delta_1 \cdot \Delta_2 \proves\appl{(\abs{x} P)}{(\abs{y} Q)} \hastype \Proc
			}
			\]

			Thus, by IH we have:
			\begin{eqnarray}
			\tmap{\Gamma}{3} \cat x:\tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3}   & \proves &  \pmap{P}{3} \hastype \Proc
			\label{eq:hopppre4} \\
			\tmap{\Gamma}{3}  ; \es; \tmap{\Delta_1}{3}, y:\tmap{C}{3}   & \proves &  \pmap{Q}{3} \hastype \Proc
			\label{eq:hopppre5} 
			\end{eqnarray}

			The corresponding typing in \HOp is as follows --- recall that $\tmap{\lhot{C}}{3} = \lhot{\tmap{C}{3}}$.
			\begin{eqnarray}
				\tree{
					\tree{
						\tree{}{\eqref{eq:hopppre4}}
					}{
						\tmap{\Gamma}{3}\cat x: \tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cat s: \tinact \proves \pmap{P}{3} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cat  s:\btinp{\tmap{\lhot{C}}{3}}\tinact \proves \binp{s}{x}\pmap{P}{3} \hastype \Proc
				}
				\label{eq:hopppre12}
			\end{eqnarray}
			{\small
			\[
				\tree{
					\tree{
						\eqref{eq:hopppre12}
						\quad
						\tree{
							\tree{
								\tree{}{\eqref{eq:hopppre5}}
							}{
								\tree{
									\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \cat y:\tmap{ C}{3} \proves \pmap{Q}{3} \hastype \Proc
								}{
									\tree{
										\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \proves \abs{y}{\pmap{Q}{3}} \hastype \tmap{\lhot{C}}{3}
									}{
										\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} \cat \dual{s}: \tinact \proves \abs{y}{\pmap{Q}{3}} \hastype \tmap{\lhot{C}}{3}
									}
								}
							}
						}{
							\tmap{\Gamma}{3}; \es;   \tmap{\Delta_2}{3} \cat \dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact \proves \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact \hastype \Proc
						}
					}{
						\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} \cat s:\btinp{\tmap{\lhot{C}}{3}}\tinact \cat \dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact
						\proves
						\binp{s}{x}\pmap{P}{3} \Par \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact \hastype \Proc
					}
				}{
					\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} \proves \news{s}(\binp{s}{x}\pmap{P}{3} \Par \bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact) \hastype \Proc
				}
			\]
			}

	\end{enumerate}
\qed
\end{proof}


%We repeat the statement of \propref{prop:op_corr_HOpp_to_HOp},
%as in Page~\pageref{prop:op_corr_HOpp_to_HOp}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{3}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{3}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%
%\[
%	\begin{array}{c} 
%		\mapa{\news{\tilde{m}} \bactout{n}{\abs{\AT{x}{L}}{P}}}^{3} 
%		\defeq
%		\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
%		\qquad \qquad
%		\mapa{\bactinp{n}{\abs{\AT{x}{L}}{P}}}^{3}
%		\defeq \bactinp{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
%	\end{array}
%\]
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}

%We now state and prove a detailed version of the operational corresponce in \defref{app:def:opc_strong}.

\begin{proposition}[Operational Correspondence. From \HOpp to \HOp]\myrm
	\label{app:prop:op_corr_HOpp_to_HOp}
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell'}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$ with $\mapa{\ell}^{3} = \ell'$.

%				\item	If $\ell = \bactinp{n}{\abs{x: C}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{x: C}{\pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \news{\tilde{m}} \bactout{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \bactinp{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \btau$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\tau}}
					{\Delta''}{R}$ and
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}{\hwb}{\Delta''}{R}$, for some $R$.

				\item	If $\ell = \tau$ and $\ell \not= \btau$ then %and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
			{\tmap{\Delta''}{3}}{Q}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$
					with $\mapa{\ell'}^{3} = \ell$ and $Q \scong \pmap{P'}{3}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $Q \scong \pmap{P'}{3}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ then
					either
					$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ with $Q \scong \pmap{P'}{3}$\\
					or
					$\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\btau}}
					{\tmap{\Delta''}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
\begin{enumerate}
	\item The proof of Part 1 does a transition induction and
	considers the mapping as defined in \figref{f:enc:hopip_to_hopi}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$.

			$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ implies
\[
			\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q_1}{3} \Par \bout{\dual{s}}{\abs{x}{\pmap{Q_2}{3}}} \inact}}{\hby{\stau}}
			{\tmap{\Delta'}{3}}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
\]

		\item	Case: $P = \bout{n}{\abs{\underline{x}} Q} P$

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$
		\item Other cases are similar. 
	\end{itemize}

	\item The proof of Part 2 also does a transition induction and
	considers the mapping as defined in \figref{f:enc:hopip_to_hopi}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$.
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{ \appl{(\abs{z}\binp{z}{x} \pmap{Q}{3})}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\btau}}
			{\tmap{\Delta'}{3}}{}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}
		\]
%
			\noi implies
			$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ and
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\stau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
		\]

		\item	Case: $P = \bout{n}{\abs{\underline{x}} Q} P$

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$ and

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{\underline{x}}{Q}}}}{\Delta}{P}$
%			\dk{this case is incomplete}
		\item Other cases are similar. 
	\end{itemize}
\end{enumerate}
\qed
\end{proof}

\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\myrm
	\label{app:prop:fulla_HOpp_to_HOp}
	Let $P, Q$ \HOpp processes with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$. \\
	Then 
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}$
\end{proposition}

\begin{proof}
	\noi {\bf Soundness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}}
	\]
%
	\noi	It is straightforward to show that $\Re$ is a bisimulation if we follow Part 2 of
		\propref{app:prop:op_corr_HOpp_to_HOp} for subcases a and b.
		In subcase c we make use of \propref{lem:tau_inert}.

	\noi {\bf Completeness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\ ,\ }{\tmap{\Delta_2}{3}}{\pmap{Q}{3}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
	\noi	We show that $\Re$ is a bisimulation up to deterministic transitions
		by following Part 1 of \propref{app:prop:op_corr_HOpp_to_HOp}.
		The proof is straightforward for subcases a), b) and d).
		In subcase c) we make use of \lemref{lem:up_to_deterministic_transition}.
	\qed
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%	pHOp to HOp
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsection{Properties for encoding $\tyl{L}_{\PHOp}$ into $\tyl{L}_{\HOp}$}
\label{app:pHOp_to_HOp}

%We study the properties of the typed encoding in
%\defref{def:enc:pHOp_to_HOp} (Page~\pageref{def:enc:pHOp_to_HOp}).

%We repeat the statement of \propref{prop:typepres_pHOp_to_HOp}, as in Page~\pageref{prop:typepres_pHOp_to_HOp}:

In this section we prove \thmref{f:enc:phopiptohopi}, in Page~\pageref{f:enc:phopiptohopi}
that requires that encoding
$\tyl{L}_{\PHOp}$ into $\tyl{L}_{\HOp}$ is precise.
A precise encoding requires to prove three independent results:
\begin{itemize}
	\item	Type preservation, stated in \propref{app:prop:typepres_pHOp_to_HOp}.
	\item	Operational Correspondence, stated in \propref{app:prop:op_corr_pHOp_to_HOp}.
		Note that we prove a stronger operational correspondence condition,
		as in \defref{app:def:opc_strong},
		than the condition suggested in \defref{def:ep}(2).
	\item	Full Abstraction, stated in \propref{app:prop:fulla_pHOp_to_HOp}.
\end{itemize}


\begin{proposition}[Type Preservation. From \pHOp to \HOp]\rm
	\label{app:prop:typepres_pHOp_to_HOp}
	Let $P$ be a \pHOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta}{4} \proves \pmap{P}{4} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	We examine two representative cases, using biadic communications.

	\begin{enumerate}[1.]
		\item	Case $P = \bout{n}{V} P'$ and 
			$\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat n:\btout{\lhot{(C_1,C_2)}} S \proves \bout{n}{V} P' \hastype \Proc$.
			Then either $V = y$ or $V = \abs{(x_1,x_2)}Q$, for some $Q$.
			The case $V = y$ is immediate; we give details for the case $V = \abs{(x_1,x_2)}Q$, for which we have the following typing:
			\[
				\tree{
					\tree{}{
						\Gamma; \emptyset; \Delta_1 \cat n:S \proves P' \hastype \Proc
					}
					\quad
					\tree{
						\Gamma; \emptyset; \Delta_2 \cat x_1: C_1 \cat x_2:C_2 \proves Q \hastype \Proc
					}{
						\Gamma; \emptyset; \Delta_2 \proves \abs{(x_1,x_2)}Q \hastype \lhot{(C_1,C_2)}
					}
				}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat n:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{\abs{(x_1,x_2)}Q} P \hastype \Proc
				}
		\]
		We now show the typing for $\pmap{P}{4}$.
		By IH we have both:
%
		\[
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n: \tmap{S}{4} \proves \pmap{P'}{4} \hastype \Proc
			\qquad
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2:\tmap{C_2}{4} \proves \pmap{Q}{4} \hastype \Proc
		\]
%
		Let $L = \lhot{(C_1,C_2)}$. 
		By \figref{f:enc:poltomon} we have  
		$\tmap{L}{4} = \lhot{\big(\btinp{\tmap{C_1}{4}} \btinp{\tmap{C_2}{4}}\tinact\big)}$
		and
		$\pmap{P}{4} = \bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4}} \pmap{P'}{4}$.
		We can now infer the following typing derivation:
%
		\begin{eqnarray}
			\label{prop:tpres:pHOp_to_HOp1}
			\tree{
				\tree{
					\tree{
						\tree{
							\tree{}{
								\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \proves \pmap{Q}{4} \hastype \Proc
							}
						}{
							\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \cat z:\tinact \proves \pmap{Q}{4} \hastype \Proc
						}
					}{
						\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat x_1: \tmap{C_1}{4}\cat z:\btinp{\tmap{C_2}{4}}\tinact \proves \binp{z}{x_2} \pmap{Q}{4} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \cat z:\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact \proves \binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4} \hastype \Proc
				}
			}{
				\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_2}{4} \proves \abs{z}\binp{z}{x_1}\binp{z}{x_2} \pmap{Q}{4} \hastype \lhot{(\tmap{C_1}{4},\tmap{C_2}{4})}
			}
		\end{eqnarray}
%
%
		\[
		\tree{
			\tree{}{
				\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \proves \map{P'}^{\mathsf{p}} \hastype \Proc
			}
			\quad
			\eqref{prop:tpres:pHOp_to_HOp1}
		}{
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat \tmap{\Delta_2}{4} \cat n:\btout{\tmap{L}{4}} \tmap{S}{4} \proves \pmap{P}{4} \hastype \Proc
		}
		\]

		\item	Case $P = \binp{n}{x_1,x_2} P'$ 
			and
			$\Gamma; \emptyset; \Delta_1 \cat n: \btinp{(C_1, C_2)} S \proves \binp{n}{x_1,x_2} P' \hastype \Proc$.
			We have the following typing derivation:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_1 \cat n:S \cat x_1: C_1 \cat x_2: C_2 \proves  P' \hastype \Proc
					\quad
					\Gamma; \emptyset;  \proves x_1, x_2 \hastype C_1,C_2
				}{
					\Gamma; \emptyset; \Delta_1 \cat n: \btinp{(C_1, C_2)} S \proves \binp{n}{x_1,x_2} P' \hastype \Proc
				}
		\]
		By \figref{f:enc:poltomon} we have 
		$\pmap{P}{4} = \binp{n}{x_1}\binp{k}{x_2} \pmap{P'}{4}$.
		By IH we have 
%
		\[
			\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n:\tmap{S}{4} \cat x_1: \tmap{C_1}{4} \cat x_2: \tmap{C_2}{4} \proves  \pmap{P'}{4} \hastype \Proc
		\]
%
		and the following type derivation:
		\[
			\tree{
				\tree{
					\tree{}{
						\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat x_1:\tmap{C_1}{4} \cat x_2:\tmap{C_2}{4} \cat n:\tmap{S}{4} \proves \pmap{P'}{4} \hastype \Proc
					}
					%\quad
					%\tree{}{
					%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_2:\tmap{C_2}{\mathsf{p}}  \proves  x_2 \hastype \tmap{C_2}{\mathsf{p}}}
				}{
					\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat x_1:\tmap{C_1}{4} \cat n:\btinp{\tmap{C_2}{4}}\tmap{S}{4} \proves \binp{n}{x_2}\pmap{P'}{4} \hastype \Proc
				}
				%\quad
				%\tree{}{
				%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_1:\tmap{C_1}{\mathsf{p}}  \proves  x_1 \hastype \tmap{C_1}{\mathsf{p}}}
			}{
				\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta_1}{4} \cat n:\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tmap{S}{4} \proves \pmap{P}{4} \hastype \Proc
			}
		\]
	\end{enumerate}
	\qed
\end{proof}

%We repeat the statement of \propref{prop:op_cor:pHOp_to_HOp}, as in Page~\pageref{prop:op_cor:pHOp_to_HOp}:

%Before we prove operational correspondence we
%define mapping from $\mapa{\cdot}^{4}: \mathcal{A} \to \mathcal{A}$
%where $\mathcal{A}$ is the set of labels of the relation
%$\hby{\ell}$:
%\begin{definition}[$\mapa{\cdot}^{4}: \mathcal{A} \to \mathcal{A}$]\rm
%	Let $\mathcal{A}$ is the set of labels of the relation
%	$\hby{\ell}$ then we define:
%
%\[
%	\begin{array}{c}
%		\mapa{\news{\tilde{m}} \bactout{n}{m_1,  m_2}}^4 
%		\defeq \ell_1, \ell_2
%		\textrm{ where }
%%		\left\{
%%		\begin{array}{rcl}
%			(m_i \in \tilde{m} \Leftrightarrow \ell_i = \news{m_i}\bactout{n}{m_i} ) ~ \lor %\\
%			(m_i \not\in \tilde{m} \Leftrightarrow  \ell_i = \bactout{n}{m_i})
%%		\end{array}
%%		\right.
%%		& &  (m_i \in \tilde{m}  \Leftrightarrow \ell_i = \news{m_i}\bactout{n}{m_i} ) ~ \lor \\
%%		& & (m_i \not\in \tilde{m}  \Leftrightarrow  \ell_i = \bactout{n}{m_i}) \\
%		\\
%		\mapa{\news{\tilde{m}} \bactout{n}{\abs{(x_1, x_2)}{P}} }^4 
%		\defeq
%		\news{\tilde{m}} \bactout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{P}^{4}}
%	\end{array}
%\]
%	and homomorphic for all other cases of $\ell \in \mathcal{A}$.
%\end{definition}


\begin{proposition}[Operational Correspondence. From \pHOp to \HOp]\myrm
	\label{app:prop:op_corr_pHOp_to_HOp}
%
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$. Then
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$
					with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell = \bactinp{n}{\tilde{m}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$
					with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{\tilde{x}}{R}}, \bactinp{n}{\abs{\tilde{x}}{R}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell'}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell}^{4} = \ell'$.

				\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$.

				\item	If $\ell = \btau$ then either
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\btau} \hby{\stau} \dots \hby{\stau}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell} = \btau, \stau \dots \stau$.

				\item	If $\ell = \tau$ then %and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\tau} \dots \hby{\tau}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell}^{4} = \tau \dots \tau$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$. Then
			$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell}}
			{\tmap{\Delta_1}{4}}{P_1}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\bactinp{n}{m}, \bactout{n}{m}, \news{m} \bactout{n}{m}}$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and\\
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\ell_2} \dots \hby{\ell_n}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
					with $\mapa{\ell'}^{4} = \ell$ and $P_1 \scong \pmap{P'}{4}$.

				\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $P_1 \scong \pmap{P'}{4}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \btau$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\stau} \dots \hby{\stau}}
					{\tmap{\Delta'}{4}}{\tmap{P'}{4}}$ with $\mapa{\ell}^{4} = \btau, \stau \dots \stau$.

				\item	If $\ell = \tau$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\tau} \dots \hby{\tau}}
					{\tmap{\Delta'}{4}}{\tmap{P'}{4}}$ with $\mapa{\ell}^{4} = \tau \dots \tau$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
	The proof of both parts is by transition induction, following 
	the mapping defined in  \figref{f:enc:poltomon} .
	We consider some representative cases, using biadic communication:
	\begin{enumerate}[$\bullet$]
	%\item 
	%% Biadic Output 
\item Case (1(a)), with $P =\bout{n}{m_1, m_2} P'$ and $\ell_1 = \bactout{n}{m_1, m_2}$. 
By assumption, $P$ is well-typed. 
As one particular possibility, we may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; m_1{:} S_1 \cat m_2{:}S_2 \proves  m_1,m_2 \hastype S_1,S_2}{
					\Gamma; \emptyset; \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S \proves  
					\bout{n}{m_1,m_2} P' \hastype \Proc}
			\]
for some $\Gamma, S, S_1, S_2, \Delta_0$, 
such that $\Delta = \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S$.
We may then have the following typed transition
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}{\bout{n}{m_1, m_2} P'}{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgment for $P$ is as follows:
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}^{4} \proves \map{\bout{n}{m_1, m_2} P'}^{4} \hastype \Proc
$$
which, using  \figref{f:enc:poltomon} , can be expressed as 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0} 
\cat m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} 
\cat n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} 
\hastype \Proc
$$
Now, $\mapa{\ell_1}^{4} = \bactout{n}{m_1 }, \bactout{n}{ m_2}$. 
It is immediate to infer the following typed transitions for $\map{P}^{4}  = \bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} $:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta_0} \cat  m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4}  \\
& \hby{\bactout{n}{m_1}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat  m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_2} \map{P'}^{4} \\
& \hby{\bactout{n}{m_2}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0}  \cat n{:}\mapt{S}^{4}
\proves 
 \map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat
n:S }^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%% Biadic Abstraction Output 
\item Case (1(c)) with $P = \bbout{n}{\abs{(x_1, x_2)} Q} P' $ and $\ell_1 = \bactout{n}{\abs{(x_1, x_2)}{Q}}$. 
By assumption, $P$ is well-typed. 
We may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; \Delta_1 \proves  \abs{(x_1,x_2)}Q \hastype \lhot{(C_1,C_2)}}{
					\Gamma; \emptyset; \Delta_0 \cat \Delta_1 \cat n:\btout{\lhot{(C_1,C_2)}}S \proves  
					\bout{n}{\abs{(x_1,x_2)}Q} P' \hastype \Proc}
			\]
for some $\Gamma$, $S$, $C_1$, $C_2$, $\Delta_0$, $\Delta_1$, 
such that $\Delta = \Delta_0 \cat \Delta_1 \cat  n:\btout{\lhot{(C_1,C_2)}}S$.
(For simplicity, we consider only the case of a linear function.)
We may have the following typed transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}{\bbout{n}{\abs{(x_1, x_2)} Q} P' }{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgement is
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}^{4} \proves \map{\bbout{n}{\abs{(x_1, x_2)} Q} P' }^{4} \hastype \Proc
$$
which, using  \figref{f:enc:poltomon} , can be equivalently expressed as 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}
\hastype \Proc
$$

Now, $\mapa{\ell_1}^{4} = \bactout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}}$. 
It is immediate to infer the following typed transition for $\map{P}^{4}  = \bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\mapa{\ell_1}^{4}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat
n:\mapt{S}^{4}, \,
\proves 
\map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; 
 \mapt{\Delta_0 \cat n:S}^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PART 2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Biadic Input 
\item Case (2(a)), with $P =  \binp{n}{x_1, x_2} P' $, 
$\map{P}^{4} = 
		\binp{n}{x_1}  \binp{n}{x_2}  \map{P'}^{4}$.
%		We show that this case falls under part~(b) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 		
%		and $\ell_2 = \bactinp{n}{m_1}, \bactinp{n}{m_2}$. Then w
		We have  the following typed transitions for $\map{P}^{4}$, for some $S$, $S_1$, $S_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_1}{4}}\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
\proves 
\binp{n}{x_1} \binp{n}{x_2}\map{P'}^{4} \\
& \hby{\bactinp{n}{m_1}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
m_1:\mapt{S_1}^{4}
\proves 
\binp{n}{x_2}\map{P'}^{4} \subst{m_1}{x_1} \\
& \hby{\bactinp{n}{m_2}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat n:\tmap{S}{4} \cat
m_1:  \mapt{S_1}^{4} \cat
m_2: \mapt{S_2}^{4}
\proves 
\map{P'}^{4} \subst{m_1}{x_1}\subst{m_2}{x_2} = Q
\end{eqnarray*}
Observe that the we use substitution %lemma (Lemma~\ref{lem:subst}(1)) has been used
twice.
%Considering Remarn~\ref{r:multilabels} 
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactinp{n}{m_1,m_2}$. Indeed, $\mapa{\ell_1}^{4} = \bactinp{n}{m_1}, \bactinp{n}{m_2}$.
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta \cat n:\btinp{S_1, S_2}S}{\binp{n}{x_1, x_2} P' }{\Delta\cat n{:}S \cat m_1:S_1 \cat m_2:S_2}{P'\subst{m_1,m_2}{x_1, x_2}}
$$
which concludes the proof for this case.


%% Biadic Abstraction Output 
\item Case (2(b)), with $P =  \bbout{n}{\abs{(x_1,x_2)} Q} P' $, 
$\map{P}^{4} = 
		\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$.
		%We show that this case falls under part~(a) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 
		We have the following  typed transition, for some $S$, $C_1$, $C_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{\bbtout{\lhot{(C_1,  C_2)}} S}{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\ell'_1} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{ S}{4} 
\proves 
\map{P'}^{4} = Q
\end{eqnarray*}
where
$\ell'_1 = \bactout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}}$.
For simplicity, we consider only the case of linear functions.
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactout{n}{\abs{(x_1,  x_2)}{Q}} $. 
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta\cat n:\bbtout{\lhot{(C_1,  C_2)}} S}{ \bbout{n}{\abs{x_1,x_2} Q} P'}{\Delta\cat n{:}S}{P'}
$$
which concludes the proof for this case.



	\end{enumerate}
%\iftodo{
%	\dk{do some cases}
%}\else\fi
	\qed
\end{proof}


\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\myrm
	\label{app:prop:fulla_pHOp_to_HOp}
	Let $P, Q$ be \HOpp process with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$.
	$\horel{\Gamma}{\Delta_1}{P}{\hwb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hwb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}$.
\end{proposition}

\begin{proof}
	The proof for both direction is a consequence of Operational Correspondence,
	\propref{app:prop:op_corr_pHOp_to_HOp}.

	\begin{itemize}
	\item	Soundness Direction.

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\wb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}}
	\]
%
	\noi	It is straightforward to show that $\Re$ is a bisimulation if we follow Part 2 of \propref{app:prop:op_corr_pHOp_to_HOp}. We
	present some cases:
	\begin{enumerate}
		\item	If $\ell \in \set{\bactinp{n}{m}, \bactout{n}{m}, \news{m} \bactout{n}{m}}$ then
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
		\]
		implies
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
		\]
		From Part 2(a) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
		\[
		\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1''}{P'}
		\]
		and
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{P_1}{\hby{\ell_2} \dots \hby{\ell_n}}
		{\tmap{\Delta_1''}{4}}{\pmap{P'}{4}}
		\]
		with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.
		
		Moreover 
		\[
			\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell}}{\Delta_2''}{Q'}
		\]
		and
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2'}{4}}{Q_1}{\Hby{\ell_2} \dots \Hby{\ell_n}}
		{\tmap{\Delta_2''}{4}}{\pmap{Q'}{4}}
		\]
		
		If we follow the bisimulation game we conclude that
		\[
		\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1''}{4}}{\pmap{P'}{4}}{\wb}{\tmap{\Delta_2''}{4}}{\pmap{Q'}{4}}
		\]
		and
		\[
		\horel{\Gamma}{\Delta_1''}{P'}{\ \Re\ }{\Delta_2''}{Q'}
		\]
		\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}}$
				then
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
				\]
				implies
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
				\]
				and
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1'}{4}}{P_1 \Par C}{\wb}{\tmap{\Delta_2' \Par C}{4}}{Q_1}
				\]
				with $C$ corresponding to the characteristic process if $\ell$ is an output action and $C = \inact$ otherwise.
				From Part 2(b) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
				$\horel{\Gamma}{\Delta_1}{P}{\hby{\ell'}}{\Delta_1'}{P'}$
				with $\mapa{\ell'}^{4} = \ell$ and $P_1 \scong \pmap{P'}{4}$
				and
				$\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell'}}{\Delta_2'}{Q'}$
				and $P_1 \scong \pmap{P'}{4}$.
				\dk{we need an auxiliary result here}
				
		\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$
				then
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell}}{\tmap{\Delta_1'}{4}}{P_1}
				\]
				implies
				\[
				\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell}}{\tmap{\Delta_2'}{4}}{Q_1}
				\]
				From Part 2(c) of \propref{app:prop:op_corr_pHOp_to_HOp} we conclude that
				\[	
				\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
				\]
				with $P_1 \cong \pmap{P'}{4}$
				and
				\[	
				\horel{\Gamma}{\Delta_2}{Q}{\hby{\ell}}{\Delta_2'}{Q'}
				\]
				with $Q_1 \cong \pmap{Q'}{4}$
				which concludes the case.

		\item	The cases for $\ell = \tau$ are similar
				and correspond to Part 2(d, e) of \propref{app:prop:op_corr_pHOp_to_HOp} 
	\end{enumerate}
			
			
%		for subcases a and b.
%		In subcase c we make use of \propref{lem:tau_inert}.

	\item	Completeness Direction.

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\ ,\ }{\tmap{\Delta_2}{4}}{\pmap{Q}{4}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
%	\dk{Is the proof easy? do the proof}
	\noi	We show that $\Re$ is a bisimulation up to deterministic transitions by following Part 1 of \propref{app:prop:op_corr_pHOp_to_HOp}.
	\begin{enumerate}
		\item
		If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
		\[
		\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
		\]
		implies
		\[
		\horel{\Gamma}{\Delta_2}{Q}{\Hby{\ell}}{\Delta_2'}{Q'}
		\]
		and
		\[
		\horel{\Gamma}{\Delta_1'}{P' \Par C}{\wb}{\Delta_2'}{Q' \Par C}
		\]
		with $C$ corresponding to the trigger process.
		Furthermore, from Part 1 (a) of \propref{app:prop:op_corr_pHOp_to_HOp} we have that
		$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta_1'}{4}}{\pmap{P'}{4}}$
		with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$
		and
		$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell_1} \dots \Hby{\ell_n}}{\tmap{\Delta_2'}{4}}{\pmap{Q'}{4}}$
		\dk{we need an auxiliary result}.
						
		\item	If $\ell = \bactinp{n}{\tilde{m}}$ then
				If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
				\[
				\horel{\Gamma}{\Delta_1}{P}{\hby{\ell}}{\Delta_1'}{P'}
				\]
				implies
				\[
				\horel{\Gamma}{\Delta_2}{Q}{\Hby{\ell}}{\Delta_2'}{Q'}
				\]
				and
				\[
				\horel{\Gamma}{\Delta_1'}{P'}{\wb}{\Delta_2'}{Q'}
				\]
				Furthermore, from Part 1 (b) of \propref{app:prop:op_corr_pHOp_to_HOp} we have that
				$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta_1'}{4}}{\pmap{P'}{4}}$
				with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$
				and
				$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}{\Hby{\ell_1} \dots \Hby{\ell_n}}{\tmap{\Delta_2'}{4}}{\pmap{Q'}{4}}$
				as required.
		\item	The case for $\ell = \news{\tilde{m} \bactout{n}{\abs{\tilde{x}}{R}}$
		is similar to the first case.
		
		\item	The case for $\ell = \bactinp{n}{\abs{\tilde{x}}{R}}}$
		is similar to the second case.
		
		\item	The case for $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$ is similar to the second case.
		
		\item	The case for $\ell = \tau$ is similar to the second case.
		
	\end{enumerate}
%		The proof is straightforward for subcases a), b) and d).
%		In subcase c) we make use of \lemref{lem:up_to_deterministic_transition}.
	\end{itemize}
	\qed
\end{proof}

