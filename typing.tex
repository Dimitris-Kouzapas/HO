\section{Types}

\subsection{Session Types}

\[
	\begin{array}{rcl}
		H &\bnfis&	\lhot{T} \bnfbar \shot{T}\\
		T &\bnfis&	\tinact \bnfbar \trec{t}{T} \bnfbar \vart{t} \bnfbar \btout{H} T \bnfbar \btinp{H} T
		\bnfbar		\btsel{l_i:T_i}_{i \in I} \bnfbar \btbra{l_i:T_i}_{i \in I}
	\end{array}
\]\

We let $\logicop \in \set{\lollipop, \sharedop}$.

\subsection{Subtyping}


\begin{definition}
	Let $\lollipop\ <\ \sharedop$ to define $\subt\ =\ <^*$.
\end{definition}

\begin{definition}[Session Subtyping]
Let $\mathcal{T}$ to be the set of all session types.
Define the monotone function $F: \mathcal{T} \longrightarrow \mathcal{T}$:
%
\[
	\begin{array}{rcl}
		F(R)	& = &	\set{\tinact, \tinact}\\
			&\cup&	\set{(T_1, T_2) \setbar T_1 \logicop \diamond\ R\ T_2 \logicop \diamond}
			\cup	\set{(T_1, T_2) \setbar T_1 \lollipop \diamond\ R\ T_2 \sharedop \diamond}\\
			&\cup&	\set{(T_1, T_2) \setbar \btout{H_1} T_1\ R\ \btout{H_2} T_2, H_2\ R\ H_1}\\
			&\cup&	\set{(T_1, T_2) \setbar \btinp{H_1} T_1\ R\ \btinp{H_2} T_2, H_1\ R\ H_2}\\
			&\cup&	\set{(T_k, T'_k) \setbar \btsel{l_i: T_i}_{i \in I}\ R\ \btsel{l_i: T'_i}_{i \in I}, k \in I}\\
			&\cup&	\set{(T_k, T'_k) \setbar \btbra{l_i: T_i}_{i \in I}\ R\ \btbra{l_i: T'_i}_{i \in I}, k \in I}\\
			&\cup&	\set{(T_1, \trec{t} T_2) \setbar T_1\subst{\trec{t} T_1}{t}\ R\ \trec{t}{T_2}}
			\cup	\set{(\trec{t} T_1, T_2) \setbar \trec{t}{T_1}\ R\ T_2\subst{\trec{t} T_2}{t}}\\
			&\cup&	\set{(T_1, T_2) \setbar \trec{t} T_1\ R\ \trec{t} T_2}
	\end{array}
\]
%
$\subt = \nu R.F(R)$.
\end{definition}

\subsection{Duality}

\begin{definition}[Session Duality]
%Let $\mathcal{T}$ to be the set of all session types.
Define the monotone function $F: \mathcal{T} \longrightarrow \mathcal{T}$:
%
\[
	\begin{array}{rcl}
		F(R)	& = &	\set{\tinact, \tinact}\\
%			&\cup&	\set{(T_1, T_2) \setbar T_1 \logicop \diamond\ R\ T_2 \logicop \diamond}
%			\cup	\set{(T_1, T_2) \setbar T_1 \lollipop \diamond\ R\ T_2 \sharedop \diamond}\\
			&\cup&	\set{(T_1, T_2) \setbar \btinp{H_1} T_1\ R\ \btout{H_2} T_2, H_1\ \subt\ H_2}\\
			&\cup&	\set{(T_1, T_2) \setbar \btout{H_1} T_1\ R\ \btinp{H_2} T_2, H_2\ \subt\ H_1}\\
			&\cup&	\set{(T_k, T'_k) \setbar \btsel{l_i: T_i}_{i \in I}\ R\ \btbra{l_i: T'_i}_{i \in I}, k \in I}\\
			&\cup&	\set{(T'_k, T_k) \setbar \btbra{l_i: T_i}_{i \in I}\ R\ \btsel{l_i: T'_i}_{i \in I}, k \in I}\\
			&\cup&	\set{(T_1, \trec{t} T_2) \setbar T_1\subst{\trec{t} T_1}{t}\ R\ \trec{t}{T_2}}
			\cup	\set{(\trec{t} T_1, T_2) \setbar \trec{t}{T_1}\ R\ T_2\subst{\trec{t} T_2}{t}}\\
			&\cup&	\set{(T_1, T_2) \setbar \trec{t} T_1\ R\ \trec{t} T_2}
	\end{array}
\]
%
$\dualof = \nu R.F(R)$.
\end{definition}

\subsection{Typing System}

\[
	\Gamma \bnfis \Gamma \cat \X: H \bnfbar \es
\]

\[
	\Delta \bnfis \Delta \cat k:T \bnfbar \Delta \cat X \bnfbar \es
\]

\[
	\Gtprocess{P}{\Delta}
\]

\[
\begin{array}{crccr}
	\Gtprocess{\inact}{\es} & \trule{Inact}
	&\qquad&
	\tree{
		\Gtprocess{P}{\Delta} \quad k \notin \dom{\Delta}
	}{
		\Gtprocess{P}{\Delta \cat k:\tinact}
	} & \trule{Comp}
	\\[4mm]

	\tprocess{\Gamma \cat \X: \lhot{T}}{\appl{X}{k}}{k:T \cat X} & \trule{LAppl}
	& &
	\tprocess{\Gamma \cat \X: \shot{T}}{\appl{X}{k}}{k:T} & \trule{SAppl}
	\\[4mm]

	\tree{
		\Gtprocess{P}{\Delta \cat s: T'} \quad T' \subt T
	}{
		\Gtprocess{P}{\Delta \cat s: T}
	} & \trule{Subs}
	\\[4mm]

%	\multicolumn{5}{c}{
%		\tree{
%			\begin{array}{l}
%				\Gtprocess{Q}{\Delta_1 \cat x:T'} \quad \Gtprocess{P}{\Delta_2 \cat k:T} \quad
%				\dom{\Delta_1} \cap \dom{\Delta_2} = \es \\
%				\Delta_1 = \es \Rightarrow \logicop = \sharedop \wedge \Delta_1 \not= \es \Rightarrow \logicop = \lollipop
%			\end{array}
%		}{
%			\Gtprocess{\bout{k}{\abs{x} Q} P}{\Delta_1 \cat \Delta_2 \cat k: \btout{\hot{T'}} T}
%		}
%	\ \ \trule{Out}
%	}
%	\\[7mm]

	\multicolumn{5}{c}{
		\tree{
			\Gtprocess{Q}{\Delta \cat x:T'} \quad \Gtprocess{P}{k:T}
			\quad
			k \notin \dom{\Delta}
		}{
			\Gtprocess{\bout{k}{\abs{x} Q} P}{\Delta \cat k: \btout{\shot{T'}} T}
		}
	\ \ \trule{SOut}
	}
	\\[7mm]

	\multicolumn{5}{c}{
		\tree{
			\Gtprocess{Q}{\Delta_1 \cat x:T'} \quad \Gtprocess{P}{\Delta_2 \cat k:T}
			\quad
			\Delta_1 \not= \es
			\quad
			\dom{\Delta_1} \cap \dom{\Delta_2 \cat k:T} = \es
		}{
			\Gtprocess{\bout{k}{\abs{x} Q} P}{\Delta_1 \cat \Delta_2 \cat k: \btout{\lhot{T'}} T}
		}
	\ \ \trule{LOut}
	}
	\\[7mm]



%	\multicolumn{5}{c}{
%		\tree{
%			\tprocess{\Gamma \cat \X: \hot{T'}}{P}{\Delta \cat k: T} \quad \logicop = \lollipop \Rightarrow X \in \Delta
%		}{
%			\tprocess{\Gamma}{\binp{k}{\X} P}{\setsubtr{\Delta}{\X} \cat k: \btinp{\hot{T'}} T}
%		}\ \ \trule{In}
%	}
%	\\[7mm]

	\multicolumn{5}{c}{
		\tree{
			\tprocess{\Gamma \cat \X: \shot{T'}}{P}{\Delta \cat k: T} \quad \X \notin \Delta
		}{
			\tprocess{\Gamma}{\binp{k}{\X} P}{\Delta \cat k: \btinp{\shot{T'}} T}
		}\ \ \trule{SIn}
	}
	\\[7mm]

	\multicolumn{5}{c}{
		\tree{
			\tprocess{\Gamma \cat \X: \lhot{T'}}{P}{\Delta \cat k: T \cat X}
		}{
			\tprocess{\Gamma}{\binp{k}{\X} P}{\Delta \cat k: \btinp{\lhot{T'}} T}
		}\ \ \trule{LIn}
	}
	\\[7mm]


	\tree{
		\Gtprocess{P}{\Delta \cat s:T_1 \cat \dual{s}:T_2} \quad T_1 \dualof T_2
	}{
		\Gtprocess{\news{s} P}{\Delta}
	} & \trule{Res}
	& &
	\tree{
		\begin{array}{l}
			\Gtprocess{P_1}{\Delta_1} \quad \Gtprocess{P_2}{\Delta_2} \\
			\dom{\Delta_1} \cap \dom{\Delta_2} = \es
		\end{array}
	}{
		\Gtprocess{P_1 \Par P_2}{\Delta_1 \cat \Delta_2}
	} & \trule{Par}
	\\[7mm]

	\tree{
		\Gtprocess{P}{\Delta \cat k: T}
	}{
		\Gtprocess{P}{\Delta \cat k: \btsel{l:T}}
	} & \trule{Sel}
	& &
	\tree{
		\forall i \in I, \Gtprocess{P_i}{\Delta \cat k: T_i}
	}{
		\Gtprocess{\bbra{s}{l_i:P_i}_{i \in I}}{\Delta \cat k: \btbra{l_i:T_i}_{i \in I}}
	} & \trule{Bra}
\end{array}
\]

\subsection{Examples}

\begin{example}
\label{ex:linear_abstraction}
\[
	P = \binp{s}{\X} (\appl{\X}{s_1} \Par \appl{\X}{s_2})
\]
is untypable under environment $\Gamma = \X: \lhot{T}$, since:
\[
	\Gtprocess{\appl{\X}{s_1}}{s_1 : T \cat \X} \quad \Gtprocess{\appl{\X}{s_2}}{s_2 : T \cat \X}
\]
We cannot apply rule $\trule{Par}$ to get:
\[
	\Gtprocess{\appl{\X}{s_1} \Par \appl{\X}{s_2}}{s_1:T \cat s_2:T}
\]
because $\dom{s_1 : T \cat \X} \cup \dom{s_2 : T \cat \X} = \X$.

It is though typable under environment $\Gamma = \X: \shot{T}$, since:
\[
	\tree{
		\tree{
			\Gtprocess{\appl{\X}{s_1}}{s_1 : T} \quad \Gtprocess{\appl{\X}{s_2}}{s_2 : T} \quad \dom{s_1 : T} \cup \dom{s_2 : T} = \es
		}{
			\Gtprocess{\appl{\X}{s_1} \Par \appl{\X}{s_2}}{s_1 : T \cat s_2 : T}
		}
	}{
		\tprocess{}{\binp{s}{X} (\appl{\X}{s_1} \Par \appl{\X}{s_2})}{s: \btinp{\shot{T}} \tinact \cat s_1 : T \cat s_2 : T}
	}
\]

Now let
\[
	\begin{array}{rcl}
		Q_1 &=& \bout{\dual{s}}{\abs{x}{\bout{x}{\inact} \inact}} \inact\\
		Q_2 &=& \bout{\dual{s}}{\abs{x}{\bout{x}{\inact} \bout{s'}{\inact} \inact}} \inact
	\end{array}
\]

Process $\newsp{s}{Q_1 \Par P}$ is typable, whereas $\newsp{s}{Q_2 \Par P}$ is not.
This is due to the fact that abstraction $\abs{x}{\bout{x}{\inact} \bout{s'}{\inact} \inact}$
contains linear session $s'$ and should not be duplicated:
\[
P \Par Q_2 \red \bout{s_1}{\inact} \bout{s'}{\inact} \inact \Par \bout{s_2}{\inact} \bout{s'}{\inact} \inact
\]
The last process should not be typable because name $s'$ is appeared twice.

The type system avoids the above situation on rule $\trule{Out}$ and the duality relation:
%
\[
	\tree{
		\tprocess{}{\bout{x}{\inact} \bout{s'}{\inact} \inact}{x: T \cat s':T'} \tprocess{}{\inact}{\dual{s}:\tinact}
	}{
		\tprocess{}{Q_2}{s':T' \cat \dual{s}:\btout{\lhot{T}} \tinact}
	}
\]

We then apply rule $\trule{Par}$ to get:
\[
	\tprocess{}{P \Par Q_2}{s':T' \cat \dual{s}:\btout{\lhot{T}} \tinact \cat s: \btinp{\shot{T}} \inact s_1 : T \cat s_2 : T}
\]
On this typing node, rule $\trule{Res}$ is not applicable since
$\btout{\lhot{T}} \tinact$ is not dual with $\btinp{\shot{T}} \inact$.
\end{example}
