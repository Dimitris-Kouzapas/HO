This section defines a type system for
$\HOp$ and establishes its main properties. 
Our system is simpler than that in~\cite{tlca07}, in order to distill the key
features of higher-order communication in a session-typed setting.

\subsection{Types}
\label{subsec:types}
The syntax of types of \HOp is given below: 
\[
\begin{array}{lrl}
\text{(value)}	& U \bnfis &	\nonhosyntax{C} \bnfbar L\\[1mm]  % \bnfbar \Proc
\text{(chan)}   & C  \bnfis &	S \bnfbar \chtype{S}\bnfbar \chtype{L}
	\\[1mm]
\text{(lambda)} & L \bnfis &	\shot{C} \bnfbar \lhot{C}
	\\[1mm]
\text{(session)} &  S \bnfis & 	\btout{U} S \bnfbar \btinp{U} S 
\bnfbar \btsel{l_i:S_i}_{i \in I} \\ 
 & \bnfbar & \btbra{l_i:S_i}_{i \in I}
	  \bnfbar  \trec{t}{S} \bnfbar \vart{t}  \bnfbar \tinact
\end{array}
\]
In channel types, $\chtype{U}$ is shared channel types 
which are sent via shared channels. 
$\shot{C}$ and $\lhot{C}$ denote
{\em shared} and {\em linear} function types, respectively.
$\lhot{C}$ \cite{tlca07} ensures values which contain free 
session channels used once. 
 
We write $S$ to denote binary session types.  {\em Output type}
$\btout{U} S$ is assigned to a channel that first sends a value of
type $U$ and then follows the protocol described by $S$.  Dually,
$\btinp{U} S$ denotes an {\em input type}.  {\em Branching type}
$\btbra{l_i:S_i}_{i \in I}$ and {\em selection type}
$\btsel{l_i:S_i}_{i \in I}$ are standard.  We assume {\em recursive
  type} $\trec{t}{S}$ is guarded, i.e.  $\trec{t}{\vart{t}}$ is not
allowed.  Note that we allow carried type $U$ in $\btout{U} S$ and
$\btinp{U} S$ contains free recursive type variables, which is crucial
to encode $\HOp$ into $\HO$. Type $\tinact$ represents the
terminaition. 

The types of \HO excludes $\nonhosyntax{C}$ from 
value types of \HOp; and the types of \sessp exludes $L$. 
From each calculus $\CAL \in \{\HOp, \HO, \pi \}$, $\CAL^{-\mathsf{sh}}$ 
excludes shared channel type, $\chtype{S}$ and $\chtype{L}$, 
from channel type $C$.

We write $S_1 \dualof S_2$ if 
$S_1$ is dual of $S_2$ following \cite{TGC14}.  
Intuitively, 
the duality of types is defined by 
duallising $!$ by $?$, $?$ by $!$, $\oplus$ by $\&$ and $\&$ by $\oplus$,  
incorporating the fixed point construction 
(see Definition~\ref{def:dual} in Appendix). 

\subsection{Typing System of \HOp}
\label{subsec:typing}
\paragraph{Typing Judgements of \HOp}
\noi We define typing judgements for values $V$
and processes $P$:
%
\[	\begin{array}{c}
		\Gamma; \Lambda; \Delta \proves V \hastype U \qquad \qquad \qquad \Gamma; \Lambda; \Delta \proves P \hastype \Proc
	\end{array}
\]
The first judgement
states that under environment $\Gamma; \Lambda; \Delta$ values $V$
have type $U$, whereas the second judgement states that under
environment $\Gamma; \Lambda; \Delta$ process $P$ has the process type
$\Proc$. The environments are defined below:
\[
\begin{array}{l}
 \Lambda \bnfis  \emptyset \bnfbar \Lambda \cat \AT{x}{\lhot{C}}
\quad\quad \Delta  \ \bnfis  \ \emptyset \bnfbar \Delta \cat \AT{u}{S} \\
 \Gamma  \bnfis  \emptyset \bnfbar \Gamma \cat \varp{x}: \shot{C} \bnfbar \Gamma \cat u: \chtype{S} \bnfbar \Gamma \cat u: \chtype{L} 
        \bnfbar \Gamma \cat \rvar{X}: \Delta
\end{array}
\]
\noi 
$\Gamma$ is a mapping from variables, shared channels and recursive 
process variables;  $\Lambda$ is a mapping from variables to 
the linear functional types; and $\Delta$ is a mapping from 
session channels to session types. 

As expected, weakening, contraction, and exchange principles apply to
$\Gamma$; environments $\Lambda$ and $\Delta$ behave linearly, and are
only subject to exchange.  We require that the domains of $\Gamma,
\Lambda$ and $\Delta$ are pairwise distinct. $\Delta_1\cdot \Delta_2$ means 
a disjoint union of $\Delta_1$ and $\Delta_2$.  

The following definition ensures two session endpoints 
are dual each other. 

\begin{definition}[Balance]\label{d:wtenv}%\rm
	Let $\Delta$ be a session environment.
	We say that $\Delta$ is {\em balanced} if whenever
	$s: S_1, \dual{s}: S_2 \in \Delta$ then $S_1 \dualof S_2$.
\end{definition}

\paragraph{The Typing System of \HOp}
Since the typing system is similar to~\cite{tlca07}, we leave the full
typing sistem in Appendix~\ref{app:types}.  The rest of the paper can
be read without knowing the details of the typing system. We list the
key properties.



\begin{definition}[Session Environment Reduction]%\rm
\label{def:ses_red}
	We define the relation $\red$ on session environments as:
	\begin{enumerate}[$-$]
		\item	$\Delta \cat s: \btout{U} S_1 \cat \dual{s}: \btinp{U} S_2 \red \Delta \cat s: S_1 \cat \dual{s}: S_2$
		\item	$\Delta \cat s: \btsel{l_i: S_i}_{i \in I} \cat \dual{s}: \btbra{l_i: S_i'}_{i \in I} \red \Delta \cat s: S_k \cat \dual{s}: S_k', \quad k \in I$.
	\end{enumerate}
\end{definition}

%Theorem 7.3 in M\&Y
\begin{theorem}[Type Soundness]\label{t:sr}%\rm
	\begin{enumerate}[1.]
		\item	(Subject Congruence) Suppose $\Gamma; \es; \Delta \proves P \hastype \Proc$.
			Then $P \scong P'$ implies $\Gamma; \es; \Delta \proves P' \hastype \Proc$.

		\item	(Subject Reduction) Suppose $\Gamma; \es; \Delta \proves P \hastype \Proc$
			with
			well-typed $\Delta$. 
			Then $P \red P'$ implies $\Gamma; \es; \Delta'  \proves P' \hastype \Proc$
			and $\Delta = \Delta'$ or $\Delta \red \Delta'$
with $\Delta'$ well-formed. 
	\end{enumerate}
\end{theorem}
