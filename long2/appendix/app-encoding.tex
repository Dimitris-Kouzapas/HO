% !TEX root = ../main.tex
\section{Encoding Semantics}



\begin{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% POLYADIC TO MONADIC
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Properties for $\encod{\cdot}{\cdot}{\mathsf{p}}$}
\label{app:polmon}
We study the properties of the typed encoding in
Def.~\ref{d:enc:poltomon} (Page~\pageref{d:enc:poltomon}).

We repeat the statement of Prop.~\ref{prop:typepresp}, as in Page \pageref{prop:typepresp}:
\begin{proposition}[Type Preservation, Polyadic to Monadic]
Let $P$ be an  $\HOp$ process.
If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
			$\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta}^{\mathsf{p}} \proves \map{P}^{\mathsf{p}} \hastype \Proc$. 
\end{proposition}

\begin{proof}
By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
We examine two representative cases, using biadic communications.

\begin{enumerate}[1.]
\item Case 
$P = \bout{k}{V} P'$ and 
$\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{V} P' \hastype \Proc$. Then either $V = Y$ or $V = \abs{x_1,x_2}Q$, for some $Q$. The case $V = Y$ is immediate; we give details for the case $V = \abs{x_1,x_2}Q$, for which we have the following typing:
\[
\tree{
\tree{}{
\Gamma; \emptyset; \Delta_1 \cat k:S \proves P' \hastype \Proc}
\quad
\tree{
\Gamma; \emptyset; \Delta_2 \cat x_1: C_1 \cat x_2:C_2 \proves Q \hastype \Proc
}{
\Gamma; \emptyset; \Delta_2 \proves \abs{x_1,x_2}Q \hastype \lhot{(C_1,C_2)}
}
}{
\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{(C_1,C_2)}} S \proves \bout{k}{\abs{x_1,x_2}Q} P \hastype \Proc
}
\]
We now show the typing for $\map{P}^{\mathsf{p}}$. By IH we have both:
\[
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \proves \map{P'}^{\mathsf{p}} \hastype \Proc
\qquad
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \mapt{C_1}^{\mathsf{p}} \cat x_2:\mapt{C_2}^{\mathsf{p}} \proves \map{Q}^{\mathsf{p}} \hastype \Proc
\]
Let $L = \lhot{(C_1,C_2)}$. 
By Def.~\ref{d:enc:poltomon} 
we have  
$\mapt{L}^{\mathsf{p}} = \lhot{\big(\btinp{\tmap{C_1}{\mathsf{p}}} \btinp{\tmap{C_2}{\mathsf{p}}}\tinact\big)}$
and
$\map{P}^{\mathsf{p}} = \bbout{k}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}}} \map{P'}^{\mathsf{p}}$.
We can now infer the following typing derivation:
\[
\tree{
\tree{}
{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \proves \map{P'}^{\mathsf{p}} \hastype \Proc}
\quad
\tree{
\tree{
\tree{
\tree{
\tree{}{\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}} \proves 
 \map{Q}^{\mathsf{p}} \hastype \Proc}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}}
\cat z:\tinact \proves 
 \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}}\cat z:\btinp{\tmap{C_2}{\mathsf{p}}}\tinact \proves 
\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}} \cat z:\btinp{\tmap{C_1}{\mathsf{p}}}\btinp{\tmap{C_2}{\mathsf{p}}}\tinact \proves 
\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \Proc
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_2}^{\mathsf{p}}  \proves 
\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{\mathsf{p}} \hastype \lhot{(\tmap{C_1}{\mathsf{p}},\tmap{C_2}{\mathsf{p}})}
}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat \mapt{\Delta_2}^{\mathsf{p}} \cat k:\btout{\mapt{L}^{\mathsf{p}}} \mapt{S}^{\mathsf{p}} \proves \map{P}^{\mathsf{p}} \hastype \Proc
}
\]

\item Case $P = \binp{k}{x_1,x_2} P'$ 
and
$\Gamma; \emptyset; \Delta_1 \cat k: \btinp{(C_1, C_2)} S \proves \binp{k}{x_1,x_2} P' \hastype \Proc$.
We have the following typing derivation:
\[
\tree{
\Gamma; \emptyset; \Delta_1 \cat k:S \cat x_1: C_1 \cat x_2: C_2 \proves  P' \hastype \Proc
\quad
\Gamma; \emptyset;  \proves x_1, x_2 \hastype C_1,C_2
}{
\Gamma; \emptyset; \Delta_1 \cat k: \btinp{(C_1, C_2)} S \proves \binp{k}{x_1,x_2} P' \hastype \Proc
}
\]
By Def.~\ref{d:enc:poltomon} we have 
$\map{P}^{\mathsf{p}} = \binp{k}{x_1}\binp{k}{x_2}\map{P'}^{\mathsf{p}}$.
By IH we have 
$$
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}} \cat x_1: \tmap{C_1}{\mathsf{p}} \cat x_2: \tmap{C_2}{\mathsf{p}} \proves  \map{P'}^{\mathsf{p}} \hastype \Proc
$$
and the following type derivation:
\[
\tree{
\tree{
\tree{
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat x_1:\tmap{C_1}{\mathsf{p}} \cat x_2:\tmap{C_2}{\mathsf{p}} \cat k:\mapt{S}^{\mathsf{p}}  \proves  \map{P'}^{\mathsf{p}} \hastype \Proc
}
%\quad
%\tree{}{
%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_2:\tmap{C_2}{\mathsf{p}}  \proves  x_2 \hastype \tmap{C_2}{\mathsf{p}}}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat x_1:\tmap{C_1}{\mathsf{p}} \cat k:\btinp{\tmap{C_2}{\mathsf{p}}}\mapt{S}^{\mathsf{p}}  \proves  \binp{k}{x_2}\map{P'}^{\mathsf{p}} \hastype \Proc
}
%\quad
%\tree{}{
%\mapt{\Gamma}^{\mathsf{p}}; \emptyset; x_1:\tmap{C_1}{\mathsf{p}}  \proves  x_1 \hastype \tmap{C_1}{\mathsf{p}}}
}{
\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_1}^{\mathsf{p}} \cat k:\btinp{\tmap{C_1}{\mathsf{p}}}\btinp{\tmap{C_2}{\mathsf{p}}}\mapt{S}^{\mathsf{p}}  \proves  \map{P}^{\mathsf{p}} \hastype \Proc
}
\]
\end{enumerate}
\qed
\end{proof}

\end{comment}

%\subsection{Properties for $\encod{\cdot}{\cdot}{1}: \sessp^{-\mu} \to \HO$}
%\label{app:enc_sesspnr_to_ho}

%\begin{proposition}\rm
%	\label{app:enc_sesspnr_to_ho_typing}
%	Encoding $\encod{\cdot}{\cdot}{1}: \sessp^{-\mu} \to \HO$  is type-preserving (cf. Def.~\ref{def:ep}\,(1)).\rm
%\end{proposition}

%We repeat the statement of Prop.~\ref{prop:typepres1}, as in Page \pageref{prop:typepres1}:

%\begin{proposition}[Type Preservation, First-Order into Higher-Order]
%Let $P$ be a  $\sessp^{-\mu}$ process.
%If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
%			$\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} \proves \map{P}^{1} \hastype \Proc$. 
%\end{proposition}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO HO
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Properties for $\enco{\pmapp{\cdot}{1}{f}, \tmap{\cdot}{1}, \mapa{\cdot}^{1}}: \HOp \to \HO$}
\label{app:enc_HOp_to_HO}

We repeat the statement of \propref{prop:typepres_HOp_to_HO}, 
as in Page \pageref{prop:typepres_HOp_to_HO}:

%% Type Preservation

\begin{proposition}[Type Preservation, \HOp into \HO]
	\label{app:prop:typepres_HOp_to_HO}
	Let $P$ be a \HOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} \proves \pmapp{P}{1}{f} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the   inference of $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$. %\jp{TO BE ADJUSTED!}
%
	\begin{enumerate}[1.]
		%%%% Output of (linear) channel
		\item	Case $P = \bout{k}{n}P'$. There are two sub-cases.
			In the first sub-case $n = k'$ (output of a linear channel). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P' \hastype \Proc \quad \Gamma ; \emptyset ; \{k' : S_1\} \proves  k' \hastype S_1}{
					\Gamma; \emptyset; \Delta \cat k':S_1 \cat k:\btout{S_1}S \proves  \bout{k}{k'} P' \hastype \Proc}
			\]
			}
			Thus, by IH we have
			$$
			\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmap{P'}{1} \hastype \Proc
			$$
			Let us write $U_1$
			to stand for $\lhot{\btinp{\lhot{\tmap{S_1}{1}}}\tinact}$.
			The corresponding typing in the target language is as follows:
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t1}
				\tree{
					\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} ; \set{X : \lhot{\tmap{S_1}{1}}} ; \emptyset \proves \X  \hastype \lhot{\tmap{S_1}{1}}
								\qquad 
								\tmap{\Gamma}{1} ; \emptyset ; \set{k' : \tmap{S_1}{1}} \proves  k' \hastype \tmap{S_1}{1}
							}{
								\tmap{\Gamma}{1} ; \set{X : \lhot{\tmap{S_1}{1}}} ; k' : \tmap{S_1}{1} \proves \appl{\X}{k'} \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1} ; \{X : \lhot{\tmap{S_1}{1}}\} ; k' : \tmap{S_1}{1} \cat z:\tinact \proves \appl{\X}{k'} \hastype \Proc
						}
					}{
						\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \cat z:\btinp{\lhot{\tmap{S_1}{1}}}\tinact \proves \binp{z}{X} \appl{\X}{k'} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{X} \appl{\X}{k'}} \hastype U_1
				}
			\end{eqnarray}
			\begin{eqnarray*}
				\tree{
					\tmap{\Gamma}{1}; \emptyset ; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \pmap{P'}{1} \hastype \Proc
					\qquad
					\tmap{\Gamma}{1} ; \emptyset; k' : \tmap{S_1}{1} \proves \abs{z}{\binp{z}{X} \appl{\X}{k'}} \hastype U_1 \ \eqref{prop:sesspnr_to_HO_t1}
				}{
					\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k':\tmap{S_1}{1} \cat k:\btout{U_1}\tmap{S}{1} \proves  \bbout{k}{\abs{z}{\binp{z}{X} \appl{\X}{k'}}} \pmap{P'}{1} \hastype \Proc
				}
			\end{eqnarray*}
%
	
		%%%% Output of (shared) channel
			In the second sub-case, we have $n = a$ (output of a shared name). Then  
			we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma \cat a:\chtype{S_1}; \emptyset; \Delta \cat k:S  \proves
					P' \hastype \Proc \quad \Gamma \cat a:\chtype{S_1} ; \emptyset ; \emptyset \proves  a \hastype S_1
				}{
					\Gamma \cat a:\chtype{S_1} ; \emptyset; \Delta  \cat k:\bbtout{\chtype{S_1}}S \proves  \bout{k}{a} P' \hastype \Proc
				}
			\]
			}
			The typing in the target language is derived similarly as in the first sub-case. \\
	
		%%%% Input of (linear) channel 
		\item	Case $P = \binp{k}{x}Q$. We have two sub-cases, depending on the type of $x$.
			In the first case, $x$ stands for a linear channel.
			Then we have the following typing in the source language:
			{
			\[
				\tree{
					\Gamma; \emptyset; \Delta  \cat k:S \cat x:S_1 \proves   Q \hastype \Proc
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btinp{S_1}S \proves  \binp{k}{x} Q \hastype \Proc
				}
			\]
			 }
			 Thus, by IH we have
			 $$
			 \tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat x:\tmap{S_1}{1} \proves  \pmap{Q}{1}   \hastype \Proc
			 $$
			 Let us write $U_1$ to stand for $\lhot{\btinp{\lhot{\tmap{S_1}{1}}}\tinact}$.
			 The corresponding typing in the target language is as follows:
			{\small
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t2}
				\tree{
					\tmap{\Gamma}{1}; \{X: U_1\};   \emptyset \proves X \hastype U_1
					\qquad
					\tmap{\Gamma}{1}; \emptyset;   \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves s \, \hastype  \btinp{\lhot{\tmap{S_1}{1}}} \tinact 
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};   \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{X}{s}  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t3}
				\tree{
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \emptyset \proves   \inact  \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \dual{s}: \tinact\proves   \inact  \hastype \Proc
					}
					\quad 
					\tree{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  x:\tmap{S_1}{1} \proves \pmap{Q}{1}   \hastype \Proc
					}{
						\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}   \proves \abs{x} \pmap{Q}{1}   \hastype \lhot{\tmap{S_1}{1}}
					}
				}{
					\tmap{\Gamma}{1}; \emptyset;  \tmap{\Delta}{1} \cat k:\tmap{S}{1}  \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves  \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sesspnr_to_HO_t4}
		 		\tree{
					\begin{array}{cl}
						\tmap{\Gamma}{1}; \{X: U_1\}; \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \ \proves \appl{X}{s}  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t2}
						\\
						\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact \proves
						\bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
						& \eqref{prop:sesspnr_to_HO_t3}
					\end{array}
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves \appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc
			}
			\end{eqnarray}
%
			\begin{eqnarray*}
			\\
			 \tree{
				 \tree{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \cat s: \btinp{\lhot{\tmap{S_1}{1}}}\tinact \cat \dual{s}: \btout{\lhot{\tmap{S_1}{1}}}\tinact\proves \appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact  \hastype \Proc \quad \eqref{prop:sesspnr_to_HO_t4}
				}{
					\tmap{\Gamma}{1}; \{X: U_1\};  \tmap{\Delta}{1} \cat k:\tmap{S}{1} \proves \newsp{s}{\appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}  \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1}; \emptyset; \tmap{\Delta}{1}  \cat k:\btinp{U_1}\tmap{S}{1} \proves  \binp{k}{X} \newsp{s}{\appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}  \hastype \Proc
			}
			\end{eqnarray*}
			 }
			 
			 In the second sub-case, $x$ stands for a shared name. Then we have the following typing in the source language:
			\[
			 \tree{
				\Gamma \cat x:\chtype{S_1} ; \emptyset; \Delta  \cat k:S \proves   Q \hastype \Proc
			 }{
				\Gamma ; \emptyset; \Delta  \cat k:\btinp{\chtype{S_1}}S \proves  \binp{k}{x} Q \hastype \Proc}
			 \]
			 The typing in the target language is derived similarly as in the first sub-case.	

		\item	Case $P_0 = \varp{X}$.
			Then we have the following typing in the source language:
%
			\[
				\Gamma \cat \varp{X}: \Delta ;\, \es ;\, \es \proves \varp{X} \hastype \Proc
			\]
%
			Then the typing of $\pmapp{\varp{X}}{1}{f}$ is as follows,
			assuming $f(\varp{X}) = \tilde{n}$ and $\tilde{x} = \vmap{\tilde{n}}$.
			Also, we write $\Delta_{\tilde{n}}$ 
			and $\Delta_{\tilde{x}}$ 
			to stand for 
			$n_1: S_1, \ldots, n_m: S_m$ and
			$x_1: S_1, \ldots, x_m: S_m$, respectively. 
			Below, we assume that $\Gamma = \Gamma' \cat X:\shot{\tilde{T}}$, 
			where  
			%$$\tilde{T} =  \trec{t}{\big(\tilde{S}, \btinp{\vart{t}}\tinact\big)}$$.
			\[
				\tilde{T} = \big(\tilde{S}, S^*\big) \qquad \quad
				S^* = \bbtinp{A}\tinact \qquad \quad
				A = \trec{t}{(\tilde{S}, \btinp{\vart{t}}\tinact)}
			\]
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t1}
				\tree{
					\tree{
					}{
						\Gamma ;\, \es ;\, \es \proves X \hastype \shot{\tilde{T}}
					}
					\quad 
					\begin{array}{c}
						\Gamma ;\, \es ;\, \{n_i: S_i \} \proves n_i \hastype S_i \\
						\Gamma ;\, \es ;\, \{s: S^* \} \proves s\hastype S^*  \\
					\end{array}
				}{
					\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact
					\proves  
					\appl{\X}{\tilde{n}, s} \hastype \Proc
				} 
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t2}
				\tree{
					\tree{
						\Gamma  ;\, \es ;\,   \es \proves \inact \hastype \Proc
					}{
						\Gamma  ;\, \es ;\,   \dual{s}: \tinact \proves \inact \hastype \Proc
					} 
					\quad
					\tree{
						\tree{
							\begin{array}{c}
								\Gamma ;\, \es ;\, \{x_i: S_i \} \proves x_i \hastype S_i \\
								\Gamma ;\, \es ;\, \{z: S^*  \} \proves z\hastype S^*  \\
								\Gamma ;\, \es ;\, \es \proves X \hastype \shot{\tilde{T}}  \\
							\end{array}
						}{
							\Gamma  ;\, \es ;\,   \Delta_{\tilde{x}}, \, z:S^*
							\proves 
							 {\appl{X}{ \tilde{x}, z}} \hastype \Proc
						}
					}{
						\Gamma  ;\, \es ;\,   \es
						\proves 
						 \abs{\tilde{x},z}\,\,{\appl{X}{ \tilde{x}, z}} \hastype \shot{\tilde{T}}
					} 	
				}{
					\Gamma  ;\, \es ;\,   \dual{s}: \btout{\shot{\tilde{T}}}\tinact
					\proves 
					\bbout{\dual{s}}{ \abs{\tilde{x},z}\,\,{\appl{X}{ \tilde{x}, z}}} \inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
			\tree{
				\tree{
					\begin{array}{cc}
						\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact
						\proves  
						\appl{\X}{\tilde{n}, s} \hastype \Proc
						& \eqref{prop:sessp_to_HO_t1}
						\\ 
						\Gamma  ;\, \es ;\,   \dual{s}: \btout{\shot{\tilde{T}}}\tinact
						\proves 
						\bbout{\dual{s}}{ \abs{\tilde{x},z}\,\,{\appl{X}{ \tilde{x}, z}}} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t2}
					\end{array}
				}{
					\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}, s:\btinp{\shot{\tilde{T}}}\tinact, \, \dual{s}: \btout{\shot{\tilde{T}}}\tinact
					\proves 
					\appl{\X}{\tilde{n}, s} \Par \bbout{\dual{s}}{ \abs{\tilde{x},z}\,\,{\appl{X}{ \tilde{x}, z}}} \inact \hastype \Proc
				}
			}{
				\Gamma  ;\, \es ;\, \Delta_{\tilde{n}}
				\proves 
				\newsp{s}{\appl{\X}{\tilde{n}, s} \Par \bbout{\dual{s}}{ \abs{\tilde{x},z}\,\,{\appl{X}{ \tilde{x}, z}}} \inact} \hastype \Proc
			}
			\]
%	
		\item	Case $P_0 = \recp{X}{P}$. Then we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat \varp{X}:\Delta ;\, \es ;\,  \Delta \proves P \hastype \Proc
				}{
					\Gamma  ;\, \es ;\,  \Delta \proves \recp{X}{P} \hastype \Proc
				}
			\]
%	
			Then we have the following typing in the target language ---we write $R$
			to stand for $\pmapp{P}{1}{{f,\{\varp{X}\to \tilde{n}\}} }$
			and $\tilde{x}$ to stand for $\vmap{\ofn{P}}$.
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t4}
				\tree{
					\tree{
						\tmap{\Gamma}{1}\cat X:\shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}
						\proves
						 R  \hastype \Proc
					}{
						\tmap{\Gamma}{1}\cat X:\shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\tinact 
						\proves
						 R  \hastype \Proc
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact 
					\proves
					\binp{s}{\X} R  \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:sessp_to_HO_t5}
				\tree{
					\tree{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						\inact \hastype \Proc
					}{
						\tmap{\Gamma}{1};\, \es;\, \dual{s}:\tinact
						\proves
						\inact \hastype \Proc
					} 
					\quad 
					\tree{
						\tree{
							\tree{
								\tmap{\Gamma}{1} \cat X: \shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}
								\proves
								{{\auxmap{R}{\es}}}  \hastype \Proc
							}{
								\tmap{\Gamma}{1} \cat X: \shot{\tilde{T}};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1},z: \tinact
								\proves
								{{\auxmap{R}{\es}}}  \hastype \Proc
							}
						}{
							\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{x}}}{1}, \, z: \btinp{A}\tinact
							\proves
							{{\binp{z}{\X} \auxmap{R}{\es}}}  \hastype \Proc
						}
					}{
						\tmap{\Gamma}{1};\, \es;\, \es
						\proves
						{\abs{\tilde{x}, z } \,{\binp{z}{\X} \auxmap{R}{\es}}}  \hastype \shot{\tilde{T}}
					}
				}{
					\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{\tilde{T}}}\tinact
					\proves
					\bbout{\dual{s}}{\abs{\tilde{x}, z } \,{\binp{z}{\X} \auxmap{R}{\es}}} \inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
			\tree{
				\tree{
					\begin{array}{cc}
						\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact 
						\proves
						\binp{s}{\X} R  \hastype \Proc
						& \eqref{prop:sessp_to_HO_t4}
						\\
						\tmap{\Gamma}{1};\, \es;\, \dual{s}:\btout{\shot{\tilde{T}}}\tinact
						\proves
						\bbout{\dual{s}}{\abs{\tilde{x}, z } \,{\binp{z}{\X} \auxmap{R}{\es}}} \inact \hastype \Proc
						& \eqref{prop:sessp_to_HO_t5}
					\end{array}
				}{
					\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1}, s:\btinp{\shot{\tilde{T}}}\tinact , \dual{s}:\btout{\shot{\tilde{T}}}\tinact
					\proves
					\binp{s}{\X} R \Par \bbout{\dual{s}}{\abs{\tilde{x}, z } \,{\binp{z}{\X} \auxmap{R}{\es}}} \inact \hastype \Proc
				}
			}{
				\tmap{\Gamma}{1};\, \es;\, \tmap{\Delta_{\tilde{n}}}{1} 
				\proves
				\newsp{s}{\binp{s}{\X} R \Par \bbout{\dual{s}}{\abs{\tilde{x}, z } \,{\binp{z}{\X} \auxmap{R}{\es}}} \inact} \hastype \Proc
			}
			\]
	\end{enumerate}
	\qed
\end{proof}


%%% Operational Correspondence

We repeat the statement of
\propref{prop:op_corr_HOp_to_HO}, 
as in Page \pageref{prop:op_corr_HOp_to_HO}:

\begin{proposition}[Operational Correspondence, \HOp into \HO]\rm
	\label{app:prop:op_corr_HOp_to_HO}
	Let $P$ be a \HOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then:
%
	\begin{enumerate}[1.]
		\item
			Suppose $\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P'}$. Then we have:
%
			\begin{enumerate}[a)]
				\item
					If $\ell_1 \in \set{\news{\tilde{m}}\bactout{n}{m}, \,\news{\tilde{m}}\bactout{n}{\abs{x}Q}, \,\bactsel{s}{l}, \,\bactbra{s}{l}}$
					then $\exists \ell_2$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{\pmapp{P'}{1}{f}}$
					and $\ell_2 = \mapa{\ell_1}^{1}$.
			
				\item
					If $\ell_1 = \bactinp{n}{\abs{y}Q}$ and
					$P' = P_0 \subst{\abs{y}Q}{x}$
					then $\exists \ell_2$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{\pmapp{P_0}{1}{f}\subst{\abs{y}\pmapp{Q}{1}{\emptyset}}{x}}$
					and $\ell_2 = \mapa{\ell_1}^{1}$.
			
				\item
					If $\ell_1 = \bactinp{n}{m}$
					and 
					$P' = P_0 \subst{m}{x}$
					then $\exists \ell_2$, $R$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{R}$,
					with $\ell_2 = \mapa{\ell_1}^{1}$, \\
					and
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta'}{1}}{R}{\hby{\btau} \hby{\stau} \hby{\btau}}
					{\tmap{\Delta'}{1}}{\pmapp{P_0}{1}{f}\subst{m}{x}}$.
						
				\item
					If $\ell_1 = \tau$
					and $P' \scong \newsp{\tilde{m}}{P_1 \Par P_2\subst{m}{x}}$
					then $\exists R$ s.t. \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}{\mapt{\Delta}^{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par R}}$,
					and\\ 
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par R}}{\hby{\btau} \hby{\stau} \hby{\btau}}
					{\mapt{\Delta}^{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f} \Par \pmapp{P_2}{1}{f}\subst{m}{x}}}$.
			
				\item
					If $\ell_1 = \tau$
					and $P' \scong \newsp{\tilde{m}}{P_1 \Par P_2 \subst{\abs{y}Q}{x}}$
					then \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}
					{\tmap{\Delta_1}{1}}{\newsp{\tilde{m}}{\pmapp{P_1}{1}{f}\Par \pmapp{P_2}{1}{f}\subst{\abs{y}\pmapp{Q}{1}{\emptyset}}{x}}}$.
			
				\item
					If $\ell_1 = \tau$
					and $P' \not\scong \newsp{\tilde{m}}{P_1 \Par P_2 \subst{m}{x}} \land P' \not\scong \newsp{\tilde{m}}{P_1 \Par P_2\subst{\abs{y}Q}{x}}$
					then \\
					$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\tau}}{\tmap{\Delta'_1}{1}}{ \pmapp{P'}{1}{f}}$.
			\end{enumerate}
			
		\item	Suppose $\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{\pmapp{P}{1}{f}}{\hby{\ell_2}}{\tmap{\Delta'}{1}}{Q}$.
			Then we have:
%
			\begin{enumerate}[a)]
				\item 
					If $\ell_2 \in
					\set{\news{\tilde{m}}\bactout{n}{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}, \,\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \,\bactsel{s}{l}, \,\bactbra{s}{l}}$
					then $\exists \ell_1, P'$ s.t. \\
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P'}$, 
					$\ell_1 = \mapa{\ell_2}^{1}$, 
					and
					$Q = \pmapp{P'}{1}{f}$.
			
				\item 
					If $\ell_2 = \bactinp{n}{\abs{y} R}$ %(with $R \neq \binp{y}{x} \appl{x}{m}$)
					then either:
%
					\begin{enumerate}[(i)]
						\item	$\exists \ell_1, x, P', P''$ s.t. \\
							$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P' \subst{\abs{y}P''}{x}}$, 
							$\ell_1 = \mapa{\ell_2}^{1}$, $\pmapp{P''}{1}{\es} = R$, and $Q = \pmapp{P'}{1}{f}$.

						\item	$R \scong \binp{y}{x} \appl{x}{m}$ and 
							$\exists \ell_1, z, P'$ s.t. \\
							$\horel{\Gamma}{\Delta}{P}{\hby{\ell_1}}{\Delta'}{P' \subst{m}{z}}$, 
							$\ell_1 = \mapa{\ell_2}^{1}$,
							and\\
							$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta'}{1}}{Q}{\hby{\btau} \hby{\stau} \hby{\btau}}{\tmap{\Delta''}{1}}{\pmapp{P'\subst{m}{z}}{1}{f}}$
					\end{enumerate}
			
				\item 
					If $\ell_2 = \tau$ 
					then $\Delta' = \Delta$ and 
					either
%
					\begin{enumerate}[(i)]
						\item	$\exists P'$ s.t. 
							$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta}{P'}$,
							and $Q = \map{P'}^{1}_f$.	

						\item
							$\exists P_1, P_2, x, m, Q'$ s.t. 
							$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta}{\newsp{\tilde{m}}{P_1 \Par P_2\subst{m}{x}} }$, and\\
							$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta}{1}}{Q}{\hby{\btau} \hby{\stau} \hby{\btau}}{\tmap{\Delta}{1}}{\pmapp{P_1}{1}{f} \Par \pmapp{P_2\subst{m}{x}}{1}{f}}$ 
%							$Q = \map{P_1}^{1}_f \Par Q'$, where $Q'  \Hby{} $.

%						\item $\exists P_1, P_2, x, R$ s.t. 
%						$\stytra{ \Gamma }{\tau}{ \Delta }{ P}{ \Delta}{ \news{\tilde{m}}(P_1 \Par P_2\subst{\abs{y}R}{x}) }$, and 
%						$Q = \map{\news{\tilde{m}}(P_1 \Par P_2\subst{\abs{y}R}{x})}^{1}_f$.
			\end{enumerate}
		    \end{enumerate}
		    
%		\item   
%			If  $\wtytra{\mapt{\Gamma}^{1}}{\ell_2}{\mapt{\Delta}^{1}}{\pmapp{P}{1}{f}}{\mapt{\Delta'}^{1}}{Q}$
%			then $\exists \ell_1, P'$ s.t.  \\
%			(i)~$\stytra{\Gamma}{\ell_1}{\Delta}{P}{\Delta'}{P'}$,
%			(ii)~$\ell_2 = \mapa{\ell_1}^{1}$, 
%			(iii)~$\wbb{\mapt{\Gamma}^{1}}{\ell}{\mapt{\Delta'}^{1}}{\pmapp{P'}{1}{f}}{\mapt{\Delta'}^{1}}{Q}$.
	\end{enumerate}
\end{proposition}


\begin{proof}

By transition induction. We consider parts (1) and (2) separately:

\noi \textbf{Part (1) - Completeness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
	%%  Output 
	\item	Subcase  (a): $P =\bout{s}{n} P'$ and $\ell_1 = \bactout{s}{n}$ (the case $\ell_1 = \news{n}\bactout{s}{n}$ is similar). By assumption, $P$ is well-typed. 
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat s:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{n{:} S\}  \proves   n \hastype S }{
				\Gamma; \emptyset; \Delta_0 \cat n{:}S \cat s:\btout{S}S_1 \proves \bout{s}{n} P' \hastype \Proc}
		\]
%
		\noi for some $S, S_1, \Delta_0$.
		%such that $\Delta = \Delta_0 \cat k_1{:}T  \cat k:\btout{T}S$.
		We may then have the following transition:
%
		\[
			\stytra{\Gamma}{\ell_1}{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1 }{\bout{s}{n} P'}{\Delta_0 \cat s{:}S_1 }{P'}
		\]
%
		\noi The encoding of the source judgment for $P$ is as follows:
%
		\[
			\mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0 \cat n{:}S \cat s:\btout{S}S_1}^{1} \proves \map{\bout{s}{n} P'}^{1} \hastype \Proc
		\]
%
		\noi which, using Def.~\ref{def:enc:HOp_to_HO} can be expressed as 
%
		\[
			\mapt{\Gamma}^{\mathsf{p}}; \emptyset; \mapt{\Delta_0} 
			\cat n{:}\mapt{S}^{1} 
			\cat s: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} \appl{x}{n}} } \pmap{P'}{1}
			\hastype \Proc
		\]
%
		\noi Now, $\mapa{\ell_1}^{1} = \bactout{s}{\abs{z}{\,\binp{z}{x} \appl{x}{n}}\, } $. 
		We may infer the following  transition for $\map{P}^{1}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta}^{1} 
			\proves 
			\bbout{s}{ \abs{z}{\,\binp{z}{x} \appl{x}{n}} } \pmap{P'}{1}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}} & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0}^{1} 
			\cat s:  \tmap{S_1}{1}
			\proves  \pmap{P'}{1}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1}; \emptyset; \mapt{\Delta_0 \cat s:  S_1}^{1}
			\proves  \pmap{P'}{1}
			\hastype \Proc 
		\end{eqnarray*}
%
		\noi from which the thesis follows easily.

	\item	Subcase (c): $P = \binp{n}{x} P'$	and $\ell_1 = \bactinp{n}{m}$.
		By assumption $P$ is well-typed.
		We may have:
%
		\[
			\tree{
				\Gamma; \emptyset; \Delta_0 \cat x:S \cat n:S_1  \proves  P' \hastype \Proc \quad 
				\Gamma ; \emptyset ; \{x: S\}  \proves   x\hastype S}{
				\Gamma; \emptyset; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc}
		\]
%
		for some  $S, S_1, \Delta_0$.
%		such that $\Delta = \Delta_0 \cat k:\btinp{T}S$.
		We may infer the following typed transition:
%
		\[
			\Gamma; \emptyset; \Delta_0 \cat   n:\btinp{S}S_1 \proves \binp{n}{x} P' \hastype \Proc
			\hby{\bactinp{n}{m}}
			\Gamma; \emptyset; \Delta_0 \cat  n:S_1 \cat m:S \proves   P'\subst{m}{x} \hastype \Proc
		\]
%
		The encoding of the source judgment for $P$ is as follows:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 \cat   n:\btinp{S}S_1 }^{1} \proves 
			\map{P}^{1}
			\hastype \Proc \\
			& = & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc
		\end{eqnarray*}
%
		Now, 
		$\mapa{\ell_1}^{1} = \bactinp{n}{\abs{z}{\,\binp{z}{x} \appl{x}{m}}\, }$
		and it is immediate to infer the following 
		transition for $\map{P}^{1}$:
%
		\begin{eqnarray*}
			&  & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} \proves 
			\binp{n}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc \\
			& \hby{\mapa{\ell_1}^{1}}  & \mapt{\Gamma}^{1}; \emptyset; \mapt{ \Delta_0 }^{1} \cat   
			n:  \tmap{S_1}{1} \cat m:  \tmap{S}{1} \proves 
			 \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}{x}
			\hastype \Proc 
		\end{eqnarray*}
%
		Let us write $R$ to stand for process 
		$\newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}{x}$. 
		%$\newsp{s}{\appl{X}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{Q}{1}}} \inact}\subst{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}{X}$.
		We then have:
		\begin{eqnarray*}
		R & \by{\tau} & \newsp{s}{\binp{s}{x} \appl{x}{m} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \\
		& \by{\tau} &  \appl{(\abs{x}{\pmap{P'}{1}})}{m} \Par \inact \\
		& \by{\tau} & \pmap{P'}{1}\subst{m}{x}
		\end{eqnarray*}
		and so the thesis follows.

		%%%%%%%%%%%
		%%  Recursion
		%%%%%%%%%%%

%	\item	Case $P =\recp{X}{P'}$ and $P = \varp{X}$.
%
%		It follows similar arguments with the previous cases
%		and uses Prop.~\ref{prop:op_corr_HOprec_to_HO} whenever necessary.
		
\end{enumerate}
%
\noi \textbf{Part (2) - Soundness}. We consider two representative cases, the rest is similar or simpler:
%
\begin{enumerate}[1.]
		%%%%%%%%%%%
		%%  Output 
		%%%%%%%%%%%
	\item Subcase (a): $P = \bout{n}{m} P'$ and $\ell_2 = \bactout{n}{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}$
	(the case $\ell_2 = \news{m}\bactout{n}{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}$ is similar).
		%,  $\map{P}^{1} = \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1}$.
		Then 
		we have: % the following typed transition for $\map{P}^{1}$:
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} \appl{x}{m}} } \pmap{P'}{1} 
			 \hastype \Proc
		\]
%
		for some $S, S_1$, and $\Delta_0$. 
		We may infer the following typed transition for $\pmap{P}{1}$:
%
		\begin{eqnarray*}
			& & \mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \btout{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1} 
			\proves 
			 \bbout{n}{ \abs{z}{\,\binp{z}{x} \appl{x}{m}} } \pmap{P'}{1} 
			 \\
			%& & \bbout{k}{ \abs{z}{\,\binp{z}{X} \appl{X}{k'}} } \pmap{P'}{1} \hby{\bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}} \pmap{P'}{1}  \\
			&\hby{\ell_2}& 
			\mapt{\Gamma}^{1};\, \mapt{\Delta_0}^{1} \cat n: \tmap{S_1}{1} 
			\proves  \pmap{P'}{1} 
		\end{eqnarray*}
%
		%with $\ell_2 = \bactout{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k'}}}$.
		Now, in the source term $P$ we can infer the following transition 
%
		\[
		\Gamma;\,  \Delta_0 \cat n:\btout{S} S_1 \proves \bout{n}{m} P'
		 \hby{\bactout{n}{m}} 
		 \Gamma;\,  \Delta_0 \cat n: S_1 \proves P'
		\]
%
		and thus the thesis follows easily by noticing that 
		$\mapa{\bactout{n}{m}}^{1} = \bactout{n}{\abs{z}{\,\binp{z}{x} \appl{x}{m}}}$.


		%%%%%%%%%%%
		%% Input
		%%%%%%%%%%%
	\item	Subcase (c): $P = \binp{n}{x} P'$ and $\ell_2 = \bactinp{n}{\abs{y}\binp{y}{x} \appl{x}{m}}$.
		Then we have
%
		\[
			\mapt{\Gamma}^{1};\, \emptyset;\, \mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}
			\hastype \Proc
		\]
%
		for some $S$, $S_1$, $\Delta_0$.
		We may infer the following typed transitions for $\pmap{P}{1}$:
%
		\begin{eqnarray*}
			& & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n: \btinp{\lhot{\btinp{\lhot{\tmap{S}{1}}}\tinact}} \tmap{S_1}{1}
			\proves
			\binp{n}{x} \newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \\
			& \hby{\ell_2} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} \cat 
			n:\tmap{S_1}{1}
			\cat m:\tmap{S_1}{1}
			\proves
			\newsp{s}{\appl{x}{s} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact} \subst{\abs{z}\binp{z}{x}\appl{x}{m}}{x} \\
			& = & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\newsp{s}{\binp{s}{x}\appl{x}{m} \Par \bbout{\dual{s}}{\abs{x}{\pmap{P'}{1}}} \inact}  \\
			& \hby{\tau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\appl{(\abs{x}{\pmap{P'}{1}})}{m}   \\
			& \hby{\tau} & 
			\mapt{\Gamma}^{1};\, %\emptyset;\, 
			\mapt{\Delta_0}^{1} 
			\cat n:\tmap{S_1}{1}
			\cat m:\tmap{S}{1}
			\proves
			\pmap{P'}{1}\subst{m}{x}   
		\end{eqnarray*}
%
		%with $\ell_2 = \bactinp{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}$.
		Now, in the source term $P$ we can infer the following transition 
%
		\[
			\Gamma;\,  \Delta_0 \cat n:\btinp{S} S_1 \proves \binp{n}{x} P'
			\hby{\bactinp{n}{m}} 
			\Gamma;\,  \Delta_0 \cat n: S_1 \cat m: S \proves P'\subst{m}{x}
		\]
%
		and the thesis follows.
%		 easily by noticing that $\mapa{\bactinp{k}{k_1}}^{1} = \bactinp{k}{\abs{z}{\,\binp{z}{X} \appl{X}{k_1}}}$.

		%%%%%%%%%%%
		%%  Recursion
		%%%%%%%%%%%
%	\item	Case $P =\recp{X}{P'}$ and $P = \varp{X}$.
%
%		It follows similar arguments with the previous case
%		and uses Prop.~\ref{prop:op_corr_HOprec_to_HO} whenever nescessary.
\end{enumerate}
\qed
\end{proof}


%%%%%%%% Full Abstraction

We repeat the statement of
\propref{prop:fulla_HOp_to_HO}, 
as in Page~\pageref{prop:fulla_HOp_to_HO}:

\begin{proposition}[Full Abstraction, \HOp into \HO]\rm
	\label{app:prop:fulla_HOp_to_HO}
	$\horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1}$
	if and only if
	$\horel{\tmap{\Gamma}{1}}{\tmap{\Delta_1}{1}}{\pmapp{P_1}{1}{f}}{\wb}{\tmap{\Delta_2}{1}}{\pmapp{Q_2}{1}{f}}$.
\end{proposition}

\begin{proof}
	\noi {\bf Proof of Soundness Direction.}

	\noi Let
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1} \setbar \horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\wb}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}}
	\]
%
	\noi	The proof considers a case analysis on the transition $\hby{\ell}$ and
		uses the soundness direction of operational correspondence (cf.~Proposition~\ref{prop:op_corr_HOp_to_HO}).
		We give an interesting case. The others are similar of easier.

	\noi	- Case: $\ell = \news{\tilde{m_1}'} \bactout{n}{m_1}$.

	\noi Proposition~\ref{prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}
	\]
%
	\noi implies
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} \appl{x}{m_1}}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi that in combination with the definition of $\Re$ we get
%
	\begin{eqnarray}
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} \appl{x}{m_2}}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs11}
	\end{eqnarray}
%
	\noi and
%
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\newsp{\tilde{m_1}'}{\pmapp{P_2}{1}{f} \Par \hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} \appl{x}{m_1}}} }}
		{\wb}{\mapt{\Delta_2'}^{1}}{}{\newsp{\tilde{m_2}'}{\pmapp{Q_2}{1}{f} \Par \hotrigger{t}{x}{s}{\abs{z}{\binp{z}{x} \appl{x}{m_2}}}}}
	\]
%
	\noi We rewrite the last result as
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\wb}{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi to conclude that
%
	\[
		\mhorel{\Gamma}{\Delta_1'}{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}
		{\ \Re\ }{\Delta_2'}{}{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}
	\]
%
	\noi as required


	\noi {\bf Proof of Completeness Direction.}

	\noi Let
%
	\[
		\Re = \set{\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{,}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}} \setbar \horel{\Gamma}{\Delta_1}{P_1}{\wb}{\Delta_2}{Q_1}}
	\]
%
	We show that $\Re \subset \wb$ by a case analysis on the action $\ell$

	\noi - Case: $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{P}}, \bactinp{n}{\abs{x}{P}}}$.

	\noi The proof of Proposition~\ref{prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
	\]
%
	\noi From the latter transition and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\ell}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs1}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\wb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs2}
	\end{eqnarray}
%
	\noi From~\ref{prop:HOp_to_HO:full_abs1} and proposition~\ref{prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\ell}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\ref{prop:HOp_to_HO:full_abs2} and the definition of $\Re$ we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi as required.

	\noi - Case: $\ell = \news{\tilde{m}} \bactout{n}{\abs{x}{P}}$

	\noi There are two subcases:

	\noi -Subcase:

	\noi The proof of Proposition~\ref{prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\ell}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\ell}}{\Delta_1'}{P_2}
	\]
%
	\noi where the proof is similar with the previous case.

	\noi - Subcase:

	\noi The proof of Proposition~\ref{prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\news{\tilde{m_1}'} \bactout{n}{\abs{z}{\binp{z}{x} \appl{x}{m_1}}}}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\[
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\news{\tilde{m_1}'} \bactout{n}{m_1}}}{\Delta_1'}{P_2}
	\]
%
	\noi From the latter transition and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\news{\tilde{m_2}'} \bactout{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs3}
	\end{eqnarray}
%
	\noi and
%
	\begin{eqnarray}
		& \Gamma; \es; \Delta_1' & \proves \newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}} \nonumber \\
		& \wb & \Delta_2' \proves \newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}
		\label{prop:HOp_to_HO:full_abs4}
	\end{eqnarray}
%
	\noi From~\ref{prop:HOp_to_HO:full_abs3} and proposition~\ref{prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\news{\tilde{m_2}'} \bactout{n}{\abs{z}{\binp{z}{x} \appl{x}{m_2}}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\ref{prop:HOp_to_HO:full_abs4} and the definition of $\Re$ we get
%
	\[
		\mhorel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{\newsp{\tilde{m_1}'}{P_2 \Par \hotrigger{t}{x}{s}{m_1}}}{1}{f}}
		{\ \Re\ }{\mapt{\Delta_2'}^{1}}{}{\pmapp{\newsp{\tilde{m_2}'}{Q_2 \Par \hotrigger{t}{x}{s}{m_2}}}{1}{f}}
	\]
%
	\noi as required.

	\noi - Case: $\ell = \bactinp{n}{\abs{x}{P}}$

	\noi We have two subcases.

	\noi - Subcase: Similar with the first subcase of the previous case.

	\noi - Subcase:
	\noi The proof of Proposition~\ref{prop:op_corr_HOp_to_HO} implies that
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1}^{1}}{\pmapp{P_1}{1}{f}}{\hby{\bactinp{n}{\abs{z}{ \binp{z}{x} \appl{x}{s}}}}}{\mapt{\Delta_1''}^{1}} R %{\pmapp{P_2}{1}{f}}
	\]
%
	\noi implies
%
	\begin{eqnarray}
		\horel{\Gamma}{\Delta_1}{P_1}{\hby{\bactinp{n}{m_1}}}{\Delta_1'}{P_2}
		\label{prop:HOp_to_HO:full_abs7}
	\end{eqnarray}
%
	\noi and
%
	\begin{eqnarray}
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\shby{\tau}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
		\label{prop:HOp_to_HO:full_abs8}
	\end{eqnarray}
%
%	\noi With the last transition happening on a restricted session channel.
%	From \dk{Lemma~\ref{lem:tau_inert}} we can conclude that
%	\begin{eqnarray}
%		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\wb}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}
%		\label{prop:HOp_to_HO:full_abs9}
%	\end{eqnarray}
%
	\noi From the transition~\ref{prop:HOp_to_HO:full_abs7} and the definition of $\Re$ we imply
%
	\begin{eqnarray}
		&&\horel{\Gamma}{\Delta_2}{Q_1}{\Hby{\bactinp{n}{m_2}}}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs5}
		\\
		&&\horel{\Gamma}{\Delta_1'}{P_2}{\wb}{\Delta_2'}{Q_2}
		\label{prop:HOp_to_HO:full_abs6}
	\end{eqnarray}
%
	\noi From~\ref{prop:HOp_to_HO:full_abs5} and proposition~\ref{prop:op_corr_HOp_to_HO} we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_2}^{1}}{\pmapp{Q_1}{1}{f}}{\Hby{\bactinp{n}{\abs{z}{\binp{z}{x} \appl{x}{s}}}}}{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi Furthermore, from~\ref{prop:HOp_to_HO:full_abs6} and the definition of $\Re$ we get
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1'}^{1}}{\pmapp{P_2}{1}{f}}{\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
%
	\noi If we consider result~\ref{prop:HOp_to_HO:full_abs8} we get.
%
	\[
		\horel{\mapt{\Gamma}^{1}}{\mapt{\Delta_1''}^{1}}{R}{\shby{\tau}\ \Re\ }{\mapt{\Delta_2'}^{1}}{\pmapp{Q_2}{1}{f}}
	\]
	where following Lemma~\ref{lem:up_to_deterministic_transition} we show that $R$ is a bisimulation an up to $\SHby{}$.
	\qed
\end{proof}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HOp TO SESSP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Properties for $\enco{\pmap{\cdot}{2}, \tmap{\cdot}{}, \mapa{\cdot}^{2}}: \HOp \to \sessp$}
\label{app:enc:HOp_to_sessp}

We repeat the statement of Prop.~\ref{prop:typepres_HOp_to_FO},
as in Page \pageref{prop:typepres_HOp_to_FO}:

\begin{proposition}[Type Preservation, \HOp into \sessp]\rm
	\label{app:prop:typepres_HOp_to_p}
	Let $P$ be a \HOp process. 
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$.
\end{proposition}


%\begin{proposition}[Type Preservation, Higher-Order into First-Order]
%Let $P$ be an  $\HO$ process. 
%If			$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
%			$\mapt{\Gamma}^{2}; \emptyset; \mapt{\Delta}^{2} \proves \map{P}^{2} \hastype \Proc$. 
%\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
%	By induction on the structure of \HO process $P$.  \jp{TO BE ADJUSTED!}
	\begin{enumerate}[1.]

	%%%% Output of (linear) channel
		\item	Case $P = \bbout{k}{\abs{x}{Q}}P$. Then we have two possibilities, depending on the typing for $\abs{x}Q$.
			The first case concerns a linear typing, and  
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta_1 \cat k:S  \proves  P \hastype \Proc
					\quad
					\tree{
						\Gamma ; \emptyset ; \Delta_2\cat x:S_1 \proves  Q \hastype \Proc
					}{
						\Gamma ; \emptyset ; \Delta_2 \proves  \abs{x}Q \hastype \lhot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta_1 \cat \Delta_2 \cat k:\btout{\lhot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
%			
			This way, by IH we have
			$$
			\tmap{\Gamma}{2}; \es ; \tmap{\Delta_2}{2}, x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
			$$
			Let us write 
			 $U_1$ to stand for 
			$\chtype{\btinp{\tmap{S_1}{2}}\tinact}$.
			The corresponding typing in the target language is as follows: 
%
			\begin{eqnarray*}
				\tmap{\Gamma_1}{2} & = & \tmap{\Gamma}{2} \cup a:\chtype{\btinp{\tmap{S_1}{2}}\tinact} \\
				\tmap{\Gamma_2}{2} & = & \tmap{\Gamma_1}{2} \cup \varp{X}:\tmap{\Delta_2}{2}
			\end{eqnarray*}
%
			Also $(*)$ stands for $\tmap{\Gamma_1}{2}; \es ; \es \proves a \hastype U_1$; 
			$(**)$ stands for $\tmap{\Gamma_2}{2}; \es ; \es \proves a \hastype U_1$; and
			$(***)$ stands for $\tmap{\Gamma_2}{2}; \es ; \es \proves \varp{X} \hastype \Proc$.
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t1}
				\tree{
					\tree{
						\tree{
						}{
							(***)
						} 
						\quad 
						\tree{
							\tree{
								\tree{
									\tree{
									}{
										\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2},  x:\tmap{S_1}{2}
										\proves 
										\pmap{Q}{2} \hastype \Proc
									}
								}{
									\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}, y:\tinact, x:\tmap{S_1}{2}
									\proves 
									\pmap{Q}{2} \hastype \Proc
								}
							}{
								\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2}, y: \btinp{\tmap{S_1}{2}}\tinact
								\proves 
								\binp{y}{x}\pmap{Q}{2} \hastype \Proc
							} 
							\quad 
							\tree{
							}{
								(**)
							}
						}{
							\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
							\proves 
							\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \hastype \Proc
						} 
					}{
						\tmap{\Gamma_2}{2}; \es ; \tmap{\Delta_2}{2} 
						\proves 
						\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X} \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
					\proves 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
%
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t2}
				\tree{
					\begin{array}{c}
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1}{2}, k:\tmap{S}{2} 
						\proves 
						\pmap{P}{2}  \hastype \Proc
						\\
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_2}{2} 
						\proves 
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
						\quad \eqref{prop:HO_to_sessp_t1}
					\end{array}
				}{
					\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\tmap{S}{2} 
					\proves 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
				}
			\end{eqnarray}
%
			\[
				\tree{
					\tree{
						\begin{array}{c}
							\tmap{\Gamma_1}{2}; \es ; \es \proves a \hastype U_1
							\\
							\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\tmap{S}{2} 
							\proves 
							\pmap{P}{2} \Par 
							\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X})} \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t2}
						\end{array}
					}{
						\tmap{\Gamma_1}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\bbtout{U_1}\tmap{S}{2} 
						\proves 
						\bout{k}{a}(\pmap{P}{2} \Par 
						\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))} \hastype \Proc
					}
				}{
					\tmap{\Gamma}{2}; \es ; \tmap{\Delta_1, \Delta_2}{2}, k:\bbtout{U_1}\tmap{S}{2} 
					\proves 
					\newsp{a}{\bout{k}{a}( 
					\pmap{P}{2} \Par 
					\recp{X}{(\binp{a}{y}\binp{y}{x}\pmap{Q}{2} \Par \varp{X}))}} \hastype \Proc
				}
			\]
%
			In the second case, $\abs{x}Q$ has a shared type. We have the following typing in the source language:
%
			\[
				\tree{
					\Gamma; \emptyset; \Delta \cat k:S  \proves  P \hastype \Proc
					\quad 
					\tree{
						\tree{
							\Gamma ; \emptyset ; \cat x:S_1 \proves  Q \hastype \Proc
						}{
							\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \lhot{S_1}
						}
					}{
						\Gamma ; \emptyset ; \es \proves  \abs{x}Q \hastype \shot{S_1}
					}
				}{
					\Gamma; \emptyset; \Delta  \cat k:\btout{\shot{S_1}}S \proves  \bbout{k}{\abs{x}{Q}} P \hastype \Proc
				}
			\]
%
			The corresponding typing in the target language can be derived similarly as in the first case.
	
		\item	Case $P = \binp{k}{X} P$. Then there are two cases, depending on the type of $X$. 
			In the first case,
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat X : \shot{S_1};\, \emptyset ;\, \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\shot{S_1}}S \proves  \binp{k}{X} P \hastype \Proc
				}
			\]
			The corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tree{}{\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc}
				}{
					\tmap{\Gamma}{2};\, \emptyset; \, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
			In the second case,  
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma;\, \{X : \lhot{S_1}\};\, \emptyset ;\, \Delta \cat k:S \proves  P \hastype \Proc
				}{
					\Gamma;\, \emptyset;\, \Delta\cat k:\btinp{\lhot{S_1}}S \proves  \binp{k}{X} P \hastype \Proc
				}
			\]
%
			The corresponding typing in the target language is as follows:
			% --- we write $\Gamma_0$ to stand for $\Gamma \setminus \{X: \lhot{S_1}\}$.
%
			\[
				\tree{
					\tmap{\Gamma}{2} \cat x : \chtype{\btinp{\tmap{S_1}{2}}\tinact};\, \emptyset ;\, \Delta \cat k:\tmap{S}{2} \proves  \tmap{P}{2} \hastype \Proc
				}{
					\tmap{\Gamma}{2};\, \emptyset;\, \tmap{\Delta}{2}\cat k:\bbtinp{\chtype{\btinp{\tmap{S_1}{2}}\tinact}}\tmap{S}{2} \proves
					\binp{k}{x} \pmap{P}{2} \hastype \Proc
				}
			\]
%
		\item	Case $P = \appl{X}{k}$. Also here we have two cases, depending on whether $X$ has linear or shared type.
			In the first case, $X$ is linear and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma ;\, \{X : \lhot{S_1}\};\,  \es \proves  X \hastype \lhot{S_1} \quad \Gamma; \es ; \{k:S_1\} \proves k \hastype S_1
				}{
					\Gamma;\, \{X : \lhot{S_1}\};\, k:S_1 \proves  \appl{X}{k} \hastype \Proc}
			\]
			Let us write
			$\tmap{\Gamma_1}{2}$ to stand for $\tmap{\Gamma}{2} \cat x:\chtype{\btout{\tmap{S_1}{2}}\tinact}$.
			The corresponding typing in the target language is as follows:
%
			\begin{eqnarray}
				\label{prop:HO_to_sessp_t11}
				\tree{
					\tree{
						\tmap{\Gamma_1}{2};\, \es;\,  \es \proves  \inact \hastype \Proc
					}{
						\tmap{\Gamma_1}{2};\, \es;\,  \dual{s}:\tinact \proves  \inact \hastype \Proc
					}
					\quad 
						\tmap{\Gamma_1}{2};\, \es;\, \{k:\tmap{S_1}{2}\} \proves  k \hastype \tmap{S_1}{2} 
				}{
					\tmap{\Gamma_1}{2};\, \es;\,\, k:\tmap{S_1}{2},\,  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves  \bout{\dual{s}}{k}\inact \hastype \Proc
				}
			\end{eqnarray}
%
			\[
				\tree{
					\tree{
						\begin{array}{c}
							\tmap{\Gamma_1}{2};\, \es;\,\, k:\tmap{S_1}{2},\,  \dual{s}:\btout{\tmap{S_1}{2}}\tinact \proves
							\bout{\dual{s}}{k}\inact \hastype \Proc
							\quad \eqref{prop:HO_to_sessp_t11}
							\\
							\tmap{\Gamma_1}{2} ;\, \es ;\, \es \proves x \hastype \chtype{\btout{\tmap{S_1}{2}}\tinact}
						\end{array}
					}{
						\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2}, s:\btinp{\tmap{S_1}{2}}\tinact , \dual{s}:\btout{\tmap{S_1}{2}}\tinact
						\proves
						\bout{x}{s}\bout{\dual{s}}{k}\inact \hastype \Proc
					}
				}{
					\tmap{\Gamma_1}{2};\, \es;\, k:\tmap{S_1}{2} \proves  \news{s}{(\bout{x}{s}\bout{\dual{s}}{k}\inact)} \hastype \Proc
				}
	\]
%
			In the second case, $X$ is shared, and
			we have the following typing in the source language:
%
			\[
				\tree{
					\Gamma \cat  X : \lhot{S_1} ;\,  \es ;\,  \es \proves  X \hastype \shot{S_1} \quad \Gamma; \es ; k:S_1 \proves k \hastype S_1
				}{
					\Gamma \cat X : \shot{S_1};\, \es ;\, k:S_1 \proves  \appl{X}{k} \hastype \Proc
				}
			\]
%
			The associated typing in the target language is obtained similarly as in the first case. \qed
	\end{enumerate}
\end{proof}


%\begin{proposition}\rm
%	\label{app:enc_HO_to_sessp_oc}
%	Encoding $\encod{\cdot}{\cdot}{2}: \HO \to \sessp$ 
%	enjoys operational correspondence (cf. Def.~\ref{def:ep}\,(2)).
%\end{proposition}
%
%\begin{proof}[Sketch]
%For completeness, we 
%consider the \HO process $P = {\bbout{k}{\abs{x}{Q}} P_1} \Par \binp{k}{X} P_2$. We have that
%\[
%P \red P_1 \Par P_2 \subst{\abs{x}Q}{X}
%\]
%In the target language, this reduction is mimicked as follows:
%\begin{eqnarray*}
%\pmap{P}{2} & = & \newsp{a}{\bout{k}{a} (\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2})\,} 
%                  \Par \binp{k}{x} \pmap{P_2}{2} \\
%            & \red & \newsp{a}{\pmap{P_1}{2} \Par \repl{} \binp{a}{y} \binp{y}{x} \pmap{Q}{2} 
%                  \Par  \pmap{P_2}{2}\subst{a}{x}}
%\end{eqnarray*}
%\qed
%\end{proof}

