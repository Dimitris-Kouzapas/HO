% !TEX root = main.tex
\section{Extending \HOp}

We present two essential extension of $\HOp$
and show their precise encoding to $\HOp$.

\subsection{Polyadic \HOp}
\label{subsec:pol_HOp}

The \HOp is presented in monadic terms.
Nevertheless, we use polyadic \HOp terms
as syntax sugar to define the encoding from
$\HOp$ to $\HO$ in Definition~\ref{def:enc:HOp_to_HO},
since polyadic encoding for session types
has already been studied (cf.~\ref{}).

For clarity reasons we present the polyadic variants
\pHOp of \HOp and show a fully abstract
encoding from \pHOp to \HOp.

\subsubsection{Extending the Semantics}

\paragraph{Syntax and Operational Semantics:}
The syntax of Figure~\ref{fig:syntax} is changed to
include 
$$V \bnfis \tilde{u} \bnfbar \abs{\tilde{x}}{P} \qquad
\binp{n}{\tilde{x}} P$$ 
instead of $\binp{n}{x} P$.
The reduction relation in Figure~\ref{fig:reduction}
replaces rule $\orule{App}$ 
with rule
%
\[
	\appl{\abs{\tilde{x}}{P}}{\tilde{u}} \red P \subst{\tilde{u}}{\tilde{x}}
\]
%
\noi and rule $\orule{Pass}$ with
%
\[
	\bout{n}{V} P_1 \Par \binp{\dual{n}}{\tilde{x}} P_2 \red P_1 \Par P_2 \subst{V}{\tilde{x}} \quad |V| = |\tilde{x}|
\]
%

\paragraph{Types:}
The syntax of types in Figure~\ref{def:types}
is changed to include 
$$L \bnfis \shot{\tilde{C}} \bnfbar \lhot{\tilde{C}}$$
instead of $L \bnfis \shot{C} \bnfbar \lhot{C}$ and
to $U \bnfis \tilde{C} \bnfbar L$.

Note that we dissallow types of the form
$\chtype{\tilde{U}}$---shared types do not
carry polyadic value types.
In the current polyadic extension we do not
require polyadic shared names since the
polyadic encoding for shared names is
less straightforward than the polyadic
encoding for session names.

We extend the type system in Figure~\ref{fig:typerulesmy}
to include the type rule:
%
\[
	\trule{Pol}~~\tree{
		V = a_i \dots a_n \qquad \Gamma; \Lambda_i; \Delta_i \proves u_i \hastype C_i \qquad U = C_1 \dots C_n
	}{
		\Gamma; \bigcup_{i \in I} \Lambda_i; \bigcup_{i \in I} \Delta_i \proves V \hastype U
	}
\]
%
that allows us to type polyadic values. We expect the
extension of the type rules to accomodate polyadic values.
Note that rules $\trule{Req}$ and $\trule{Acc}$
continue to type monadic instances of shared
name prefixes.

\dk{prove subject reduction?}

\paragraph{Behavioural Semantics}
The definition of the labelled transition system
replaces rule $\ltsrule{App}$ with rule:
%
\[
	\appl{\abs{\tilde{x}} P}{\tilde{u}} \by{\tau} P\subst{\tilde{u}}{\tilde{x}}
\]
%
The characteristic process and characteristic value 
definition (Definition~\ref{def:characteristic_process})
is extended to include the cases:
\[
	\mapchar{C_1 \dots C_n}{u_1 \cdots u_n} \defeq \mapchar{C_1}{x_1} \Par \dots \Par \mapchar{C_n}{x_n}
\]
\noi and
\[
	\omapchar{U_1 \dots U_n} \defeq \omapchar{U_1}, \dots, \omapchar{U_n}
\]
%
A polyadic type is inhabited in a process where its
parallel components inhabit type terms of the polyadic
type. A polyadic value type is inhabited as a list
of values that inhabit the polyadic values.

The rest of the behavioural semantics remains unchanged.

\subsubsection{Encoding from \pHOp to \HOp}

\begin{definition}[Encoding from \pHOp to \HOp]\rm
	\label{def:enc:pHOp_to_HOp}
	Let map $\enco{\pmap{\cdot}{4}, \tmap{\cdot}{4}, \mapa{\cdot}^{4}}: \pHOp \to \HOp$
	to be defined as in Figure~\ref{fig:enc:pHOp_to_HOp}.
\end{definition}

\begin{figure}[t]
	\[
		\begin{array}{rcl}
			\pmap{\bout{n}{u_1, \dots, u_n} P}{4} &\defeq& \bout{n}{u_1} \dots ; \bout{n}{u_n} \pmap{P}{4}
			\\
			\pmap{\binp{n}{x_1, \dots, x_n} P}{4} &\defeq& \binp{n}{x_1} \dots ; \binp{n}{x_n} \pmap{P}{4}
			\\
			\pmap{\bout{n}{\abs{x_1, \dots, x_n}{Q}} P}{4} &\defeq& \bout{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{Q}{4}}} \pmap{P}{4}
			\\
			\pmap{\appl{x}{u_1, \dots, u_n}}{4} &\defeq& \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{u_1} \dots; \bout{\dual{s}}{u_1} \inact}
			\\
			\\
			\tmap{\lhot{(C_1, \dots, C_n)}}{4} &\defeq& \lhot{(\btinp{C_1} \dots; \btinp{C_n} \tinact)}
			\\
			\tmap{\shot{(C_1, \dots, C_n)}}{4} &\defeq& \shot{(\btinp{C_1} \dots; \btinp{C_n} \tinact)}
			\\
			\tmap{\btout{L} S}{4} &\defeq& \btout{\tmap{L}{4}} \tmap{S}{4}
			\\
			\tmap{\btinp{L} S}{4} &\defeq& \btinp{\tmap{L}{4}} \tmap{S}{4}
			\\
			\tmap{\btout{C_1, \dots, C_n} S}{4} &\defeq& \btout{C_1} \dots; \btout{C_n} \tmap{S}{4}
			\\
			\tmap{\btinp{C_1, \dots, C_n} S}{4} &\defeq& \btinp{C_1} \dots; \btout{C_n} \tmap{S}{4}
			\\
			\\
			\mapa{\news{\tilde{m}'} \bactout{n}{m_1, \dots, m_n}}^{4} &\defeq& \news{\tilde{m_1}'} \bactout{n}{m_1} \dots \news{\tilde{m_n}'}\bactout{n}{m_n}
			\quad \left.
			\begin{array}{rcl}
				\tilde{m_i}' &=& m_i \Leftrightarrow m_i \in \tilde{m}' \wedge\\
				\tilde{m_i}' &=& \es \Leftrightarrow m_i \notin \tilde{m}'
			\end{array}
			\right.
			\\
			\mapa{\bactinp{n}{m_1, \dots, m_n}}^{4} &\defeq& \bactinp{n}{m_1} \dots \bactinp{n}{m_n}
			\\
			\mapa{\news{\tilde{m}} \bactout{n}{\abs{x_1, \dots, x_n}{P}}}{4} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{P}{4}}}
			\\
			\mapa{\bactinp{n}{\abs{x_1, \dots, x_n}{P}}}{4} &\defeq& \bactinp{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{P}{4}}}
		\end{array}
	\]
%
	\caption{Encoding of \pHOp into \HOp (cf. Def.~\ref{def:enc:pHOp_to_HOp}).
	We assume that the rest of the encoding is homomorphic on the syntax of
	processes, types and labels, respectively. \label{fig:enc:pHOp_to_HOp}}
\end{figure}


\subsection{From \HOp to \HOpp}

So far we have studied a higher-order calculus that allows
only name applications. Higher-order calculi in the
literature~\cite{} allow for higher-order applications.
In this section we introduce \HOpp which is an 
extension of the \HOp calculus that includes
higher-order applications.
We further show that \HOpp has a precise encoding
into \HOp and thus by the composability of
encoding (Proposition~\ref{prop:enc_composability})
\HOpp has a precise encoding to \HO and \sessp.
The latter result implies that \HO is powerful
enough to express full higher-order semantics.

\subsubsection{Extending the Semantics}

\paragraph{Syntax and Operational Semantics:}
The syntax of Figure~\ref{fig:syntax} is changed to
include $$\appl{x}{V}$$ instead of $\appl{x}{u}$.
The reduction relation in Figure~\ref{fig:reduction}
replaces rule $\orule{App}$ 
with rule $$\appl{\abs{x}{P}}{V} \red P \subst{V}{x}$$
%The structural congruence in Section~\ref{subsec:reduction_semantics}
%is changed to include $\appl{(\abs{x} P)}{V} \scong P \subst{x}{V}$
%instead of $\appl{(\abs{x} P)}{u} \scong P \subst{x}{u}$.

\paragraph{Types:}
The syntax of types in Figure~\ref{def:types}
is changed to include $$L \bnfis \shot{U} \bnfbar \lhot{U}$$
instead of $L \bnfis \shot{C} \bnfbar \lhot{C}$.
We expect the obvious extension for type equivalence
(Definition~\ref{def:type_equiv})
and for the definition of type environments.

We also expect the straightforward extension of the type 
system to accomodate the new type syntax. The two
most characterestic rules $\trule{Abs}$ and $\trule{App}$ 
for application and abstraction, respectively, now become:
\[
	\begin{array}{c}
		\trule{Abs}~~\tree{
			\Gamma; \Lambda; \Delta_1 \proves P \hastype \Proc
			\quad
			\Gamma; \es; \Delta_2 \proves x \hastype U
		}{
			\Gamma; \Lambda; \Delta_1 \backslash \Delta_2 \proves \abs{x}{P} \hastype \lhot{U}
		}
		\\[6mm]

		\trule{App}~~\tree{
			\begin{array}{c}
				U = \lhot{U'} \lor \shot{U'}
				\quad
				\Gamma; \Lambda; \Delta_1 \proves V \hastype U
				\quad
				\Gamma; \es; \Delta_2 \proves u \hastype U'
			\end{array}
		}{
			\Gamma; \Lambda; \Delta_1 \cat \Delta_2 \proves \appl{V}{u} \hastype \Proc
		} 
	\end{array}
\]

\dk{prove subject reduction for the extension}

\paragraph{Behavioural Semantics:}
The label definition remain the same.
Rule $\ltsrule{App}$ in the untyped LTS
is replaced with rule
$\appl{\abs{x}{P}}{V} \by{\tau} P \subst{V}{x}$.
The definition of the
characteristic process~\ref{def:characteristic_process}
now includes
\begin{eqnarray*}
\mapchar{\shot{U}}{x} & \defeq & \mapchar{\lhot{U}}{x} \defeq \appl{x}{\omapchar{U}} \\
\omapchar{\shot{U}} & \defeq & \omapchar{\lhot{U}} \defeq \abs{x}{\mapchar{U}{x}}
\end{eqnarray*}
instead of $\mapchar{\shot{C}}{x} \defeq \mapchar{\lhot{C}}{x} \defeq \appl{x}{\omapchar{C}}$
and
$\omapchar{\shot{C}} \defeq \omapchar{\lhot{C}} \defeq \abs{x}{\mapchar{C}{x}}$, respectively.
\begin{comment}
%
\begin{definition}[Characteristic Process]\rm
	\noi Let name $u$ and type $U$; then we define the {\em characteristic process}:
	$\mapchar{U}{u}$ and the {\em characteristic value} $\omapchar{U}$ as:
%
	\[
	\begin{array}{cc}
		\begin{array}{rclcl}
			\mapchar{\btinp{U} S}{u} &\defeq& \binp{u}{x} (\mapchar{S}{u} \Par \mapchar{U}{x})
			\\
			\mapchar{\btout{U} S}{u} &\defeq& \bout{u}{\omapchar{U}} \mapchar{S}{u} %& & n \textrm{ fresh}
			\\
			\mapchar{\btsel{l : S}}{u} &\defeq& \bsel{u}{l} \mapchar{S}{u}
			\\
			\mapchar{\btbra{l_i: S_i}_{i \in I}}{u} &\defeq& \bbra{u}{l_i: \mapchar{S_i}{u}}_{i \in I}
			\\
			\mapchar{\tvar{t}}{u} &\defeq& \varp{X}_{\vart{t}}
			\\
			\mapchar{\trec{t}{S}}{u} &\defeq& \recp{X_{\vart{t}}}{\mapchar{S}{u}}
			\\
			\mapchar{\tinact}{u} &\defeq& \inact
			\\
		\end{array}
		&
		\begin{array}{rcrclcl}
			&&\mapchar{\chtype{S}}{u} &\defeq& \bout{u}{\omapchar{S}} \inact
			\\
			&&\mapchar{\chtype{L}}{u} &\defeq& \bout{u}{\omapchar{L}} \inact
			\\
			\dk{\mapchar{\shot{U}}{x}} &\defeq& \dk{\mapchar{\lhot{U}}{x}} &\defeq& \dk{\appl{x}{\omapchar{U}}}
			\\
			\\
			&&\omapchar{S} &\defeq& s && s \textrm{ fresh}
			\\
			\omapchar{\chtype{S}} &\defeq& \omapchar{\chtype{L}} &\defeq& a && a \textrm{ fresh}
			\\
			\dk{\omapchar{\shot{U}}} &\defeq& \dk{\omapchar{\lhot{U}}} &\defeq& \dk{\abs{x}{\mapchar{U}{x}}}
		\end{array}
	\end{array}
	\]
\end{definition}
%
\end{comment}
\noi The rest of the definition for the behavioural remains the same.

\subsubsection{Encoding from \HOpp to \HOp}

We now present an encoding from \HOpp to \HOp.
%
\begin{definition}[Encoding from \HOpp to \HOp]\rm
	\label{def:enc:HOpp_to_HOp}
	Let mapping $\enco{\pmap{\cdot}{3}, \tmap{\cdot}{3}, \mapa{\cdot}^{3}}: \HOpp \to \HOp$
	as defined in Figure~\ref{fig:enc:HOpp_to_HOp}.
\end{definition}
%
\begin{figure}[t]
	\[
	\begin{array}{rcl}
		\pmap{\appl{x}{\abs{x} P}}{3} &\defeq& \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{x} \pmap{P}{3}} \inact}
		\\
		\pmap{\bout{u}{\abs{x: L}{Q}} P}{3} &\defeq& \bout{u}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}} \pmap{P}{3}
		\\
		\pmap{\bout{u}{\abs{x: C}{Q}} P}{3} &\defeq& \bout{u}{\abs{x}{\pmap{Q}{3}}} \pmap{P}{3}
		\\
		\\
		\tmap{\shot{L}}{3} &\defeq& \shot{\btinp{\tmap{L}{3}} \tinact}
		\\
		\tmap{\lhot{L}}{3} &\defeq& \lhot{\btinp{\tmap{L}{3}} \tinact}
		\\
		\tmap{\btout{\shot{L}} S}{3} &\defeq& \btout{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btout{\lhot{L}} S}{3} &\defeq& \btout{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\shot{L}} S}{3} &\defeq& \btinp{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\lhot{L}} S}{3} &\defeq& \btinp{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\\
		\mapa{\news{\tilde{m}} \bactout{n}{\abs{x:C}{P}}}^{3} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{x:C}{P}}}^{3} &\defeq& \bactinp{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\news{\tilde{m}} \bactout{n}{\abs{x:L}{P}}}^{3} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{x:L}{P}}}^{3} &\defeq& \bactinp{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}

	\end{array}
	\]
%
	\caption{Encoding of \HOpp into \HOp (cf. Def.~\ref{def:enc:HOpp_to_HOp}).
	We assume that the rest of the encoding is homomorphic on the syntax of
	processes, types and labels, respectively. \label{fig:enc:HOpp_to_HOp}}
\end{figure}

\begin{proposition}[Operational Correspondence. From \HOpp to \HOp]\rm
	\label{prop:op_corr:HOpp_to_HO}
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell'}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$ with $\mapa{\ell}^{3} = \ell'$.

%				\item	If $\ell = \bactinp{n}{\abs{x: C}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{x: C}{\pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \news{\tilde{m}} \bactout{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \bactinp{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\hby{\ell}$ is a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\bhby{\tau} \shby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
			{\tmap{\Delta''}{3}}{Q}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$
					with $\mapa{\ell'}^{3} = \ell$ and $Q \scong \pmap{P'}{3}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $Q \scong \pmap{P'}{3}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ then
					either
					$\horel{\Gamma}{\Delta}{\Delta}{\hby{\tau}}{\Delta'}{P'}$ with $Q \scong \pmap{P'}{3}$\\
					or
					$\horel{\Gamma}{\Delta}{\Delta}{\bhby{\ell}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\shby{\tau}}
					{\tmap{\Delta''}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
	The proof of Part 1 does a transition induction and
	considers the mapping in Definition~\ref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}$.

			$\horel{\Gamma}{\Delta}{\appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}}{\bhby{\tau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ implies
\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{ \newsp{s}{ \appl{\abs{z}\binp{z}{x} \pmap{Q}{3}}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\bhby{\tau} \shby{\tau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
\]

		\item	Case: $P = \bout{n}{\abs{x:L} Q} P$

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{x:L} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$
	\end{itemize}

	The proof of Part 2 also does a transition induction and
	considers the mapping in Definition~\ref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}$.
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{ \appl{\abs{z}\binp{z}{x} \pmap{Q}{3}}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\tau}}
			{\tmap{\Delta'}{3}}{}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}
		\]
%
			\noi implies
			$\horel{\Gamma}{\Delta}{\appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}}{\bhby{\tau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ and
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\shby{\tau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
		\]

		\item	Case: $P = \bout{n}{\abs{x:L} Q} P$

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$ implies

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{x:L} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies
	\end{itemize}
	\dk{Do more cases}
	\qed
\end{proof}

\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\rm
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}$
\end{proposition}

\begin{proof}
	\noi {\bf Soundness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}}
	\]
%
	\noi	It is straightforward to show that $\Re$ is a bisimulation if we follow Part 2 of
		Proposition~\ref{prop:op_corr:HOpp_to_HO} for subcases a and b.
		In subcase c we make use of Proposition~\ref{lem:tau_inert}.

	\noi {\bf Completeness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\ ,\ }{\tmap{\Delta_2}{3}}{\pmap{Q}{3}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
	\noi	We show that $\Re$ is a bisimulation up to deterministic transitions
		by following Part 1 of Proposition~\ref{prop:op_corr:HOpp_to_HO}.
		The proof is straightforward for subcases a, b and d.
		In subcase c we make use of Lemma~\ref{lem:up_to_deterministic_transition}.
	\qed
\end{proof}
