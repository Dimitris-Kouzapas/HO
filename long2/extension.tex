% !TEX root = main.tex
\section{Extensions of \HOp}
\label{sec:extension}

This section studies (i) the extension of \HOp with higher-order applications/abstractions (denoted \HOpp), and (ii) the extension of \HOp with polyadicity (denoted \pHOp). In both cases, we detail required modifications in the syntax and types, and describe further encodability results.

\subsection{Encoding \HOpp into \HOp}

The \HOp calculus is purposefully minimal and allows
only name applications/abstractions (also referred to as \emph{first-order} applications/abstractions).
We now introduce \HOpp, the 
extension of \HOp with higher-order applications.
We show that \HOpp has a precise encoding
into \HOp (\propref{prop:prec:HOpp_to_HOp}). 
Therefore, since 
typed encodings are composable (\propref{prop:enc_composability}), 
\HOpp has a precise encoding to \HO and \sessp.
In turn, this latter result implies that \HO is powerful
enough to express full higher-order semantics.

\subsubsection{Modifications in Syntax, Reduction Semantics, and Types.}
%\myparagraph{Syntax and Operational Semantics:}
The syntax of \HOpp processes is obtained from the
syntax for processes given in \figref{fig:syntax} by replacing 
$\appl{V}{u}$ with $\appl{W}{V}$.
Reduction is then defined by 
the rules in \figref{fig:reduction}, excepting 
rule $\orule{App}$, which is replaced by 
the following rule 
$$
\orule{App$^+$} \qquad
\appl{(\abs{x}{P})}{V} \red P \subst{V}{x}
$$
%The structural congruence in \secref{subsec:reduction_semantics}
%is changed to include $\appl{(\abs{x} P)}{V} \scong P \subst{x}{V}$
%instead of $\appl{(\abs{x} P)}{u} \scong P \subst{x}{u}$.
%\myparagraph{Types}
The syntax of types in \figref{def:types}
is generalized by including $$L \bnfis \shot{U} \bnfbar \lhot{U}$$
instead of $L \bnfis \shot{C} \bnfbar \lhot{C}$.
Definitions of type equivalence/duality 
and typing environments ($\Gamma$ and $\Lambda$) are straightforward extensions of 
\defref{def:type_equiv}, \defref{def:type_dual},
and  \defref{def:typeenv}, respectively. 
The typing rules of \figref{fig:typerulesmy} are then modified accordingly:
most significant changes are required in rules $\trule{Abs}$ and $\trule{App}$ 
(for typing abstractions and applications, respectively), which  for \HOpp processes are modified as follows:
\[
	\begin{array}{c}
		\trule{Abs$^+$}~~\tree{
			\Gamma; \Lambda; \Delta_1 \proves P \hastype \Proc
			\quad
			\Gamma; \es; \Delta_2 \proves x \hastype U
		}{
			\Gamma; \Lambda; \Delta_1 \backslash \Delta_2 \proves \abs{x}{P} \hastype \lhot{U}
		}
		\\[6mm]

		\trule{App$^+$}~~\tree{
			\begin{array}{c}
				U = \lhot{U'} \lor \shot{U'}
				\quad
				\Gamma; \Lambda; \Delta_1 \proves V \hastype U
				\quad
				\Gamma; \es; \Delta_2 \proves W \hastype U'
			\end{array}
		}{
			\Gamma; \Lambda; \Delta_1 \cat \Delta_2 \proves \appl{V}{W} \hastype \Proc
		} 
	\end{array}
\]

%\iftodo\dk{prove subject reduction for the extension}\else\fi

With these modifications we can now state the extension of \thmref{thm:sr}:

\begin{theorem}[Type Soundness for \HOpp]\rm
	\label{thm:sr_hopp}
	\begin{enumerate}[1.]
		\item	(Subject Congruence)
			$\Gamma; \es; \Delta \proves P \hastype \Proc$
			and
			$P \scong P'$
			implies
			$\Gamma; \es; \Delta \proves P' \hastype \Proc$.

		\item	(Subject Reduction)
			$\Gamma; \es; \Delta \proves P \hastype \Proc$
			with
			balanced $\Delta$
			and
			$P \red P'$
			implies $\Gamma; \es; \Delta'  \proves P' \hastype \Proc$
			and either (i)~$\Delta = \Delta'$ or (ii)~$\Delta \red \Delta'$
			with $\Delta'$ balanced.
	\end{enumerate}
\end{theorem}

\begin{proof}
Part (1) is as for \HOp processes.
Part (2) 
is also as before, but 
requires the expected generalization of parts (3) and (4) of the substitution lemma (\lemref{lem:subst}).
We describe the analysis when the reduction is inferred by rule \orule{App$^+$}. We have
	   $$
	   P = (\abs{x}{Q}) \, V   \red  Q \subst{V}{x} = P'
	   $$
	   Suppose $\Gamma;\, \emptyset ;\, \Delta \proves (\abs{x}{Q}) \, V \hastype \Proc$. 
	   We examine one possible way in which 
	   this assumption can be derived; other cases are similar or simpler:
	   \[
	   \tree{
	   \tree{\Gamma, x:\lhot{L_1};\, \emptyset ;\, \Delta \proves Q  \hastype \Proc \quad 
	   \Gamma, x:\lhot{L_1};\, \emptyset ;\, \es \proves x  \hastype \lhot{L_1}}
	   {
	   \Gamma;\, \emptyset ;\, \Delta \proves \abs{x}{Q}  \hastype \shot{(\shot{L_1})} }
	   \qquad
	   \tree{}{
	   \Gamma ;\, \es ;\, \emptyset \proves   V \hastype \shot{L_1}}
	   }{
	   \Gamma;\, \emptyset ;\, \Delta  \proves (\abs{x}{Q}) \, V \hastype \Proc
	   }
	   \]
	  Then, by combining premise
	   $\Gamma, x:\lhot{L_1};\, \emptyset ;\, \Delta \proves Q  \hastype \Proc$
	   with
	   the extended formulation of \lemref{lem:subst}(4),
	   we obtain 
	    $\Gamma;\, \emptyset ;\, \Delta   \proves Q\subst{V}{x}  \hastype \Proc$, as desired.
	\qed
\end{proof}

\noi 
As for the behavioural semantics of \HOpp, modifications are as expected.
The set of action labels remains the same.
In the untyped LTS, rule $\ltsrule{App}$
is replaced with rule
$\appl{\abs{x}{P}}{V} \by{\tau} P \subst{V}{x}$.
\defref{def:characteristic_process} (characteristic processes)
now includes
\begin{eqnarray*}
\mapchar{\shot{U}}{x} & \defeq & \mapchar{\lhot{U}}{x} \defeq \appl{x}{\omapchar{U}} \\
\omapchar{\shot{U}} & \defeq & \omapchar{\lhot{U}} \defeq \abs{x}{\mapchar{U}{x}}
\end{eqnarray*}
instead of $\mapchar{\shot{C}}{x} \defeq \mapchar{\lhot{C}}{x} \defeq \appl{x}{\omapchar{C}}$
and
$\omapchar{\shot{C}} \defeq \omapchar{\lhot{C}} \defeq \abs{x}{\mapchar{C}{x}}$, respectively.
\noi The rest of the definitions for the behavioural semantics is kept unchanged. 

\subsubsection{Encoding \HOpp into \HOp.}

We now present an encoding from \HOpp to \HOp.
%
\begin{definition}[Encoding from \HOpp to \HOp]\rm
	\label{def:enc:HOpp_to_HOp}
	Let $\tyl{L}_{\HOpp}=\calc{\HOpp}{{\cal{T}}_4}{\hby{\ell}}{\wb}{\proves}$
where 
${\cal{T}}_4$ is a set of types of $\HOpp$;  
the typing $\proves$ is defined in 
\figref{fig:typerulesmy} with extended rules \trule{Abs} and \trule{App}. 
Then, mapping $\enco{\pmap{\cdot}{3}, \tmap{\cdot}{3}, \mapa{\cdot}^{3}}: \tyl{L}_\HOpp \to \tyl{L}_\HOp$
	is defined in \figref{fig:enc:HOpp_to_HOp}.
\end{definition}
%
\begin{figure}[t]
	\[
	\begin{array}{rcl}
		\pmap{\appl{x}{(\abs{y} P})}{3} &\defeq& \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{y} \pmap{P}{3}} \inact}
		\\
		\pmap{\appl{(\abs{x} P)}{(\abs{y} Q)}}{3} &\defeq& \newsp{s}{\binp{s}{x}\pmap{P}{3} \Par \bout{\dual{s}}{\abs{y} \pmap{Q}{3}} \inact}
		\\
		\pmap{\bout{u}{\abs{\underline{x}}{Q}} P}{3} &\defeq& \bout{u}{\abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}}} \pmap{P}{3}
		\\
		\pmap{\bout{u}{\abs{k}{Q}} P}{3} &\defeq& \bout{u}{\abs{k}{\pmap{Q}{3}}} \pmap{P}{3}
		\\
		\\
		\tmap{\shot{L}}{3} &\defeq& \shot{\big(\btinp{\tmap{L}{3}} \tinact\big)}
		\\
		\tmap{\lhot{L}}{3} &\defeq& \lhot{\big(\btinp{\tmap{L}{3}} \tinact\big)}
		\\
		\tmap{\btout{\shot{L}} S}{3} &\defeq& \btout{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btout{\lhot{L}} S}{3} &\defeq& \btout{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\shot{L}} S}{3} &\defeq& \btinp{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\lhot{L}} S}{3} &\defeq& \btinp{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\\
		\mapa{\news{\tilde{m}} \bactout{n}{\abs{k}{P}}}^{3} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{k}{P}}}^{3} &\defeq& \bactinp{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\news{\tilde{m}} \bactout{n}{\abs{\underline{x}}{P}}}^{3} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{\underline{x}}{P}}}^{3} &\defeq& \bactinp{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}

	\end{array}
	\]
%
	\caption{Encoding of \HOpp into \HOp (cf.~\defref{def:enc:HOpp_to_HOp}).
	We assume that the rest of the encoding is homomorphic on the syntax of
	processes, types and labels, respectively. \label{fig:enc:HOpp_to_HOp}}
\end{figure}

\begin{proposition}[Type Preservation. From \HOpp to \HOp]\rm
	\label{prop:typepres_HOpp_to_HOp}
	Let $P$ be a \HOpp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{3}; \emptyset; \tmap{\Delta}{3} \proves \pmap{P}{3} \hastype \Proc$. 
\end{proposition}

%\iftodo
\begin{proof}
%	\dk{Put some additional cases.}
By induction on the inference of 
$\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
We detail some representative cases:
\begin{enumerate}[1.]
\item Case $P = \bout{u}{\abs{\underline{x}}{Q}} P'$.
Then we may have the following typing in \HOpp:
			\[
				\tree{
					\tree{}{\Gamma; \Lambda_1; \Delta_1 \cat u:S  \proves  P' \hastype \Proc} 
					\quad 
					\tree{
					\tree{}{\Gamma \cat \underline{x}:L; \Lambda_2 ; \Delta_2 \proves  Q \hastype \Proc}
					\quad 
					\tree{}{\Gamma \cat \underline{x}:L; \es ; \es \proves  \underline{x} \hastype L}
					}{\Gamma ; \Lambda_2 ; \Delta_2 \proves  \abs{\underline{x}:L}Q \hastype \lhot{L}}}{
					\Gamma; \Lambda_1 \cat \Lambda_2; \Delta_1 \cat \Delta_2 \cat 
					u:\btout{\lhot{L}}S 
					\proves  \bout{u}{\abs{\underline{x}}{Q}} P'
					\hastype \Proc}
			\]
Thus, by IH we have:
\begin{eqnarray}
\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3}; \tmap{\Delta_1}{3} \cat u:\tmap{S}{3} & \proves &  \pmap{P'}{3} \hastype \Proc
\label{eq:hopppre1}\\
\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \tmap{\Lambda_2}{3} ; \tmap{\Delta_2}{3} & \proves & \pmap{Q}{3} \hastype \Proc \label{eq:hopppre2}
\\
\tmap{\Gamma}{3} \cat \underline{x}:\tmap{L}{3}; \es ; \es & \proves & \underline{x} \hastype \tmap{L}{3} \label{eq:hopppre3}
\end{eqnarray}
The corresponding typing in \HOp is as follows:
{\small
\[
\tree{
\tree{}{
				\eqref{eq:hopppre1}}
				\quad
\tree{\tree{
\tree{
\tree{}{\eqref{eq:hopppre2}}
}{
\tmap{\Gamma}{3} \cat x:\tmap{L}{3};   \tmap{\Lambda_2}{3};  \tmap{\Delta_2}{3} \cat
				z: \tinact
					\proves  \pmap{Q}{3}
					\hastype \Proc}
					\qquad
					\tree{}{\eqref{eq:hopppre3}}
}{
				\tmap{\Gamma}{3};   \tmap{\Lambda_2}{3};  \tmap{\Delta_2}{3} \cat
				z:\btinp{\tmap{L}{3}} \tinact
					\proves  \binp{z}{\underline{x}} \pmap{Q}{3}
					\hastype \Proc }
					\qquad 
					\tree{}{\tmap{\Gamma}{3};   \es;  
				z:\btinp{\tmap{L}{3}} \tinact
					\proves  z
					\hastype \btinp{\tmap{L}{3}} \tinact}
}{
					\tmap{\Gamma}{3};   \tmap{\Lambda_2}{3};  \tmap{\Delta_2}{3} 
					\proves  \abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}}
					\hastype \lhot{(\btinp{\tmap{L}{3}} \tinact)}
}
}
{
					\tmap{\Gamma}{3}; \tmap{\Lambda_1}{3} \cat \tmap{\Lambda_2}{3}; \tmap{\Delta_1}{3} \cat \tmap{\Delta_2}{3} \cat 
					u:\btout{\lhot{\btinp{\tmap{L}{3}} \tinact}}\tmap{S}{3} 
					\proves  \bout{u}{\abs{z}{\binp{z}{\underline{x}} \pmap{Q}{3}}} \pmap{P'}{3}
					\hastype \Proc
					}
			\]
			}

\item Case $P =  \appl{(\abs{x} P)}{(\abs{y} Q)}$.
We may have different possibilities for the types of each abstraction. 
We consider only one of them, as the rest are similar:
\[
\tree{
\tree{
\tree{}{
\Gamma \cat x:\shot{C}; \Lambda;  \Delta_1 \proves   P \hastype \Proc}
}{
\Gamma; \Lambda;  \Delta_1 \proves \abs{x} P \hastype \lhot{(\lhot{C})}
} 
\quad
\tree{
\tree{}{
\Gamma; \es;  \Delta_2, y:C \proves  Q \hastype \Proc}
}{
\Gamma; \es;  \Delta_2 \proves \abs{y} Q \hastype \lhot{C}
}
}{
\Gamma; \Lambda; \Delta_1 \cdot \Delta_2 \proves\appl{(\abs{x} P)}{(\abs{y} Q)} \hastype \Proc
}
\]

Thus, by IH we have:
\begin{eqnarray}
\tmap{\Gamma}{3} \cat x:\tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3}   & \proves &  \pmap{P}{3} \hastype \Proc
\label{eq:hopppre4} \\
\tmap{\Gamma}{3}  ; \es; \tmap{\Delta_1}{3}, y:\tmap{C}{3}   & \proves &  \pmap{Q}{3} \hastype \Proc
\label{eq:hopppre5} 
\end{eqnarray}

The corresponding typing in \HOp is as follows --- recall that $\tmap{\lhot{C}}{3} = \lhot{\tmap{C}{3}}$.
{\small
\[
\tree{
\tree{
\tree{
\tree{
\tree{}{
\eqref{eq:hopppre4}
}
}{
\tmap{\Gamma}{3}\cat x: \tmap{\shot{C}}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3}   \cat 
s: \tinact 
\proves
\pmap{P}{3}
\hastype \Proc
}
}{
\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3}   \cat 
s:\btinp{\tmap{\lhot{C}}{3}}\tinact 
\proves 
\binp{s}{x}\pmap{P}{3}
\hastype \Proc
}
\quad
\tree{
\tree{
\tree{}{
\eqref{eq:hopppre5}}
}{
\tree{
\tmap{\Gamma}{3}; \es; \tmap{\Delta_2}{3} 
\cat y:\tmap{ C}{3}
\proves 
  \pmap{Q}{3}
\hastype \Proc
}{
\tree{
\tmap{\Gamma}{3}; \es;   \tmap{\Delta_2}{3} 
\proves 
 \abs{y}{\pmap{Q}{3}} 
\hastype \tmap{\lhot{C}}{3}
}{
\tmap{\Gamma}{3}; \es;   \tmap{\Delta_2}{3} \cat 
\dual{s}: \tinact
\proves 
 \abs{y}{\pmap{Q}{3}} 
\hastype \tmap{\lhot{C}}{3}
}
}
}
}{
\tmap{\Gamma}{3}; \es;   \tmap{\Delta_2}{3} \cat 
\dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact
\proves 
\bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact
\hastype \Proc
}
}{
\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} \cat 
s:\btinp{\tmap{\lhot{C}}{3}}\tinact \cat
\dual{s}:\btout{\tmap{\lhot{C}}{3}}\tinact
\proves 
\binp{s}{x}\pmap{P}{3}
\Par
\bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact
\hastype \Proc
}
}{
\tmap{\Gamma}{3}; \tmap{\Lambda}{3}; \tmap{\Delta_1}{3} \cdot \tmap{\Delta_2}{3} 
\proves \news{s}(\binp{s}{x}\pmap{P}{3}
\Par
\bout{\dual{s}}{\abs{y}{\pmap{Q}{3}}}\inact)
\hastype \Proc
}
\]
}

\end{enumerate}
\qed
\end{proof}
%\else 
%\begin{proof}
%Similar with the case of the encoding of $\pmap{P}{1}$. 
%	\qed
%\end{proof}
%\fi

\begin{proposition}[Operational Correspondence. From \HOpp to \HOp]\rm
	\label{prop:op_corr_HOpp_to_HOp}
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell'}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$ with $\mapa{\ell}^{3} = \ell'$.

%				\item	If $\ell = \bactinp{n}{\abs{x: C}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{x: C}{\pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \news{\tilde{m}} \bactout{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \bactinp{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \btau$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\btau} \hby{\stau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ and $\ell \not= \btau$ then %and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
			{\tmap{\Delta''}{3}}{Q}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$
					with $\mapa{\ell'}^{3} = \ell$ and $Q \scong \pmap{P'}{3}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $Q \scong \pmap{P'}{3}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ then
					either
					$\horel{\Gamma}{\Delta}{\Delta}{\hby{\tau}}{\Delta'}{P'}$ with $Q \scong \pmap{P'}{3}$\\
					or
					$\horel{\Gamma}{\Delta}{\Delta}{\hby{\btau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\btau}}
					{\tmap{\Delta''}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
	The proof of Part 1 does a transition induction and
	considers the mapping as defined in \defref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$.

			$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ implies
\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{ \newsp{s}{ \appl{(\abs{z} \binp{z}{x} \pmap{Q}{3})}{s} \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\btau} \hby{\stau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
\]

		\item	Case: $P = \bout{n}{\abs{\underline{x}} Q} P$

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$
	\end{itemize}

	The proof of Part 2 also does a transition induction and
	considers the mapping as defined in \defref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}$.
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{ \appl{(\abs{z}\binp{z}{x} \pmap{Q}{3})}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\btau}}
			{\tmap{\Delta'}{3}}{}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}
		\]
%
			\noi implies
			$\horel{\Gamma}{\Delta}{\appl{(\abs{x}{Q_1})}{\abs{x}{Q_2}}}{\hby{\btau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ and
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\stau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
		\]

\iftodo
		\item	Case: $P = \bout{n}{\abs{\underline{x}} Q} P$

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$ implies

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{\underline{x}} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies
			\dk{this case is incomplete}
	\end{itemize}
	\dk{Do more cases}
\else 
\item Other cases are similar. 
\end{itemize}
\fi
	\qed
\end{proof}

\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\rm
	\label{prop:fulla_HOpp_to_HOp}
	Let $P, Q$ \HOpp processes with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$.
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}$
\end{proposition}

\begin{proof}
	\noi {\bf Soundness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}}
	\]
%
	\noi	It is straightforward to show that $\Re$ is a bisimulation if we follow Part 2 of
		\propref{prop:op_corr_HOpp_to_HOp} for subcases a and b.
		In subcase c we make use of \propref{lem:tau_inert}.

	\noi {\bf Completeness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\ ,\ }{\tmap{\Delta_2}{3}}{\pmap{Q}{3}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
	\noi	We show that $\Re$ is a bisimulation up to deterministic transitions
		by following Part 1 of \propref{prop:op_corr_HOpp_to_HOp}.
		The proof is straightforward for subcases a), b) and d).
		In subcase c) we make use of \lemref{lem:up_to_deterministic_transition}.
	\qed
\end{proof}

\begin{proposition}[Precise encoding of \HOpp into \HOp]\rm
	\label{prop:prec:HOpp_to_HOp}
	The encoding from $\tyl{L}_{\HOpp}$ to $\tyl{L}_{\HOp}$
	is precise.
\end{proposition}

\begin{proof}
	Syntactic requirements are easily derivable from the
	definition of the mappings in \figref{fig:enc:HOpp_to_HOp}.
	Semantic requirements are a consequence of
	\propref{prop:typepres_HOpp_to_HOp}, \propref{prop:op_corr_HOpp_to_HOp}, and \propref{prop:fulla_HOpp_to_HOp}.
	\qed
\end{proof}



\subsection{Polyadic \HOp}
\label{subsec:pol_HOp}


\noi Embedding polyadic name passing 
into the monadic name passing is well-studied in the literature.    
Using the linear typing, 
the preciseness (full abstraction) can be obtained~\cite{Yoshida96}.
Here we describe an encoding of $\pHOp$ into $\HOp$. 


%The \HOp is presented in monadic terms.
%Nevertheless, we use polyadic \HOp terms
%as syntax sugar to define the encoding from
%$\HOp$ to $\HO$ in \defref{def:enc:HOp_to_HO},
%since polyadic encoding for session types
%has already been studied (cf.~\cite{}).

%For clarity reasons we present the polyadic variants
%\pHOp of \HOp and show a fully abstract
%encoding from \pHOp to \HOp.

\subsubsection{Modifications in Syntax, Reduction Semantics, and Types.}
%\myparagraph{Syntax and Operational Semantics}
The syntax of 
\pHOp processes is obtained from the syntax for processes given in 
\figref{fig:syntax} by considering values 
$$V \bnfis \tilde{u} \bnfbar \abs{\tilde{x}}{P}$$
and input prefixes $\binp{n}{\tilde{x}} P$.
Thus, polyadicity arises both in (session) communications and abstractions. 
Reduction is then defined by the rules in \figref{fig:reduction}, excepting 
 rules $\orule{App}$ and $\orule{Pass}$ which are replaced by rules
 \begin{eqnarray*}
	\orule{App$^p$} & 
	\appl{(\abs{\tilde{x}}{P})}{\tilde{u}} \red P \subst{\tilde{u}}{\tilde{x}} \quad |\tilde{x}| = |\tilde{u}| \\
	\orule{Pass$^p$} & 
		\quad \bout{n}{V} P_1 \Par \binp{\dual{n}}{\tilde{x}} P_2 \red P_1 \Par P_2 \subst{V}{\tilde{x}} \quad |V| = |\tilde{x}|
\end{eqnarray*}
The syntax of types in \figref{def:types}
is modified to include
 \begin{eqnarray*}
 L & \bnfis & \shot{\tilde{C}} \bnfbar \lhot{\tilde{C}} \\
 U & \bnfis & \tilde{C} \bnfbar L
 \end{eqnarray*}
 instead of $L \bnfis \shot{C} \bnfbar \lhot{C}$ and
$U \bnfis C \bnfbar L$, respectively.


%In the current polyadic extension we do not
%require polyadic shared names since the
%polyadic encoding for shared names is
%less straightforward than the polyadic
%encoding for session names.
Definitions of type equivalence/duality 
and typing environments ($\Gamma$ and $\Lambda$) are straightforward extensions of 
\defref{def:type_equiv}, \defref{def:type_dual},
and  \defref{def:typeenv}, respectively. 
Following~\cite{tlca07,MostrousY15} the type system for \pHOp
disallows polyadicity along shared names. Based on these modifications, 
the typing rules of \figref{fig:typerulesmy} are adapted in the expected way. 
In order to type polyadic values, we 
rely on the following rule:
%
\[
	\trule{Pol}~~\tree{
		V = a_i \dots a_n \qquad \Gamma; \Lambda_i; \Delta_i \proves u_i \hastype C_i \qquad U = C_1 \dots C_n
	}{
		\Gamma; \bigcup_{i \in I} \Lambda_i; \bigcup_{i \in I} \Delta_i \proves V \hastype U
	}
\]
%
Other rules are adjusted in the expected way, in order to accommodate polyadic values.
Notice, however, that rules $\trule{Req}$ and $\trule{Acc}$ are kept unchanged, as they
are used to type monadic exchanges along shared name prefixes.
We now state type soundness for \pHOp; the proof is straightforward and omitted, for it follows closely the proof detailed in 
\appref{app:ts}.

\begin{theorem}[Type Soundness for \pHOp]\rm
	\label{thm:sr_phop}
	\begin{enumerate}[1.]
		\item	(Subject Congruence)
			$\Gamma; \es; \Delta \proves P \hastype \Proc$
			and
			$P \scong P'$
			implies
			$\Gamma; \es; \Delta \proves P' \hastype \Proc$.

		\item	(Subject Reduction)
			$\Gamma; \es; \Delta \proves P \hastype \Proc$
			with
			balanced $\Delta$
			and
			$P \red P'$
			implies $\Gamma; \es; \Delta'  \proves P' \hastype \Proc$
			and either (i)~$\Delta = \Delta'$ or (ii)~$\Delta \red \Delta'$
			with $\Delta'$ balanced.
	\end{enumerate}
\end{theorem}

%\iftodo
%\dk{sketch subject reduction (just revise the related case)}
%\else\fi

As for the behavioral semantics for \pHOp, the 
set of action labels is kept unchanged. 
In fact, 
as $V$ now stands for $\tilde{u}$ and $\abs{\tilde{x}}{P}$, 
labels  $\news{\tilde{m}} \bactout{n}{V}$ and $\bactinp{n}{V}$
require no modification. 
The LTS for \pHOp is as for \HOp, 
excepting rule $\ltsrule{App}$ which is replaced with the rule:
%
\[
	\appl{(\abs{\tilde{x}} P)}{\tilde{u}} \by{\tau} P\subst{\tilde{u}}{\tilde{x}}
\]
%
The characteristic process and characteristic value 
definition (\defref{def:characteristic_process})
is extended to include the cases:
\begin{eqnarray*}
	\mapchar{C_1 \dots C_n}{u_1 \cdots u_n} & \defeq &  \mapchar{C_1}{x_1} \Par \dots \Par \mapchar{C_n}{x_n} \\
	\omapchar{U_1 \dots U_n}  & \defeq &  \omapchar{U_1}, \dots, \omapchar{U_n}
\end{eqnarray*}
%
Thus, a polyadic type is inhabited by process whose
parallel components inhabit type the individual components of the polyadic
type. A polyadic value type is inhabited by a list
of values which inhabit the individual components of the polyadic value.
The rest of the behavioural semantics remains unchanged.

%Other definitions are straightforwardly extended. 

\subsubsection{Encoding \pHOp into \HOp.}

We slightly modify \defref{def:ep} to capture that a 
label $\ell$ may be mapped into a sequence of labels $\tilde{\ell}$.
Also, \defref{def:ep} stays as the same
assuming that if 
$P \hby{\ell} P'$ and $\mapa{\ell} = \{\ell_1, \ell_2,  \cdots, \ell_m\}$ then
$\map{P} \Hby{\mapa{\ell}} \map{P'}$
should be understood as
$\map{P} \Hby{\ell_1} P_1 \Hby{\ell_2} P_2 \cdots \Hby{\ell_m} P_m =  \map{P'}$,
for some
$P_1, P_2, \ldots, P_m$.

Let $\tyl{L}_{\pHOp}=\calc{\pHOp}{{\cal{T}}_5}{\hby{\ell}}{\wb}{\proves}$
where 
${\cal{T}}_5$ is a set of types of $\HOpp$;  
the typing $\proves$ is defined in 
\figref{fig:typerulesmy} with polyadic types.

\begin{definition}[Encoding from \pHOp to \HOp]\rm
	\label{def:enc:pHOp_to_HOp}
	Encoding $\enco{\pmap{\cdot}{4}, \tmap{\cdot}{4}, \mapa{\cdot}^{4}}: \tyl{L}_{\pHOp} \to \tyl{L}_{\HOp}$
	to be defined as in \figref{fig:enc:pHOp_to_HOp}.
\end{definition}

\begin{figure}[t]
	\[
		\begin{array}{rcl}
			\multicolumn{3}{l}{\textrm{\bf Terms}}
			\\
			\pmap{\bout{n}{u_1, \dots, u_n} P}{4} &\defeq& \bout{n}{u_1} \dots ; \bout{n}{u_n} \pmap{P}{4}
			\\
			\pmap{\binp{n}{x_1, \dots, x_n} P}{4} &\defeq& \binp{n}{x_1} \dots ; \binp{n}{x_n} \pmap{P}{4}
			\\
			\pmap{\bout{n}{\abs{x_1, \dots, x_n}{Q}} P}{4} &\defeq& \bout{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{Q}{4}}} \pmap{P}{4}
			\\
			\pmap{\appl{x}{(u_1, \dots, u_n)}}{4} &\defeq& \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{u_1} \dots; \bout{\dual{s}}{u_1} \inact}
			\\
			\pmap{\appl{(\abs{x}{P})}{(u_1, \dots, u_n)}}{4} &\defeq& \newsp{s}{\appl{(\abs{x}{\pmap{P}{4}})}{s} \Par \bout{\dual{s}}{u_1} \dots; \bout{\dual{s}}{u_1} \inact}
			\\
			\\
			\multicolumn{3}{l}{\textrm{\bf Types}}
			\\
			\tmap{\lhot{(C_1, \dots, C_n)}}{4} &\defeq& \lhot{(\btinp{C_1} \dots; \btinp{C_n} \tinact)}
			\\
			\tmap{\shot{(C_1, \dots, C_n)}}{4} &\defeq& \shot{(\btinp{C_1} \dots; \btinp{C_n} \tinact)}
			\\
			\tmap{\btout{L} S}{4} &\defeq& \btout{\tmap{L}{4}} \tmap{S}{4}
			\\
			\tmap{\btinp{L} S}{4} &\defeq& \btinp{\tmap{L}{4}} \tmap{S}{4}
			\\
			\tmap{\btout{C_1, \dots, C_n} S}{4} &\defeq& \btout{C_1} \dots; \btout{C_n} \tmap{S}{4}
			\\
			\tmap{\btinp{C_1, \dots, C_n} S}{4} &\defeq& \btinp{C_1} \dots; \btout{C_n} \tmap{S}{4}
			\\
			\\
			\multicolumn{3}{l}{\textrm{\bf Labels}}
			\\
			\mapa{\news{\tilde{m}'} \bactout{n}{m_1, \dots, m_n}}^{4} &\defeq& \news{\tilde{m_1}'} \bactout{n}{m_1} \dots \news{\tilde{m_n}'}\bactout{n}{m_n}
			\quad \left.
			\begin{array}{rcl}
				\tilde{m_i}' &=& m_i \Leftrightarrow m_i \in \tilde{m}' \wedge\\
				\tilde{m_i}' &=& \es \Leftrightarrow m_i \notin \tilde{m}'
			\end{array}
			\right.
			\\
			\mapa{\bactinp{n}{m_1, \dots, m_n}}^{4} &\defeq& \bactinp{n}{m_1} \dots \bactinp{n}{m_n}
			\\
			\mapa{\news{\tilde{m}} \bactout{n}{\abs{x_1, \dots, x_n}{P}}}{4} &\defeq& \news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{P}{4}}}
			\\
			\mapa{\bactinp{n}{\abs{x_1, \dots, x_n}{P}}}{4} &\defeq& \bactinp{n}{\abs{z}{\binp{z}{x_1} \dots; \binp{z}{x_n} \pmap{P}{4}}}
			\\
			\mapa{\btau}^{4} &\defeq& \btau, \stau, \dots, \stau
			\\
			\mapa{\tau}^{4} &\defeq& \tau, \dots, \tau
		\end{array}
	\]
%
	\caption{Encoding of \pHOp into \HOp (cf.~\defref{def:enc:pHOp_to_HOp}).
	We assume that the rest of the encoding is homomorphic on the syntax of
	processes, types and labels, respectively. \label{fig:enc:pHOp_to_HOp}}
\end{figure}

\begin{proposition}[Type Preservation. From \pHOp to \HOp]\rm
	\label{prop:typepres_pHOp_to_HOp}
	Let $P$ be a \pHOp process.
	If $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$ then 
	$\tmap{\Gamma}{4}; \emptyset; \tmap{\Delta}{4} \proves \pmap{P}{4} \hastype \Proc$. 
\end{proposition}

\begin{proof}
	By induction on the inference $\Gamma; \emptyset; \Delta \proves P \hastype \Proc$.
	See \propref{app:prop:typepres_pHOp_to_HOp} (Page~\pageref{app:prop:typepres_pHOp_to_HOp}) for details.
	\qed
\end{proof}


\begin{proposition}[Operational Correspondence. From \pHOp to \HOp]\rm
	\label{prop:op_cor:pHOp_to_HOp}
%
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$. Then
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell = \news{\tilde{m}'} \bactout{n}{\tilde{m}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta'}{4}}{\pmap{P}{4}}$
					with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell = \bactinp{n}{\tilde{m}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell_1} \dots \hby{\ell_n}}{\tmap{\Delta'}{4}}{\pmap{P}{4}}$
					with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{\tilde{x}}{R}}, \bactinp{n}{\abs{\tilde{x}}{R}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell'}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell}^{4} = \ell'$.

				\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$ then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$.

				\item	If $\ell = \btau$ then either
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\btau} \hby{\stau} \dots \hby{\stau}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell} = \btau, \stau \dots \stau$.

				\item	If $\ell = \tau$ then %and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\tau} \dots \hby{\tau}}
					{\tmap{\Delta'}{4}}{\pmap{P'}{4}}$ with $\mapa{\ell}^{4} = \tau \dots \tau$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta}{4}}{\pmap{P}{4}}{\hby{\ell_1}}
			{\tmap{\Delta_1}{4}}{P_1}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\bactinp{n}{m}, \bactout{n}{m}, \news{m} \bactout{n}{m}}$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and\\
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\ell_2} \dots \hby{\ell_n}}
					{\tmap{\Delta'}{4}}{\tmap{P'}{4}}$ with $\mapa{\ell}^{4} = \ell_1 \dots \ell_n$.

				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{R}}, \bactinp{n}{\abs{x}{R}}}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
					with $\mapa{\ell'}^{4} = \ell$ and $P_1 \scong \pmap{P'}{4}$.

				\item	If $\ell \in \set{\bactsel{n}{l}, \bactbra{n}{l}}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $P_1 \scong \pmap{P'}{4}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \btau$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\btau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\stau} \dots \hby{\stau}}
					{\tmap{\Delta'}{4}}{\tmap{P'}{4}}$ with $\mapa{\ell}^{4} = \btau, \stau \dots \stau$.

				\item	If $\ell = \tau$ then
					$\horel{\Gamma}{\Delta}{P}{\hby{\tau}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{P_1}{\hby{\tau} \dots \hby{\tau}}
					{\tmap{\Delta'}{4}}{\tmap{P'}{4}}$ with $\mapa{\ell}^{4} = \tau \dots \tau$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
	The proof of both parts is by transition induction, following 
	the mapping defined in \defref{def:enc:HOpp_to_HOp}.
	We consider some representative cases, using biadic communication:
	\begin{enumerate}[$\bullet$]
	%\item 
	%% Biadic Output 
\item Case (1(a)), with $P =\bout{n}{m_1, m_2} P'$ and $\ell_1 = \bactout{n}{m_1, m_2}$. 
By assumption, $P$ is well-typed. 
As one particular possibility, we may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; m_1{:} S_1 \cat m_2{:}S_2 \proves  m_1,m_2 \hastype S_1,S_2}{
					\Gamma; \emptyset; \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S \proves  
					\bout{n}{m_1,m_2} P' \hastype \Proc}
			\]
for some $\Gamma, S, S_1, S_2, \Delta_0$, 
such that $\Delta = \Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S$.
We may then have the following typed transition
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}{\bout{n}{m_1, m_2} P'}{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgment for $P$ is as follows:
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat m_1{:}S_1 \cat m_2{:}S_2 \cat n:\btout{S_1,S_2}S}^{4} \proves \map{\bout{n}{m_1, m_2} P'}^{4} \hastype \Proc
$$
which, using \defref{def:enc:HOpp_to_HOp}, can be expressed as 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0} 
\cat m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} 
\cat n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} 
\hastype \Proc
$$
Now, $\mapa{\ell_1}^{4} = \bactout{n}{m_1 }, \bactout{n}{ m_2}$. 
It is immediate to infer the following typed transitions for $\map{P}^{4}  = \bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4} $:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta_0} \cat  m_1{:}\mapt{S_1}^{4} \cat m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_1}\bout{n}{m_2} \map{P'}^{4}  \\
& \hby{\bactout{n}{m_1}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat  m_2{:}\mapt{S_2}^{4} \cat
n:\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
\proves 
\bout{n}{m_2} \map{P'}^{4} \\
& \hby{\bactout{n}{m_2}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0}  \cat n{:}\mapt{S}^{4}
\proves 
 \map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat
n:S }^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%% Biadic Abstraction Output 
\item Case (1(c)) with $P = \bbout{n}{\abs{(x_1, x_2)} Q} P' $ and $\ell_1 = \bactout{n}{\abs{(x_1, x_2)}{Q}}$. 
By assumption, $P$ is well-typed. 
We may have:
			\[
				\tree{
					\Gamma; \emptyset; \Delta_0 \cat n:S  \proves  P' \hastype \Proc \quad 
					\Gamma ; \emptyset ; \Delta_1 \proves  \abs{(x_1,x_2)}Q \hastype \lhot{(C_1,C_2)}}{
					\Gamma; \emptyset; \Delta_0 \cat \Delta_1 \cat n:\btout{\lhot{(C_1,C_2)}}S \proves  
					\bout{n}{\abs{(x_1,x_2)}Q} P' \hastype \Proc}
			\]
for some $\Gamma$, $S$, $C_1$, $C_2$, $\Delta_0$, $\Delta_1$, 
such that $\Delta = \Delta_0 \cat \Delta_1 \cat  n:\btout{\lhot{(C_1,C_2)}}S$.
(For simplicity, we consider only the case of a linear function.)
We may have the following typed transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}{\bbout{n}{\abs{(x_1, x_2)} Q} P' }{\Delta_0 \cat n{:}S}{P'}
$$
The encoding of the source judgment is
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1 \cat n:\bbtout{\lhot{(C_1, C_2)}}S}^{4} \proves \map{\bbout{n}{\abs{(x_1, x_2)} Q} P' }^{4} \hastype \Proc
$$
which, using \defref{def:enc:HOpp_to_HOp}, can be equivalently expressed as 
$$
\mapt{\Gamma}^{4}; \emptyset; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}
\hastype \Proc
$$

Now, $\mapa{\ell_1}^{4} = \bactout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}}$. 
It is immediate to infer the following typed transition for $\map{P}^{4}  = \bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; \mapt{\Delta_0 \cat \Delta_1} \cat
%n:\btout{\mapt{S_1}^{4}}\btout{\mapt{S_2}^{4}}\mapt{S}^{4}
n:\bbtout{
		\lhot{\big(\btinp{\tmap{C_1}{4}}\btinp{\tmap{C_2}{4}}\tinact\big)}}\mapt{S}^{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\mapa{\ell_1}^{4}} & 
\mapt{\Gamma}^{4}; \mapt{\Delta_0} \cat
n:\mapt{S}^{4}, \,
\proves 
\map{P'}^{4} \\
 & = & 
 \mapt{\Gamma}^{4}; 
 \mapt{\Delta_0 \cat n:S}^{4}
\proves 
 \map{P'}^{4}
\end{eqnarray*}
which concludes the proof for this case.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PART 2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Biadic Input 
\item Case (2(a)), with $P =  \binp{n}{x_1, x_2} P' $, 
$\map{P}^{4} = 
		\binp{n}{x_1}  \binp{n}{x_2}  \map{P'}^{4}$.
%		We show that this case falls under part~(b) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 		
%		and $\ell_2 = \bactinp{n}{m_1}, \bactinp{n}{m_2}$. Then w
		We have  the following typed transitions for $\map{P}^{4}$, for some $S$, $S_1$, $S_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_1}{4}}\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
\proves 
\binp{n}{x_1} \binp{n}{x_2}\map{P'}^{4} \\
& \hby{\bactinp{n}{m_1}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat 
n:\btinp{\tmap{S_2}{4}}\tmap{S}{4} \cat
m_1:\mapt{S_1}^{4}
\proves 
\binp{n}{x_2}\map{P'}^{4} \subst{m_1}{x_1} \\
& \hby{\bactinp{n}{m_2}} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4} \cat n:\tmap{S}{4} \cat
m_1:  \mapt{S_1}^{4} \cat
m_2: \mapt{S_2}^{4}
\proves 
\map{P'}^{4} \subst{m_1}{x_1}\subst{m_2}{x_2} = Q
\end{eqnarray*}
Observe that the substitution lemma (Lemma~\ref{lem:subst}(1)) has been used twice.
%Considering Remarn~\ref{r:multilabels} 
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactinp{n}{m_1,m_2}$. Indeed, $\mapa{\ell_1}^{4} = \bactinp{n}{m_1}, \bactinp{n}{m_2}$.
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta \cat n:\btinp{S_1, S_2}S}{\binp{n}{x_1, x_2} P' }{\Delta\cat n{:}S \cat m_1:S_1 \cat m_2:S_2}{P'\subst{m_1,m_2}{x_1, x_2}}
$$
which concludes the proof for this case.


%% Biadic Abstraction Output 
\item Case (2(b)), with $P =  \bbout{n}{\abs{(x_1,x_2)} Q} P' $, 
$\map{P}^{4} = 
		\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4}$.
		%We show that this case falls under part~(a) of the thesis (cf. Prop.~\ref{p:ocpotomo}). 
		We have the following  typed transition, for some $S$, $C_1$, $C_2$, and $\Delta$:
\begin{eqnarray*}
& & \mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{\bbtout{\lhot{(C_1,  C_2)}} S}{4}
\proves 
\bbout{n}{\abs{z}\binp{z}{x_1}\binp{z}{x_2} \map{Q}^{4}} \map{P'}^{4} \\
& \hby{\ell'_1} & 
\mapt{\Gamma}^{4}; 
\mapt{\Delta}^{4}\cat n:\tmap{ S}{4} 
\proves 
\map{P'}^{4} = Q
\end{eqnarray*}
where
$\ell'_1 = \bactout{n}{\abs{z}\binp{z}{x_1} \binp{z}{x_2} \map{Q}^{4}}$.
For simplicity, we consider only the case of linear functions.
It is then immediate to infer the label for the source transition:
$\ell_1 = \bactout{n}{\abs{(x_1,  x_2)}{Q}} $. 
Now, in the source term $P$ we can infer the following transition:
$$
\stytra{\Gamma}{\ell_1}{\Delta\cat n:\bbtout{\lhot{(C_1,  C_2)}} S}{ \bbout{n}{\abs{x_1,x_2} Q} P'}{\Delta\cat n{:}S}{P'}
$$
which concludes the proof for this case.



	\end{enumerate}
%\iftodo{
%	\dk{do some cases}
%}\else\fi
	\qed
\end{proof}


\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\rm
	\label{prop:fulla:pHOp_to_HOp}
	Let $P, Q$ \pHOp process with $\Gamma; \es; \Delta_1 \proves P \hastype \Proc$ and 
	$\Gamma; \es; \Delta_2 \proves Q \hastype \Proc$.
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\wb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}$
\end{proposition}

\begin{proof}
	The proof for both direction is a consequence of Operational Correspondence,
	\propref{prop:op_cor:pHOp_to_HOp}.

	\noi {\bf Soundness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\wb}{\tmap{\Delta_2}{4}}{\pmap{Q}{4}}}
	\]
%
	\noi	It is straightforward to show that $\Re$ is a bisimulation if we follow Part 2 of
		\propref{prop:op_cor:pHOp_to_HOp}.
%		for subcases a and b.
%		In subcase c we make use of \propref{lem:tau_inert}.

	\noi {\bf Completeness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{4}}{\tmap{\Delta_1}{4}}{\pmap{P}{4}}{\ ,\ }{\tmap{\Delta_2}{4}}{\pmap{Q}{4}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
%	\dk{Is the proof easy? do the proof}
	\noi	We show that $\Re$ is a bisimulation up to deterministic transitions
		by following Part 1 of \propref{prop:op_cor:pHOp_to_HOp}.
%		The proof is straightforward for subcases a), b) and d).
%		In subcase c) we make use of \lemref{lem:up_to_deterministic_transition}.
	\qed
\end{proof}

\begin{proposition}[Precise encoding of \HOpp into \HOp]\rm
	\label{prop:prec:pHOp_to_HOp}
	The encoding from $\tyl{L}_{\pHOp}$ to $\tyl{L}_{\HOp}$
	is precise.
\end{proposition}

\begin{proof}
	Syntactic requirements are easily derivable from the
	definition of the mappings in \figref{fig:enc:pHOp_to_HOp}.
	Semantic requirements are a consequence of
	\propref{prop:typepres_pHOp_to_HOp}, \propref{prop:op_cor:pHOp_to_HOp}, and \propref{prop:fulla:pHOp_to_HOp}.
	\qed
\end{proof}

