\newcommand{\HOpp}{\ensuremath{\mathsf{HO\pi^{+}}}\xspace}
\section{Extension of \HOp to \HOpp}

In this section we extend the \HOp calculus to include higher order applications.

\subsection{Extending the Semantics}

{\bf Syntax and Operational Semantics:}
The syntax of Figure~\ref{fig:syntax} is changed to include $\appl{x}{V}$
instead of $\appl{x}{u}$.
We also replace rule $\orule{App}$ in Figure~\ref{fig:reduction}
with rule $\appl{\abs{x}{P}}{V} \red P \subst{V}{x}$.
%The structural congruence in Section~\ref{subsec:reduction_semantics}
%is changed to include $\appl{(\abs{x} P)}{V} \scong P \subst{x}{V}$
%instead of $\appl{(\abs{x} P)}{u} \scong P \subst{x}{u}$.

\noi {\bf Types.}
The syntax of types changes to include $L \bnfis \shot{U} \bnfbar \lhot{U}$
instead of $L \bnfis \shot{C} \bnfbar \lhot{C}$. We expect the obvious
extension for type equivalence (Definition~\ref{def:type_equiv})
and for the definition of type environments.

We also expect the straightforward extension of the type 
system to accomodate the new type syntax. The two
most characterestic rules $\trule{Abs}$ and $\trule{App}$ 
for application and abstraction, respectively, now become:
\[
	\begin{array}{c}
		\trule{Abs}~~\tree{
			\Gamma; \Lambda; \Delta_1 \proves P \hastype \Proc
			\quad
			\Gamma; \es; \Delta_2 \proves x \hastype U
		}{
			\Gamma; \Lambda; \Delta_1 \backslash \Delta_2 \proves \abs{x}{P} \hastype \lhot{U}
		}
		\\[6mm]

		\trule{App}~~\tree{
			\begin{array}{c}
				U = \lhot{U'} \lor \shot{U'}
				\quad
				\Gamma; \Lambda; \Delta_1 \proves x \hastype U
				\quad
				\Gamma; \es; \Delta_2 \proves u \hastype U'
			\end{array}
		}{
			\Gamma; \Lambda; \Delta_1 \cat \Delta_2 \proves \appl{x}{u} \hastype \Proc
		} 
	\end{array}
\]

\dk{prove subject reduction for the extension}

\noi {\bf Behavioural Semantics.}
Labels remain the same. Rule $\ltsrule{App}$ in the untyped LTS
is replaced with rule $\appl{\abs{x}{P}}{V} \by{\tau} P \subst{V}{x}$.
The definition of the
characteristic process~\ref{def:characteristic_process} should be:
%
\begin{definition}[Characteristic Process]\rm
	\noi Let name $u$ and type $U$; then we define the {\em characteristic process}:
	$\mapchar{U}{u}$ and the {\em characteristic value} $\omapchar{U}$ as:
%
	\[
	\begin{array}{cc}
		\begin{array}{rclcl}
			\mapchar{\btinp{U} S}{u} &\defeq& \binp{u}{x} (\mapchar{S}{u} \Par \mapchar{U}{x})
			\\
			\mapchar{\btout{U} S}{u} &\defeq& \bout{u}{\omapchar{U}} \mapchar{S}{u} %& & n \textrm{ fresh}
			\\
			\mapchar{\btsel{l : S}}{u} &\defeq& \bsel{u}{l} \mapchar{S}{u}
			\\
			\mapchar{\btbra{l_i: S_i}_{i \in I}}{u} &\defeq& \bbra{u}{l_i: \mapchar{S_i}{u}}_{i \in I}
			\\
			\mapchar{\tvar{t}}{u} &\defeq& \varp{X}_{\vart{t}}
			\\
			\mapchar{\trec{t}{S}}{u} &\defeq& \recp{X_{\vart{t}}}{\mapchar{S}{u}}
			\\
			\mapchar{\tinact}{u} &\defeq& \inact
			\\
		\end{array}
		&
		\begin{array}{rcrclcl}
			&&\mapchar{\chtype{S}}{u} &\defeq& \bout{u}{\omapchar{S}} \inact
			\\
			&&\mapchar{\chtype{L}}{u} &\defeq& \bout{u}{\omapchar{L}} \inact
			\\
			\mapchar{\shot{U}}{x} &\defeq& \mapchar{\lhot{U}}{x} &\defeq& \appl{x}{\omapchar{U}}
			\\
			\\
			&&\omapchar{S} &\defeq& s && s \textrm{ fresh}
			\\
			\omapchar{\chtype{S}} &\defeq& \omapchar{\chtype{L}} &\defeq& a && a \textrm{ fresh}
			\\
			\omapchar{\shot{U}} &\defeq& \omapchar{\lhot{U}} &\defeq& \abs{x}{\mapchar{U}{x}}
		\end{array}
	\end{array}
	\]
\end{definition}
%
\noi The rest of the definition for the behavioural remain the same.

\subsection{Encoding from \HOpp to \HOp}

We now present an encoding from \HOpp to \HOp.

\begin{definition}[Encoding from \HOpp to \HOp]\rm
	\label{def:enc:HOpp_to_HOp}
	Let mapping $\enco{\pmap{\cdot}{3}, \tmap{\cdot}{3}, \mapa{\cdot}^{3}}: \HOpp \to \HOp$:
%
	\[
	\begin{array}{rcl}
		\pmap{\appl{x}{\abs{x} P}}{3} &\defeq& \newsp{s}{\appl{x}{s} \Par \bout{\dual{s}}{\abs{x} \pmap{P}{3}} \inact}
		\\
		\pmap{\bout{u}{\abs{x: L}{Q}} P}{3} &\defeq& \bout{u}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}} \pmap{P}{3}
		\\
		\pmap{\bout{u}{\abs{x: C}{Q}} P}{3} &\defeq& \bout{u}{\abs{x}{\pmap{Q}{3}}} \pmap{P}{3}
		\\
		\\
		\tmap{\shot{L}}{3} &\defeq& \shot{\btinp{L} \tinact}
		\\
		\tmap{\lhot{L}}{3} &\defeq& \lhot{\btinp{L} \tinact}
		\\
		\tmap{\btout{\shot{L}} S}{3} &\defeq& \btout{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btout{\lhot{L}} S}{3} &\defeq& \btout{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\shot{L}} S}{3} &\defeq& \btinp{\tmap{\shot{L}}{3}} \tmap{S}{3}
		\\
		\tmap{\btinp{\lhot{L}} S}{3} &\defeq& \btinp{\tmap{\lhot{L}}{3}} \tmap{S}{3}
		\\
		\\
		\mapa{\bactout{n}{\abs{x:C}{P}}}^{3} &\defeq& \bactout{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{x:C}{P}}}^{3} &\defeq& \bactinp{n}{\abs{x}{\pmap{P}{3}}}
		\\
		\mapa{\bactout{n}{\abs{x:L}{P}}}^{3} &\defeq& \bactout{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}
		\\
		\mapa{\bactinp{n}{\abs{x:L}{P}}}^{3} &\defeq& \bactinp{n}{\abs{z}{\binp{z}{x} \pmap{P}{3}}}

	\end{array}
	\]
%
	\noi We assume that the rest of the encoding is homomorphic on the syntax of
	processes, types and labels, respectively.
\end{definition}

\begin{proposition}[Operational Correspondence. From \HOpp to \HOp]\rm
	\label{prop:op_corr:HOpp_to_HO}
	\begin{enumerate}
		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}}$ then
%					$\exists l' $ such that
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell'}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$ with $\mapa{\ell}^{3} = \ell'$.

%				\item	If $\ell = \bactinp{n}{\abs{x: C}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{x: C}{\pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \news{\tilde{m}} \bactout{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\news{\tilde{m}} \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
%
%				\item	If $\ell = \bactinp{n}{\abs{x: L}{Q}}$ then
%					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\bactinp{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}}}}}
%					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$ then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\hby{\ell}$ is a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\bhby{\tau} \shby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ and $\hby{\ell}$ is not a \betatran then
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\tau}}
					{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}

		\item	Let $\Gamma; \es; \Delta \proves P$.
			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\pmap{P}{3}}{\hby{\ell}}
			{\tmap{\Delta''}{3}}{Q}$ implies
%
			\begin{enumerate}[a)]
				\item	If $\ell \in \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell'}}{\Delta'}{P'}$
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$
					with $\mapa{\ell'}^{3} = \ell$ and $Q \scong \pmap{P'}{3}$.

				\item	If $\ell \notin \set{\news{\tilde{m}} \bactout{n}{\abs{x}{Q}}, \bactinp{n}{\abs{x}{Q}}, \tau}$
					then
					$\horel{\Gamma}{\Delta}{P}{\hby{\ell}}{\Delta'}{P'}$ and $Q \scong \pmap{P'}{3}$.
%					and $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\hby{\hat{\ell}}}{\tmap{\Delta'}{3}}{\pmap{P'}{3}}$.

				\item	If $\ell = \tau$ then
					either
					$\horel{\Gamma}{\Delta}{\Delta}{\hby{\tau}}{\Delta'}{P'}$ with $Q \scong \pmap{P'}{3}$\\
					or
					$\horel{\Gamma}{\Delta}{\Delta}{\bhby{\ell}}{\Delta'}{P'}$ and
					$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta''}{3}}{Q}{\shby{\tau}}
					{\tmap{\Delta''}{3}}{\pmap{P'}{3}}$.
			\end{enumerate}
	\end{enumerate}
\end{proposition}

\begin{proof}
	The proof of Part 1 does a transition induction and
	considers the mapping in Definition~\ref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}$.

			$\horel{\Gamma}{\Delta}{\appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}}{\bhby{\tau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ implies
\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{ \newsp{s}{ \appl{\abs{z}\binp{z}{x} \pmap{Q}{3}}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\bhby{\tau} \shby{\tau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
\]

		\item	Case: $P = \bout{n}{\abs{x:L} Q} P$

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{x:L} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$
	\end{itemize}

	The proof of Part 2 also does a transition induction and
	considers the mapping in Definition~\ref{def:enc:HOpp_to_HOp}.
	We give the most interesting cases.

	\begin{itemize}
		\item	Case: $P = \appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}$.
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{ \appl{\abs{z}\binp{z}{x} \pmap{Q}{3}}{s}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\hby{\tau}}
			{\tmap{\Delta'}{3}}{}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}
		\]
%
			\noi implies
			$\horel{\Gamma}{\Delta}{\appl{\abs{x}{Q_1}}{\abs{x}{Q_2}}}{\bhby{\tau}}{\Delta}{Q_1 \subst{\abs{x}{Q_2}}{x}}$ and
%
		\[
			\mhorel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\newsp{s}{\binp{s}{x} \pmap{Q}{3}  \Par \bout{\dual{s}}{\abs{x}{Q_2}} \inact}}{\shby{\tau}}
			{\tmap{\Delta'}{3}}{}{\pmap{Q_1}{3} \subst{\abs{x}{\pmap{Q_2}{3}}}{x}}
		\]

		\item	Case: $P = \bout{n}{\abs{x:L} Q} P$

			$\horel{\tmap{\Gamma}{3}}{\tmap{\Delta}{3}}{\bout{n}{\abs{z} \binp{z}{x} \pmap{Q}{3}} \pmap{P}{3}}{\hby{ \bactout{n}{\abs{z}{\binp{z}{x} \pmap{Q}{3}} } }}{\Delta}{\pmap{P}{3}}$ implies

			$\horel{\Gamma}{\Delta}{\bout{n}{\abs{x:L} Q} P}{\hby{ \bactout{n}{\abs{x}{Q}}}}{\Delta}{P}$ implies
	\end{itemize}
	\dk{Do more cases}
	\qed
\end{proof}

\begin{proposition}[Full Abstraction. From \HOpp to \HOp]\rm
	$\horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}$ if and only if $\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}$
\end{proposition}

\begin{proof}
	\noi {\bf Soundness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\Gamma}{\Delta_1}{P}{\ ,\ }{\Delta_2}{Q} \setbar \horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\wb}{\tmap{\Delta_2}{3}}{\pmap{Q}{3}}}
	\]
%
	\noi and show that $\Re$ is a bisimulation.


	\noi {\bf Completeness Direction.}

	\noi We create the closure
%
	\[
		\Re = \set{\horel{\tmap{\Gamma}{3}}{\tmap{\Delta_1}{3}}{\pmap{P}{3}}{\ ,\ }{\tmap{\Delta_2}{3}}{\pmap{Q}{3}} \setbar \horel{\Gamma}{\Delta_1}{P}{\wb}{\Delta_2}{Q}}
	\]
%
	\noi and show that $\Re$ is a bisimulation up to deterministic transition.
	
	\dk{To be done!}
	\qed
\end{proof}
